=== ./keyboards/admin_keyboards.py ===
from aiogram.types import InlineKeyboardMarkup
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.types import InlineKeyboardButton


def get_main_admin_menu_keyboard() -> InlineKeyboardMarkup:
    """
    –û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
    """
    builder = InlineKeyboardBuilder()
    
    builder.row(
        InlineKeyboardButton(
            text="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
            callback_data="admin_stats"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏",
            callback_data="admin_users"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="üéÅ –†–æ–∑—ã–≥—Ä—ã—à–∏",
            callback_data="admin_giveaways"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="üì¢ –†–∞—Å—Å—ã–ª–∫–∞",
            callback_data="admin_broadcast"
        )
    )
    
    return builder.as_markup()


def get_back_to_main_menu_keyboard() -> InlineKeyboardMarkup:
    """
    –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π "–ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"
    """
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é",
            callback_data="admin_main_menu"
        )
    )
    return builder.as_markup()


def get_cancel_search_keyboard() -> InlineKeyboardMarkup:
    """
    –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π –æ—Ç–º–µ–Ω—ã –ø–æ–∏—Å–∫–∞
    """
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(
            text="‚ùå –û—Ç–º–µ–Ω–∞",
            callback_data="admin_main_menu"
        )
    )
    return builder.as_markup()


def get_cancel_broadcast_creation_keyboard() -> InlineKeyboardMarkup:
    """
    –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π –æ—Ç–º–µ–Ω—ã —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∏
    """
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(
            text="‚ùå –û—Ç–º–µ–Ω–∞",
            callback_data="admin_broadcast"
        )
    )
    return builder.as_markup()


def get_cancel_schedule_keyboard() -> InlineKeyboardMarkup:
    """
    –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π –æ—Ç–º–µ–Ω—ã –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    """
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(
            text="‚ùå –û—Ç–º–µ–Ω–∞",
            callback_data="admin_broadcast"
        )
    )
    return builder.as_markup()=== ./keyboards/admin_broadcast_time_keyboards.py ===
from aiogram.types import InlineKeyboardMarkup
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.types import InlineKeyboardButton
import calendar
from datetime import datetime
from core.tools.timezone import get_now_msk

MONTHS = ["", "–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"]

def get_broadcast_date_picker_keyboard(year: int = None, month: int = None) -> InlineKeyboardMarkup:
    """
    –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–º –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã —Ä–∞—Å—Å—ã–ª–∫–∏
    """
    if year is None or month is None:
        now = get_now_msk()
        year, month = now.year, now.month
    
    builder = InlineKeyboardBuilder()
    
    # –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –º–µ—Å—è—Ü–µ–º –∏ –≥–æ–¥–æ–º
    builder.button(text=f"{MONTHS[month]} {year}", callback_data="admin_ignore")
    
    # –î–Ω–∏ –Ω–µ–¥–µ–ª–∏
    days = ["–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±", "–í—Å"]
    for d in days:
        builder.button(text=d, callback_data="admin_ignore")
    
    # –ö–∞–ª–µ–Ω–¥–∞—Ä—å
    cal = calendar.monthcalendar(year, month)
    now = get_now_msk()
    
    for week in cal:
        for day in week:
            if day == 0:
                builder.button(text=" ", callback_data="admin_ignore")
                continue
            
            # –õ–æ–≥–∏–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—à–ª—ã—Ö –¥–Ω–µ–π
            is_past = False
            if year < now.year: 
                is_past = True
            elif year == now.year and month < now.month: 
                is_past = True
            elif year == now.year and month == now.month and day < now.day: 
                is_past = True
            
            if is_past:
                builder.button(text="‚úñÔ∏è", callback_data="admin_ignore")
            else:
                builder.button(text=str(day), callback_data=f"admin_broadcast_date_set:{year}:{month}:{day}")
    
    builder.adjust(1, 7, 7, 7, 7, 7, 7)
    
    # –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º
    prev_m = month - 1 if month > 1 else 12
    prev_y = year if month > 1 else year - 1
    next_m = month + 1 if month < 12 else 1
    next_y = year if month < 12 else year + 1
    
    can_go_back = not (prev_y < now.year or (prev_y == now.year and prev_m < now.month))
    
    # –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è
    if can_go_back:
        builder.button(text="‚¨ÖÔ∏è", callback_data=f"admin_broadcast_cal_nav:{prev_y}:{prev_m}")
    else:
        builder.button(text=" ", callback_data="admin_ignore")  # –ü—É—Å—Ç—ã—à–∫–∞ –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è
        
    builder.button(text="‚û°Ô∏è", callback_data=f"admin_broadcast_cal_nav:{next_y}:{next_m}")
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
    builder.button(text="‚è± –í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é", callback_data="admin_broadcast_manual_time")
    builder.button(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="admin_broadcast")
    
    # –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä—è–¥: –ù–∞–≤–∏–≥–∞—Ü–∏—è + –û—Ç–º–µ–Ω–∞
    builder.adjust(1, 7, 7, 7, 7, 7, 7, 2, 2)
    return builder.as_markup()


def get_broadcast_time_picker_keyboard(year: int, month: int, day: int) -> InlineKeyboardMarkup:
    """
    –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –≤—ã–±–æ—Ä–æ–º –≤—Ä–µ–º–µ–Ω–∏ (—á–∞—Å–æ–≤) –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏
    """
    builder = InlineKeyboardBuilder()
    now = get_now_msk()
    
    # –ó–∞–≥–æ–ª–æ–≤–æ–∫
    builder.button(text=f"–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è ({day}.{month}.{year})", callback_data="admin_ignore")
    
    # –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω "—Å–µ–≥–æ–¥–Ω—è", –±–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ—à–µ–¥—à–∏–µ —á–∞—Å—ã
    is_today = (year == now.year and month == now.month and day == now.day)
    current_hour = now.hour
    
    # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞—Å–∞
    for h in range(0, 24):
        if is_today and h < current_hour:
            # –ü—Ä–æ—à–µ–¥—à–∏–µ —á–∞—Å—ã –±–ª–æ–∫–∏—Ä—É–µ–º
            builder.button(text="‚Ä¢", callback_data="admin_ignore")
        elif is_today and h == current_hour:
            # –¢–µ–∫—É—â–∏–π —á–∞—Å —Ç–∞–∫–∂–µ –±–ª–æ–∫–∏—Ä—É–µ–º, —Ç–∞–∫ –∫–∞–∫ –≤—Ä–µ–º—è —É–∂–µ –ø—Ä–æ—à–ª–æ
            builder.button(text="‚Ä¢", callback_data="admin_ignore")
        else:
            builder.button(text=f"{h:02d}:00", callback_data=f"admin_broadcast_time_set:{year}:{month}:{day}:{h}:00")
    
    builder.adjust(4)  # 4 –∫–Ω–æ–ø–∫–∏ –≤ —Ä—è–¥
    
    # –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    builder.row(
        InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥ –∫ –¥–∞—Ç–µ", callback_data=f"admin_broadcast_cal_nav:{year}:{month}"),
        InlineKeyboardButton(text="‚è± –í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é", callback_data="admin_broadcast_manual_time")
    )
    
    builder.row(InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="admin_broadcast"))
    
    return builder.as_markup()


def get_manual_time_input_keyboard() -> InlineKeyboardMarkup:
    """
    –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –≤–≤–µ—Å—Ç–∏ –≤—Ä–µ–º—è –≤—Ä—É—á–Ω—É—é
    """
    builder = InlineKeyboardBuilder()
    
    builder.row(
        InlineKeyboardButton(
            text="‚è± –í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é",
            callback_data="admin_broadcast_manual_time_input"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="‚ùå –û—Ç–º–µ–Ω–∞",
            callback_data="admin_broadcast"
        )
    )
    
    return builder.as_markup()
=== ./keyboards/inline/calendar_kb.py ===
import calendar
from datetime import datetime
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder
from core.tools.timezone import get_now_msk

MONTHS = ["", "–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"]

def generate_calendar(year: int, month: int) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    now = get_now_msk()

    builder.button(text=f"{MONTHS[month]} {year}", callback_data="ignore")
    days = ["–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±", "–í—Å"]
    for d in days:
        builder.button(text=d, callback_data="ignore")

    cal = calendar.monthcalendar(year, month)
    for week in cal:
        for day in week:
            if day == 0:
                builder.button(text=" ", callback_data="ignore")
                continue
            
            # –õ–æ–≥–∏–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–æ—à–ª–æ–≥–æ
            is_past = False
            if year < now.year: is_past = True
            elif year == now.year and month < now.month: is_past = True
            elif year == now.year and month == now.month and day < now.day: is_past = True
            
            if is_past:
                # –í–º–µ—Å—Ç–æ —Ü–∏—Ñ—Ä—ã —Å—Ç–∞–≤–∏–º –ø—Ä–æ—á–µ—Ä–∫ –∏–ª–∏ –∫—Ä–µ—Å—Ç–∏–∫
                builder.button(text="‚úñÔ∏è", callback_data="ignore")
            else:
                builder.button(text=str(day), callback_data=f"date_set:{year}:{month}:{day}")

    builder.adjust(1, 7, 7, 7, 7, 7, 7)
    
    # –ù–∞–≤–∏–≥–∞—Ü–∏—è (–Ω–µ –¥–∞–µ–º —É–π—Ç–∏ –¥–∞–ª–µ–∫–æ –≤ –ø—Ä–æ—à–ª–æ–µ)
    prev_m = month - 1 if month > 1 else 12
    prev_y = year if month > 1 else year - 1
    next_m = month + 1 if month < 12 else 1
    next_y = year if month < 12 else year + 1
    
    can_go_back = not (prev_y < now.year or (prev_y == now.year and prev_m < now.month))
    
    nav_row = []
    if can_go_back:
        builder.button(text="‚¨ÖÔ∏è", callback_data=f"cal_nav:{prev_y}:{prev_m}")
    else:
        builder.button(text=" ", callback_data="ignore") # –ü—É—Å—Ç—ã—à–∫–∞ –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è
        
    builder.button(text="‚û°Ô∏è", callback_data=f"cal_nav:{next_y}:{next_m}")
    
    builder.button(text="üîô –ù–∞–∑–∞–¥", callback_data="constr_back_main")
    
    # –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä—è–¥: –ù–∞–≤–∏–≥–∞—Ü–∏—è + –ù–∞–∑–∞–¥
    builder.adjust(1, 7, 7, 7, 7, 7, 7, 2, 1)
    return builder.as_markup()

def time_picker_kb(year, month, day) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    now = get_now_msk()
    
    # –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω "—Å–µ–≥–æ–¥–Ω—è", –±–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ—à–µ–¥—à–∏–µ —á–∞—Å—ã
    is_today = (year == now.year and month == now.month and day == now.day)
    current_hour = now.hour
    
    for h in range(0, 24):
        if is_today and h <= current_hour:
            # –ü—Ä–æ—à–µ–¥—à–∏–µ —á–∞—Å—ã –ø–æ–º–µ—á–∞–µ–º —Ç–æ—á–∫–æ–π –∏–ª–∏ —É–¥–∞–ª—è–µ–º
            builder.button(text="‚Ä¢", callback_data="ignore")
        else:
            builder.button(text=f"{h:02d}:00", callback_data=f"time_set:{year}:{month}:{day}:{h}:00")
        
    builder.adjust(4)
    builder.row(InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥ –∫ –¥–∞—Ç–µ", callback_data=f"cal_nav:{year}:{month}"))
    return builder.as_markup()=== ./keyboards/inline/user_panel.py ===
from aiogram.utils.keyboard import InlineKeyboardBuilder
from database.models.giveaway import Giveaway

from keyboards.builder import KeyboardBuilder, ButtonType


def giveaways_hub_kb(has_created: bool, active_count: int, finished_count: int) -> InlineKeyboardBuilder:
    builder = KeyboardBuilder()
    
    # –†–∞–∑–¥–µ–ª —É—á–∞—Å—Ç–Ω–∏–∫–∞ (–°—á–µ—Ç—á–∏–∫–∏!)
    builder.add_button(text=f"‚è≥ –£—á–∞—Å—Ç–≤—É—é ({active_count})", button_type=ButtonType.CALLBACK, data="part_list:active:0")
    builder.add_button(text=f"üèÅ –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ ({finished_count})", button_type=ButtonType.CALLBACK, data="part_list:finished:0")
    
    # –†–∞–∑–¥–µ–ª —Å–æ–∑–¥–∞—Ç–µ–ª—è
    if has_created:
        builder.add_button(text="üìÇ –ú–æ–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–∏ (–°–æ–∑–¥–∞–Ω–Ω—ã–µ)", button_type=ButtonType.CALLBACK, data="created_list:0")
        
    builder.add_button(text="üîô –ù–∞–∑–∞–¥", button_type=ButtonType.CALLBACK, data="dashboard_home")
    return builder.adjust(1).build()


def universal_list_kb(
    giveaways: list[Giveaway],
    page: int,
    total_pages: int,
    prefix: str,
    won_ids: set[int] = None
) -> InlineKeyboardBuilder:
    """
    –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫.
    """
    builder = KeyboardBuilder()
    won_ids = won_ids or set()
    
    for gw in giveaways:
        # –í—ã–±–∏—Ä–∞–µ–º –∏–∫–æ–Ω–∫—É
        if "created" in prefix:
            icon = "üì¢"
        elif gw.status == 'active':
            icon = "‚è≥"
        else:
            if gw.id in won_ids:
                icon = "üèÜ"
            else:
                icon = "‚ùå"
        
        btn_text = f"{icon} {gw.prize_text[:20]}..."
        
        action = "view_created" if "created" in prefix else "part_view"
        builder.add_button(text=btn_text, button_type=ButtonType.CALLBACK, data=f"{action}:{gw.id}")

    # –ü–∞–≥–∏–Ω–∞—Ü–∏—è
    nav_buttons = []
    if page > 0:
        nav_buttons.append(("‚¨ÖÔ∏è", f"{prefix}:{page-1}"))
    
    nav_buttons.append((f"{page+1}/{total_pages}", "ignore"))
    
    if page < total_pages - 1:
        nav_buttons.append(("‚û°Ô∏è", f"{prefix}:{page+1}"))
    
    for text, data in nav_buttons:
        builder.add_button(text=text, button_type=ButtonType.CALLBACK, data=data)
    
    builder.add_button(text="üîô –ù–∞–∑–∞–¥", button_type=ButtonType.CALLBACK, data="giveaways_hub")
    
    sizes = [1] * len(giveaways) + [len(nav_buttons)] + [1]
    return builder.adjust(*sizes).build()


def participation_details_kb(channel_link: str) -> InlineKeyboardBuilder:
    builder = KeyboardBuilder()
    if channel_link:
        builder.add_button(text="‚ÜóÔ∏è –ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ—Å—Ç—É", button_type=ButtonType.URL, url=channel_link)
    builder.add_button(text="üîô –ù–∞–∑–∞–¥", button_type=ButtonType.CALLBACK, data="giveaways_hub")
    return builder.adjust(1).build()


def detail_back_kb() -> InlineKeyboardBuilder:
    builder = KeyboardBuilder()
    builder.add_button(text="üîô –ù–∞–∑–∞–¥", button_type=ButtonType.CALLBACK, data="giveaways_hub")
    return builder.build()=== ./keyboards/inline/participation.py ===
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder

from keyboards.builder import KeyboardBuilder, ButtonType


def join_keyboard(bot_username: str, giveaway_id: int) -> InlineKeyboardMarkup:
    """–ö–Ω–æ–ø–∫–∞ –ø–æ–¥ –ø–æ—Å—Ç–æ–º –≤ –∫–∞–Ω–∞–ª–µ"""
    url = f"https://t.me/{bot_username}?start=gw_{giveaway_id}"
    return KeyboardBuilder() \
        .add_button("–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å üéÅ", ButtonType.URL, url=url) \
        .build()


def check_subscription_kb(gw_id: int, channels_status: list) -> InlineKeyboardMarkup:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å–æ —Å–ø–∏—Å–∫–æ–º –∫–∞–Ω–∞–ª–æ–≤.
    channels_status: —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π {'title': str, 'link': str, 'is_subscribed': bool}
    """
    builder = KeyboardBuilder()
    
    for ch in channels_status:
        if ch['is_subscribed']:
            # –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∞–Ω - —Å—Ç–∞–≤–∏–º –≥–∞–ª–æ—á–∫—É
            text = f"‚úÖ {ch['title']}"
        else:
            # –ï—Å–ª–∏ –Ω–µ—Ç - —Å—Ç–∞–≤–∏–º —Ä—É–ø–æ—Ä
            text = f"üì¢ {ch['title']}"
            
        # –°—Å—ã–ª–∫–∞ –Ω—É–∂–Ω–∞ –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
        builder.add_button(text, ButtonType.URL, url=ch['link'])
    
    # –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏
    builder.add_button("üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏", ButtonType.CALLBACK, f"check_sub:{gw_id}")
    
    return builder.adjust(1).build()


def results_keyboard(bot_username: str, giveaway_id: int) -> InlineKeyboardMarkup:
    url = f"https://t.me/{bot_username}?start=res_{giveaway_id}"
    return KeyboardBuilder() \
        .add_button("üìã –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã", ButtonType.URL, url=url) \
        .build()=== ./keyboards/inline/dashboard.py ===
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder
from database.models.channel import Channel
from database.models.giveaway import Giveaway

# --- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ (/start) ---
def start_menu_kb() -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    # –ë–´–õ–û: "üé´ –ú–æ–∏ —É—á–∞—Å—Ç–∏—è" -> –°–¢–ê–õ–û: "üéÅ –†–æ–∑—ã–≥—Ä—ã—à–∏"
    builder.button(text="üéÅ –†–æ–∑—ã–≥—Ä—ã—à–∏", callback_data="my_participations")
    builder.button(text="‚ú® –°–æ–∑–¥–∞—Ç—å —Ä–æ–∑—ã–≥—Ä—ã—à", callback_data="create_gw_init")
    builder.button(text="üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç", callback_data="cabinet_hub")
    builder.adjust(1)
    return builder.as_markup()

# --- –õ–ò–ß–ù–´–ô –ö–ê–ë–ò–ù–ï–¢ ---
def cabinet_kb() -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    builder.button(text="‚öôÔ∏è –ú–æ–∏ –∫–∞–Ω–∞–ª—ã", callback_data="my_channels")
    builder.button(text="üìÇ –ò—Å—Ç–æ—Ä–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π", callback_data="my_giveaways_hub")
    builder.button(text="üß© –ü–ª–∞—Ç–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏", callback_data="premium_shop")
    builder.button(text="üîô –ù–∞–∑–∞–¥", callback_data="dashboard_home")
    builder.adjust(1)
    return builder.as_markup()

# --- –ú–ï–ù–Æ –†–û–ó–´–ì–†–´–®–ï–ô (HUB –û–†–ì–ê–ù–ò–ó–ê–¢–û–†–ê) ---
def my_giveaways_hub_kb(active_count: int, finished_count: int) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    builder.button(text=f"–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ ({active_count})", callback_data="gw_list:active")
    builder.button(text=f"–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ ({finished_count})", callback_data="gw_list:finished")
    builder.button(text="üîô –ù–∞–∑–∞–¥", callback_data="cabinet_hub")
    builder.adjust(1)
    return builder.as_markup()

# --- –°–ü–ò–°–û–ö –†–û–ó–´–ì–†–´–®–ï–ô ---
def giveaways_list_kb(giveaways: list[Giveaway], status: str) -> InlineKeyboardBuilder:
    builder = InlineKeyboardBuilder()
    
    for gw in giveaways:
        icon = "üü¢" if status == "active" else "‚ö´Ô∏è"
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º short_description –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ, –∏–Ω–∞—á–µ –ø–µ—Ä–≤—ã–µ 25 —Å–∏–º–≤–æ–ª–æ–≤ prize_text
        name = (gw.short_description or gw.prize_text)[:25].replace("\n", " ")
        builder.button(text=f"{icon} {name}...", callback_data=f"gw_manage:{gw.id}")
    
    builder.button(text="üîô –ù–∞–∑–∞–¥", callback_data="my_giveaways_hub")
    builder.adjust(1)
    return builder.as_markup()

# --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ê–ö–¢–ò–í–ù–´–ú ---
def active_gw_manage_kb(gw_id: int) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    builder.button(text="üîÑ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è", callback_data=f"gw_act:repost:{gw_id}")
    builder.button(text="üìä –°–∫–∞—á–∞—Ç—å –±–∞–∑—É (CSV)", callback_data=f"gw_act:export:{gw_id}")
    builder.button(text="ÔøΩ –ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–æ—Å—Ä–æ—á–Ω–æ", callback_data=f"gw_act:finish:{gw_id}")
    builder.button(text="üóë –£–¥–∞–ª–∏—Ç—å", callback_data=f"gw_act:delete:{gw_id}")
    builder.button(text="üîô –ù–∞–∑–∞–¥", callback_data="gw_list:active")
    builder.adjust(1)
    return builder.as_markup()

# --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–ù–´–ú ---
def finished_gw_manage_kb(gw_id: int, results_link: str = None) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    if results_link:
        builder.button(text="üîó –ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ—Å—Ç—É", url=results_link)
    builder.button(text="üóë –£–¥–∞–ª–∏—Ç—å –∏–∑ –±–∞–∑—ã", callback_data=f"gw_act:delete:{gw_id}")
    builder.button(text="üîô –ù–∞–∑–∞–¥", callback_data="gw_list:finished")
    builder.adjust(1)
    return builder.as_markup()

# --- –ú–ê–ì–ê–ó–ò–ù (PREMIUM) ---
def premium_shop_kb(is_premium: bool) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    if is_premium:
        builder.button(text="‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞", callback_data="premium_info")
        # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–¥–ª–∏—Ç—å"
    else:
        # –¶–µ–Ω–∞ –≤ –∑–≤–µ–∑–¥–∞—Ö (XTR)
        builder.button(text="üíé –ö—É–ø–∏—Ç—å Premium (250 ‚≠êÔ∏è)", callback_data="buy_premium_sub")
    
    builder.button(text="üîô –ù–∞–∑–∞–¥", callback_data="cabinet_hub")
    builder.adjust(1)
    return builder.as_markup()

# --- –ö–ê–ù–ê–õ–´ ---
def channels_list_kb(channels: list[Channel]) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    for ch in channels:
        builder.button(text=f"üóë {ch.title}", callback_data=f"del_ch_{ch.id}")
    builder.button(text="‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–∞–ª", callback_data="add_new_channel")
    builder.button(text="üîô –ù–∞–∑–∞–¥", callback_data="cabinet_hub")
    builder.adjust(1)
    return builder.as_markup()

def back_to_dash() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="cabinet_hub")]
    ])

def skip_link_kb(mode="settings") -> InlineKeyboardMarkup:
    callback = "skip_link_settings" if mode == "settings" else "skip_link_constr"
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚è© –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å", callback_data=callback)]
    ])=== ./keyboards/inline/constructor.py ===
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder
from database.models.channel import Channel

def constructor_main_kb(
    time_str: str, winners: int,
    ref_req: int, # –ï—Å–ª–∏ 0 - –≤—ã–∫–ª, –∏–Ω–∞—á–µ –∫–æ–ª-–≤–æ –¥—Ä—É–∑–µ–π
    is_captcha: bool, has_main_channel: bool, sponsors_count: int, is_participants_hidden: bool = False
) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    main_text = "üì¢ –ö–∞–Ω–∞–ª/–ß–∞—Ç: –í—ã–±—Ä–∞—Ç—å" if not has_main_channel else "üì¢ –ö–∞–Ω–∞–ª/–ß–∞—Ç: ‚úÖ –í—ã–±—Ä–∞–Ω"
    sponsor_text = f"ü§ù –°–ø–æ–Ω—Å–æ—Ä—ã: {sponsors_count}" if sponsors_count > 0 else "ü§ù –°–ø–æ–Ω—Å–æ—Ä—ã: –ù–µ—Ç"
    builder.button(text=main_text, callback_data="constr_select_main")
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ø–æ–Ω—Å–æ—Ä–æ–≤ —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –ø—Ä–µ–º–∏—É–º-—Ñ—É–Ω–∫—Ü–∏–∏
    if sponsors_count > 5:
        sponsor_text = f"ü§ù –°–ø–æ–Ω—Å–æ—Ä—ã: {sponsors_count} üåü"
    elif sponsors_count > 0:
        sponsor_text = f"ü§ù –°–ø–æ–Ω—Å–æ—Ä—ã: {sponsors_count}"
    else:
        sponsor_text = "ü§ù –°–ø–æ–Ω—Å–æ—Ä—ã: –ù–µ—Ç"
    builder.button(text=sponsor_text, callback_data="constr_select_sponsors")
    
    builder.button(text=f"‚è≥ –ò—Ç–æ–≥–∏: {time_str}", callback_data="constr_time_menu")
    builder.button(text=f"üèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª–∏: {winners}", callback_data="constr_winners_menu")
    
    ref_text = f"üîó –†–µ—Ñ: {ref_req} –¥—Ä—É–∑–µ(–π)" if ref_req > 0 else "üîó –†–µ—Ñ: –í—ã–∫–ª"
    builder.button(text=ref_text, callback_data="constr_ref_menu")
    
    cap_status = "–í–ö–õ" if is_captcha else "–í—ã–∫–ª"
    builder.button(text=f"üõ° –ö–∞–ø—á–∞: {cap_status}", callback_data="constr_toggle_cap")
    
    hidden_participants_status = "–í–ö–õ" if is_participants_hidden else "–í—ã–∫–ª"
    builder.button(text=f"üïµÔ∏è –°–∫—Ä—ã—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: {hidden_participants_status}", callback_data="constr_toggle_hidden_participants")
    
    builder.button(text="‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –¢–µ–∫—Å—Ç/–ú–µ–¥–∏–∞", callback_data="constr_edit_content")
    builder.button(text="‚úÖ –û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨", callback_data="constr_publish")
    
    # –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê –û–¢–ú–ï–ù–´
    builder.button(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_creation")
    
    # –°–µ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫: 2, 2, 2, 1, 1, 1, 1
    builder.adjust(2, 2, 2, 1, 1, 1, 1)
    return builder.as_markup()

def winners_selector_kb() -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    # –ö–Ω–æ–ø–∫–∏ —Å –ø–æ–ø—É–ª—è—Ä–Ω—ã–º–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞–º–∏
    popular_values = [1, 2, 3, 5, 10, 20, 50]
    for w in popular_values:
        builder.button(text=f"üèÜ {w}", callback_data=f"constr_set_winners:{w}")
    
    # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –≤–≤–æ–¥–∞ –≤—Ä—É—á–Ω—É—é
    builder.button(text="‚úèÔ∏è –í–≤–µ—Å—Ç–∏ —á–∏—Å–ª–æ", callback_data="constr_set_winners_input")
    builder.button(text="üîô –ù–∞–∑–∞–¥", callback_data="constr_back_main")
    
    # –°–µ—Ç–∫–∞: 4 –≤ —Ä—è–¥—É, –∑–∞—Ç–µ–º 1
    builder.adjust(4, 4, 1)
    return builder.as_markup()

def referral_selector_kb() -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    options = [(0, "–í—ã–∫–ª"), (1, "1 –¥—Ä—É–≥"), (3, "3 –¥—Ä—É–≥–∞"), (5, "5 –¥—Ä—É–∑–µ–π")]
    for val, label in options:
        builder.button(text=label, callback_data=f"constr_set_ref:{val}")
    
    # –î–æ–±–∞–≤–∏–º –∫–Ω–æ–ø–∫—É –¥–ª—è –≤–≤–æ–¥–∞ –≤—Ä—É—á–Ω—É—é
    builder.button(text="‚úèÔ∏è –í–≤–µ—Å—Ç–∏ —á–∏—Å–ª–æ", callback_data="constr_set_ref_input")
    builder.button(text="üîô –ù–∞–∑–∞–¥", callback_data="constr_back_main")
    
    builder.adjust(2, 2, 1)
    return builder.as_markup()

def channel_selection_kb(channels: list[Channel], mode: str, selected_ids: list[int]) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    # –ö–Ω–æ–ø–∫–∏ –∫–∞–Ω–∞–ª–æ–≤
    for ch in channels:
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∫–æ–Ω–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —á–∞—Ç–∞
        icon = "‚úÖ" if mode == "main" and ch.channel_id in selected_ids else ("‚òëÔ∏è" if ch.channel_id in selected_ids else "‚¨ú")
        chat_icon = "üì¢" if ch.type == 'channel' else "üí¨"
        cb = f"constr_set_ch:{mode}:{ch.channel_id}"
        builder.button(text=f"{icon} {chat_icon} {ch.title}", callback_data=cb)
    
    # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    builder.button(text="‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∫–∞–Ω–∞–ª", callback_data="add_new_channel_constr")
    builder.button(text="üíæ –ì–æ—Ç–æ–≤–æ (–°–æ—Ö—Ä–∞–Ω–∏—Ç—å)", callback_data="constr_back_main")
    
    builder.adjust(1)
    return builder.as_markup()=== ./keyboards/admin_users_keyboards.py ===
from aiogram.types import InlineKeyboardMarkup
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.types import InlineKeyboardButton


def get_users_menu_keyboard() -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    builder.row(
        InlineKeyboardButton(
            text="üîç –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
            callback_data="admin_search_user"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="üìã –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",
            callback_data="admin_list_users_1"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥",
            callback_data="admin_main_menu"
        )
    )
    
    return builder.as_markup()


def get_user_search_results_keyboard(users: list) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    for user in users:
        premium_status = "üíé" if user.is_premium else "üë§"
        builder.row(
            InlineKeyboardButton(
                text=f"{premium_status} [{user.user_id}] @{user.username or '–±–µ–∑_–Ω–∏–∫–∞'}",
                callback_data=f"admin_user_detail_{user.user_id}"
            )
        )
    
    builder.row(
        InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º",
            callback_data="admin_users"
        )
    )
    
    return builder.as_markup()


def get_user_detail_menu_keyboard(user_id: int) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    builder.row(
        InlineKeyboardButton(
            text="‚≠ê –í—ã–¥–∞—Ç—å –ø—Ä–µ–º–∏—É–º",
            callback_data=f"admin_grant_premium_{user_id}"
        ),
        InlineKeyboardButton(
            text="‚ùå –ó–∞–±—Ä–∞—Ç—å –ø—Ä–µ–º–∏—É–º",
            callback_data=f"admin_revoke_premium_{user_id}"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="üìã –†–æ–∑—ã–≥—Ä—ã—à–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
            callback_data=f"admin_user_giveaways_{user_id}_1"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º",
            callback_data="admin_users"
        )
    )
    
    return builder.as_markup()


def get_confirm_premium_action_keyboard(user_id: int, action: str) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(
            text="‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å",
            callback_data=f"admin_confirm_premium_{action}_{user_id}"
        ),
        InlineKeyboardButton(
            text="‚ùå –û—Ç–º–µ–Ω–∞",
            callback_data=f"admin_user_detail_{user_id}"
        )
    )
    return builder.as_markup()


def get_back_to_users_menu_keyboard() -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º",
            callback_data="admin_users"
        )
    )
    return builder.as_markup()


def get_users_pagination_keyboard(current_page: int, total_count: int, page_size: int = 10) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    total_pages = (total_count + page_size - 1) // page_size
    
    if current_page > 1:
        builder.button(
            text="‚è™ –ù–∞–∑–∞–¥",
            callback_data=f"admin_list_users_{current_page - 1}"
        )
    
    builder.button(
        text=f"{current_page}/{total_pages}",
        callback_data="admin_ignore"  # –ó–∞–≥–ª—É—à–∫–∞, –ø—Ä–æ—Å—Ç–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    )
    
    if current_page < total_pages:
        builder.button(
            text="–í–ø–µ—Ä–µ–¥ ‚è©",
            callback_data=f"admin_list_users_{current_page + 1}"
        )
    
    builder.adjust(3)  # –†–∞—Å–ø–æ–ª–∞–≥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
    
    # –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥ –∫ –º–µ–Ω—é"
    builder.row(
        InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º",
            callback_data="admin_users"
        )
    )
    
    return builder.as_markup()


def get_cancel_search_keyboard() -> InlineKeyboardMarkup:
    """
    –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π –æ—Ç–º–µ–Ω—ã –ø–æ–∏—Å–∫–∞
    """
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(
            text="‚ùå –û—Ç–º–µ–Ω–∞",
            callback_data="admin_main_menu"
        )
    )
    return builder.as_markup()=== ./keyboards/admin_stats_keyboards.py ===
from aiogram.types import InlineKeyboardMarkup
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.types import InlineKeyboardButton


def get_stats_menu_keyboard() -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    builder.row(
        InlineKeyboardButton(
            text="üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
            callback_data="admin_general_stats"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="üìà –†–æ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",
            callback_data="admin_user_growth"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="‚≠ê –ü—Ä–µ–º–∏—É–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
            callback_data="admin_premium_stats"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="üéÆ –†–æ–∑—ã–≥—Ä—ã—à–∏",
            callback_data="admin_giveaway_stats"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="üéØ –£—á–∞—Å—Ç–∏—è",
            callback_data="admin_participation_stats"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥",
            callback_data="admin_main_menu"
        )
    )
    
    return builder.as_markup()


def get_back_to_stats_menu_keyboard() -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ",
            callback_data="admin_stats"
        )
    )
    return builder.as_markup()


def get_stats_filter_keyboard() -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    builder.row(
        InlineKeyboardButton(
            text="–î–µ–Ω—å",
            callback_data="admin_general_stats_today"
        ),
        InlineKeyboardButton(
            text="–ù–µ–¥–µ–ª—è",
            callback_data="admin_general_stats_week"
        ),
        InlineKeyboardButton(
            text="–ú–µ—Å—è—Ü",
            callback_data="admin_general_stats_month"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥",
            callback_data="admin_general_stats"
        )
    )
    
    return builder.as_markup()=== ./keyboards/admin_broadcast_keyboards.py ===
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder

def get_broadcast_menu_keyboard() -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    builder.row(
        InlineKeyboardButton(text="‚úçÔ∏è –°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É", callback_data="admin_create_broadcast")
    )
    builder.row(
        InlineKeyboardButton(text="üìù –ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫", callback_data="admin_broadcast_history_1")
    )
    builder.row(
        InlineKeyboardButton(text="‚è± –û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ —Ä–∞—Å—Å—ã–ª–∫–∏", callback_data="admin_scheduled_broadcasts_1")
    )
    
    builder.row(InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="admin_main_menu"))
    return builder.as_markup()


def get_broadcast_preview_keyboard() -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(text="üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–µ–π—á–∞—Å", callback_data="admin_send_broadcast_now"),
        InlineKeyboardButton(text="‚è∞ –û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞", callback_data="admin_schedule_broadcast")
    )
    builder.row(InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="admin_broadcast"))
    return builder.as_markup()


def get_cancel_broadcast_creation_keyboard() -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="admin_broadcast"))
    return builder.as_markup()


def get_cancel_schedule_keyboard() -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="admin_broadcast"))
    return builder.as_markup()


# --- –°–ü–ò–°–ö–ò (–ò–°–¢–û–†–ò–Ø –ò –û–¢–õ–û–ñ–ï–ù–ù–´–ï) ---

def get_broadcast_list_keyboard(broadcasts: list, current_page: int, total_count: int, page_size: int, is_scheduled: bool) -> InlineKeyboardMarkup:
    """
    –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —Å–ø–∏—Å–∫–∞ —Ä–∞—Å—Å—ã–ª–æ–∫ (–∫–Ω–æ–ø–∫–∏ –≤–º–µ—Å—Ç–æ —Ç–µ–∫—Å—Ç–∞).
    is_scheduled: True –¥–ª—è –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö, False –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏.
    """
    builder = InlineKeyboardBuilder()
    
    # –ü—Ä–µ—Ñ–∏–∫—Å –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–µ—Ç–∞–ª–µ–π
    nav_prefix = "admin_scheduled_broadcasts" if is_scheduled else "admin_broadcast_history"
    detail_prefix = "admin_scheduled_detail" if is_scheduled else "admin_broadcast_detail"
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏
    for bc in broadcasts:
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏: –î–∞—Ç–∞ + –ù–∞—á–∞–ª–æ —Ç–µ–∫—Å—Ç–∞
        dt_source = bc.scheduled_time if is_scheduled else bc.created_at
        dt_str = dt_source.strftime('%d.%m %H:%M') if dt_source else "???"
        
        text_preview = bc.message_text[:20] + "..." if bc.message_text else "[–ú–µ–¥–∏–∞]"
        status_icon = "‚è≥" if is_scheduled else ("‚úÖ" if bc.status == 'completed' else "üìù")
        
        btn_text = f"{status_icon} {dt_str} | {text_preview}"
        builder.row(InlineKeyboardButton(text=btn_text, callback_data=f"{detail_prefix}_{bc.id}"))

    # –ü–∞–≥–∏–Ω–∞—Ü–∏—è
    total_pages = (total_count + page_size - 1) // page_size
    pagination_row = []
    
    if current_page > 1:
        pagination_row.append(InlineKeyboardButton(text="‚¨ÖÔ∏è", callback_data=f"{nav_prefix}_{current_page - 1}"))
    
    pagination_row.append(InlineKeyboardButton(text=f"{current_page}/{total_pages or 1}", callback_data="admin_ignore"))
    
    if current_page < total_pages:
        pagination_row.append(InlineKeyboardButton(text="‚û°Ô∏è", callback_data=f"{nav_prefix}_{current_page + 1}"))
    
    if pagination_row:
        builder.row(*pagination_row)
    
    # –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥
    builder.row(InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ –º–µ–Ω—é", callback_data="admin_broadcast"))
    
    return builder.as_markup()


# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –æ–±–µ—Ä—Ç–∫–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
def get_broadcast_history_pagination_keyboard(current_page: int, total_count: int, page_size: int = 10) -> InlineKeyboardMarkup:
    return get_broadcast_list_keyboard([], current_page, total_count, page_size, False)

def get_scheduled_broadcasts_pagination_keyboard(current_page: int, total_count: int, page_size: int = 10) -> InlineKeyboardMarkup:
    return get_broadcast_list_keyboard([], current_page, total_count, page_size, True)


# --- –î–ï–¢–ê–õ–¨–ù–´–ô –ü–†–û–°–ú–û–¢–† ---

def get_broadcast_detail_keyboard(broadcast_id: int) -> InlineKeyboardMarkup:
    """–î–ª—è –∏—Å—Ç–æ—Ä–∏–∏ (–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ)"""
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(text="üîÑ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ", callback_data=f"admin_resend_broadcast_{broadcast_id}")
    )
    builder.row(
        InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É", callback_data="admin_broadcast_history_1")
    )
    return builder.as_markup()


def get_scheduled_detail_keyboard(broadcast_id: int) -> InlineKeyboardMarkup:
    """–î–ª—è –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö (–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Ä–∞–∑—É)"""
    builder = InlineKeyboardBuilder()
    
    # –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å
    builder.row(
        InlineKeyboardButton(text="üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–µ–π—á–∞—Å", callback_data=f"admin_force_send_scheduled_{broadcast_id}")
    )
    
    # –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
    builder.row(
        InlineKeyboardButton(text="üóë –£–¥–∞–ª–∏—Ç—å/–û—Ç–º–µ–Ω–∏—Ç—å", callback_data=f"admin_delete_scheduled_{broadcast_id}")
    )
    
    # –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥
    builder.row(
        InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É", callback_data="admin_scheduled_broadcasts_1")
    )
    return builder.as_markup()=== ./keyboards/admin_giveaways_keyboards.py ===
from aiogram.types import InlineKeyboardMarkup
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.types import InlineKeyboardButton


def get_giveaways_menu_keyboard() -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    builder.row(
        InlineKeyboardButton(
            text="üîç –ü–æ–∏—Å–∫ —Ä–æ–∑—ã–≥—Ä—ã—à–∞",
            callback_data="admin_search_giveaway"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="üìã –°–ø–∏—Å–æ–∫ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π",
            callback_data="admin_list_giveaways_1"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥",
            callback_data="admin_main_menu"
        )
    )
    
    return builder.as_markup()


def get_giveaway_search_results_keyboard(giveaways: list) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    for giveaway in giveaways:
        status_emoji = "üü¢" if giveaway.status == "active" else "üî¥"
        builder.row(
            InlineKeyboardButton(
                text=f"{status_emoji} [{giveaway.id}] \"{giveaway.prize_text}\" - {giveaway.owner_id}",
                callback_data=f"admin_giveaway_detail_{giveaway.id}"
            )
        )
    
    builder.row(
        InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ —Ä–æ–∑—ã–≥—Ä—ã—à–∞–º",
            callback_data="admin_giveaways"
        )
    )
    
    return builder.as_markup()


def get_giveaway_detail_menu_keyboard(giveaway_id: int) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    builder.row(
        InlineKeyboardButton(
            text="üé≤ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å",
            callback_data=f"admin_force_finish_{giveaway_id}"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="üèÜ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ–±–µ–¥–∏—Ç–µ–ª—å",
            callback_data=f"admin_set_winner_{giveaway_id}"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="üë• –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤",
            callback_data=f"admin_giveaway_participants_{giveaway_id}_1"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ —Ä–æ–∑—ã–≥—Ä—ã—à–∞–º",
            callback_data="admin_giveaways"
        )
    )
    
    return builder.as_markup()


def get_confirm_giveaway_action_keyboard(giveaway_id: int, action: str) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(
            text="‚úÖ –î–∞",
            callback_data=f"admin_confirm_giveaway_{action}_{giveaway_id}"
        ),
        InlineKeyboardButton(
            text="‚ùå –ù–µ—Ç",
            callback_data="admin_giveaways"
        )
    )
    return builder.as_markup()


def get_giveaways_pagination_keyboard(current_page: int, total_count: int, page_size: int = 10) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    total_pages = (total_count + page_size - 1) // page_size
    
    if current_page > 1:
        builder.button(
            text="‚è™ –ù–∞–∑–∞–¥",
            callback_data=f"admin_list_giveaways_{current_page - 1}"
        )
    
    builder.button(
        text=f"{current_page}/{total_pages}",
        callback_data="admin_ignore"
    )
    
    if current_page < total_pages:
        builder.button(
            text="–í–ø–µ—Ä–µ–¥ ‚è©",
            callback_data=f"admin_list_giveaways_{current_page + 1}"
        )
    
    builder.adjust(3)
    
    # –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥ –∫ –º–µ–Ω—é"
    builder.row(
        InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ —Ä–æ–∑—ã–≥—Ä—ã—à–∞–º",
            callback_data="admin_giveaways"
        )
    )
    
    return builder.as_markup()


def get_cancel_search_keyboard() -> InlineKeyboardMarkup:
    """
    –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π –æ—Ç–º–µ–Ω—ã –ø–æ–∏—Å–∫–∞
    """
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(
            text="‚ùå –û—Ç–º–µ–Ω–∞",
            callback_data="admin_main_menu"
        )
    )
    return builder.as_markup()=== ./keyboards/__init__.py ===
from .callback_data import *
from .builder import *
from .builders import *
from .admin_keyboards import *
from .admin_stats_keyboards import *
from .admin_users_keyboards import *
from .admin_giveaways_keyboards import *
from .admin_broadcast_keyboards import *

__all__ = [
    # callback_data
    'GiveawayAction',
    'JoinAction',
    'GiveawaysAction',
    'GiveawaysPagination',
    'BaseNavigationAction',
    'UserMenuAction',
    'UserListAction',
    'PaginationAction',
    
    # builder
    'KeyboardBuilder',
    'StandardKeyboards',
    'ButtonType',
    
    # builders
    'simple_menu',
    
    # admin keyboards
    'get_main_admin_menu_keyboard',
    'get_back_to_main_menu_keyboard',
    'get_cancel_search_keyboard',
    'get_cancel_broadcast_creation_keyboard',
    'get_cancel_schedule_keyboard',
    # admin stats keyboards
    'get_stats_menu_keyboard',
    'get_back_to_stats_menu_keyboard',
    'get_stats_filter_keyboard',
    # admin users keyboards
    'get_users_menu_keyboard',
    'get_user_search_results_keyboard',
    'get_user_detail_menu_keyboard',
    'get_confirm_premium_action_keyboard',
    'get_back_to_users_menu_keyboard',
    'get_users_pagination_keyboard',
    # admin giveaways keyboards
    'get_giveaways_menu_keyboard',
    'get_giveaway_search_results_keyboard',
    'get_giveaway_detail_menu_keyboard',
    'get_confirm_giveaway_action_keyboard',
    'get_giveaways_pagination_keyboard',
    # admin broadcast keyboards
    'get_broadcast_menu_keyboard',
    'get_broadcast_preview_keyboard',
    'get_broadcast_history_pagination_keyboard',
    'get_broadcast_detail_actions_keyboard',
    'get_scheduled_broadcasts_pagination_keyboard'
]=== ./keyboards/builder.py ===
from enum import Enum
from typing import Optional, List, Union
from aiogram.types import InlineKeyboardButton, InlineKeyboardMarkup
from aiogram.utils.keyboard import InlineKeyboardBuilder


class ButtonType(Enum):
    """–¢–∏–ø—ã –∫–Ω–æ–ø–æ–∫ –¥–ª—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä"""
    CALLBACK = "callback"
    URL = "url"
    LOGIN = "login"


class KeyboardBuilder:
    """
    –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å—Ç—Ä–æ–∏—Ç–µ–ª—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –±—ã—Å—Ç—Ä–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è
    —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Ç–∏–ø–æ–≤ –∫–ª–∞–≤–∏–∞—Ç—É—Ä
    """
    
    def __init__(self):
        self.builder = InlineKeyboardBuilder()
    
    def add_button(
        self, 
        text: str, 
        button_type: ButtonType = ButtonType.CALLBACK, 
        data: Optional[str] = None, 
        url: Optional[str] = None
    ) -> 'KeyboardBuilder':
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –∫ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ"""
        if button_type == ButtonType.CALLBACK:
            if data is None:
                raise ValueError("For CALLBACK buttons, 'data' parameter is required")
            self.builder.button(text=text, callback_data=data)
        elif button_type == ButtonType.URL:
            if url is None:
                raise ValueError("For URL buttons, 'url' parameter is required")
            self.builder.button(text=text, url=url)
        elif button_type == ButtonType.LOGIN:
            if url is None:
                raise ValueError("For LOGIN buttons, 'url' parameter is required")
            # Note: login_url is not supported in InlineKeyboardBuilder directly
            # We'll need to handle this differently if needed
            pass
        return self
    
    def add_buttons_row(self, *buttons) -> 'KeyboardBuilder':
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–Ω–æ–ø–æ–∫ –≤ –æ–¥–∏–Ω —Ä—è–¥"""
        for button in buttons:
            if isinstance(button, tuple) and len(button) == 3:
                text, button_type, data_or_url = button
                self.add_button(text, button_type, data_or_url if button_type == ButtonType.CALLBACK else None, 
                               data_or_url if button_type == ButtonType.URL else None)
            elif isinstance(button, dict):
                self.add_button(**button)
        return self
    
    def add_navigation_buttons(
        self, 
        back_callback: Optional[str] = None, 
        home_callback: Optional[str] = None,
        custom_buttons: Optional[List[tuple]] = None
    ) -> 'KeyboardBuilder':
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫"""
        nav_buttons = []
        if custom_buttons:
            nav_buttons.extend(custom_buttons)
        if back_callback:
            nav_buttons.append(("üîô –ù–∞–∑–∞–¥", ButtonType.CALLBACK, back_callback))
        if home_callback:
            nav_buttons.append(("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", ButtonType.CALLBACK, home_callback))
        
        if nav_buttons:
            self.add_buttons_row(*nav_buttons)
        return self
    
    def adjust(self, *sizes: int) -> 'KeyboardBuilder':
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ —Ä—è–¥–æ–≤ –∫–Ω–æ–ø–æ–∫"""
        self.builder.adjust(*sizes)
        return self
    
    def build(self) -> InlineKeyboardMarkup:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã"""
        return self.builder.as_markup()


class StandardKeyboards:
    """–ö–ª–∞—Å—Å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∫–ª–∞–≤–∏–∞—Ç—É—Ä"""
    
    @staticmethod
    def confirmation_keyboard(
        confirm_callback: str, 
        cancel_callback: str, 
        confirm_text: str = "‚úÖ –î–∞", 
        cancel_text: str = "‚ùå –ù–µ—Ç",
        back_callback: Optional[str] = None
    ) -> InlineKeyboardMarkup:
        """–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"""
        builder = KeyboardBuilder()
        builder.add_buttons_row(
            (confirm_text, ButtonType.CALLBACK, confirm_callback),
            (cancel_text, ButtonType.CALLBACK, cancel_callback)
        )
        if back_callback:
            builder.add_button("üîô –ù–∞–∑–∞–¥", ButtonType.CALLBACK, back_callback)
        return builder.adjust(2).build()
    
    @staticmethod
    def pagination_keyboard(
        current_page: int, 
        total_pages: int, 
        base_callback: str,
        back_callback: Optional[str] = None
    ) -> InlineKeyboardMarkup:
        """–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π"""
        if total_pages <= 1:
            if back_callback:
                return KeyboardBuilder().add_button("üîô –ù–∞–∑–∞–¥", ButtonType.CALLBACK, back_callback).build()
            return InlineKeyboardMarkup()
        
        builder = KeyboardBuilder()
        
        # –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        nav_buttons = []
        if current_page > 0:
            nav_buttons.append(("‚¨ÖÔ∏è", ButtonType.CALLBACK, f"{base_callback}:{current_page - 1}"))
        
        nav_buttons.append((f"{current_page + 1}/{total_pages}", ButtonType.CALLBACK, "ignore"))
        
        if current_page < total_pages - 1:
            nav_buttons.append(("‚û°Ô∏è", ButtonType.CALLBACK, f"{base_callback}:{current_page + 1}"))
        
        builder.add_buttons_row(*nav_buttons)
        
        if back_callback:
            builder.add_button("üîô –ù–∞–∑–∞–¥", ButtonType.CALLBACK, back_callback)
        
        return builder.build()
    
    @staticmethod
    def choice_keyboard(
        choices: List[tuple],  # (text, callback_data)
        back_callback: Optional[str] = None,
        columns: int = 1
    ) -> InlineKeyboardMarkup:
        """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –æ–ø—Ü–∏–π"""
        builder = KeyboardBuilder()
        
        for text, callback_data in choices:
            builder.add_button(text, ButtonType.CALLBACK, callback_data)
        
        if back_callback:
            builder.add_button("üîô –ù–∞–∑–∞–¥", ButtonType.CALLBACK, back_callback)
        
        # Adjust buttons in rows according to columns
        if len(choices) % columns == 0:
            row_sizes = [columns] * (len(choices) // columns)
        else:
            row_sizes = [columns] * (len(choices) // columns) + [len(choices) % columns]
        
        if back_callback:
            row_sizes.append(1)  # For back button
            
        return builder.adjust(*row_sizes).build()
    
    @staticmethod
    def url_keyboard(
        buttons: List[tuple],  # (text, url)
        back_callback: Optional[str] = None
    ) -> InlineKeyboardMarkup:
        """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å URL-–∫–Ω–æ–ø–∫–∞–º–∏"""
        builder = KeyboardBuilder()
        
        for text, url in buttons:
            builder.add_button(text, ButtonType.URL, url=url)
        
        if back_callback:
            builder.add_button("üîô –ù–∞–∑–∞–¥", ButtonType.CALLBACK, back_callback)
        
        return builder.build()=== ./keyboards/builders.py ===
# keyboards/builders.py
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.types import InlineKeyboardButton

def simple_menu(text: str, callback_data: str) -> InlineKeyboardBuilder:
    builder = InlineKeyboardBuilder()
    builder.add(InlineKeyboardButton(text=text, callback_data=callback_data))
    return builder=== ./keyboards/callback_data.py ===
from aiogram.filters.callback_data import CallbackData
from typing import Optional


class GiveawayAction(CallbackData, prefix="giveaway"):
    action: str
    giveaway_id: int


class GiveawaysPagination(CallbackData, prefix="gwp"):
    """
    Callback data –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
    action: prev, next
    page: –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    filter_status: —Å—Ç–∞—Ç—É—Å —Ñ–∏–ª—å—Ç—Ä–∞ (active, finished, pending)
    """
    action: str
    page: int
    filter_status: str = ""
=== ./Dockerfile ===
# Dockerfile
FROM python:3.11-slim

WORKDIR /app

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã –¥–ª—è —Å–±–æ—Ä–∫–∏ pg driver)
RUN apt-get update && apt-get install -y \
    gcc \
    && rm -rf /var/lib/apt/lists/*

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

# –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ–∑ –ø—Ä–∞–≤ root
RUN useradd -m appuser
USER appuser

CMD ["python", "main.py"]=== ./.gitignore ===
# –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
venv/
.venv/
env/

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–°–ê–ú–û–ï –í–ê–ñ–ù–û–ï)
.env

# –ë–∞–π—Ç-–∫–æ–¥ Python
__pycache__/
*.pyc

# –õ–æ–≥–∏
*.log

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å SQLite —Ñ–∞–π–ª, –¥–ª—è Postgres –Ω–µ –Ω—É–∂–Ω–æ)
*.db
*.sqlite3

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ IDE
.idea/
.vscode/=== ./reset_db.py ===
import asyncio
from redis.asyncio import Redis
from database import engine, Base
from config import config

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –í–°–ï –º–æ–¥–µ–ª–∏, —á—Ç–æ–±—ã SQLAlchemy –∑–Ω–∞–ª–∞, —á—Ç–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å
from database.models.user import User
from database.models.giveaway import Giveaway
from database.models.participant import Participant
from database.models.channel import Channel
from database.models.required_channel import GiveawayRequiredChannel
from database.models.winner import Winner # <--- –í–∞–∂–Ω–æ! –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞

async def reset_database():
    print("üóë –£–¥–∞–ª—è—é —Å—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã PostgreSQL...")
    async with engine.begin() as conn:
        # –£–¥–∞–ª—è–µ–º –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã
        await conn.run_sync(Base.metadata.drop_all)
        # –°–æ–∑–¥–∞–µ–º –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –∑–∞–Ω–æ–≤–æ —Å –Ω–æ–≤—ã–º–∏ –ø–æ–ª—è–º–∏
        await conn.run_sync(Base.metadata.create_all)
    
    print("üóë –û—á–∏—â–∞—é Redis...")
    redis = Redis.from_url(config.REDIS_URL)
    await redis.flushdb()
    await redis.aclose()
    
    print("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±–Ω–æ–≤–ª–µ–Ω–∞!")

if __name__ == "__main__":
    asyncio.run(reset_database())=== ./utils/logging_config.py ===
import logging
from logging.handlers import RotatingFileHandler
import os


def setup_logging():
    """
    –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏—Å—Ç–µ–º—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
    """
    # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    logs_dir = "logs"
    if not os.path.exists(logs_dir):
        os.makedirs(logs_dir)
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –ª–æ–≥–æ–≤
    formatter = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )
    
    # –§–∞–π–ª–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å —Ä–æ—Ç–∞—Ü–∏–µ–π
    file_handler = RotatingFileHandler(
        'logs/admin_panel.log',
        maxBytes=10*1024*1024,  # 10 MB
        backupCount=5
    )
    file_handler.setFormatter(formatter)
    
    # –ö–æ–Ω—Å–æ–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
    console_handler = logging.StreamHandler()
    console_handler.setFormatter(formatter)
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ –ª–æ–≥–≥–µ—Ä–∞
    root_logger = logging.getLogger()
    root_logger.setLevel(logging.INFO)
    root_logger.addHandler(file_handler)
    root_logger.addHandler(console_handler)
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–æ–≤ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –º–æ–¥—É–ª–µ–π
    admin_logger = logging.getLogger('admin')
    admin_logger.setLevel(logging.INFO)
    
    broadcast_logger = logging.getLogger('broadcast')
    broadcast_logger.setLevel(logging.INFO)
    
    return root_logger=== ./utils/admin_logger.py ===
from sqlalchemy.ext.asyncio import AsyncSession
from datetime import datetime
from database.models import AdminLog


async def log_admin_action(session: AsyncSession, admin_id: int, action: str, target_id: int = None, details: dict = None):
    """
    –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    """
    log_entry = AdminLog(
        admin_id=admin_id,
        action=action,
        target_id=target_id,
        details=details
    )
    session.add(log_entry)
    await session.commit()=== ./utils/rate_limiter.py ===
import time
from collections import defaultdict
from typing import Dict


class RateLimiter:
    def __init__(self, max_requests: int = 10, window: int = 60):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–π—Ç-–ª–∏–º–∏—Ç–µ—Ä–∞
        :param max_requests: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ –æ–∫–Ω–æ
        :param window: —Ä–∞–∑–º–µ—Ä –æ–∫–Ω–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        """
        self.max_requests = max_requests
        self.window = window
        self.requests: Dict[int, list] = defaultdict(list)
    
    def is_allowed(self, user_id: int) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Ä–∞–∑—Ä–µ—à–µ–Ω –ª–∏ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        :param user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        :return: True, –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω, –∏–Ω–∞—á–µ False
        """
        now = time.time()
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã
        self.requests[user_id] = [req_time for req_time in self.requests[user_id] if now - req_time < self.window]
        
        if len(self.requests[user_id]) < self.max_requests:
            self.requests[user_id].append(now)
            return True
        
        return False
    
    def get_reset_time(self, user_id: int) -> float:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Ä–µ–º—è –¥–æ —Å–±—Ä–æ—Å–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
        :param user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        :return: –≤—Ä–µ–º—è –¥–æ —Å–±—Ä–æ—Å–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        """
        if user_id not in self.requests or not self.requests[user_id]:
            return 0
        
        oldest_request = min(self.requests[user_id])
        reset_time = oldest_request + self.window
        now = time.time()
        
        return max(0, reset_time - now)


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç–µ—Ä –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
admin_rate_limiter = RateLimiter(max_requests=20, window=60)  # 20 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É –¥–ª—è –∞–¥–º–∏–Ω–æ–≤=== ./utils/exception_handler.py ===
import logging
from functools import wraps
from typing import Callable, Any

logger = logging.getLogger(__name__)


def handle_exceptions(default_return=None):
    """
    –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
    """
    def decorator(func: Callable) -> Callable:
        @wraps(func)
        async def wrapper(*args, **kwargs) -> Any:
            try:
                return await func(*args, **kwargs)
            except Exception as e:
                logger.error(f"Error in {func.__name__}: {str(e)}", exc_info=True)
                return default_return
        return wrapper
    return decorator


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –¥–ª—è –≤—Å–µ–≥–æ —Ä–æ—É—Ç–µ—Ä–∞
def admin_errors_handler(update, error):
    logger.error(f"Admin router error: {error}", exc_info=True)
    # –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–µ=== ./utils/__init__.py ===
from .admin_logger import log_admin_action
from .rate_limiter import admin_rate_limiter, RateLimiter
from .exception_handler import handle_exceptions, admin_errors_handler

__all__ = [
    "log_admin_action",
    "admin_rate_limiter",
    "RateLimiter",
    "handle_exceptions",
    "admin_errors_handler"
]=== ./services/admin_user_service.py ===
from datetime import datetime, timedelta
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func, and_, update, or_
from database.models import User, Giveaway, Participant
from typing import List, Dict, Optional


class UserService:
    def __init__(self, session: AsyncSession):
        self.session = session
    
    async def search_users(self, query: str) -> List[User]:
        """
        –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ ID, username –∏–ª–∏ –∏–º–µ–Ω–∏
        """
        # –ü–æ–ø—Ä–æ–±—É–µ–º —Å–Ω–∞—á–∞–ª–∞ –Ω–∞–π—Ç–∏ –ø–æ ID (–µ—Å–ª–∏ query - —á–∏—Å–ª–æ)
        try:
            user_id = int(query)
            result = await self.session.execute(
                select(User).where(User.user_id == user_id)
            )
            users = result.scalars().all()
            if users:
                return users
        except ValueError:
            pass  # –ï—Å–ª–∏ query –Ω–µ —á–∏—Å–ª–æ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–æ–∏—Å–∫ –ø–æ –¥—Ä—É–≥–∏–º –ø–æ–ª—è–º
        except Exception:
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª—é–±—ã—Ö –¥—Ä—É–≥–∏—Ö –æ—à–∏–±–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö)
            return []
        
        # –ü–æ–∏—Å–∫ –ø–æ username –∏–ª–∏ –∏–º–µ–Ω–∏
        try:
            result = await self.session.execute(
                select(User).where(
                    or_(
                        User.username.ilike(f"%{query}%"),
                        User.full_name.ilike(f"%{query}%")
                    )
                )
            )
            return result.scalars().all()
        except Exception:
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª—é–±—ã—Ö –¥—Ä—É–≥–∏—Ö –æ—à–∏–±–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö)
            return []
    
    async def get_users_paginated(self, page: int = 1, page_size: int = 10,
                                 filters: dict = None) -> tuple[List[User], int]:
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
        """
        try:
            from sqlalchemy import or_
            
            offset = (page - 1) * page_size
            
            query = select(User).order_by(User.user_id.desc())
            
            # –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            if filters:
                conditions = []
                if filters.get('is_premium') is not None:
                    conditions.append(User.is_premium == filters['is_premium'])
                if filters.get('date_from'):
                    conditions.append(User.created_at >= filters['date_from'])
                if filters.get('date_to'):
                    conditions.append(User.created_at <= filters['date_to'])
                
                if conditions:
                    query = query.where(and_(*conditions))
            
            # –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            result = await self.session.execute(query.offset(offset).limit(page_size))
            users = result.scalars().all()
            
            # –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            count_query = select(func.count(User.user_id))
            if filters:
                count_conditions = []
                if filters.get('is_premium') is not None:
                    count_conditions.append(User.is_premium == filters['is_premium'])
                if filters.get('date_from'):
                    count_conditions.append(User.created_at >= filters['date_from'])
                if filters.get('date_to'):
                    count_conditions.append(User.created_at <= filters['date_to'])
                
                if count_conditions:
                    count_query = count_query.where(and_(*count_conditions))
            
            total_count = await self.session.scalar(count_query)
            
            return users, total_count or 0
        except Exception:
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª—é–±—ã—Ö –æ—à–∏–±–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö)
            return [], 0
    
    async def get_user_detailed_info(self, user_id: int) -> Optional[Dict]:
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        """
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ user_id –≤ –¥–æ–ø—É—Å—Ç–∏–º–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ
            if user_id <= 0:
                return None
            
            user = await self.session.get(User, user_id)
            if not user:
                return None
            
            # –ü–æ–¥—Å—á–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É—á–∞—Å—Ç–∏–π
            participation_count = await self.session.scalar(
                select(func.count(Participant.user_id)).where(Participant.user_id == user_id)
            )
            
            # –ü–æ–¥—Å—á–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
            created_giveaways_count = await self.session.scalar(
                select(func.count(Giveaway.id)).where(Giveaway.owner_id == user_id)
            )
            
            return {
                "user": user,
                "participation_count": participation_count or 0,
                "created_giveaways_count": created_giveaways_count or 0
            }
        except Exception:
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª—é–±—ã—Ö –æ—à–∏–±–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö)
            return None
    
    async def toggle_premium_status(self, user_id: int, is_premium: bool) -> bool:
        """
        –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–µ–º–∏—É–º–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        """
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ user_id –≤ –¥–æ–ø—É—Å—Ç–∏–º–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ
        # Telegram user IDs - —ç—Ç–æ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ —á–∏—Å–ª–∞, –æ–±—ã—á–Ω–æ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ –æ—Ç 1 –¥–æ ~10^10
        # –£—Å—Ç–∞–Ω–æ–≤–∏–º —Ä–∞–∑—É–º–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–≤–µ—Ä—Ö—É
        if user_id <= 0 or user_id > 100000000:  # –ú–∞–∫—Å–∏–º—É–º ~10 –º–∏–ª–ª–∏–∞—Ä–¥–æ–≤
            return False
            
        try:
            user = await self.session.get(User, user_id)
            if not user:
                return False
            
            user.is_premium = is_premium
            if not is_premium:
                user.premium_until = None
            
            try:
                await self.session.commit()
                return True
            except Exception:
                await self.session.rollback()
                return False
        except Exception:
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª—é–±—ã—Ö –¥—Ä—É–≥–∏—Ö –æ—à–∏–±–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö)
            return False=== ./services/admin_broadcast_service.py ===
from datetime import datetime
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, update
from database.models import Broadcast, ScheduledBroadcast, User
from aiogram import Bot
import asyncio
import logging
import traceback

# –î–æ–±–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏ –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
from database import async_session_maker

from redis.asyncio import Redis
from config import config

class BroadcastService:
    def __init__(self, bot: Bot, session: AsyncSession):
        self.bot = bot
        self.session = session
        self.logger = logging.getLogger('broadcast')
        self.redis = Redis.from_url(config.REDIS_URL)
    
    async def create_broadcast(self, message_text: str = None, photo_file_id: str = None,
                              video_file_id: str = None, document_file_id: str = None,
                              admin_id: int = None, scheduled_time: datetime = None) -> Broadcast:
        """
        –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏
        """
        try:
            # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç
            broadcast = Broadcast(
                message_text=message_text or '',
                photo_file_id=photo_file_id,
                video_file_id=video_file_id,
                document_file_id=document_file_id,
                scheduled_time=scheduled_time,
                created_by=admin_id,
                status="pending" if scheduled_time else "in_progress"
            )
            
            self.session.add(broadcast)
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º flush() –≤–º–µ—Å—Ç–æ commit()
            await self.session.flush()
            
            # –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç
            await self.session.refresh(broadcast)
            
            return broadcast
        except Exception as e:
            print(f"üî• –û–®–ò–ë–ö–ê –ü–†–ò –°–û–ó–î–ê–ù–ò–ò –†–ê–°–°–´–õ–ö–ò: {e}")
            traceback.print_exc()
            return None
    
    async def send_broadcast(self, broadcast_id: int) -> bool:
        """
        –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
        """
        try:
            broadcast = await self.session.get(Broadcast, broadcast_id)
            if not broadcast:
                return False
            
            # –ï—Å–ª–∏ —Ä–∞—Å—Å—ã–ª–∫–∞ –±—ã–ª–∞ –æ—Ç–ª–æ–∂–µ–Ω–∞, –º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ in_progress –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º
            if broadcast.status == "pending":
                broadcast.status = "in_progress"
                await self.session.flush()

            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            result = await self.session.execute(select(User.user_id))
            user_ids = result.scalars().all()
            
            total_count = len(user_ids)
            sent_count = 0
            failed_count = 0
            blocked_count = 0
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
            await self.session.execute(
                update(Broadcast)
                .where(Broadcast.id == broadcast_id)
                .values(total_count=total_count)
            )
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∂–¥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            for user_id in user_ids:
                # –ü–†–û–í–ï–†–ö–ê –°–í–ï–¢–û–§–û–†–ê
                # –ï—Å–ª–∏ –∏–¥–µ—Ç –≤—ã–±–æ—Ä –ø–æ–±–µ–¥–∏—Ç–µ–ª—è, –∂–¥–µ–º, –ø–æ–∫–∞ –æ–Ω –∑–∞–∫–æ–Ω—á–∏—Ç
                while await self.redis.get("system:high_load"):
                    await asyncio.sleep(2)  # –°–ø–∏–º 2 —Å–µ–∫—É–Ω–¥—ã –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–Ω–æ–≤–∞
                
                try:
                    success = await self._send_single_message(user_id, broadcast)
                    if success:
                        sent_count += 1
                    else:
                        failed_count += 1
                except Exception as e:
                    blocked_count += 1
                
                # –û–ì–†–ê–ù–ò–ß–ò–¢–ï–õ–¨ –°–ö–û–†–û–°–¢–ò (—á—Ç–æ–±—ã –Ω–µ –∑–∞–±–∏—Ç—å –∫–∞–Ω–∞–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é)
                # 0.1 —Å–µ–∫ = 10 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–µ–∫—É–Ω–¥—É. –û—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–ø–∞—Å –¥–ª—è —é–∑–µ—Ä–æ–≤.
                await asyncio.sleep(0.1)
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –∑–∞–≤–µ—Ä—à–∞–µ–º
            await self.session.execute(
                update(Broadcast)
                .where(Broadcast.id == broadcast_id)
                .values(
                    sent_count=sent_count,
                    failed_count=failed_count,
                    blocked_count=blocked_count,
                    status="completed",
                    completed_at=datetime.now()
                )
            )
            
            return True
        except Exception as e:
            self.logger.error(f"Error sending broadcast: {e}")
            return False
    
    async def _send_single_message(self, user_id: int, broadcast: Broadcast) -> bool:
        """
        –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        """
        try:
            if broadcast.photo_file_id:
                await self.bot.send_photo(
                    chat_id=user_id,
                    photo=broadcast.photo_file_id,
                    caption=broadcast.message_text
                )
            elif broadcast.video_file_id:
                await self.bot.send_video(
                    chat_id=user_id,
                    video=broadcast.video_file_id,
                    caption=broadcast.message_text
                )
            elif broadcast.document_file_id:
                await self.bot.send_document(
                    chat_id=user_id,
                    document=broadcast.document_file_id,
                    caption=broadcast.message_text
                )
            else:
                await self.bot.send_message(
                    chat_id=user_id,
                    text=broadcast.message_text
                )
            return True
        except Exception as e:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –æ—à–∏–±–∫–∏, —á—Ç–æ–±—ã –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –±–æ—Ç
            if "blocked" in str(e).lower() or "not found" in str(e).lower():
                return False
            return True
    
    async def get_broadcast_history(self, page: int = 1, page_size: int = 10) -> tuple[list[Broadcast], int]:
        try:
            from sqlalchemy import func
            offset = (page - 1) * page_size
            
            result = await self.session.execute(
                select(Broadcast)
                .order_by(Broadcast.created_at.desc())
                .offset(offset).limit(page_size)
            )
            broadcasts = result.scalars().all()
            
            result_count = await self.session.execute(
                select(func.count(Broadcast.id))
            )
            total_count = result_count.scalar()
            
            return broadcasts, total_count or 0
        except Exception:
            return [], 0
    
    async def get_scheduled_broadcasts(self, page: int = 1, page_size: int = 10) -> tuple[list[ScheduledBroadcast], int]:
        try:
            from sqlalchemy import func
            offset = (page - 1) * page_size
            
            result = await self.session.execute(
                select(ScheduledBroadcast)
                .order_by(ScheduledBroadcast.scheduled_time.asc())
                .offset(offset).limit(page_size)
            )
            scheduled_broadcasts = result.scalars().all()
            
            result_count = await self.session.execute(
                select(func.count(ScheduledBroadcast.id))
            )
            total_count = result_count.scalar()
            
            return scheduled_broadcasts, total_count or 0
        except Exception:
            return [], 0

# --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø ---
async def recover_stuck_broadcasts(bot: Bot):
    """
    –ò—â–µ—Ç –∑–∞–≤–∏—Å—à–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏ (in_progress) –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞,
    –º–µ–Ω—è–µ—Ç –∏—Ö —Å—Ç–∞—Ç—É—Å –Ω–∞ interrupted –∏ —É–≤–µ–¥–æ–º–ª—è–µ—Ç –∞–¥–º–∏–Ω–∞.
    """
    async with async_session_maker() as session:
        try:
            # –ò—â–µ–º –∑–∞–≤–∏—Å—à–∏–µ
            stmt = select(Broadcast).where(Broadcast.status == "in_progress")
            result = await session.execute(stmt)
            stuck_broadcasts = result.scalars().all()
            
            if not stuck_broadcasts:
                return

            logging.warning(f"‚ö†Ô∏è Found {len(stuck_broadcasts)} stuck broadcasts via recovery.")

            for bc in stuck_broadcasts:
                # –ú–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å
                bc.status = "interrupted"
                
                # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∞
                try:
                    await bot.send_message(
                        bc.created_by,
                        f"‚ö†Ô∏è <b>–í–Ω–∏–º–∞–Ω–∏–µ!</b>\n\n"
                        f"–†–∞—Å—Å—ã–ª–∫–∞ #{bc.id} –±—ã–ª–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞ –∏–∑-–∑–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –±–æ—Ç–∞.\n"
                        f"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ '–ü—Ä–µ—Ä–≤–∞–Ω–æ'.\n"
                        f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {bc.sent_count}/{bc.total_count}.\n\n"
                        f"–í—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ä–∞—Å—Å—ã–ª–∫—É –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —ç—Ç—É –∏–∑ –º–µ–Ω—é '–ò—Å—Ç–æ—Ä–∏—è'."
                    )
                except Exception as e:
                    logging.error(f"Failed to notify admin about stuck broadcast #{bc.id}: {e}")
            
            await session.commit()
            logging.info("‚úÖ All stuck broadcasts recovered to 'interrupted' status.")
            
        except Exception as e:
            logging.error(f"Error during broadcast recovery: {e}")
    
    async def close(self):
        """–ó–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Redis"""
        await self.redis.aclose()=== ./services/admin_statistics_service.py ===
from datetime import datetime, timedelta
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func, and_, update
from database.models import User, Giveaway, Participant, AdminLog
from typing import Dict, Any


class StatisticsService:
    def __init__(self, session: AsyncSession):
        self.session = session
    
    async def get_general_stats(self) -> dict:
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        """
        # –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        total_users = await self.session.scalar(select(func.count(User.user_id)))
        
        # –ê–∫—Ç–∏–≤–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
        active_giveaways = await self.session.scalar(
            select(func.count(Giveaway.id)).where(Giveaway.status == "active")
        )
        
        # –í—Å–µ–≥–æ —É—á–∞—Å—Ç–∏–π
        total_participations = await self.session.scalar(
            select(func.count(Participant.user_id))
        )
        
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ username (–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –±–æ—Ç—ã)
        potential_bots = await self.session.scalar(
            select(func.count(User.user_id)).where(User.username.is_(None))
        )
        
        return {
            "total_users": total_users,
            "active_giveaways": active_giveaways,
            "total_participations": total_participations,
            "potential_bots": potential_bots
        }
    
    async def get_user_growth_stats(self) -> dict:
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ä–æ—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        """
        today = datetime.now().date()
        week_ago = today - timedelta(days=7)
        month_ago = today - timedelta(days=30)
        
        new_today = await self.session.scalar(
            select(func.count(User.user_id)).where(
                func.date(User.created_at) == today
            )
        )
        
        new_week = await self.session.scalar(
            select(func.count(User.user_id)).where(
                User.created_at >= week_ago
            )
        )
        
        new_month = await self.session.scalar(
            select(func.count(User.user_id)).where(
                User.created_at >= month_ago
            )
        )
        
        return {
            "new_today": new_today,
            "new_week": new_week,
            "new_month": new_month
        }


class StatsCache:
    def __init__(self, ttl: int = 300):  # 5 –º–∏–Ω—É—Ç
        self.cache: Dict[str, tuple[Any, datetime]] = {}
        self.ttl = timedelta(seconds=ttl)
    
    def get(self, key: str):
        if key in self.cache:
            value, timestamp = self.cache[key]
            if datetime.now() - timestamp < self.ttl:
                return value
            else:
                del self.cache[key]
        return None
    
    def set(self, key: str, value: Any):
        self.cache[key] = (value, datetime.now())


class CachedStatisticsService(StatisticsService):
    def __init__(self, session: AsyncSession):
        super().__init__(session)
        self.cache = StatsCache()
    
    async def get_general_stats(self) -> dict:
        cache_key = "general_stats"
        cached = self.cache.get(cache_key)
        if cached:
            return cached
        
        # –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        total_users = await self.session.scalar(select(func.count(User.user_id)))
        
        # –ê–∫—Ç–∏–≤–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
        active_giveaways = await self.session.scalar(
            select(func.count(Giveaway.id)).where(Giveaway.status == "active")
        )
        
        # –í—Å–µ–≥–æ —É—á–∞—Å—Ç–∏–π
        total_participations = await self.session.scalar(
            select(func.count(Participant.user_id))
        )
        
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ username (–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –±–æ—Ç—ã)
        potential_bots = await self.session.scalar(
            select(func.count(User.user_id)).where(User.username.is_(None))
        )
        
        result = {
            "total_users": total_users,
            "active_giveaways": active_giveaways,
            "total_participations": total_participations,
            "potential_bots": potential_bots
        }
        
        self.cache.set(cache_key, result)
        return result=== ./services/admin_giveaway_service.py ===
from datetime import datetime, timedelta
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func, and_, update, or_, String
from database.models import Giveaway, Participant, User
from aiogram import Bot
from typing import List, Dict, Optional


class GiveawayService:
    def __init__(self, session: AsyncSession, bot: Bot = None):
        self.session = session
        self.bot = bot
    
    async def search_giveaways(self, query: str) -> List[Giveaway]:
        """
        –ü–æ–∏—Å–∫ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –ø—Ä–∏–∑–∞, ID –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∏–ª–∏ —Å—Ç–∞—Ç—É—Å—É
        """
        try:
            # –ü–æ–ø—Ä–æ–±—É–µ–º —Å–Ω–∞—á–∞–ª–∞ –Ω–∞–π—Ç–∏ –ø–æ ID (–µ—Å–ª–∏ query - —á–∏—Å–ª–æ)
            try:
                giveaway_id = int(query)
                result = await self.session.execute(
                    select(Giveaway).where(Giveaway.id == giveaway_id)
                )
                giveaways = result.scalars().all()
                if giveaways:
                    return giveaways
            except ValueError:
                pass  # –ï—Å–ª–∏ query –Ω–µ —á–∏—Å–ª–æ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–æ–∏—Å–∫ –ø–æ –¥—Ä—É–≥–∏–º –ø–æ–ª—è–º
            
            # –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É –ø—Ä–∏–∑–∞ –∏–ª–∏ ID –≤–ª–∞–¥–µ–ª—å—Ü–∞
            result = await self.session.execute(
                select(Giveaway).where(
                    or_(
                        Giveaway.prize_text.ilike(f"%{query}%"),
                        func.cast(Giveaway.owner_id, String).ilike(f"%{query}%")
                    )
                )
            )
            return result.scalars().all()
        except Exception:
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª—é–±—ã—Ö –¥—Ä—É–≥–∏—Ö –æ—à–∏–±–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö)
            return []
    
    async def get_giveaways_paginated(self, page: int = 1, page_size: int = 10) -> tuple[List[Giveaway], int]:
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
        """
        try:
            offset = (page - 1) * page_size
            
            # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
            result = await self.session.execute(
                select(Giveaway)
                .order_by(Giveaway.finish_time.desc())
                .offset(offset)
                .limit(page_size)
            )
            giveaways = result.scalars().all()
            
            # –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            result_count = await self.session.execute(
                select(func.count(Giveaway.id))
            )
            total_count = result_count.scalar()
            
            return giveaways, total_count or 0
        except Exception:
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª—é–±—ã—Ö –æ—à–∏–±–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö)
            return [], 0
    
    async def get_giveaway_detailed_info(self, giveaway_id: int) -> Optional[Dict]:
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–æ–∑—ã–≥—Ä—ã—à–µ
        """
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ giveaway_id –≤ –¥–æ–ø—É—Å—Ç–∏–º–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ
            if giveaway_id <= 0:
                return None
            
            giveaway = await self.session.get(Giveaway, giveaway_id)
            if not giveaway:
                return None
            
            # –ü–æ–¥—Å—á–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            participant_count = await self.session.scalar(
                select(func.count(Participant.user_id)).where(Participant.giveaway_id == giveaway_id)
            )
            
            # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤–ª–∞–¥–µ–ª—å—Ü–µ
            owner = await self.session.get(User, giveaway.owner_id)
            
            return {
                "giveaway": giveaway,
                "participant_count": participant_count or 0,
                "owner": owner
            }
        except Exception:
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª—é–±—ã—Ö –æ—à–∏–±–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö)
            return None
    
    async def force_finish_giveaway(self, giveaway_id: int, admin_id: int) -> bool:
        """
        –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
        """
        try:
            from random.core.logic.game_actions import finish_giveaway
        except ImportError:
            # –í —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ä–µ–¥–µ –º–æ–¥—É–ª—å –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º False, —á—Ç–æ–±—ã —É–∫–∞–∑–∞—Ç—å, —á—Ç–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å
            return False
        
        giveaway = await self.session.get(Giveaway, giveaway_id)
        if not giveaway or giveaway.status != "active":
            return False
        
        try:
            # –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–æ–∑—ã–≥—Ä—ã—à
            await finish_giveaway(giveaway_id, self.session, self.bot)
            return True
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–∞: {e}")
            return False
     
    async def get_user_giveaways_paginated(self, user_id: int, page: int = 1, page_size: int = 10) -> tuple[List[Giveaway], int]:
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
        """
        try:
            offset = (page - 1) * page_size
            
            # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            result = await self.session.execute(
                select(Giveaway)
                .where(Giveaway.owner_id == user_id)
                .order_by(Giveaway.finish_time.desc())
                .offset(offset)
                .limit(page_size)
            )
            giveaways = result.scalars().all()
            
            # –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            result_count = await self.session.execute(
                select(func.count(Giveaway.id))
                .where(Giveaway.owner_id == user_id)
            )
            total_count = result_count.scalar()
            
            return giveaways, total_count or 0
        except Exception:
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª—é–±—ã—Ö –æ—à–∏–±–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö)
            return [], 0=== ./services/__init__.py ===
# Admin services only
from .admin_statistics_service import StatisticsService, CachedStatisticsService
from .admin_user_service import UserService as AdminUserService
from .admin_giveaway_service import GiveawayService as AdminGiveawayService
from .admin_broadcast_service import BroadcastService as AdminBroadcastService

__all__ = [
    # Admin services
    "StatisticsService",
    "CachedStatisticsService",
    "AdminUserService",
    "AdminGiveawayService",
    "AdminBroadcastService"
]=== ./requirements.txt ===
aiofiles==25.1.0
aiogram==3.23.0
aiohappyeyeballs==2.6.1
aiohttp==3.13.2
aiosignal==1.4.0
aiounittest==1.5.0
alembic==1.17.2
annotated-types==0.7.0
APScheduler==3.11.2
asyncpg==0.31.0
attrs==25.4.0
babel==2.17.0
beautifulsoup4==4.14.3
black==25.12.0
bleach==6.3.0
certifi==2025.11.12
charset-normalizer==3.4.4
click==8.3.1
cloudscraper==1.2.71
colorlog==6.10.1
cryptg==0.5.2
fake-useragent==2.2.0
fluent-compiler==1.1
fluent.runtime==0.4.0
fluent.syntax==0.19.0
fluentogram==1.2.1
frozenlist==1.8.0
greenlet==3.3.0
hashids==1.3.1
howlongtobeatpy==1.0.19
idna==3.11
iniconfig==2.3.0
isort==7.0.0
kagglehub==0.3.13
librt==0.7.5
loguru==0.7.3
lxml==6.0.2
magic-filter==1.0.12
Mako==1.3.10
MarkupSafe==3.0.3
multidict==6.7.0
mypy==1.19.1
mypy_extensions==1.1.0
numpy==2.4.0
packaging==25.0
pandas==2.3.3
pathspec==0.12.1
pillow==12.0.0
platformdirs==4.5.1
playwright==1.57.0
pluggy==1.6.0
propcache==0.4.1
pyaes==1.6.1
pyasn1==0.6.1
pydantic==2.12.5
pydantic-settings==2.12.0
pydantic_core==2.41.5
pyee==13.0.0
Pygments==2.19.2
pyparsing==3.3.1
Pyrogram==2.0.106
PySocks==1.7.1
pytest==9.0.2
pytest-asyncio==1.3.0
python-dateutil==2.9.0.post0
python-dotenv==1.2.1
pytokens==0.3.0
pytz==2025.2
PyYAML==6.0.3
redis==7.1.0
requests==2.32.5
requests-toolbelt==1.0.0
rsa==4.9.1
six==1.17.0
soupsieve==2.8.1
SQLAlchemy==2.0.45
Telethon==1.42.0
TgCrypto==1.2.5
tqdm==4.67.1
typing-inspection==0.4.2
typing_extensions==4.15.0
tzdata==2025.3
tzlocal==5.3.1
urllib3==2.6.2
webencodings==0.5.1
wrapt==2.0.1
yarl==1.22.0
yt-dlp==2025.12.8
=== ./.pytest_cache/.gitignore ===
# Created by pytest automatically.
*
=== ./.pytest_cache/README.md ===
# pytest cache directory #

This directory contains data from the pytest's cache plugin,
which provides the `--lf` and `--ff` options, as well as the `cache` fixture.

**Do not** commit this to version control.

See [the docs](https://docs.pytest.org/en/stable/how-to/cache.html) for more information.
=== ./tests/test_admin_panel.py ===
import pytest
from unittest.mock import AsyncMock, MagicMock
from sqlalchemy.ext.asyncio import AsyncSession
from aiogram import Bot
from aiogram.types import Message, CallbackQuery, User as TelegramUser

from services.admin_statistics_service import StatisticsService, CachedStatisticsService
from services.admin_user_service import UserService
from services.admin_giveaway_service import GiveawayService
from services.admin_broadcast_service import BroadcastService
from database.models import User, Giveaway, Participant


@pytest.mark.asyncio
async def test_statistics_service():
    # –°–æ–∑–¥–∞–µ–º mock —Å–µ—Å—Å–∏–∏
    mock_session = AsyncMock()
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∂–∏–¥–∞–µ–º—ã—Ö –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
    mock_session.scalar.return_value = 100  # –ù–∞–ø—Ä–∏–º–µ—Ä, –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    
    service = StatisticsService(mock_session)
    stats = await service.get_general_stats()
    
    assert stats["total_users"] == 100
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±—ã–ª–∏ –≤—ã–∑–≤–∞–Ω—ã –æ–∂–∏–¥–∞–µ–º—ã–µ –º–µ—Ç–æ–¥—ã
    assert mock_session.scalar.called


@pytest.mark.asyncio
async def test_cached_statistics_service():
    # –°–æ–∑–¥–∞–µ–º mock —Å–µ—Å—Å–∏–∏
    mock_session = AsyncMock()
    mock_session.scalar.return_value = 100
    
    service = CachedStatisticsService(mock_session)
    stats1 = await service.get_general_stats()
    stats2 = await service.get_general_stats()  # –í—Ç–æ—Ä–æ–π –≤—ã–∑–æ–≤ –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à
    
    assert stats1["total_users"] == 100
    assert stats2["total_users"] == 100


@pytest.mark.asyncio
async def test_user_service_search():
    mock_session = AsyncMock()
    
    # –°–æ–∑–¥–∞–µ–º mock –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    mock_user = MagicMock()
    mock_user.user_id = 123
    mock_user.username = "testuser"
    mock_user.full_name = "Test User"
    
    mock_result = MagicMock()
    mock_result.scalars.return_value.all.return_value = [mock_user]
    mock_session.execute.return_value = mock_result
    
    service = UserService(mock_session)
    users = await service.search_users("testuser")
    
    assert len(users) == 1
    assert users[0].username == "testuser"


@pytest.mark.asyncio
async def test_user_service_get_detailed_info():
    mock_session = AsyncMock()
    
    # Mock –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    mock_user = MagicMock()
    mock_user.user_id = 123
    mock_user.username = "testuser"
    mock_user.full_name = "Test User"
    mock_user.is_premium = True
    
    # Mock –¥–ª—è —É—á–∞—Å—Ç–∏–π
    mock_session.scalar.return_value = 5  # –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–∏–π
    
    service = UserService(mock_session)
    
    # –ú—ã –Ω–µ –º–æ–∂–µ–º –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å get_user_detailed_info, –ø–æ—Ç–æ–º—É —á—Ç–æ –≤ —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
    # –≤ –º–µ—Ç–æ–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è await session.get(User, user_id), –∞ –Ω–µ execute(select(...))
    # –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å mock differently


@pytest.mark.asyncio
async def test_giveaway_service():
    mock_session = AsyncMock()
    mock_bot = AsyncMock()
    
    service = GiveawayService(mock_session, mock_bot)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–∏—Å —Å–æ–∑–¥–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
    assert service.session == mock_session
    assert service.bot == mock_bot


@pytest.mark.asyncio
async def test_broadcast_service():
    mock_session = AsyncMock()
    mock_bot = AsyncMock()
    
    service = BroadcastService(mock_bot, mock_session)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–∏—Å —Å–æ–∑–¥–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
    assert service.bot == mock_bot
    assert service.session == mock_session


# –ü—Ä–∏–º–µ—Ä —Ç–µ—Å—Ç–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
@pytest.mark.asyncio
async def test_broadcast_with_error_handling():
    mock_session = AsyncMock()
    mock_bot = AsyncMock()
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–∏—Ç—É–∞—Ü–∏—é, –∫–æ–≥–¥–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
    mock_bot.send_message.side_effect = Exception("Network error")
    
    service = BroadcastService(mock_bot, mock_session)
    
    # –¢–∞–∫ –∫–∞–∫ send_broadcast –º–µ—Ç–æ–¥ –≤ —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞–ø—Ä—è–º—É—é,
    # –º—ã –Ω–µ –º–æ–∂–µ–º –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ —Ç–∞–∫–∏–º —Å–ø–æ—Å–æ–±–æ–º
    # –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –ø—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ —Å–µ—Ä–≤–∏—Å —Å–æ–∑–¥–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
    assert service is not None


# –¢–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
@pytest.mark.asyncio
async def test_admin_filter():
    from filters.admin_filter import IsAdmin
    from config import config
    
    # –°–æ–∑–¥–∞–µ–º mock –¥–ª—è config
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123, 456]
    
    admin_filter = IsAdmin()
    
    # Mock —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    admin_message = MagicMock()
    admin_message.from_user.id = 123
    
    # Mock —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_message = MagicMock()
    user_message.from_user.id = 789
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    result_admin = await admin_filter(admin_message)
    assert result_admin is True
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    result_user = await admin_filter(user_message)
    assert result_user is False
    
    # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    config.ADMIN_IDS = original_admin_ids


# –¢–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
@pytest.mark.asyncio
async def test_exception_handler_decorator():
    from utils.exception_handler import handle_exceptions
    
    @handle_exceptions(default_return="error_occurred")
    async def test_function():
        raise Exception("Test exception")
    
    result = await test_function()
    assert result == "error_occurred"
    
    @handle_exceptions(default_return="success")
    async def test_function_success():
        return "success"
    
    result = await test_function_success()
    assert result == "success"


# –¢–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã –∫—ç—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
@pytest.mark.asyncio
async def test_statistics_cache():
    from services.admin_statistics_service import StatsCache
    from datetime import timedelta
    import time
    
    cache = StatsCache(ttl=1)  # TTL 1 —Å–µ–∫—É–Ω–¥–∞ –¥–ª—è —Ç–µ—Å—Ç–∞
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –∫—ç—à
    cache.set("test_key", "test_value")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –∏–∑ –∫—ç—à–∞
    value = cache.get("test_key")
    assert value == "test_value"
    
    # –ñ–¥–µ–º, –ø–æ–∫–∞ –∫—ç—à –Ω–µ –∏—Å—Ç–µ—á–µ—Ç
    time.sleep(1)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –±–æ–ª—å—à–µ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ
    value = cache.get("test_key")
    assert value is None


# –¢–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã —Ä–µ–π—Ç-–ª–∏–º–∏—Ç–µ—Ä–∞
@pytest.mark.asyncio
async def test_rate_limiter():
    from utils.rate_limiter import RateLimiter
    
    limiter = RateLimiter(max_requests=2, window=1)  # 2 –∑–∞–ø—Ä–æ—Å–∞ –≤ —Å–µ–∫—É–Ω–¥—É
    user_id = 123
    
    # –ü–µ—Ä–≤—ã–µ –¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω—ã
    assert limiter.is_allowed(user_id) == True
    assert limiter.is_allowed(user_id) == True
    
    # –¢—Ä–µ—Ç–∏–π –∑–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω
    assert limiter.is_allowed(user_id) == False
    
    # –ñ–¥–µ–º, –ø–æ–∫–∞ –ª–∏–º–∏—Ç –Ω–µ —Å–±—Ä–æ—Å–∏—Ç—Å—è
    import time
    time.sleep(1)
    
    # –¢–µ–ø–µ—Ä—å –∑–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω —Å–Ω–æ–≤–∞
    assert limiter.is_allowed(user_id) == True


# –¢–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Ä–≤–∏—Å–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
@pytest.mark.asyncio
async def test_user_service_toggle_premium():
    mock_session = AsyncMock()
    
    service = UserService(mock_session)
    
    # –ú–æ–∫–∞–µ–º –º–µ—Ç–æ–¥—ã –¥–ª—è —É—Å–ø–µ—à–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    mock_user = MagicMock()
    mock_user.is_premium = False
    mock_user.premium_until = None
    
    # –ú–æ–∫–∞–µ–º session.get –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ mock_user
    mock_session.get.return_value = mock_user
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –≤–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–µ–º–∏—É–º–∞
    result = await service.toggle_premium_status(123, True)
    assert result is True
    assert mock_user.is_premium is True
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –≤—ã–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–µ–º–∏—É–º–∞
    result = await service.toggle_premium_status(123, False)
    assert result is True
    assert mock_user.is_premium is False
    assert mock_user.premium_until is None


# –¢–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
@pytest.mark.asyncio
async def test_user_service_pagination():
    mock_session = AsyncMock()
    
    # –ú–æ–∫–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è execute –∏ scalar
    mock_users = [MagicMock() for _ in range(5)]
    for i, user in enumerate(mock_users):
        user.user_id = i
        user.username = f"user{i}"
        user.full_name = f"User {i}"
        user.is_premium = i % 2 == 0  # –ß–µ—Ä–µ–∑ –æ–¥–Ω–æ–≥–æ
    
    mock_execute_result = MagicMock()
    mock_execute_result.scalars.return_value.all.return_value = mock_users
    mock_session.execute.return_value = mock_execute_result
    
    mock_session.scalar.return_value = 100  # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    
    service = UserService(mock_session)
    users, total_count = await service.get_users_paginated(page=1, page_size=5)
    
    assert len(users) == 5
    assert total_count == 100


# –¢–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Ä–≤–∏—Å–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞–º–∏
@pytest.mark.asyncio
async def test_giveaway_service_detailed_info():
    mock_session = AsyncMock()
    mock_bot = AsyncMock()
    
    # –ú–æ–∫–∞–µ–º —Ä–æ–∑—ã–≥—Ä—ã—à
    mock_giveaway = MagicMock()
    mock_giveaway.id = 1
    mock_giveaway.prize_text = "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–∑"
    mock_giveaway.owner_id = 123
    mock_giveaway.status = "active"
    
    mock_session.get.return_value = mock_giveaway
    mock_session.scalar.return_value = 10  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    
    service = GiveawayService(mock_session, mock_bot)
    giveaway_info = await service.get_giveaway_detailed_info(1)
    
    assert giveaway_info is not None
    assert giveaway_info["giveaway"].id == 1
    assert giveaway_info["participant_count"] == 10


# –¢–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
@pytest.mark.asyncio
async def test_log_admin_action():
    from utils.admin_logger import log_admin_action
    mock_session = AsyncMock()
    
    await log_admin_action(mock_session, 123, "test_action", 456, {"test": "data"})
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤ —Å–µ—Å—Å–∏—é –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω –æ–±—ä–µ–∫—Ç –∏ –≤—ã–∑–≤–∞–Ω commit
    assert mock_session.add.called
    assert mock_session.commit.called


# –¢–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–∏—Å–∞ —Ä–∞—Å—Å—ã–ª–æ–∫
@pytest.mark.asyncio
async def test_broadcast_service_creation():
    mock_session = AsyncMock()
    mock_bot = AsyncMock()
    
    service = BroadcastService(mock_bot, mock_session)
    
    # –ú–æ–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏
    mock_broadcast = MagicMock()
    mock_broadcast.id = 1
    mock_session.add.return_value = None
    type(mock_session).commit = AsyncMock(return_value=None)
    type(mock_session).refresh = AsyncMock(return_value=None)
    
    # –°–æ–∑–¥–∞–µ–º –º–æ–∫-–∫–ª–∞—Å—Å –¥–ª—è Broadcast, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞—Ç—Ä–∏–±—É—Ç—ã
    import sys
    from unittest.mock import create_autospec
    from database.models import Broadcast
    mock_broadcast_obj = create_autospec(Broadcast)
    mock_broadcast_obj.id = 1
    
    # –ú–æ–∫–∞–µ–º –≤–æ–∑–≤—Ä–∞—Ç –æ–±—ä–µ–∫—Ç–∞ –ø–æ—Å–ª–µ refresh
    def mock_refresh(obj):
        obj.id = 1
        return obj
    mock_session.refresh = AsyncMock(side_effect=mock_refresh)
    
    # –°–æ–∑–¥–∞–µ–º —Ä–∞—Å—Å—ã–ª–∫—É
    broadcast = await service.create_broadcast(
        message_text="–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",
        admin_id=123
    )
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–∞—Å—Å—ã–ª–∫–∞ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞
    assert broadcast is not None


# –¢–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–∏—Å–∫–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
@pytest.mark.asyncio
async def test_giveaway_service_search():
    mock_session = AsyncMock()
    mock_bot = AsyncMock()
    
    # –°–æ–∑–¥–∞–µ–º mock —Ä–æ–∑—ã–≥—Ä—ã—à–∞
    mock_giveaway = MagicMock()
    mock_giveaway.id = 1
    mock_giveaway.prize_text = "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–∑"
    mock_giveaway.owner_id = 123
    mock_giveaway.status = "active"
    
    mock_result = MagicMock()
    mock_result.scalars.return_value.all.return_value = [mock_giveaway]
    mock_session.execute.return_value = mock_result
    
    service = GiveawayService(mock_session, mock_bot)
    giveaways = await service.search_giveaways("–¢–µ—Å—Ç–æ–≤—ã–π")
    
    assert len(giveaways) == 1
    assert giveaways[0].prize_text == "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–∑"=== ./tests/test_admin_e2e.py ===
import pytest
from unittest.mock import AsyncMock, MagicMock, patch
from sqlalchemy.ext.asyncio import AsyncSession
from aiogram import Bot
from aiogram.types import Message, CallbackQuery, User as TelegramUser
from aiogram.fsm.storage.memory import MemoryStorage

from handlers.admin.admin_router import admin_router
from services.admin_statistics_service import CachedStatisticsService
from services.admin_user_service import UserService
from services.admin_giveaway_service import GiveawayService
from services.admin_broadcast_service import BroadcastService
from database.models import User, Giveaway, Participant, Broadcast
from config import config


@pytest.fixture
def mock_bot():
    """–§–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞"""
    bot = AsyncMock(spec=Bot)
    return bot


@pytest.fixture
def mock_session():
    """–§–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
    session = AsyncMock(spec=AsyncSession)
    return session


@pytest.fixture
def admin_user():
    """–§–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    user = MagicMock(spec=TelegramUser)
    user.id = 123
    return user


@pytest.mark.asyncio
async def test_full_admin_flow(mock_bot, mock_session, admin_user):
    """
    E2E —Ç–µ—Å—Ç: –ø–æ–ª–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
    """
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–∞–Ω–¥—É /admin
        message = MagicMock(spec=Message)
        message.text = "/admin"
        message.from_user = admin_user
        
        # –°–æ–∑–¥–∞–µ–º –º–æ–∫-–æ–±—ä–µ–∫—Ç –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
        mock_bot.send_message = AsyncMock()
        
        # –ò–º–∏—Ç–∏—Ä—É–µ–º –≤—ã–∑–æ–≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–æ–º–∞–Ω–¥—ã
        from handlers.admin.admin_router import admin_router
        from aiogram import Router
        from aiogram.filters import Command
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        from handlers.admin.stats_handlers import show_stats_menu
        from handlers.admin.users_handlers import show_users_menu
        from handlers.admin.giveaways_handlers import show_giveaways_menu
        from handlers.admin.broadcast_handlers import show_broadcast_menu
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–º–∞–Ω–¥–∞ /admin –≤—ã–∑—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
        # (–≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ –º—ã —Ç–µ—Å—Ç–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏)
        from keyboards.admin_keyboards import get_main_admin_menu_keyboard
        
        keyboard = get_main_admin_menu_keyboard()
        assert keyboard is not None
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π (—ç—Ç–æ –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –≤–Ω—É—Ç—Ä–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞)
        await mock_bot.send_message(
            chat_id=admin_user.id,
            text="üîí –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å",
            reply_markup=keyboard
        )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
        mock_bot.send_message.assert_called_once()
        
    finally:
        # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_statistics_section_e2e(mock_bot, mock_session, admin_user):
    """
    E2E —Ç–µ—Å—Ç: —Ä–∞–∑–¥–µ–ª —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –ú–æ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        side_effects = [100, 5, 50, 5]  # total_users, active_giveaways, total_participations, potential_bots
        current_call = 0
        
        async def mock_scalar_side_effect(*args, **kwargs):
            nonlocal current_call
            result = side_effects[current_call]
            current_call = (current_call + 1) % len(side_effects)
            return result
        
        mock_session.scalar = mock_scalar_side_effect
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        service = CachedStatisticsService(mock_session)
        stats = await service.get_general_stats()
        
        assert stats["total_users"] == 100
        assert stats["active_giveaways"] == 5
        assert stats["total_participations"] == 50
        assert stats["potential_bots"] == 5
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        callback = MagicMock(spec=CallbackQuery)
        callback.data = "admin_general_stats"
        callback.from_user = admin_user
        callback.message = MagicMock()
        
        # –ú–æ–∫–∞–µ–º –º–µ—Ç–æ–¥—ã –æ—Ç–≤–µ—Ç–∞
        callback.message.edit_text = AsyncMock()
        
        # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏ –≤—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
        from handlers.admin.stats_handlers import show_general_stats
        await show_general_stats(callback, mock_session)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –±—ã–ª –∏–∑–º–µ–Ω–µ–Ω
        callback.message.edit_text.assert_called()
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_users_section_e2e(mock_bot, mock_session, admin_user):
    """
    E2E —Ç–µ—Å—Ç: —Ä–∞–∑–¥–µ–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –°–æ–∑–¥–∞–µ–º –º–æ–∫-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–æ–∏—Å–∫–∞
        mock_user = MagicMock(spec=User)
        mock_user.user_id = 456
        mock_user.username = "testuser"
        mock_user.full_name = "Test User"
        mock_user.is_premium = False
        
        # –ú–æ–∫–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
        mock_result = MagicMock()
        mock_result.scalars.return_value.all.return_value = [mock_user]
        async def mock_execute_side_effect(*args, **kwargs):
            return mock_result
        mock_session.execute = mock_execute_side_effect
        
        # –ú–æ–∫–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–∏–π
        async def mock_scalar_side_effect(*args, **kwargs):
            return 3
        mock_session.scalar = mock_scalar_side_effect
        
        # –ú–æ–∫–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async def mock_get_side_effect(model, user_id):
            if model == User and user_id == 456:
                return mock_user
            return None
        mock_session.get = mock_get_side_effect
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–µ—Ä–≤–∏—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        service = UserService(mock_session)
        users = await service.search_users("testuser")
        
        assert len(users) == 1
        assert users[0].username == "testuser"
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        user_info = await service.get_user_detailed_info(456)
        assert user_info is not None
        assert user_info["user"].user_id == 456
        assert user_info["participation_count"] == 3
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–µ–º–∏—É–º-—Å—Ç–∞—Ç—É—Å–∞
        toggle_result = await service.toggle_premium_status(456, True)
        assert toggle_result is True
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_giveaways_section_e2e(mock_bot, mock_session, admin_user):
    """
    E2E —Ç–µ—Å—Ç: —Ä–∞–∑–¥–µ–ª —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –°–æ–∑–¥–∞–µ–º –º–æ–∫-—Ä–æ–∑—ã–≥—Ä—ã—à
        mock_giveaway = MagicMock(spec=Giveaway)
        mock_giveaway.id = 1
        mock_giveaway.prize_text = "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–∑"
        mock_giveaway.owner_id = 456
        mock_giveaway.status = "active"
        
        # –ú–æ–∫–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
        mock_result = MagicMock()
        mock_result.scalars.return_value.all.return_value = [mock_giveaway]
        async def mock_execute_side_effect(*args, **kwargs):
            return mock_result
        mock_session.execute = mock_execute_side_effect
        
        # –ú–æ–∫–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        async def mock_scalar_side_effect(*args, **kwargs):
            return 10
        mock_session.scalar = mock_scalar_side_effect
        
        # –ú–æ–∫–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
        async def mock_get_side_effect(model, giveaway_id):
            if model == Giveaway and giveaway_id == 1:
                return mock_giveaway
            return None
        mock_session.get = mock_get_side_effect
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–µ—Ä–≤–∏—Å —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
        service = GiveawayService(mock_session, mock_bot)
        giveaways = await service.search_giveaways("–¢–µ—Å—Ç–æ–≤—ã–π")
        
        assert len(giveaways) == 1
        assert giveaways[0].prize_text == "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–∑"
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        giveaway_info = await service.get_giveaway_detailed_info(1)
        assert giveaway_info is not None
        assert giveaway_info["giveaway"].id == 1
        assert giveaway_info["participant_count"] == 10
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_broadcast_section_e2e(mock_bot, mock_session, admin_user):
    """
    E2E —Ç–µ—Å—Ç: —Ä–∞–∑–¥–µ–ª —Ä–∞—Å—Å—ã–ª–∫–∏
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –ú–æ–∫–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏
        mock_user1 = MagicMock(spec=User)
        mock_user1.user_id = 111
        mock_user2 = MagicMock(spec=User)
        mock_user2.user_id = 222
        
        mock_result = MagicMock()
        mock_result.scalars.return_value.all.return_value = [mock_user1, mock_user2]
        mock_session.execute.return_value = mock_result
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–µ—Ä–≤–∏—Å —Ä–∞—Å—Å—ã–ª–∫–∏
        service = BroadcastService(mock_bot, mock_session)
        
        # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é —Ä–∞—Å—Å—ã–ª–∫—É
        broadcast = await service.create_broadcast(
            message_text="–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",
            admin_id=123
        )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–∞—Å—Å—ã–ª–∫–∞ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞
        assert broadcast is not None
        
        # –ú–æ–∫–∞–µ–º —É—Å–ø–µ—à–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π
        mock_bot.send_message = AsyncMock(return_value=MagicMock())
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–µ—Ç–æ–¥—ã –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–µ –≤—ã–∑—ã–≤–∞—é—Ç –æ—à–∏–±–æ–∫
        # (–≤ —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –æ–Ω–∏ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º)
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_admin_navigation_flow(mock_bot, mock_session, admin_user):
    """
    E2E —Ç–µ—Å—Ç: –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ –æ—Å–Ω–æ–≤–Ω—ã–º —Ä–∞–∑–¥–µ–ª–∞–º –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
        from keyboards.admin_keyboards import get_main_admin_menu_keyboard
        from keyboards.admin_stats_keyboards import get_stats_menu_keyboard
        from keyboards.admin_users_keyboards import get_users_menu_keyboard
        from keyboards.admin_giveaways_keyboards import get_giveaways_menu_keyboard
        from keyboards.admin_broadcast_keyboards import get_broadcast_menu_keyboard
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
        main_menu = get_main_admin_menu_keyboard()
        stats_menu = get_stats_menu_keyboard()
        users_menu = get_users_menu_keyboard()
        giveaways_menu = get_giveaways_menu_keyboard()
        broadcast_menu = get_broadcast_menu_keyboard()
        
        assert main_menu is not None
        assert stats_menu is not None
        assert users_menu is not None
        assert giveaways_menu is not None
        assert broadcast_menu is not None
        
        # –ò–º–∏—Ç–∏—Ä—É–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é —á–µ—Ä–µ–∑ callback'–∏
        callback = MagicMock(spec=CallbackQuery)
        callback.from_user = admin_user
        callback.message = MagicMock()
        callback.message.edit_text = AsyncMock()
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        from handlers.admin.stats_handlers import show_stats_menu
        from handlers.admin.users_handlers import show_users_menu
        from handlers.admin.giveaways_handlers import show_giveaways_menu
        from handlers.admin.broadcast_handlers import show_broadcast_menu
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–∑—ã–≤–∞—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
        callback.data = "admin_stats"
        await show_stats_menu(callback)
        callback.message.edit_text.assert_called()
        
        callback.data = "admin_users"
        callback.message.edit_text.reset_mock()  # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–∑–æ–≤—ã –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ç–µ—Å—Ç–∞
        await show_users_menu(callback)
        callback.message.edit_text.assert_called()
        
        callback.data = "admin_giveaways"
        callback.message.edit_text.reset_mock()
        await show_giveaways_menu(callback)
        callback.message.edit_text.assert_called()
        
        callback.data = "admin_broadcast"
        callback.message.edit_text.reset_mock()
        await show_broadcast_menu(callback)
        callback.message.edit_text.assert_called()
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_admin_authorization(mock_bot, mock_session):
    """
    E2E —Ç–µ—Å—Ç: –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å —Ä–∞–∑–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
        from filters.admin_filter import IsAdmin
        
        admin_filter = IsAdmin()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        admin_user = MagicMock()
        admin_user.id = 123  # –≠—Ç–æ –∞–¥–º–∏–Ω
        
        message = MagicMock()
        message.from_user = admin_user
        
        is_admin = await admin_filter(message)
        assert is_admin is True
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–∫–∞–∑ –≤ –¥–æ—Å—Ç—É–ø–µ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        regular_user = MagicMock()
        regular_user.id = 999  # –≠—Ç–æ –Ω–µ –∞–¥–º–∏–Ω
        
        message_regular = MagicMock()
        message_regular.from_user = regular_user
        
        is_not_admin = await admin_filter(message_regular)
        assert is_not_admin is False
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_admin_rate_limiting():
    """
    E2E —Ç–µ—Å—Ç: –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤
    """
    from utils.rate_limiter import RateLimiter
    
    # –°–æ–∑–¥–∞–µ–º —Ä–µ–π—Ç-–ª–∏–º–∏—Ç–µ—Ä —Å –º–∞–ª–µ–Ω—å–∫–∏–º –æ–∫–Ω–æ–º –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    limiter = RateLimiter(max_requests=3, window=2)  # 3 –∑–∞–ø—Ä–æ—Å–∞ –∑–∞ 2 —Å–µ–∫—É–Ω–¥—ã
    user_id = 123
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–µ—Ä–≤—ã–µ 3 –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã
    assert limiter.is_allowed(user_id) == True
    assert limiter.is_allowed(user_id) == True
    assert limiter.is_allowed(user_id) == True
    
    # 4-–π –∑–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω
    assert limiter.is_allowed(user_id) == False
    
    # –ñ–¥–µ–º, –ø–æ–∫–∞ –ª–∏–º–∏—Ç –Ω–µ —Å–±—Ä–æ—Å–∏—Ç—Å—è
    import time
    time.sleep(2)
    
    # –¢–µ–ø–µ—Ä—å –∑–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–Ω–æ–≤–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω
    assert limiter.is_allowed(user_id) == True


@pytest.mark.asyncio
async def test_admin_access_without_permission(mock_bot, mock_session):
    """
    E2E —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫–∞–∑–∞ –≤ –¥–æ—Å—Ç—É–ø–µ –Ω–µ–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]  # –¢–æ–ª—å–∫–æ —ç—Ç–æ—Ç ID —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–æ–º
    
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        from filters.admin_filter import IsAdmin
        admin_filter = IsAdmin()
        
        regular_user = MagicMock()
        regular_user.id = 999  # –ù–µ –∞–¥–º–∏–Ω
        
        message = MagicMock()
        message.from_user = regular_user
        
        is_admin = await admin_filter(message)
        assert is_admin is False
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_invalid_user_search(mock_bot, mock_session, admin_user):
    """
    E2E —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∏—Å–∫–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –ú–æ–∫–∞–µ–º –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞
        mock_result = MagicMock()
        mock_result.scalars.return_value.all.return_value = []
        async def mock_execute_side_effect(*args, **kwargs):
            return mock_result
        mock_session.execute = mock_execute_side_effect
        
        service = UserService(mock_session)
        users = await service.search_users("nonexistent_user")
        
        assert len(users) == 0
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_invalid_giveaway_search(mock_bot, mock_session, admin_user):
    """
    E2E —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∏—Å–∫–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –ú–æ–∫–∞–µ–º –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞
        mock_result = MagicMock()
        mock_result.scalars.return_value.all.return_value = []
        async def mock_execute_side_effect(*args, **kwargs):
            return mock_result
        mock_session.execute = mock_execute_side_effect
        
        service = GiveawayService(mock_session, mock_bot)
        giveaways = await service.search_giveaways("nonexistent_giveaway")
        
        assert len(giveaways) == 0
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_user_info_nonexistent_user(mock_bot, mock_session, admin_user):
    """
    E2E —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –ú–æ–∫–∞–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async def mock_get_side_effect(model, user_id):
            return None  # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
        mock_session.get = mock_get_side_effect
        
        service = UserService(mock_session)
        user_info = await service.get_user_detailed_info(999999)
        
        assert user_info is None
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_giveaway_info_nonexistent_giveaway(mock_bot, mock_session, admin_user):
    """
    E2E —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º —Ä–æ–∑—ã–≥—Ä—ã—à–µ
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –ú–æ–∫–∞–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
        async def mock_get_side_effect(model, giveaway_id):
            return None  # –†–æ–∑—ã–≥—Ä—ã—à –Ω–µ –Ω–∞–π–¥–µ–Ω
        mock_session.get = mock_get_side_effect
        
        service = GiveawayService(mock_session, mock_bot)
        giveaway_info = await service.get_giveaway_detailed_info(999999)
        
        assert giveaway_info is None
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_toggle_premium_nonexistent_user(mock_bot, mock_session, admin_user):
    """
    E2E —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–µ–º–∏—É–º–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –ú–æ–∫–∞–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async def mock_get_side_effect(model, user_id):
            return None  # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
        mock_session.get = mock_get_side_effect
        
        service = UserService(mock_session)
        result = await service.toggle_premium_status(999999, True)
        
        assert result is False
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_force_finish_nonexistent_giveaway(mock_bot, mock_session, admin_user):
    """
    E2E —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –ú–æ–∫–∞–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
        async def mock_get_side_effect(model, giveaway_id):
            return None  # –†–æ–∑—ã–≥—Ä—ã—à –Ω–µ –Ω–∞–π–¥–µ–Ω
        mock_session.get = mock_get_side_effect
        
        service = GiveawayService(mock_session, mock_bot)
        # –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –º–µ—Ç–æ–¥ –Ω–µ –ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–º—É —Ä–æ–∑—ã–≥—Ä—ã—à—É
        # –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ force_finish_giveaway –≤—ã–∑—ã–≤–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ game_actions,
        # –Ω–æ –º—ã –Ω–µ –º–æ–∂–µ–º –µ–µ –≤—ã–∑–≤–∞—Ç—å –≤ —Ç–µ—Å—Ç–µ –∏–∑-–∑–∞ –∏–º–ø–æ—Ä—Ç–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
        # –ü–æ—ç—Ç–æ–º—É –ø—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –º–µ—Ç–æ–¥ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–π –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö
        try:
            result = await service.force_finish_giveaway(999999, admin_user.id)
            # –ú–µ—Ç–æ–¥ –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å False –≤ —Å–ª—É—á–∞–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –º–æ–¥—É–ª—è –∏–ª–∏ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
            assert result is False or result is True  # –ü—Ä–∏–Ω–∏–º–∞–µ–º –ª—é–±–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –Ω–æ –±–µ–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
        except Exception as e:
            # –ï—Å–ª–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∫–∞–∫–∞—è-—Ç–æ –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞, —ç—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞
            assert False, f"Unexpected error: {e}"
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_invalid_callback_data(mock_bot, mock_session, admin_user):
    """
    E2E —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö callback –¥–∞–Ω–Ω—ã—Ö
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –°–æ–∑–¥–∞–µ–º callback —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        callback = MagicMock(spec=CallbackQuery)
        callback.data = "invalid_callback_data_structure"
        callback.from_user = admin_user
        callback.message = MagicMock()
        callback.message.edit_text = AsyncMock()
        callback.answer = AsyncMock()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–µ –ø–∞–¥–∞—é—Ç –ø—Ä–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        # (—Ä–µ–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –±—É–¥—É—Ç –ø–æ–∑–∂–µ, –Ω–æ –º—ã –ø—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –Ω–µ –≤–æ–∑–Ω–∏–∫–∞—é—Ç)
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_rate_limit_exceeded(mock_bot, mock_session, admin_user):
    """
    E2E —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
    """
    from utils.rate_limiter import RateLimiter
    
    # –°–æ–∑–¥–∞–µ–º —Ä–µ–π—Ç-–ª–∏–º–∏—Ç–µ—Ä —Å –º–∞–ª–µ–Ω—å–∫–∏–º –ª–∏–º–∏—Ç–æ–º –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    limiter = RateLimiter(max_requests=1, window=1)  # 1 –∑–∞–ø—Ä–æ—Å –≤ —Å–µ–∫—É–Ω–¥—É
    user_id = 123
    
    # –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–π—Ç–∏
    assert limiter.is_allowed(user_id) is True
    
    # –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω
    assert limiter.is_allowed(user_id) is False


@pytest.mark.asyncio
async def test_empty_broadcast_message(mock_bot, mock_session, admin_user):
    """
    E2E —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∏ —Å –ø—É—Å—Ç—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–µ—Ä–≤–∏—Å —Ä–∞—Å—Å—ã–ª–∫–∏ —Å –ø—É—Å—Ç—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
        service = BroadcastService(mock_bot, mock_session)
        
        # –î–∞–∂–µ —Å –ø—É—Å—Ç—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º, —Ä–∞—Å—Å—ã–ª–∫–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ–∑–¥–∞—Ç—å—Å—è
        broadcast = await service.create_broadcast(
            message_text="",
            admin_id=123
        )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–∞—Å—Å—ã–ª–∫–∞ —Å–æ–∑–¥–∞–ª–∞—Å—å
        assert broadcast is not None
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_broadcast_with_special_characters(mock_bot, mock_session, admin_user):
    """
    E2E —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ —Å–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        special_text = "–¢–µ—Å—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤: @#$%^&*()_+-=[]{}|;:,.<>? —Ç–µ—Å—Ç"
        
        service = BroadcastService(mock_bot, mock_session)
        broadcast = await service.create_broadcast(
            message_text=special_text,
            admin_id=123
        )
        
        assert broadcast is not None
        assert broadcast.message_text == special_text
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_user_search_with_sql_injection_attempt(mock_bot, mock_session, admin_user):
    """
    E2E —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–æ–ø—ã—Ç–∫–æ–π SQL-–∏–Ω—ä–µ–∫—Ü–∏–∏
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –ü–æ–ø—ã—Ç–∫–∞ SQL-–∏–Ω—ä–µ–∫—Ü–∏–∏
        injection_attempt = "'; DROP TABLE users; --"
        
        # –ú–æ–∫–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
        mock_result = MagicMock()
        mock_result.scalars.return_value.all.return_value = []
        async def mock_execute_side_effect(*args, **kwargs):
            return mock_result
        mock_session.execute = mock_execute_side_effect
        
        service = UserService(mock_session)
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–∏—Å –Ω–µ –ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∏–Ω—ä–µ–∫—Ü–∏–∏
        users = await service.search_users(injection_attempt)
        
        # –†–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º, –Ω–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—à–∏–±–æ–∫
        assert isinstance(users, list)
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_admin_panel_with_long_input(mock_bot, mock_session, admin_user):
    """
    E2E —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω–æ–≥–æ –≤–≤–æ–¥–∞
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –û—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
        long_text = "A" * 10000  # 10,000 —Å–∏–º–≤–æ–ª–æ–≤
        
        # –ú–æ–∫–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
        mock_result = MagicMock()
        mock_result.scalars.return_value.all.return_value = []
        async def mock_execute_side_effect(*args, **kwargs):
            return mock_result
        mock_session.execute = mock_execute_side_effect
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –¥–ª–∏–Ω–Ω–æ–º –≤–≤–æ–¥–µ
        service = UserService(mock_session)
        # –≠—Ç–æ –º–æ–∂–µ—Ç –Ω–µ –≤–µ—Ä–Ω—É—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –Ω–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –æ—à–∏–±–∫–∏
        users = await service.search_users(long_text)
        
        assert isinstance(users, list)
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_admin_multiple_simultaneous_requests(mock_bot, mock_session, admin_user):
    """
    E2E —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    """
    import asyncio
    from utils.rate_limiter import RateLimiter
    
    # –°–æ–∑–¥–∞–µ–º –ª–∏–º–∏—Ç–µ—Ä —Å –º–∞–ª–µ–Ω—å–∫–∏–º –ª–∏–º–∏—Ç–æ–º
    limiter = RateLimiter(max_requests=2, window=1)
    user_id = 123
    
    async def make_request():
        return limiter.is_allowed(user_id)
    
    # –î–µ–ª–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
    tasks = [make_request() for _ in range(5)]
    results = await asyncio.gather(*tasks)
    
    # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–æ —Ç–æ–ª—å–∫–æ 2 –∑–∞–ø—Ä–æ—Å–∞ –∏–∑ 5
    allowed_count = sum(results)
    assert allowed_count <= 2


@pytest.mark.asyncio
async def test_giveaway_finish_with_invalid_id(mock_bot, mock_session, admin_user):
    """
    E2E —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ —Å –Ω–µ–≤–µ—Ä–Ω—ã–º ID
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        service = GiveawayService(mock_session, mock_bot)
        
        # –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–æ–∑—ã–≥—Ä—ã—à —Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º ID
        # –ü–æ—Å–∫–æ–ª—å–∫—É —Ä–µ–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –≤—ã–∑–æ–≤–∞ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ game_actions,
        # –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –≤—ã–∑–æ–≤ –Ω–µ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –∏—Å–∫–ª—é—á–µ–Ω–∏—é
        try:
            result = await service.force_finish_giveaway(-1, admin_user.id)
            # –ü—Ä–∏–Ω–∏–º–∞–µ–º –ª—é–±–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –Ω–æ –±–µ–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
        except NotImplementedError:
            # –ï—Å–ª–∏ –º–µ—Ç–æ–¥ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω, —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∞
            pass
        except Exception as e:
            # –ï—Å–ª–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∫–∞–∫–∞—è-—Ç–æ –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞, —ç—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞
            assert False, f"Unexpected error: {e}"
        
        # –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–æ–∑—ã–≥—Ä—ã—à —Å –æ—á–µ–Ω—å –±–æ–ª—å—à–∏–º ID
        try:
            result = await service.force_finish_giveaway(999999999, admin_user.id)
            # –ü—Ä–∏–Ω–∏–º–∞–µ–º –ª—é–±–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –Ω–æ –±–µ–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
        except NotImplementedError:
            # –ï—Å–ª–∏ –º–µ—Ç–æ–¥ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω, —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∞
            pass
        except Exception as e:
            # –ï—Å–ª–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∫–∞–∫–∞—è-—Ç–æ –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞, —ç—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞
            assert False, f"Unexpected error: {e}"
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_user_premium_toggle_with_invalid_id(mock_bot, mock_session, admin_user):
    """
    E2E —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–µ–º–∏—É–º–∞ —Å –Ω–µ–≤–µ—Ä–Ω—ã–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        service = UserService(mock_session)
        
        # –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –ø—Ä–µ–º–∏—É–º —Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º ID
        result = await service.toggle_premium_status(-1, True)
        assert result is False
        
        # –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –ø—Ä–µ–º–∏—É–º —Å –æ—á–µ–Ω—å –±–æ–ª—å—à–∏–º ID
        result = await service.toggle_premium_status(999999999, True)
        assert result is False
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_broadcast_to_zero_users(mock_bot, mock_session, admin_user):
    """
    E2E —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏, –∫–æ–≥–¥–∞ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –ú–æ–∫–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        mock_result = MagicMock()
        mock_result.scalars.return_value.all.return_value = []
        async def mock_execute_side_effect(*args, **kwargs):
            return mock_result
        mock_session.execute = mock_execute_side_effect
        
        service = BroadcastService(mock_bot, mock_session)
        broadcast = await service.create_broadcast(
            message_text="–¢–µ—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏",
            admin_id=123
        )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–∞—Å—Å—ã–ª–∫–∞ —Å–æ–∑–¥–∞–ª–∞—Å—å
        assert broadcast is not None
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_admin_access_with_edge_case_user_id(mock_bot, mock_session):
    """
    E2E —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å –ø–æ–≥—Ä–∞–Ω–∏—á–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ ID
    """
    original_admin_ids = config.ADMIN_IDS
    
    try:
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –≤–æ–∑–º–æ–∂–Ω—ã–º ID
        config.ADMIN_IDS = [2147483647]  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è 32-–±–∏—Ç–Ω–æ–≥–æ —Ü–µ–ª–æ–≥–æ
        
        from filters.admin_filter import IsAdmin
        admin_filter = IsAdmin()
        
        admin_user = MagicMock()
        admin_user.id = 2147483647
        
        message = MagicMock()
        message.from_user = admin_user
        
        is_admin = await admin_filter(message)
        assert is_admin is True
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –≤—ã—Å–æ–∫–∏–º ID
        regular_user = MagicMock()
        regular_user.id = 2147483646
        
        message_regular = MagicMock()
        message_regular.from_user = regular_user
        
        is_not_admin = await admin_filter(message_regular)
        assert is_not_admin is False
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_giveaway_search_with_special_chars(mock_bot, mock_session, admin_user):
    """
    E2E —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∏—Å–∫–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π —Å–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –ú–æ–∫–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
        mock_result = MagicMock()
        mock_result.scalars.return_value.all.return_value = []
        async def mock_execute_side_effect(*args, **kwargs):
            return mock_result
        mock_session.execute = mock_execute_side_effect
        
        service = GiveawayService(mock_session, mock_bot)
        
        # –ü–æ–∏—Å–∫ —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏
        special_queries = [
            "<script>alert('test')</script>",
            "test\" onload=\"alert('xss')",
            "DROP TABLE giveaways;",
            "SELECT * FROM giveaways WHERE 1=1",
            "—Ç–µ—Å—Ç & < > \" ' —Ç–µ—Å—Ç",
            "üéâüéäüéÅüéà test üéìüèÜüèÖü•á"
        ]
        
        for query in special_queries:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–∏—Å–∫ –Ω–µ –ø–∞–¥–∞–µ—Ç —Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏
            giveaways = await service.search_giveaways(query)
            assert isinstance(giveaways, list)
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_broadcast_unicode_emoji_text(mock_bot, mock_session, admin_user):
    """
    E2E —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ —Å —Ç–µ–∫—Å—Ç–æ–º —Å–æ–¥–µ—Ä–∂–∞—â–∏–º —é–Ω–∏–∫–æ–¥ –∏ —ç–º–æ–¥–∑–∏
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        unicode_text = "üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! üéÅ –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ üíé –∞–ª–º–∞–∑—ã! üèÜ –ü—Ä–∏–∑ üéä –£—Ä–∞–∞–∞–∞! üåü‚ú®üí´‚≠ê"
        
        service = BroadcastService(mock_bot, mock_session)
        broadcast = await service.create_broadcast(
            message_text=unicode_text,
            admin_id=123
        )
        
        assert broadcast is not None
        assert broadcast.message_text == unicode_text
        
    finally:
        config.ADMIN_IDS = original_admin_ids


if __name__ == "__main__":
    pytest.main([__file__, "-v"])=== ./tests/test_giveaway_errors.py ===
import pytest
import time
from datetime import datetime, timedelta
from unittest.mock import AsyncMock, MagicMock, patch
from sqlalchemy.ext.asyncio import AsyncSession
from aiogram import Bot
from aiogram.exceptions import TelegramBadRequest
from aiogram.methods import SendMessage
from database.models.giveaway import Giveaway
from database.models.user import User
from database.models.participant import Participant
from database.requests.giveaway_repo import create_giveaway
from core.services.message_service import MessageHandler


@pytest.mark.asyncio
class TestGiveawayErrors:
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ –æ —Ä–æ–∑—ã–≥—Ä—ã—à–∞—Ö"""

    async def test_error_when_user_has_blocked_bot(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç –æ—à–∏–±–∫–∏, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞ –∏ –Ω–µ –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ–±–µ–¥–µ"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456789 + int(time.time()) % 100000
        channel_id = -1001234567890
        message_id = 133 + int(time.time()) % 1000
        prize = "–ü—Ä–∏–∑ –¥–ª—è —Ç–µ—Å—Ç–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏"
        winners_count = 1
        end_time = datetime.now() - timedelta(hours=1)
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners_count, end_time
        )
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º ID
        winner_user_id = 987654329 + int(time.time()) % 1000000
        winner_username = f"blocked_user_{int(time.time())}"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        existing_user = await async_session.get(User, winner_user_id)
        if existing_user:
            await async_session.delete(existing_user)
            await async_session.commit()
        
        # –°–æ–∑–¥–∞–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –∫–∞–∫ —É—á–∞—Å—Ç–Ω–∏–∫–∞
        user = User(
            user_id=winner_user_id,
            username=winner_username,
            full_name="Blocked User",
            is_premium=False
        )
        async_session.add(user)
        
        participant = Participant(
            user_id=winner_user_id,
            giveaway_id=giveaway_id
        )
        async_session.add(participant)
        
        await async_session.commit()
        
        # –ú–æ–∫–∏—Ä—É–µ–º –±–æ—Ç–∞ —Å –≤—ã–±—Ä–æ—Å–æ–º –∏—Å–∫–ª—é—á–µ–Ω–∏—è, –∫–∞–∫ –µ—Å–ª–∏ –±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞
        with patch('aiogram.Bot.send_message') as mock_send_message:
            mock_send_message.side_effect = TelegramBadRequest("Forbidden: bot was blocked by the user")
            
            bot = AsyncMock(spec=Bot)
            bot.send_message = mock_send_message
            
            # –ü—ã—Ç–∞–µ–º—Å—è —É–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è - –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
            notification_text = f"üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ '{prize}' –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ!"
            
            with pytest.raises(TelegramBadRequest):
                await bot.send_message(winner_user_id, notification_text)

    async def test_error_when_creator_has_blocked_bot(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç –æ—à–∏–±–∫–∏, –∫–æ–≥–¥–∞ —Å–æ–∑–¥–∞—Ç–µ–ª—å —Ä–æ–∑—ã–≥—Ä—ã—à–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞ –∏ –Ω–µ –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456790 + int(time.time()) % 100000
        channel_id = -1001234567890
        message_id = 134 + int(time.time()) % 1000
        prize = "–ü—Ä–∏–∑ –¥–ª—è —Ç–µ—Å—Ç–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å–æ–∑–¥–∞—Ç–µ–ª—è"
        winners_count = 1
        end_time = datetime.now() - timedelta(hours=1)
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners_count, end_time
        )
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º ID
        winner_user_id = 987654330 + int(time.time()) % 1000000
        winner_username = f"winner_user_{int(time.time())}"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        existing_user = await async_session.get(User, winner_user_id)
        if existing_user:
            await async_session.delete(existing_user)
            await async_session.commit()
        
        # –°–æ–∑–¥–∞–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –∫–∞–∫ —É—á–∞—Å—Ç–Ω–∏–∫–∞
        user = User(
            user_id=winner_user_id,
            username=winner_username,
            full_name="Winner User",
            is_premium=False
        )
        async_session.add(user)
        
        participant = Participant(
            user_id=winner_user_id,
            giveaway_id=giveaway_id
        )
        async_session.add(participant)
        
        await async_session.commit()
        
        # –ú–æ–∫–∏—Ä—É–µ–º –±–æ—Ç–∞ —Å –≤—ã–±—Ä–æ—Å–æ–º –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è —Å–æ–∑–¥–∞—Ç–µ–ª—è
        with patch('aiogram.Bot.send_message') as mock_send_message:
            # –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–±–µ–¥–∏—Ç–µ–ª—è (—É—Å–ø–µ—à–Ω—ã–π), –≤—Ç–æ—Ä–æ–π –¥–ª—è —Å–æ–∑–¥–∞—Ç–µ–ª—è (–æ—à–∏–±–∫–∞)
            send_message_method = SendMessage(chat_id=owner_id, text="test")
            mock_send_message.side_effect = [AsyncMock(), TelegramBadRequest(method=send_message_method, message="Forbidden: bot was blocked by the user")]
            
            bot = AsyncMock(spec=Bot)
            bot.send_message = mock_send_message
            
            # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
            notification_text = f"üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ '{prize}' –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ!"
            await bot.send_message(winner_user_id, notification_text)
            
            # –ü—ã—Ç–∞–µ–º—Å—è —É–≤–µ–¥–æ–º–∏—Ç—å —Å–æ–∑–¥–∞—Ç–µ–ª—è - –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
            creator_notification = f"üèÜ –í –≤–∞—à–µ–º —Ä–æ–∑—ã–≥—Ä—ã—à–µ '{prize}' –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –ø–æ–±–µ–¥–∏—Ç–µ–ª—å!\n\n–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: @{winner_username} (ID: {winner_user_id})"
            
            with pytest.raises(TelegramBadRequest):
                await bot.send_message(owner_id, creator_notification)

    async def test_error_with_invalid_user_id(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç –æ—à–∏–±–∫–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º ID"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456791 + int(time.time()) % 100000
        channel_id = -1001234567890
        message_id = 135 + int(time.time()) % 1000
        prize = "–ü—Ä–∏–∑ –¥–ª—è —Ç–µ—Å—Ç–∞ –Ω–µ–≤–µ—Ä–Ω–æ–≥–æ ID"
        winners_count = 1
        end_time = datetime.now() - timedelta(hours=1)
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners_count, end_time
        )
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≤–µ–¥–æ–º–æ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        invalid_user_id = 0  # –ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π ID
        
        # –ú–æ–∫–∏—Ä—É–µ–º –±–æ—Ç–∞ —Å –≤—ã–±—Ä–æ—Å–æ–º –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–≥–æ ID
        with patch('aiogram.Bot.send_message') as mock_send_message:
            from aiogram.methods import SendMessage
            send_message_method = SendMessage(chat_id=invalid_user_id, text="test")
            mock_send_message.side_effect = TelegramBadRequest(method=send_message_method, message="Bad Request: chat not found")
            
            bot = AsyncMock(spec=Bot)
            bot.send_message = mock_send_message
            
            # –ü—ã—Ç–∞–µ–º—Å—è —É–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º ID
            notification_text = f"üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ '{prize}' –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ!"
            
            with pytest.raises(TelegramBadRequest):
                await bot.send_message(invalid_user_id, notification_text)

    async def test_error_with_long_message(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç –æ—à–∏–±–∫–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456792 + int(time.time()) % 100000
        channel_id = -1001234567890
        message_id = 136 + int(time.time()) % 1000
        prize = "–ü—Ä–∏–∑ –¥–ª—è —Ç–µ—Å—Ç–∞ –¥–ª–∏–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è"
        winners_count = 1
        end_time = datetime.now() - timedelta(hours=1)
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners_count, end_time
        )
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º ID
        winner_user_id = 987654331 + int(time.time()) % 1000000
        winner_username = f"long_msg_user_{int(time.time())}"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        existing_user = await async_session.get(User, winner_user_id)
        if existing_user:
            await async_session.delete(existing_user)
            await async_session.commit()
        
        # –°–æ–∑–¥–∞–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –∫–∞–∫ —É—á–∞—Å—Ç–Ω–∏–∫–∞
        user = User(
            user_id=winner_user_id,
            username=winner_username,
            full_name="Long Message User",
            is_premium=False
        )
        async_session.add(user)
        
        participant = Participant(
            user_id=winner_user_id,
            giveaway_id=giveaway_id
        )
        async_session.add(participant)
        
        await async_session.commit()
        
        # –°–æ–∑–¥–∞–µ–º –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        long_message = "üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ '" + prize + "' –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ! " + "–≠—Ç–æ –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. " * 1000
        
        # –ú–æ–∫–∏—Ä—É–µ–º –±–æ—Ç–∞ —Å –≤—ã–±—Ä–æ—Å–æ–º –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        with patch('aiogram.Bot.send_message') as mock_send_message:
            from aiogram.methods import SendMessage
            send_message_method = SendMessage(chat_id=winner_user_id, text="test")
            mock_send_message.side_effect = TelegramBadRequest(method=send_message_method, message="Bad Request: message is too long")
            
            bot = AsyncMock(spec=Bot)
            bot.send_message = mock_send_message
            
            # –ü—ã—Ç–∞–µ–º—Å—è —É–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è —Å –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
            with pytest.raises(TelegramBadRequest):
                await bot.send_message(winner_user_id, long_message)

    async def test_error_with_missing_giveaway_data(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç –æ—à–∏–±–∫–∏ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ —Ä–æ–∑—ã–≥—Ä—ã—à–µ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456793 + int(time.time()) % 100000
        channel_id = -1001234567890
        message_id = 137 + int(time.time()) % 1000
        prize = None  # –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–∏–∑
        winners_count = 1
        end_time = datetime.now() - timedelta(hours=1)
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞ —Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize or "", winners_count, end_time
        )
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º ID
        winner_user_id = 987654332 + int(time.time()) % 1000000
        winner_username = f"missing_data_user_{int(time.time())}"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        existing_user = await async_session.get(User, winner_user_id)
        if existing_user:
            await async_session.delete(existing_user)
            await async_session.commit()
        
        # –°–æ–∑–¥–∞–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –∫–∞–∫ —É—á–∞—Å—Ç–Ω–∏–∫–∞
        user = User(
            user_id=winner_user_id,
            username=winner_username,
            full_name="Missing Data User",
            is_premium=False
        )
        async_session.add(user)
        
        participant = Participant(
            user_id=winner_user_id,
            giveaway_id=giveaway_id
        )
        async_session.add(participant)
        
        await async_session.commit()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–æ–∂–µ–º –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ —Ä–æ–∑—ã–≥—Ä—ã—à–µ
        giveaway = await async_session.get(Giveaway, giveaway_id)
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–∞–∂–µ —Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        message_for_user = f"üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ {'–ø—Ä–∏–∑' if not prize else prize} –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ!"
        
        # –ú–æ–∫–∏—Ä—É–µ–º –±–æ—Ç–∞
        with patch('aiogram.Bot.send_message') as mock_send_message:
            mock_send_message.return_value = AsyncMock()
            
            bot = AsyncMock(spec=Bot)
            bot.send_message = mock_send_message
            
            # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
            await bot.send_message(winner_user_id, message_for_user)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
            mock_send_message.assert_called_once_with(winner_user_id, message_for_user)=== ./tests/test_broadcast_timepicker_integration.py ===
import pytest
from datetime import datetime
from unittest.mock import AsyncMock, MagicMock, patch
from aiogram.fsm.context import FSMContext
from aiogram.types import CallbackQuery, Message, User, Chat
from sqlalchemy.ext.asyncio import AsyncSession

from handlers.admin.broadcast_handlers import (
    start_schedule_broadcast,
    select_broadcast_date,
    navigate_broadcast_calendar,
    select_broadcast_time,
    switch_to_manual_time_input,
    process_manual_time_input,
    BroadcastState
)
from keyboards.admin_broadcast_time_keyboards import (
    get_broadcast_date_picker_keyboard,
    get_broadcast_time_picker_keyboard,
    get_manual_time_input_keyboard
)


class TestBroadcastTimePickerIntegration:
    """–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞—Å—Å—ã–ª–∫–∏"""

    @pytest.mark.asyncio
    async def test_full_schedule_broadcast_flow_with_date_picking(self):
        """–ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –ø–æ—Ç–æ–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∏ —Å –≤—ã–±–æ—Ä–æ–º –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫–∏"""
        
        # –°–æ–∑–¥–∞–µ–º –º–æ–∫–∏
        callback = AsyncMock(spec=CallbackQuery)
        callback.data = "admin_schedule_broadcast"
        callback.from_user = User(id=12345, is_bot=False, first_name="TestAdmin")
        callback.message = AsyncMock()
        callback.message.edit_text = AsyncMock()
        callback.answer = AsyncMock()
        
        state = AsyncMock(spec=FSMContext)
        state.set_state = AsyncMock()
        state.get_data = AsyncMock(return_value={
            'broadcast_data': {
                'text': 'Test broadcast message',
                'photo': None,
                'video': None,
                'document': None
            }
        })
        state.clear = AsyncMock()
        
        session = AsyncMock(spec=AsyncSession)
        bot = AsyncMock()
        
        # 1. –ù–∞—á–∏–Ω–∞–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏
        await start_schedule_broadcast(callback, state)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –Ω–∞ –æ–∂–∏–¥–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã
        state.set_state.assert_called_with(BroadcastState.waiting_for_schedule_date)
        
        # 2. –í—ã–±–∏—Ä–∞–µ–º –¥–∞—Ç—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, 25 –¥–µ–∫–∞–±—Ä—è 2024 –≥–æ–¥–∞)
        callback.data = "admin_broadcast_date_set:2024:12:25"
        callback.message.edit_text.reset_mock()  # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–∑–æ–≤—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞
        state.set_state.reset_mock()
        
        await select_broadcast_date(callback, state)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –Ω–∞ –æ–∂–∏–¥–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏
        state.set_state.assert_called_with(BroadcastState.waiting_for_schedule_time)
        
        # 3. –í—ã–±–∏—Ä–∞–µ–º –≤—Ä–µ–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 15:30)
        callback.data = "admin_broadcast_time_set:2024:12:25:15:30"
        callback.message.edit_text.reset_mock()
        state.clear.reset_mock()
        
        # –ú–æ–∫ –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
        with patch('handlers.admin.broadcast_handlers.BroadcastService') as mock_service_class, \
             patch('handlers.admin.broadcast_handlers.schedule_broadcast_task') as mock_schedule_task:
            
            # –°–æ–∑–¥–∞–µ–º –º–æ–∫ –¥–ª—è —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ —Å–µ—Ä–≤–∏—Å–∞
            mock_service_instance = AsyncMock()
            mock_broadcast = MagicMock()
            mock_broadcast.id = 999
            mock_service_instance.create_broadcast.return_value = mock_broadcast
            mock_service_class.return_value = mock_service_instance
            
            await select_broadcast_time(callback, state, session, bot)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–∞—Å—Å—ã–ª–∫–∞ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞
        mock_service_instance.create_broadcast.assert_called_once()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–¥–∞—á–∞ –±—ã–ª–∞ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞
        mock_schedule_task.assert_called_once()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—á–∏—â–µ–Ω–æ
        state.clear.assert_called_once()

    @pytest.mark.asyncio
    async def test_full_schedule_broadcast_flow_with_manual_input(self):
        """–ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –ø–æ—Ç–æ–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∏ —Å —Ä—É—á–Ω—ã–º –≤–≤–æ–¥–æ–º –≤—Ä–µ–º–µ–Ω–∏"""
        
        # –°–æ–∑–¥–∞–µ–º –º–æ–∫–∏
        callback = AsyncMock(spec=CallbackQuery)
        callback.data = "admin_schedule_broadcast"
        callback.from_user = User(id=12345, is_bot=False, first_name="TestAdmin")
        callback.message = AsyncMock()
        callback.message.edit_text = AsyncMock()
        callback.answer = AsyncMock()
        
        message = AsyncMock(spec=Message)
        message.text = "2024-12-25 15:30"
        message.from_user = User(id=12345, is_bot=False, first_name="TestAdmin")
        message.answer = AsyncMock()
        
        state = AsyncMock(spec=FSMContext)
        state.set_state = AsyncMock()
        state.get_data = AsyncMock(return_value={
            'broadcast_data': {
                'text': 'Test broadcast message',
                'photo': None,
                'video': None,
                'document': None
            }
        })
        state.clear = AsyncMock()
        
        session = AsyncMock(spec=AsyncSession)
        bot = AsyncMock()
        
        # 1. –ù–∞—á–∏–Ω–∞–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏
        await start_schedule_broadcast(callback, state)
        
        # 2. –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –∫ —Ä—É—á–Ω–æ–º—É –≤–≤–æ–¥—É –≤—Ä–µ–º–µ–Ω–∏
        callback.data = "admin_broadcast_manual_time"
        callback.message.edit_text.reset_mock()
        state.set_state.reset_mock()
        
        await switch_to_manual_time_input(callback, state)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –Ω–∞ –æ–∂–∏–¥–∞–Ω–∏–µ —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞ –≤—Ä–µ–º–µ–Ω–∏
        state.set_state.assert_called_with(BroadcastState.waiting_for_manual_schedule_time)
        
        # 3. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ –≤—Ä–µ–º–µ–Ω–∏
        message.text = "2024-12-25 15:30"
        state.clear.reset_mock()
        
        with patch('handlers.admin.broadcast_handlers.BroadcastService') as mock_service_class, \
             patch('handlers.admin.broadcast_handlers.schedule_broadcast_task') as mock_schedule_task:
            
            mock_service_instance = AsyncMock()
            mock_broadcast = MagicMock()
            mock_broadcast.id = 999
            mock_service_instance.create_broadcast.return_value = mock_broadcast
            mock_service_class.return_value = mock_service_instance
            
            await process_manual_time_input(message, state, session, bot)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–∞—Å—Å—ã–ª–∫–∞ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞
        mock_service_instance.create_broadcast.assert_called_once()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–¥–∞—á–∞ –±—ã–ª–∞ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞
        mock_schedule_task.assert_called_once()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—á–∏—â–µ–Ω–æ
        state.clear.assert_called_once()

    @pytest.mark.asyncio
    async def test_keyboard_generation_functions(self):
        """–¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏"""
        
        # –¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã
        keyboard = get_broadcast_date_picker_keyboard()
        assert keyboard is not None
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–Ω–æ–ø–∫–∏
        assert hasattr(keyboard, 'inline_keyboard')
        assert len(keyboard.inline_keyboard) > 0
        
        # –¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏ (–¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –¥–∞—Ç—ã)
        keyboard = get_broadcast_time_picker_keyboard(2024, 12, 25)
        assert keyboard is not None
        assert hasattr(keyboard, 'inline_keyboard')
        assert len(keyboard.inline_keyboard) > 0
        
        # –¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞
        keyboard = get_manual_time_input_keyboard()
        assert keyboard is not None
        assert hasattr(keyboard, 'inline_keyboard')
        assert len(keyboard.inline_keyboard) > 0

    @pytest.mark.asyncio
    async def test_date_navigation_functionality(self):
        """–¢–µ—Å—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –¥–∞—Ç–∞–º"""
        
        callback = AsyncMock(spec=CallbackQuery)
        callback.data = "admin_broadcast_cal_nav:2024:11"  # –ù–∞–≤–∏–≥–∞—Ü–∏—è –∫ –Ω–æ—è–±—Ä—é 2024
        callback.message = AsyncMock()
        callback.message.edit_text = AsyncMock()
        callback.answer = AsyncMock()
        
        # –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        await navigate_broadcast_calendar(callback)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –±—ã–ª–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ
        callback.message.edit_text.assert_called_once()
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤ —Ç–µ–∫—Å—Ç–µ —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±–æ—Ä–µ –¥–∞—Ç—ã
        args, kwargs = callback.message.edit_text.call_args
        assert "–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –æ—Ç–ø—Ä–∞–≤–∫–∏" in args[0]

    @pytest.mark.asyncio
    async def test_validation_past_time_prevention(self):
        """–¢–µ—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—â–µ–π –≤—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏ –≤ –ø—Ä–æ—à–ª–æ–º"""
        
        callback = AsyncMock(spec=CallbackQuery)
        # –ü—ã—Ç–∞–µ–º—Å—è –≤—ã–±—Ä–∞—Ç—å –≤—Ä–µ–º—è –≤ –ø—Ä–æ—à–ª–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1 —è–Ω–≤–∞—Ä—è 2020)
        callback.data = "admin_broadcast_time_set:2020:1:1:10:0"
        callback.answer = AsyncMock()
        callback.message = AsyncMock()
        callback.message.answer = AsyncMock()
        
        state = AsyncMock(spec=FSMContext)
        session = AsyncMock(spec=AsyncSession)
        bot = AsyncMock()
        
        # –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏ —Å –ø—Ä–æ—à–µ–¥—à–∏–º –≤—Ä–µ–º–µ–Ω–µ–º
        await select_broadcast_time(callback, state, session, bot)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±—ã–ª–æ –ø–æ–∫–∞–∑–∞–Ω–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
        callback.answer.assert_called()
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∞—Ä–≥—É–º–µ–Ω—Ç—ã —Å–æ–¥–µ—Ä–∂–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ—à–µ–¥—à–µ–º –≤—Ä–µ–º–µ–Ω–∏
        args, kwargs = callback.answer.call_args
        if 'show_alert' in kwargs:
            assert kwargs['show_alert'] is True
        if args:
            assert "–í—Ä–µ–º—è —É–∂–µ –ø—Ä–æ—à–ª–æ!" in str(args)

    @pytest.mark.asyncio
    async def test_invalid_time_format_handling(self):
        """–¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ —Ä—É—á–Ω–æ–º –≤–≤–æ–¥–µ"""
        
        message = AsyncMock(spec=Message)
        message.text = "–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏"
        message.from_user = User(id=12345, is_bot=False, first_name="TestAdmin")
        message.answer = AsyncMock()
        
        state = AsyncMock(spec=FSMContext)
        session = AsyncMock(spec=AsyncSession)
        bot = AsyncMock()
        
        # –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞ —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º
        await process_manual_time_input(message, state, session, bot)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        message.answer.assert_called()
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤—ã–∑–æ–≤ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ —Ñ–æ—Ä–º–∞—Ç–∞
        args, kwargs = message.answer.call_args
        assert "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏" in str(args[0]) if args else False=== ./tests/test_coverage_analysis.md ===
# –ê–Ω–∞–ª–∏–∑ –ø–æ–∫—Ä—ã—Ç–∏—è —Ç–µ—Å—Ç–∞–º–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏

## –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã
- [x] `test_admin_e2e.py` - E2E —Ç–µ—Å—Ç—ã –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ (28 —Ç–µ—Å—Ç–æ–≤)
- [x] `test_admin_inline_buttons.py` - —Ç–µ—Å—Ç—ã –≤—Å–µ—Ö –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–æ–∫ (8 —Ç–µ—Å—Ç–æ–≤)
- [x] `test_admin_stress.py` - –Ω–∞–≥—Ä—É–∑–æ—á–Ω—ã–µ —Ç–µ—Å—Ç—ã (6 —Ç–µ—Å—Ç–æ–≤)

## –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª, —Ç—Ä–µ–±—É—é—â–∏–π –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
- [ ] –¢–µ—Å—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö
- [ ] –¢–µ—Å—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- [ ] –¢–µ—Å—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ —Å–µ—Ç–∏ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å Telegram API
- [ ] –¢–µ—Å—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### 2. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- [ ] –¢–µ—Å—Ç—ã –∑–∞—â–∏—Ç—ã –æ—Ç SQL-–∏–Ω—ä–µ–∫—Ü–∏–π
- [ ] –¢–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ (–ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –Ω–µ-–∞–¥–º–∏–Ω—ã –Ω–µ –º–æ–≥—É—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø)
- [ ] –¢–µ—Å—Ç—ã –∑–∞—â–∏—Ç—ã –æ—Ç XSS-–∞—Ç–∞–∫
- [ ] –¢–µ—Å—Ç—ã –∑–∞—â–∏—Ç—ã –æ—Ç CSRF-–∞—Ç–∞–∫

### 3. –ì—Ä–∞–Ω–∏—á–Ω—ã–µ —É—Å–ª–æ–≤–∏—è
- [ ] –¢–µ—Å—Ç—ã —Ä–∞–±–æ—Ç—ã —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤–æ–∑–º–æ–∂–Ω—ã–º–∏ ID
- [ ] –¢–µ—Å—Ç—ã —Ä–∞–±–æ—Ç—ã —Å –ø—É—Å—Ç—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
- [ ] –¢–µ—Å—Ç—ã —Ä–∞–±–æ—Ç—ã —Å –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö
- [ ] –¢–µ—Å—Ç—ã —Ä–∞–±–æ—Ç—ã —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ —Ñ–æ—Ä–º–∞—Ç–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö

### 4. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ —Ä–∞—Å—Å—ã–ª–∫–∏
- [ ] –¢–µ—Å—Ç—ã —Ä–∞—Å—Å—ã–ª–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Ç—ã—Å—è—á–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- [ ] –¢–µ—Å—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–±–æ–µ–≤ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π
- [ ] –¢–µ—Å—Ç—ã –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫
- [ ] –¢–µ—Å—Ç—ã —Ä–∞—Å—Å—ã–ª–∫–∏ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤

### 5. –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- [ ] –¢–µ—Å—Ç—ã –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- [ ] –¢–µ—Å—Ç—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–π
- [ ] –¢–µ—Å—Ç—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Å–±–æ–µ–≤ –ë–î
- [ ] –¢–µ—Å—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–æ–≤

### 6. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏
- [ ] –¢–µ—Å—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Telegram API
- [ ] –¢–µ—Å—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç Telegram –ø—Ä–∏ –º–µ–¥–ª–µ–Ω–Ω–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏
- [ ] –¢–µ—Å—Ç—ã —Ä–∞–±–æ—Ç—ã —Å webhook'–∞–º–∏

### 7. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –¢–µ—Å—Ç—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
- [ ] –¢–µ—Å—Ç—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫
- [ ] –¢–µ—Å—Ç—ã –æ–±—ä–µ–º–∞ –ª–æ–≥–æ–≤ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ

### 8. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- [ ] –¢–µ—Å—Ç—ã —Ä–∞–±–æ—Ç—ã —Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- [ ] –¢–µ—Å—Ç—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- [ ] –¢–µ—Å—Ç—ã —Ä–∞–±–æ—Ç—ã —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### 9. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
- [ ] –¢–µ—Å—Ç—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π
- [ ] –¢–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
- [ ] –¢–µ—Å—Ç—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
- [ ] –¢–µ—Å—Ç—ã —Ä–∞–±–æ—Ç—ã —Å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–º–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–∞–º–∏

### 10. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- [ ] –¢–µ—Å—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö
- [ ] –¢–µ—Å—Ç—ã –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- [ ] –¢–µ—Å—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∞–º–∏
- [ ] –¢–µ—Å—Ç—ã –∏–º–ø–æ—Ä—Ç–∞/—ç–∫—Å–ø–æ—Ä—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
2. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞)
3. –ì—Ä–∞–Ω–∏—á–Ω—ã–µ —É—Å–ª–æ–≤–∏—è
4. –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö (–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø)

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
1. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ —Ä–∞—Å—Å—ã–ª–∫–∏
2. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
3. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π

### –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
1. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏
2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
3. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π=== ./tests/test_admin_stress.py ===
import pytest
import asyncio
from unittest.mock import AsyncMock, MagicMock, patch
from sqlalchemy.ext.asyncio import AsyncSession
from aiogram import Bot
from aiogram.types import CallbackQuery, Message
from aiogram.fsm.storage.memory import MemoryStorage

from handlers.admin.admin_router import admin_router
from services.admin_statistics_service import CachedStatisticsService
from services.admin_user_service import UserService
from services.admin_giveaway_service import GiveawayService
from services.admin_broadcast_service import BroadcastService
from database.models import User, Giveaway, Participant, Broadcast
from config import config


@pytest.fixture
def mock_bot():
    """–§–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞"""
    bot = AsyncMock(spec=Bot)
    return bot


@pytest.fixture
def mock_session():
    """–§–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
    session = AsyncMock(spec=AsyncSession)
    return session


@pytest.fixture
def admin_user():
    """–§–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    user = MagicMock()
    user.id = 123
    user.username = "admin"
    user.full_name = "Admin User"
    return user


@pytest.mark.asyncio
async def test_concurrent_admin_requests(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –ú–æ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        mock_users = []
        for i in range(50):
            mock_user = MagicMock(spec=User)
            mock_user.user_id = 100 + i
            mock_user.username = f"user{i}"
            mock_user.full_name = f"User {i}"
            mock_user.is_premium = i % 2 == 0
            mock_users.append(mock_user)
        
        # –ú–æ–∫–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
        async def mock_execute_side_effect(*args, **kwargs):
            mock_result = MagicMock()
            mock_result.scalars.return_value.all.return_value = mock_users[:10]  # –ø–µ—Ä–≤—ã–µ 10 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            return mock_result
        mock_session.execute = mock_execute_side_effect
        
        # –ú–æ–∫–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        async def mock_scalar_side_effect(*args, **kwargs):
            return len(mock_users)  # 50 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        mock_session.scalar = mock_scalar_side_effect
        
        # –ú–æ–∫–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async def mock_get_side_effect(model, user_id):
            for user in mock_users:
                if user.user_id == user_id:
                    return user
            return None
        mock_session.get = mock_get_side_effect
        
        # –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á–∏ –¥–ª—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        async def simulate_admin_action(action_number):
            callback = MagicMock(spec=CallbackQuery)
            callback.from_user = admin_user
            callback.message = MagicMock(spec=Message)
            callback.message.edit_text = AsyncMock()
            callback.answer = AsyncMock()
            
            # –†–∞–∑–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤
            actions = [
                "admin_stats",
                "admin_users",
                "admin_giveaways", 
                "admin_broadcast",
                "admin_search_user",
                "admin_list_users_1"
            ]
            
            action = actions[action_number % len(actions)]
            callback.data = action
            
            try:
                if action == "admin_stats":
                    from handlers.admin.stats_handlers import show_stats_menu
                    await show_stats_menu(callback)
                elif action == "admin_users":
                    from handlers.admin.users_handlers import show_users_menu
                    await show_users_menu(callback)
                elif action == "admin_giveaways":
                    from handlers.admin.giveaways_handlers import show_giveaways_menu
                    await show_giveaways_menu(callback)
                elif action == "admin_broadcast":
                    from handlers.admin.broadcast_handlers import show_broadcast_menu
                    await show_broadcast_menu(callback)
                elif action == "admin_search_user":
                    from handlers.admin.users_handlers import start_user_search
                    state = AsyncMock()
                    await start_user_search(callback, state)
                elif action.startswith("admin_list_users_"):
                    from handlers.admin.users_handlers import show_users_list
                    await show_users_list(callback, mock_session)
            except Exception:
                # –û—à–∏–±–∫–∏ –≤ —Ç–µ—Å—Ç–µ –¥–æ–ø—É—Å—Ç–∏–º—ã, –≥–ª–∞–≤–Ω–æ–µ —á—Ç–æ–±—ã –±–æ—Ç –Ω–µ –ø–∞–¥–∞–ª
                pass
            
            return f"Action {action_number} completed"
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º 20 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        tasks = [simulate_admin_action(i) for i in range(20)]
        results = await asyncio.gather(*tasks, return_exceptions=True)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –∑–∞–¥–∞—á–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å (–±–µ–∑ —Ñ–∞—Ç–∞–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫)
        for result in results:
            assert result or isinstance(result, Exception)
            
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_mass_user_operations(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –º–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (–∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤, –ø–æ–∏—Å–∫ –∏ —Ç.–¥.)
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –°–æ–∑–¥–∞–µ–º –±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        mock_users = []
        for i in range(100):
            mock_user = MagicMock(spec=User)
            mock_user.user_id = 1000 + i
            mock_user.username = f"mass_user_{i}"
            mock_user.full_name = f"Mass User {i}"
            mock_user.is_premium = False
            mock_users.append(mock_user)
        
        # –ú–æ–∫–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        async def mock_execute_side_effect(*args, **kwargs):
            mock_result = MagicMock()
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–∞–∑–Ω—ã–µ –Ω–∞–±–æ—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
            query_str = str(args[0])
            if 'LIMIT' in query_str.upper() and 'OFFSET' in query_str.upper():
                # –î–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ 10 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                import re
                offset_match = re.search(r'OFFSET\s+(\d+)', query_str, re.IGNORECASE)
                if offset_match:
                    offset = int(offset_match.group(1))
                    return_users = mock_users[offset:offset + 10]
                else:
                    return_users = mock_users[:10]
            else:
                return_users = mock_users
            mock_result.scalars.return_value.all.return_value = return_users
            return mock_result
        
        import re
        mock_session.execute = mock_execute_side_effect

        async def mock_scalar_side_effect(*args, **kwargs):
            return len(mock_users)  # 100 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        mock_session.scalar = mock_scalar_side_effect
        
        async def mock_get_side_effect(model, user_id):
            for user in mock_users:
                if user.user_id == user_id:
                    return user
            return None
        mock_session.get = mock_get_side_effect
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –º–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
        service = UserService(mock_session)
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        search_results = await service.search_users("mass_user")
        assert len(search_results) == 100
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–µ–º–∏—É–º–∞ –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        for i in range(0, min(10, len(mock_users)), 2):  # –¥–ª—è –ø–µ—Ä–≤—ã—Ö 10 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            result = await service.toggle_premium_status(mock_users[i].user_id, True)
            assert result is True
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö
        for i in range(0, min(5, len(mock_users))):
            user_info = await service.get_user_detailed_info(mock_users[i].user_id)
            assert user_info is not None
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
        for page in range(1, 11):  # 10 —Å—Ç—Ä–∞–Ω–∏—Ü
            users, total = await service.get_users_paginated(page=page, page_size=10)
            assert len(users) <= 10
            assert total == 100
            
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_mass_giveaway_operations(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –º–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —Ä–æ–∑—ã–≥—Ä—ã—à–∞–º–∏
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –°–æ–∑–¥–∞–µ–º –±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
        mock_giveaways = []
        for i in range(50):
            mock_giveaway = MagicMock(spec=Giveaway)
            mock_giveaway.id = 1 + i
            mock_giveaway.prize_text = f"–ü—Ä–∏–∑ {i}"
            mock_giveaway.owner_id = 1000 + i
            mock_giveaway.status = "active" if i % 2 == 0 else "finished"
            mock_giveaway.finish_time = MagicMock()
            mock_giveaway.finish_time.strftime.return_value = f"2023-01-{i+1:02d} 12:00"
            mock_giveaway.winners_count = 1
            mock_giveaways.append(mock_giveaway)
        
        # –ú–æ–∫–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        async def mock_execute_side_effect(*args, **kwargs):
            mock_result = MagicMock()
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–∞–∑–Ω—ã–µ –Ω–∞–±–æ—Ä—ã —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
            query_str = str(args[0])

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –∑–∞–ø—Ä–æ—Å COUNT (–¥–ª—è –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞)
            if 'func.count' in query_str.lower() or 'count(' in query_str.lower():
                # –î–ª—è –∑–∞–ø—Ä–æ—Å–∞ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—â–µ–µ —á–∏—Å–ª–æ
                mock_result.scalar.return_value = len(mock_giveaways)
                mock_result.scalars.return_value.all.return_value = []  # –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –¥–ª—è count –∑–∞–ø—Ä–æ—Å–∞
            elif 'LIMIT' in query_str.upper() and 'OFFSET' in query_str.upper():
                # –î–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ 10 —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
                import re
                offset_match = re.search(r'OFFSET\s+(\d+)', query_str, re.IGNORECASE)
                if offset_match:
                    offset = int(offset_match.group(1))
                    return_giveaways = mock_giveaways[offset:offset + 10]
                else:
                    return_giveaways = mock_giveaways[:10]
                mock_result.scalars.return_value.all.return_value = return_giveaways
            else:
                mock_result.scalars.return_value.all.return_value = mock_giveaways

            return mock_result
        mock_session.execute = mock_execute_side_effect

        # –ú–æ–∫–∞–µ–º scalar –Ω–∞–ø—Ä—è–º—É—é, —á—Ç–æ–±—ã –æ–Ω –≤–æ–∑–≤—Ä–∞—â–∞–ª –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        async def mock_scalar_side_effect(stmt):
            query_str = str(stmt)
            if 'func.count' in query_str.lower() or 'count(' in query_str.lower():
                return len(mock_giveaways)  # 50
            # –î–ª—è –¥—Ä—É–≥–∏—Ö —Å–∫–∞–ª—è—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            return 1
        mock_session.scalar.side_effect = mock_scalar_side_effect
        
        async def mock_get_side_effect(model, giveaway_id):
            for giveaway in mock_giveaways:
                if giveaway.id == giveaway_id:
                    return giveaway
            return None
        mock_session.get = mock_get_side_effect
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –º–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
        service = GiveawayService(mock_session, mock_bot)
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–∏—Å–∫ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
        search_results = await service.search_giveaways("–ø—Ä–∏–∑")
        assert len(search_results) == 50
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
        for page in range(1, 6):  # 5 —Å—Ç—Ä–∞–Ω–∏—Ü
            giveaways, total = await service.get_giveaways_paginated(page=page, page_size=10)
            assert len(giveaways) <= 10
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ total - —ç—Ç–æ —á–∏—Å–ª–æ, –∞ –Ω–µ MagicMock
            assert int(total) == 50
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–æ–∑—ã–≥—Ä—ã—à–∞—Ö
        for i in range(0, min(5, len(mock_giveaways))):
            giveaway_info = await service.get_giveaway_detailed_info(mock_giveaways[i].id)
            assert giveaway_info is not None
            
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_admin_rate_limit_bypass_attempts(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø–æ–ø—ã—Ç–∫–∏ –æ–±—Ö–æ–¥–∞ —Ä–µ–π—Ç-–ª–∏–º–∏—Ç–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –ú–æ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        mock_user = MagicMock(spec=User)
        mock_user.user_id = 456
        mock_user.username = "testuser"
        mock_user.full_name = "Test User"
        mock_user.is_premium = False
        
        mock_result = MagicMock()
        mock_result.scalars.return_value.all.return_value = [mock_user]
        mock_session.execute.return_value = mock_result
        
        async def mock_scalar_side_effect(*args, **kwargs):
            return 1
        mock_session.scalar = mock_scalar_side_effect
        
        async def mock_get_side_effect(model, user_id):
            if model == User and user_id == 456:
                return mock_user
            return None
        mock_session.get = mock_get_side_effect
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–æ –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        results = []
        
        for i in range(50):  # 50 –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–¥—Ä—è–¥
            callback = MagicMock(spec=CallbackQuery)
            callback.from_user = admin_user
            callback.message = MagicMock(spec=Message)
            callback.message.edit_text = AsyncMock()
            callback.answer = AsyncMock()
            callback.data = "admin_search_user"
            
            try:
                from handlers.admin.users_handlers import start_user_search
                state = AsyncMock()
                await start_user_search(callback, state)
                results.append("success")
            except Exception as e:
                results.append(f"error: {str(e)}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
        success_count = sum(1 for r in results if r == "success")
        assert success_count >= 0  # –î–∞–∂–µ –µ—Å–ª–∏ —á–∞—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞, —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –ø–∞–¥–∞—Ç—å
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_memory_usage_under_load(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏ –ø—Ä–∏ –Ω–∞–≥—Ä—É–∑–∫–µ
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –°–æ–∑–¥–∞–µ–º —Å—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        mock_users = []
        for i in range(25):
            mock_user = MagicMock(spec=User)
            mock_user.user_id = 2000 + i
            mock_user.username = f"load_user_{i}"
            mock_user.full_name = f"Load User {i}"
            mock_user.is_premium = i % 3 == 0
            mock_users.append(mock_user)
        
        # –ú–æ–∫–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        async def mock_execute_side_effect(*args, **kwargs):
            mock_result = MagicMock()
            mock_result.scalars.return_value.all.return_value = mock_users
            return mock_result
        mock_session.execute = mock_execute_side_effect
        
        async def mock_scalar_side_effect(*args, **kwargs):
            return len(mock_users)
        mock_session.scalar = mock_scalar_side_effect
        
        async def mock_get_side_effect(model, user_id):
            for user in mock_users:
                if user.user_id == user_id:
                    return user
            return None
        mock_session.get = mock_get_side_effect
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º —Å–µ—Ä–∏—é –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏
        service = UserService(mock_session)
        
        # –ü–æ–≤—Ç–æ—Ä—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
        for cycle in range(5):
            # –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            search_results = await service.search_users("load")
            assert len(search_results) == 25
            
            # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–∞–∂–¥–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            for user in mock_users:
                user_info = await service.get_user_detailed_info(user.user_id)
                assert user_info is not None
            
            # –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–µ–º–∏—É–º–∞ –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            for i in range(0, len(mock_users), 5):
                await service.toggle_premium_status(mock_users[i].user_id, True)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å —É—Å–ø–µ—à–Ω–æ
        assert True  # –ï—Å–ª–∏ –º—ã –¥–æ—à–ª–∏ –¥–æ —ç—Ç–æ–π —Ç–æ—á–∫–∏, –∑–Ω–∞—á–∏—Ç –Ω–∞–≥—Ä—É–∑–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_complex_admin_workflow_under_load(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: —Å–ª–æ–∂–Ω—ã–π —Ä–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –ú–æ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        mock_users = []
        for i in range(20):
            mock_user = MagicMock(spec=User)
            mock_user.user_id = 3000 + i
            mock_user.username = f"workflow_user_{i}"
            mock_user.full_name = f"Workflow User {i}"
            mock_user.is_premium = False
            mock_users.append(mock_user)
        
        mock_giveaways = []
        for i in range(10):
            mock_giveaway = MagicMock(spec=Giveaway)
            mock_giveaway.id = 100 + i
            mock_giveaway.prize_text = f"Workflow Prize {i}"
            mock_giveaway.owner_id = 3000 + i
            mock_giveaway.status = "active"
            mock_giveaway.finish_time = MagicMock()
            mock_giveaway.finish_time.strftime.return_value = f"2023-02-{i+1:02d} 12:00"
            mock_giveaway.winners_count = 1
            mock_giveaways.append(mock_giveaway)
        
        # –ú–æ–∫–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
        async def mock_execute_side_effect(*args, **kwargs):
            mock_result = MagicMock()
            query_str = str(args[0])
            
            if 'Giveaway' in str(type(args[0])) or 'giveaways' in query_str.lower():
                mock_result.scalars.return_value.all.return_value = mock_giveaways
            else:
                mock_result.scalars.return_value.all.return_value = mock_users
            return mock_result
        mock_session.execute = mock_execute_side_effect
        
        async def mock_scalar_side_effect(*args, **kwargs):
            query_str = str(args[0])
            if 'Giveaway' in str(type(args[0])) or 'giveaways' in query_str.lower():
                return len(mock_giveaways)
            else:
                return len(mock_users)
        mock_session.scalar = mock_scalar_side_effect
        
        async def mock_get_side_effect(model, obj_id):
            if model == User:
                for user in mock_users:
                    if user.user_id == obj_id:
                        return user
            elif model == Giveaway:
                for giveaway in mock_giveaways:
                    if giveaway.id == obj_id:
                        return giveaway
            return None
        mock_session.get = mock_get_side_effect
        
        # –°–∏–º—É–ª–∏—Ä—É–µ–º —Å–ª–æ–∂–Ω—ã–π —Ä–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å
        tasks = []
        
        async def admin_workflow_iteration(iteration):
            # –ö–∞–∂–¥–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–º–ø–ª–µ–∫—Å –¥–µ–π—Å—Ç–≤–∏–π
            callback = MagicMock(spec=CallbackQuery)
            callback.from_user = admin_user
            callback.message = MagicMock(spec=Message)
            callback.message.edit_text = AsyncMock()
            callback.answer = AsyncMock()
            
            # –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–π
            try:
                # 1. –û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                callback.data = "admin_stats"
                from handlers.admin.stats_handlers import show_stats_menu
                await show_stats_menu(callback)
                
                # 2. –û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                callback.data = "admin_users"
                from handlers.admin.users_handlers import show_users_menu
                await show_users_menu(callback)
                
                # 3. –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                callback.data = "admin_list_users_1"
                from handlers.admin.users_handlers import show_users_list
                await show_users_list(callback, mock_session)
                
                # 4. –û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
                callback.data = "admin_giveaways"
                from handlers.admin.giveaways_handlers import show_giveaways_menu
                await show_giveaways_menu(callback)
                
                # 5. –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
                callback.data = "admin_list_giveaways_1"
                from handlers.admin.giveaways_handlers import show_giveaways_list
                await show_giveaways_list(callback, mock_session)
                
            except Exception:
                pass  # –û—à–∏–±–∫–∏ –≤ —Ç–µ—Å—Ç–µ –¥–æ–ø—É—Å—Ç–∏–º—ã
            
            return f"Iteration {iteration} completed"
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º 10 –∏—Ç–µ—Ä–∞—Ü–∏–π –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
        tasks = [admin_workflow_iteration(i) for i in range(10)]
        results = await asyncio.gather(*tasks, return_exceptions=True)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        completed_iterations = sum(1 for r in results if isinstance(r, str) and "completed" in r)
        assert completed_iterations >= 8  # –•–æ—Ç—è –±—ã 8 –∏–∑ 10 –¥–æ–ª–∂–Ω—ã –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è —É—Å–ø–µ—à–Ω–æ
            
    finally:
        config.ADMIN_IDS = original_admin_ids=== ./tests/test_additional_scenarios.py ===
import pytest
from unittest.mock import AsyncMock, MagicMock, patch
from sqlalchemy.ext.asyncio import AsyncSession
from aiogram import Bot
from aiogram.types import CallbackQuery, Message

from handlers.admin.admin_router import admin_router
from services.admin_user_service import UserService
from services.admin_giveaway_service import GiveawayService
from services.admin_broadcast_service import BroadcastService
from database.models import User, Giveaway, Participant, Broadcast
from config import config


@pytest.fixture
def mock_bot():
    """–§–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞"""
    bot = AsyncMock(spec=Bot)
    return bot


@pytest.fixture
def mock_session():
    """–§–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
    session = AsyncMock(spec=AsyncSession)
    return session


@pytest.fixture
def admin_user():
    """–§–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    user = MagicMock()
    user.id = 123
    user.username = "admin"
    user.full_name = "Admin User"
    return user


@pytest.mark.asyncio
async def test_large_payload_handling(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–æ–ª—å—à–∏—Ö –ø–æ–ª–µ–∑–Ω—ã—Ö –Ω–∞–≥—Ä—É–∑–æ–∫
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –°–æ–∑–¥–∞–µ–º –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        very_long_text = "A" * 10000  # 10,000 —Å–∏–º–≤–æ–ª–æ–≤
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–∏—Å—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –±–æ–ª—å—à–∏–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è
        broadcast_service = BroadcastService(mock_bot, mock_session)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏ —Å –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º
        try:
            result = await broadcast_service.create_broadcast(very_long_text, admin_id=admin_user.id)
            # –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–ª–∏ None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
            assert result is None or hasattr(result, 'id')
        except Exception:
            # –û—à–∏–±–∫–∏ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–ª–∏–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫ –¥–æ–ø—É—Å—Ç–∏–º—ã, –≥–ª–∞–≤–Ω–æ–µ —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø–∞–¥–µ–Ω–∏–π —Å–∏—Å—Ç–µ–º—ã
            pass
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ä–≤–∏—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        user_service = UserService(mock_session)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–∏—Å–∫ –ø–æ –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω–æ–º—É –∑–∞–ø—Ä–æ—Å—É
        result = await user_service.search_users(very_long_text)
        # –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –±–µ–∑ –æ—à–∏–±–æ–∫
        assert result == []
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ä–≤–∏—Å —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
        giveaway_service = GiveawayService(mock_session, mock_bot)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–∏—Å–∫ –ø–æ –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω–æ–º—É –∑–∞–ø—Ä–æ—Å—É
        result = await giveaway_service.search_giveaways(very_long_text)
        # –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –±–µ–∑ –æ—à–∏–±–æ–∫
        assert result == []
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_concurrent_access_to_same_resource(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –æ–¥–Ω–∏–º –∏ —Ç–µ–º –∂–µ —Ä–µ—Å—É—Ä—Å–∞–º
    """
    import asyncio
    
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –ú–æ–∫–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        mock_user = MagicMock(spec=User)
        mock_user.user_id = 123
        mock_user.username = "concurrent_user"
        mock_user.full_name = "Concurrent User"
        mock_user.is_premium = False
        
        async def mock_get_side_effect(model, user_id):
            return mock_user
        mock_session.get = mock_get_side_effect
        
        async def mock_scalar_side_effect(*args, **kwargs):
            return 5  # –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–∏–π
        mock_session.scalar = mock_scalar_side_effect
        
        user_service = UserService(mock_session)
        
        # –°–æ–∑–¥–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã—Ö –∑–∞–¥–∞—á, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—Ä–∞—â–∞—é—Ç—Å—è –∫ –æ–¥–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        async def get_user_info_task():
            return await user_service.get_user_detailed_info(123)
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º 10 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –æ–¥–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        tasks = [get_user_info_task() for _ in range(10)]
        results = await asyncio.gather(*tasks, return_exceptions=True)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –∑–∞–¥–∞—á–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å —É—Å–ø–µ—à–Ω–æ (–±–µ–∑ –ø–∞–¥–µ–Ω–∏–π)
        for result in results:
            if not isinstance(result, Exception):
                assert result is not None
                assert "user" in result
                assert "participation_count" in result
            else:
                # –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞
                assert str(result) != "System crash"  # –ü—Ä–∏–º–µ—Ä –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–µ–º–∏—É–º–∞
        async def toggle_premium_task():
            return await user_service.toggle_premium_status(123, True)
        
        toggle_tasks = [toggle_premium_task() for _ in range(5)]
        toggle_results = await asyncio.gather(*toggle_tasks, return_exceptions=True)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–¥–∞—á–∏ –Ω–µ –≤—ã–∑–≤–∞–ª–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –æ—à–∏–±–æ–∫
        for result in toggle_results:
            if isinstance(result, Exception):
                # –í —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –º–æ–∂–µ—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å –æ—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
                pass  # –≠—Ç–æ –ø—Ä–∏–µ–º–ª–µ–º–æ
            else:
                # –õ–∏–±–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç (True/False)
                assert isinstance(result, bool) or result is None
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_extreme_pagination_scenarios(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        user_service = UserService(mock_session)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é —Å —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–æ –±–æ–ª—å—à–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
        result_users, result_count = await user_service.get_users_paginated(page=999999, page_size=10)
        assert isinstance(result_users, list)
        assert isinstance(result_count, int)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é —Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
        result_users, result_count = await user_service.get_users_paginated(page=-1, page_size=10)
        assert isinstance(result_users, list)
        assert isinstance(result_count, int)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é —Å –Ω—É–ª–µ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
        result_users, result_count = await user_service.get_users_paginated(page=0, page_size=0)
        assert isinstance(result_users, list)
        assert isinstance(result_count, int)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é —Å –æ—á–µ–Ω—å –±–æ–ª—å—à–∏–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        result_users, result_count = await user_service.get_users_paginated(page=1, page_size=999999)
        assert isinstance(result_users, list)
        assert isinstance(result_count, int)
        
        # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
        giveaway_service = GiveawayService(mock_session, mock_bot)
        
        result_giveaways, result_count = await giveaway_service.get_giveaways_paginated(page=999999, page_size=10)
        assert isinstance(result_giveaways, list)
        assert isinstance(result_count, int)
        
        result_giveaways, result_count = await giveaway_service.get_giveaways_paginated(page=-1, page_size=10)
        assert isinstance(result_giveaways, list)
        assert isinstance(result_count, int)
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_malformed_json_and_data_handling(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö JSON –∏ –¥–∞–Ω–Ω—ã—Ö
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã—Ö —Å—Ç—Ä–æ–∫
        dangerous_strings = [
            '{"malicious": "json"}',
            '<script>alert("xss")</script>',
            'SELECT * FROM users; DROP TABLE users;',
            '..\\..\\windows\\system32\\',
            'eval("console.log(\'dangerous\')")',
            '{{7*7}}',  # Potentially dangerous template injection
            'file:///etc/passwd',
            'javascript:alert(1)',
        ]
        
        user_service = UserService(mock_session)
        giveaway_service = GiveawayService(mock_session, mock_bot)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–∏—Å—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
        for dangerous_string in dangerous_strings:
            # –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            result = await user_service.search_users(dangerous_string)
            assert isinstance(result, list)
            
            # –ü–æ–∏—Å–∫ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
            result = await giveaway_service.search_giveaways(dangerous_string)
            assert isinstance(result, list)
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ —Å –æ–ø–∞—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å None –∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏)
            try:
                result = await user_service.get_user_detailed_info(dangerous_string)
                assert result is None or isinstance(result, dict)
            except (TypeError, ValueError):
                # –û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è
                pass
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_rate_limiting_under_heavy_load(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ
    """
    import asyncio
    from utils.rate_limiter import RateLimiter
    
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –°–æ–∑–¥–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–∏—Ç–µ–ª—å —Å –æ—á–µ–Ω—å –Ω–∏–∑–∫–∏–º–∏ –ª–∏–º–∏—Ç–∞–º–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        limiter = RateLimiter(max_requests=3, window=1)  # 3 –∑–∞–ø—Ä–æ—Å–∞ –≤ —Å–µ–∫—É–Ω–¥—É
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –±–æ–ª—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤, —á–µ–º –ø–æ–∑–≤–æ–ª—è–µ—Ç –ª–∏–º–∏—Ç
        results = []
        for i in range(10):
            result = limiter.is_allowed(admin_user.id)
            results.append(result)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã –±—ã–ª–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã
        allowed_count = sum(1 for result in results if result)
        blocked_count = len(results) - allowed_count
        
        # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–∞–∑—É–º–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        assert allowed_count <= 3  # –ù–µ –±–æ–ª—å—à–µ 3 —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –≤ –ø–µ—Ä–≤—É—é —Å–µ–∫—É–Ω–¥—É
        assert blocked_count >= 7  # –û—Å—Ç–∞–ª—å–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_empty_and_null_values_handling(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—É—Å—Ç—ã—Ö –∏ –Ω—É–ª–µ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        user_service = UserService(mock_session)
        giveaway_service = GiveawayService(mock_session, mock_bot)
        broadcast_service = BroadcastService(mock_bot, mock_session)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫
        result = await user_service.search_users("")
        assert result == []
        
        result = await giveaway_service.search_giveaways("")
        assert result == []
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É None –∑–Ω–∞—á–µ–Ω–∏–π
        try:
            result = await user_service.search_users(None)
            assert result == []
        except (TypeError, AttributeError):
            # –û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è
            pass
        
        try:
            result = await giveaway_service.search_giveaways(None)
            assert result == []
        except (TypeError, AttributeError):
            # –û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è
            pass
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏ —Å –ø—É—Å—Ç—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
        result = await broadcast_service.create_broadcast("", admin_id=admin_user.id)
        # –ú–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        assert result is None or hasattr(result, 'id')
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏ —Å None –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
        result = await broadcast_service.create_broadcast(None, admin_id=admin_user.id)
        assert result is None or hasattr(result, 'id')
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_integer_overflow_protection(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—â–∏—Ç—ã –æ—Ç —Ü–µ–ª–æ—á–∏—Å–ª–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        user_service = UserService(mock_session)
        giveaway_service = GiveawayService(mock_session, mock_bot)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤–æ–∑–º–æ–∂–Ω—ã–º–∏ —Ü–µ–ª—ã–º–∏ —á–∏—Å–ª–∞–º–∏
        max_int32 = 2**31 - 1
        max_int64 = 2**63 - 1
        overflow_int = 2**63  # –≠—Ç–æ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –æ—à–∏–±–∫—É –≤ PostgreSQL (bigint max is 2^63-1)
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
        try:
            result = await user_service.get_user_detailed_info(max_int64)
            # –†–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å None (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç) –∏–ª–∏ —Å–ª–æ–≤–∞—Ä–µ–º (–µ—Å–ª–∏ –µ—Å—Ç—å)
            assert result is None or isinstance(result, dict)
        except (OverflowError, ValueError):
            # –≠—Ç–æ –¥–æ–ø—É—Å—Ç–∏–º–∞—è —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ
            pass
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –ø—Ä–æ–±–ª–µ–º–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
        try:
            result = await user_service.get_user_detailed_info(overflow_int)
            # –í –º–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å—Å—è —Å–ª–æ–≤–∞—Ä—å —Å –º–æ–∫–∞–º–∏ –∏–ª–∏ None
            assert result is None or isinstance(result, dict)
        except (OverflowError, ValueError):
            # –≠—Ç–æ –¥–æ–ø—É—Å—Ç–∏–º–∞—è —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ
            pass
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–æ–∑—ã–≥—Ä—ã—à–∏
        try:
            result = await giveaway_service.get_giveaway_detailed_info(max_int64)
            assert result is None or isinstance(result, dict)
        except (OverflowError, ValueError):
            # –≠—Ç–æ –¥–æ–ø—É—Å—Ç–∏–º–∞—è —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ
            pass
        
        try:
            result = await giveaway_service.get_giveaway_detailed_info(overflow_int)
            # –í –º–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å—Å—è —Å–ª–æ–≤–∞—Ä—å —Å –º–æ–∫–∞–º–∏ –∏–ª–∏ None
            assert result is None or isinstance(result, dict)
        except (OverflowError, ValueError):
            # –≠—Ç–æ –¥–æ–ø—É—Å—Ç–∏–º–∞—è —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ
            pass
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_unicode_and_special_characters_handling(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —é–Ω–∏–∫–æ–¥–∞ –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        user_service = UserService(mock_session)
        giveaway_service = GiveawayService(mock_session, mock_bot)
        broadcast_service = BroadcastService(mock_bot, mock_session)
        
        # –†–∞–∑–ª–∏—á–Ω—ã–µ —é–Ω–∏–∫–æ–¥–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        unicode_strings = [
            "üåüüéâ‚ú® Unicode —Ç–µ—Å—Ç üá∑üá∫üá∏üá¶üá¨üá™",  # –≠–º–æ–¥–∑–∏ –∏ —Ñ–ª–∞–≥–∏
            "√†√°√¢√£√§√•√¶√ß√®√©√™√´√¨√≠√Æ√Ø√±√≤√≥√¥√µ√∂√∏√π√∫√ª√º√Ω√ø",  # –õ–∞—Ç–∏–Ω—Å–∫–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
            "–ê–ë–í–ì–î–ï–ñ–ó–ò–ô–ö–õ–ú–ù–û–ü–†–°–¢–£–§–•–¶–ß–®–©–™–´–¨–≠–Æ–Ø",  # –ö–∏—Ä–∏–ª–ª–∏—Ü–∞
            "Í∞ÄÎÇòÎã§ÎùºÎßàÎ∞îÏÇ¨ÏïÑÏûêÏ∞®Ïπ¥ÌÉÄÌååÌïò",  # –ö–æ—Ä–µ–π—Å–∫–∏–π
            "„ÅÇ„ÅÑ„ÅÜ„Åà„Åä„Åã„Åç„Åè„Åë„Åì„Åï„Åó„Åô„Åõ„Åù„Åü„Å°„Å§„Å¶„Å®",  # –Ø–ø–æ–Ω—Å–∫–∏–π —Ö–∏—Ä–∞–≥–∞–Ω–∞
            "ŸÖÿ±ÿ≠ÿ®ÿßÿå ÿπÿßŸÑŸÖ",  # –ê—Ä–∞–±—Å–∫–∏–π
            "‚ù§Ô∏èüî•üëç üíï üíû üíì üíó üíñ üíò üíù üíü üíú üíõ üíö üíô",  # –≠–º–æ–¥–∑–∏
            "¬©¬Æ‚Ñ¢ ‚Ç¨ ¬£ ¬• ¬© ¬Æ ‚Ñ¢ ‚Ç¨ ¬£ ¬•",  # –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
            "‚Ä≥ ‚Ññ ¬ß “ë “ê —ñ –Ü —ó –á —ò –à ‚ÑÆ ‚ÑØ ‚Ñ∞ ‚Ñ≤ ‚Ñ≥ ‚Ñæ ‚Ñø",  # –†–∞–∑–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
        ]
        
        for unicode_str in unicode_strings:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            result = await user_service.search_users(unicode_str)
            assert isinstance(result, list)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–∏—Å–∫ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
            result = await giveaway_service.search_giveaways(unicode_str)
            assert isinstance(result, list)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏ —Å —é–Ω–∏–∫–æ–¥–æ–º
            result = await broadcast_service.create_broadcast(unicode_str, admin_id=admin_user.id)
            # –ú–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏, –Ω–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–∞–¥–µ–Ω–∏–π
            assert result is None or hasattr(result, 'id')
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ —Å–∏–º–≤–æ–ª–æ–≤
        combined_unicode = "üéâ –ü—Ä–∏–≤–µ—Ç! üëã –¢–µ—Å—Ç üåç ‚àë ‚àè ‚à´ ‚àÆ ‚à¥ ‚àµ ‚àã ‚àå ‚àç ‚àé ‚àè ‚àê ‚àë"
        result = await user_service.search_users(combined_unicode)
        assert isinstance(result, list)
        
        result = await giveaway_service.search_giveaways(combined_unicode)
        assert isinstance(result, list)
        
    finally:
        config.ADMIN_IDS = original_admin_ids=== ./tests/test_giveaway_creation.py ===
import pytest
from datetime import datetime, timedelta
from unittest.mock import AsyncMock, MagicMock
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from database.models.giveaway import Giveaway
from database.models.user import User
from database.models.required_channel import GiveawayRequiredChannel
from database.requests.giveaway_repo import create_giveaway


@pytest.mark.asyncio
class TestGiveawayCreation:
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π"""
    
    async def test_create_giveaway_basic(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Å—Ç–æ–≥–æ —Ä–æ–∑—ã–≥—Ä—ã—à–∞"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456789
        channel_id = -1001234567890
        message_id = 123
        prize = "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–∑"
        winners = 1
        end_time = datetime.now() + timedelta(days=7)
        
        # –í—ã–∑–æ–≤ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners, end_time
        )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∏
        assert isinstance(giveaway_id, int)
        assert giveaway_id > 0
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–æ–∑—ã–≥—Ä—ã—à —Å–æ—Ö—Ä–∞–Ω–∏–ª—Å—è –≤ –ë–î
        giveaway = await async_session.get(Giveaway, giveaway_id)
        assert giveaway is not None
        assert giveaway.owner_id == owner_id
        assert giveaway.channel_id == channel_id
        assert giveaway.message_id == message_id
        assert giveaway.prize_text == prize
        assert giveaway.winners_count == winners
        assert giveaway.finish_time == end_time
        assert giveaway.status == "active"
    
    async def test_create_giveaway_with_media(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ —Å –º–µ–¥–∏–∞"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456789
        channel_id = -1001234567890
        message_id = 124
        prize = "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–∑ —Å –º–µ–¥–∏–∞"
        winners = 2
        end_time = datetime.now() + timedelta(days=5)
        media_file_id = "test_media_file_id"
        media_type = "photo"
        
        # –í—ã–∑–æ–≤ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners, end_time, media_file_id, media_type
        )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∏
        giveaway = await async_session.get(Giveaway, giveaway_id)
        assert giveaway is not None
        assert giveaway.media_file_id == media_file_id
        assert giveaway.media_type == media_type
    
    async def test_create_giveaway_with_sponsors(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –∫–∞–Ω–∞–ª–∞–º–∏ (—Å–ø–æ–Ω—Å–æ—Ä–∞–º–∏)"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456789
        channel_id = -1001234567890
        message_id = 125
        prize = "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–∑ —Å–æ —Å–ø–æ–Ω—Å–æ—Ä–∞–º–∏"
        winners = 3
        end_time = datetime.now() + timedelta(days=3)
        
        # –°–ø–æ–Ω—Å–æ—Ä—ã
        sponsors = [
            {"id": -10011111111, "title": "–¢–µ—Å—Ç–æ–≤—ã–π –∫–∞–Ω–∞–ª 1", "link": "https://t.me/test_channel_1"},
            {"id": -10022222222, "title": "–¢–µ—Å—Ç–æ–≤—ã–π –∫–∞–Ω–∞–ª 2", "link": "https://t.me/test_channel_2"}
        ]
        
        # –í—ã–∑–æ–≤ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners, end_time, sponsors=sponsors
        )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∏
        giveaway = await async_session.get(Giveaway, giveaway_id)
        assert giveaway is not None
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–ø–æ–Ω—Å–æ—Ä—Å–∫–∏–µ –∫–∞–Ω–∞–ª—ã –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã
        stmt = select(GiveawayRequiredChannel).where(GiveawayRequiredChannel.giveaway_id == giveaway_id)
        result = await async_session.execute(stmt)
        required_channels = result.scalars().all()
        
        assert len(required_channels) == 2
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–∞–Ω–∞–ª—ã —Å–≤—è–∑–∞–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
        channel_ids = {ch.channel_id for ch in required_channels}
        sponsor_ids = {sp["id"] for sp in sponsors}
        assert channel_ids == sponsor_ids

    async def test_create_giveaway_with_sponsors_correct_ids(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –∫–∞–Ω–∞–ª–∞–º–∏ (—Å–ø–æ–Ω—Å–æ—Ä–∞–º–∏) —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ ID"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456789
        channel_id = -1001234567890
        message_id = 125
        prize = "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–∑ —Å–æ —Å–ø–æ–Ω—Å–æ—Ä–∞–º–∏"
        winners = 3
        end_time = datetime.now() + timedelta(days=3)
        
        # –°–ø–æ–Ω—Å–æ—Ä—ã
        sponsors = [
            {"id": -1001111111, "title": "–¢–µ—Å—Ç–æ–≤—ã–π –∫–∞–Ω–∞–ª 1", "link": "https://t.me/test_channel_1"},
            {"id": -1002222222, "title": "–¢–µ—Å—Ç–æ–≤—ã–π –∫–∞–Ω–∞–ª 2", "link": "https://t.me/test_channel_2"}
        ]
        
        # –í—ã–∑–æ–≤ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners, end_time, sponsors=sponsors
        )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∏
        giveaway = await async_session.get(Giveaway, giveaway_id)
        assert giveaway is not None
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–ø–æ–Ω—Å–æ—Ä—Å–∫–∏–µ –∫–∞–Ω–∞–ª—ã –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã
        stmt = select(GiveawayRequiredChannel).where(GiveawayRequiredChannel.giveaway_id == giveaway_id)
        result = await async_session.execute(stmt)
        required_channels = result.scalars().all()
        
        assert len(required_channels) == 2
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–∞–Ω–∞–ª—ã —Å–≤—è–∑–∞–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (—Ç–æ–ª—å–∫–æ ID, –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è)
        for ch in required_channels:
            assert ch.giveaway_id == giveaway_id
            assert ch.channel_id in [-1001111111, -1002222222]
    
    async def test_create_giveaway_with_referral_enabled(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ —Å –≤–∫–ª—é—á–µ–Ω–Ω–æ–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456789
        channel_id = -1001234567890
        message_id = 126
        prize = "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–∑ —Å —Ä–µ—Ñ–∫–æ–π"
        winners = 1
        end_time = datetime.now() + timedelta(days=10)
        
        # –í—ã–∑–æ–≤ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners, end_time, is_referral=True
        )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∏
        giveaway = await async_session.get(Giveaway, giveaway_id)
        assert giveaway is not None
        assert giveaway.is_referral_enabled == True
    
    async def test_create_giveaway_with_captcha_enabled(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ —Å –≤–∫–ª—é—á–µ–Ω–Ω–æ–π –∫–∞–ø—á–µ–π"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456789
        channel_id = -1001234567890
        message_id = 127
        prize = "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–∑ —Å –∫–∞–ø—á–µ–π"
        winners = 1
        end_time = datetime.now() + timedelta(days=10)
        
        # –í—ã–∑–æ–≤ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners, end_time, is_captcha=True
        )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∏
        giveaway = await async_session.get(Giveaway, giveaway_id)
        assert giveaway is not None
        assert giveaway.is_captcha_enabled == True

    async def test_create_giveaway_multiple_winners(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è–º–∏"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456789
        channel_id = -1001234567890
        message_id = 128
        prize = "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–∑ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è–º–∏"
        winners = 5
        end_time = datetime.now() + timedelta(days=15)
        
        # –í—ã–∑–æ–≤ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners, end_time
        )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∏
        giveaway = await async_session.get(Giveaway, giveaway_id)
        assert giveaway is not None
        assert giveaway.winners_count == 5
        assert giveaway.prize_text == "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–∑ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è–º–∏"

    async def test_create_giveaway_long_prize_text(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ —Å –¥–ª–∏–Ω–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –ø—Ä–∏–∑–∞"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456789
        channel_id = -1001234567890
        message_id = 129
        prize = "–û—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø—Ä–∏–∑–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –Ω–∞ –¥–ª–∏–Ω—É —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏–∑–∞ –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ. " * 10
        winners = 1
        end_time = datetime.now() + timedelta(hours=12)
        
        # –í—ã–∑–æ–≤ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners, end_time
        )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∏
        giveaway = await async_session.get(Giveaway, giveaway_id)
        assert giveaway is not None
        assert giveaway.prize_text == prize
        assert giveaway.winners_count == 1

    # –¢–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
    async def test_create_giveaway_invalid_owner_id(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º ID –≤–ª–∞–¥–µ–ª—å—Ü–∞"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = -1  # –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID
        channel_id = -1001234567890
        message_id = 130
        prize = "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–∑"
        winners = 1
        end_time = datetime.now() + timedelta(days=7)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç –±–µ–∑ –æ—à–∏–±–æ–∫ (–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏)
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners, end_time
        )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∏
        assert isinstance(giveaway_id, int)
        assert giveaway_id > 0
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–æ–∑—ã–≥—Ä—ã—à —Å–æ—Ö—Ä–∞–Ω–∏–ª—Å—è –≤ –ë–î —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º ID –≤–ª–∞–¥–µ–ª—å—Ü–∞
        giveaway = await async_session.get(Giveaway, giveaway_id)
        assert giveaway is not None
        assert giveaway.owner_id == owner_id

    async def test_create_giveaway_invalid_channel_id(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º ID –∫–∞–Ω–∞–ª–∞"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456789
        channel_id = 0  # –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID
        message_id = 131
        prize = "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–∑"
        winners = 1
        end_time = datetime.now() + timedelta(days=7)
        
        # –í—ã–∑–æ–≤ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners, end_time
        )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∏
        assert isinstance(giveaway_id, int)
        assert giveaway_id > 0
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–æ–∑—ã–≥—Ä—ã—à —Å–æ—Ö—Ä–∞–Ω–∏–ª—Å—è –≤ –ë–î —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º ID –∫–∞–Ω–∞–ª–∞
        giveaway = await async_session.get(Giveaway, giveaway_id)
        assert giveaway is not None
        assert giveaway.channel_id == channel_id

    async def test_create_giveaway_empty_prize_text(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ —Å –ø—É—Å—Ç—ã–º —Ç–µ–∫—Å—Ç–æ–º –ø—Ä–∏–∑–∞"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456789
        channel_id = -1001234567890
        message_id = 132
        prize = ""  # –ü—É—Å—Ç–æ–π –ø—Ä–∏–∑
        winners = 1
        end_time = datetime.now() + timedelta(days=7)
        
        # –í—ã–∑–æ–≤ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners, end_time
        )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∏
        assert isinstance(giveaway_id, int)
        assert giveaway_id > 0
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–æ–∑—ã–≥—Ä—ã—à —Å–æ—Ö—Ä–∞–Ω–∏–ª—Å—è –≤ –ë–î —Å –ø—É—Å—Ç—ã–º —Ç–µ–∫—Å—Ç–æ–º –ø—Ä–∏–∑–∞
        giveaway = await async_session.get(Giveaway, giveaway_id)
        assert giveaway is not None
        assert giveaway.prize_text == prize

    async def test_create_giveaway_zero_winners(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ —Å –Ω—É–ª–µ–≤—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456789
        channel_id = -1001234567890
        message_id = 133
        prize = "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–∑"
        winners = 0  # –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        end_time = datetime.now() + timedelta(days=7)
        
        # –í—ã–∑–æ–≤ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners, end_time
        )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∏
        assert isinstance(giveaway_id, int)
        assert giveaway_id > 0
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–æ–∑—ã–≥—Ä—ã—à —Å–æ—Ö—Ä–∞–Ω–∏–ª—Å—è –≤ –ë–î —Å –Ω—É–ª–µ–≤—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π
        giveaway = await async_session.get(Giveaway, giveaway_id)
        assert giveaway is not None
        assert giveaway.winners_count == winners

    async def test_create_giveaway_negative_winners(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ —Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456789
        channel_id = -1001234567890
        message_id = 134
        prize = "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–∑"
        winners = -5  # –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        end_time = datetime.now() + timedelta(days=7)
        
        # –í—ã–∑–æ–≤ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners, end_time
        )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∏
        assert isinstance(giveaway_id, int)
        assert giveaway_id > 0
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–æ–∑—ã–≥—Ä—ã—à —Å–æ—Ö—Ä–∞–Ω–∏–ª—Å—è –≤ –ë–î —Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π
        giveaway = await async_session.get(Giveaway, giveaway_id)
        assert giveaway is not None
        assert giveaway.winners_count == winners

    async def test_create_giveaway_past_end_time(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ —Å –¥–∞—Ç–æ–π –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤ –ø—Ä–æ—à–ª–æ–º"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456789
        channel_id = -1001234567890
        message_id = 135
        prize = "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–∑"
        winners = 1
        end_time = datetime.now() - timedelta(days=1)  # –ü—Ä–æ—à–ª–æ–µ –≤—Ä–µ–º—è
        
        # –í—ã–∑–æ–≤ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners, end_time
        )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∏
        assert isinstance(giveaway_id, int)
        assert giveaway_id > 0
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–æ–∑—ã–≥—Ä—ã—à —Å–æ—Ö—Ä–∞–Ω–∏–ª—Å—è –≤ –ë–î —Å –¥–∞—Ç–æ–π –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤ –ø—Ä–æ—à–ª–æ–º
        giveaway = await async_session.get(Giveaway, giveaway_id)
        assert giveaway is not None
        assert giveaway.finish_time == end_time

    # –¢–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã —Å –∫–∞–Ω–∞–ª–∞–º–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
    async def test_create_giveaway_with_single_additional_channel(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ —Å –æ–¥–Ω–∏–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –∫–∞–Ω–∞–ª–æ–º"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456789
        channel_id = -1001234567890
        message_id = 136
        prize = "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–∑ —Å –æ–¥–Ω–∏–º –¥–æ–ø. –∫–∞–Ω–∞–ª–æ–º"
        winners = 1
        end_time = datetime.now() + timedelta(days=5)
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–∞–Ω–∞–ª
        sponsors = [
            {"id": -1001111, "title": "–¢–µ—Å—Ç–æ–≤—ã–π –∫–∞–Ω–∞–ª 1", "link": "https://t.me/test_channel_1"}
        ]
        
        # –í—ã–∑–æ–≤ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners, end_time, sponsors=sponsors
        )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∏
        giveaway = await async_session.get(Giveaway, giveaway_id)
        assert giveaway is not None
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–∞–Ω–∞–ª –±—ã–ª —Å–æ–∑–¥–∞–Ω
        stmt = select(GiveawayRequiredChannel).where(GiveawayRequiredChannel.giveaway_id == giveaway_id)
        result = await async_session.execute(stmt)
        required_channels = result.scalars().all()
        
        assert len(required_channels) == 1
        assert required_channels[0].channel_id == -1001111
        assert required_channels[0].channel_title == "–¢–µ—Å—Ç–æ–≤—ã–π –∫–∞–Ω–∞–ª 1"
        assert required_channels[0].channel_link == "https://t.me/test_channel_1"

    async def test_create_giveaway_with_max_additional_channels(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456789
        channel_id = -1001234567890
        message_id = 137
        prize = "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–∑ —Å –º–∞–∫—Å–∏–º—É–º–æ–º –¥–æ–ø. –∫–∞–Ω–∞–ª–æ–≤"
        winners = 1
        end_time = datetime.now() + timedelta(days=5)
        
        # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ (20)
        sponsors = []
        for i in range(20):
            sponsors.append({
                "id": -10022222200 - i,
                "title": f"–¢–µ—Å—Ç–æ–≤—ã–π –∫–∞–Ω–∞–ª {i+1}",
                "link": f"https://t.me/test_channel_{i+1}"
            })
        
        # –í—ã–∑–æ–≤ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners, end_time, sponsors=sponsors
        )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∏
        giveaway = await async_session.get(Giveaway, giveaway_id)
        assert giveaway is not None
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–∞–Ω–∞–ª—ã –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã
        stmt = select(GiveawayRequiredChannel).where(GiveawayRequiredChannel.giveaway_id == giveaway_id)
        result = await async_session.execute(stmt)
        required_channels = result.scalars().all()
        
        assert len(required_channels) == 20
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–∞–Ω–∞–ª—ã —Å–≤—è–∑–∞–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
        for i, channel in enumerate(required_channels):
            assert channel.channel_id == -10022222200 - i
            assert channel.channel_title == f"–¢–µ—Å—Ç–æ–≤—ã–π –∫–∞–Ω–∞–ª {i+1}"
            assert channel.channel_link == f"https://t.me/test_channel_{i+1}"

    async def test_create_giveaway_with_duplicate_channels(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ —Å –¥—É–±–ª–∏—Ä—É—é—â–∏–º–∏—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –∫–∞–Ω–∞–ª–∞–º–∏"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456789
        channel_id = -1001234567890
        message_id = 138
        prize = "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–∑ —Å –¥—É–±–ª–∏—Ä—É—é—â–∏–º–∏—Å—è –∫–∞–Ω–∞–ª–∞–º–∏"
        winners = 1
        end_time = datetime.now() + timedelta(days=5)
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–∞–Ω–∞–ª—ã —Å –¥—É–±–ª–∏–∫–∞—Ç–æ–º
        sponsors = [
            {"id": -100111111, "title": "–¢–µ—Å—Ç–æ–≤—ã–π –∫–∞–Ω–∞–ª 1", "link": "https://t.me/test_channel_1"},
            {"id": -10011111111, "title": "–¢–µ—Å—Ç–æ–≤—ã–π –∫–∞–Ω–∞–ª 1", "link": "https://t.me/test_channel_1"},  # –¥—É–±–ª—å
            {"id": -10022222222, "title": "–¢–µ—Å—Ç–æ–≤—ã–π –∫–∞–Ω–∞–ª 2", "link": "https://t.me/test_channel_2"}
        ]
        
        # –í—ã–∑–æ–≤ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners, end_time, sponsors=sponsors
        )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∏
        giveaway = await async_session.get(Giveaway, giveaway_id)
        assert giveaway is not None
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–∞–Ω–∞–ª—ã –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã (–≤–∫–ª—é—á–∞—è –¥—É–±–ª–∏–∫–∞—Ç—ã)
        stmt = select(GiveawayRequiredChannel).where(GiveawayRequiredChannel.giveaway_id == giveaway_id)
        result = await async_session.execute(stmt)
        required_channels = result.scalars().all()
        
        assert len(required_channels) == 3  # –í—Å–µ —Ç—Ä–∏ –∑–∞–ø–∏—Å–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω—ã, –≤–∫–ª—é—á–∞—è –¥—É–±–ª–∏–∫–∞—Ç—ã

    async def test_create_giveaway_with_empty_channels_list(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ —Å –ø—É—Å—Ç—ã–º —Å–ø–∏—Å–∫–æ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456789
        channel_id = -1001234567890
        message_id = 139
        prize = "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–∑ —Å –ø—É—Å—Ç—ã–º —Å–ø–∏—Å–∫–æ–º –∫–∞–Ω–∞–ª–æ–≤"
        winners = 1
        end_time = datetime.now() + timedelta(days=5)
        
        # –ü—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤
        sponsors = []
        
        # –í—ã–∑–æ–≤ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners, end_time, sponsors=sponsors
        )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∏
        giveaway = await async_session.get(Giveaway, giveaway_id)
        assert giveaway is not None
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–∞–Ω–∞–ª—ã –Ω–µ –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã
        stmt = select(GiveawayRequiredChannel).where(GiveawayRequiredChannel.giveaway_id == giveaway_id)
        result = await async_session.execute(stmt)
        required_channels = result.scalars().all()
        
        assert len(required_channels) == 0
        
    # –¢–µ—Å—Ç—ã –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –¥–æ–ø—É—Å–∫–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
    async def test_create_giveaway_with_extremely_long_prize_text(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ —Å –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –ø—Ä–∏–∑–∞"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456789
        channel_id = -1001234567890
        message_id = 140
        prize = "A" * 10000  # –û—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø—Ä–∏–∑–∞
        winners = 1
        end_time = datetime.now() + timedelta(days=5)
        
        # –í—ã–∑–æ–≤ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners, end_time
        )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∏
        giveaway = await async_session.get(Giveaway, giveaway_id)
        assert giveaway is not None
        assert len(giveaway.prize_text) == 10000
        assert giveaway.prize_text == prize
        assert giveaway.winners_count == 1

    async def test_create_giveaway_with_maximum_winners(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤–æ–∑–º–æ–∂–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456789
        channel_id = -1001234567890
        message_id = 141
        prize = "–ü—Ä–∏–∑ –¥–ª—è –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π"
        winners = 50  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –∫–æ–¥–∞
        end_time = datetime.now() + timedelta(days=5)
        
        # –í—ã–∑–æ–≤ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners, end_time
        )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∏
        giveaway = await async_session.get(Giveaway, giveaway_id)
        assert giveaway is not None
        assert giveaway.winners_count == 50
        assert giveaway.prize_text == prize

    async def test_create_giveaway_with_minimum_values(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 1
        channel_id = -1001
        message_id = 1
        prize = "A"  # –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ –∫–æ—Ä–æ—Ç–∫–∏–π –ø—Ä–∏–∑
        winners = 1
        end_time = datetime.now() + timedelta(seconds=1)  # –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
        
        # –í—ã–∑–æ–≤ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners, end_time
        )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∏
        giveaway = await async_session.get(Giveaway, giveaway_id)
        assert giveaway is not None
        assert giveaway.owner_id == 1
        assert giveaway.channel_id == -1001
        assert giveaway.message_id == 1
        assert giveaway.prize_text == "A"
        assert giveaway.winners_count == 1

    async def test_create_giveaway_with_special_characters_in_prize(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ —Å –æ—Å–æ–±—ã–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –ø—Ä–∏–∑–∞"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456789
        channel_id = -1001234567890
        message_id = 142
        prize = "–ü—Ä–∏–∑ —Å —ç–º–æ–¥–∑–∏ üéÅüéâüéä –∏ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–∞–º–∏ !@#$%^&*()"
        winners = 1
        end_time = datetime.now() + timedelta(days=5)
        
        # –í—ã–∑–æ–≤ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners, end_time
        )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∏
        giveaway = await async_session.get(Giveaway, giveaway_id)
        assert giveaway is not None
        assert giveaway.prize_text == prize
        assert "üéÅ" in giveaway.prize_text
        assert "!@#$%^&*()" in giveaway.prize_text

    async def test_create_giveaway_with_large_numbers(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ —Å –±–æ–ª—å—à–∏–º–∏ —á–∏—Å–ª–æ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 999999
        channel_id = -9999999
        message_id = 999999
        prize = "–ü—Ä–∏–∑ —Å –±–æ–ª—å—à–∏–º–∏ —á–∏—Å–ª–∞–º–∏"
        winners = 10
        end_time = datetime.now() + timedelta(days=365*10)  # 10 –ª–µ—Ç
    
        # –í—ã–∑–æ–≤ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners, end_time
        )
    
        # –ü—Ä–æ–≤–µ—Ä–∫–∏
        giveaway = await async_session.get(Giveaway, giveaway_id)
        assert giveaway is not None
        assert giveaway.owner_id == 999999
        assert giveaway.channel_id == -9999999

=== ./tests/test_security.py ===
import pytest
from unittest.mock import AsyncMock, MagicMock, patch
from sqlalchemy.ext.asyncio import AsyncSession
from aiogram import Bot
from aiogram.types import CallbackQuery, Message

from handlers.admin.admin_router import admin_router
from services.admin_user_service import UserService
from services.admin_giveaway_service import GiveawayService
from services.admin_broadcast_service import BroadcastService
from database.models import User, Giveaway, Participant, Broadcast
from config import config


@pytest.fixture
def mock_bot():
    """–§–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞"""
    bot = AsyncMock(spec=Bot)
    return bot


@pytest.fixture
def mock_session():
    """–§–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
    session = AsyncMock(spec=AsyncSession)
    return session


@pytest.fixture
def admin_user():
    """–§–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    user = MagicMock()
    user.id = 123
    user.username = "admin"
    user.full_name = "Admin User"
    return user


@pytest.fixture
def regular_user():
    """–§–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user = MagicMock()
    user.id = 456
    user.username = "regular_user"
    user.full_name = "Regular User"
    return user


@pytest.mark.asyncio
async def test_access_control_for_non_admin_users(mock_bot, mock_session, regular_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –Ω–µ-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [999]  # ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å regular_user.id
    
    try:
        # –ú–æ–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /admin
        from filters.admin_filter import IsAdmin
        admin_filter = IsAdmin()
        
        message = MagicMock()
        message.from_user = regular_user
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∏–ª—å—Ç—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç False –¥–ª—è –Ω–µ-–∞–¥–º–∏–Ω–∞
        is_admin = await admin_filter(message)
        assert is_admin is False
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ callback –æ—Ç –Ω–µ-–∞–¥–º–∏–Ω–∞ —Ç–∞–∫–∂–µ –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è
        callback = MagicMock()
        callback.from_user = regular_user
        
        is_admin_callback = await admin_filter(callback)
        assert is_admin_callback is False
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_sql_injection_protection_in_user_search(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—â–∏—Ç—ã –æ—Ç SQL-–∏–Ω—ä–µ–∫—Ü–∏–π –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–∏—Å –±–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
        service = UserService(mock_session)
        
        # –ü–æ–ø—ã—Ç–∫–∞ SQL-–∏–Ω—ä–µ–∫—Ü–∏–∏
        malicious_query = "'; DROP TABLE users; --"
        result = await service.search_users(malicious_query)
        
        # –°–µ—Ä–≤–∏—Å –¥–æ–ª–∂–µ–Ω –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å –±–µ–∑ –æ—à–∏–±–æ–∫
        # (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –æ–Ω –Ω–µ –Ω–∞–π–¥–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ç–∞–∫–∏–º –∑–∞–ø—Ä–æ—Å–æ–º)
        assert isinstance(result, list)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ –≤—ã–∑–æ–≤–∞ execute —Å –æ–ø–∞—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π –Ω–∞–ø—Ä—è–º—É—é
        # (–ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ SQLAlchemy –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã)
        # –í –º–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–µ—Ç–æ–¥ –Ω–µ –ø–∞–¥–∞–µ—Ç
        assert True  # –ï—Å–ª–∏ –º—ã –¥–æ—à–ª–∏ –¥–æ —ç—Ç–æ–π —Ç–æ—á–∫–∏, –∏–Ω—ä–µ–∫—Ü–∏—è –Ω–µ –ø—Ä–∏–≤–µ–ª–∞ –∫ –ø–∞–¥–µ–Ω–∏—é
        
        # –î—Ä—É–≥–∏–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
        dangerous_queries = [
            "admin' OR '1'='1",
            "test'; DELETE FROM users; --",
            "1' UNION SELECT * FROM users --",
            "admin'; UPDATE users SET role='admin' WHERE id=1 --"
        ]
        
        for query in dangerous_queries:
            result = await service.search_users(query)
            assert isinstance(result, list)
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_sql_injection_protection_in_giveaway_search(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—â–∏—Ç—ã –æ—Ç SQL-–∏–Ω—ä–µ–∫—Ü–∏–π –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–∏—Å –±–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
        service = GiveawayService(mock_session, mock_bot)
        
        # –ü–æ–ø—ã—Ç–∫–∞ SQL-–∏–Ω—ä–µ–∫—Ü–∏–∏
        malicious_query = "'; DROP TABLE giveaways; --"
        result = await service.search_giveaways(malicious_query)
        
        # –°–µ—Ä–≤–∏—Å –¥–æ–ª–∂–µ–Ω –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å –±–µ–∑ –æ—à–∏–±–æ–∫
        assert isinstance(result, list)
        
        # –î—Ä—É–≥–∏–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
        dangerous_queries = [
            "prize' OR '1'='1",
            "test'; DELETE FROM giveaways; --",
            "1' UNION SELECT * FROM giveaways --"
        ]
        
        for query in dangerous_queries:
            result = await service.search_giveaways(query)
            assert isinstance(result, list)
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_xss_protection_in_response_generation(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—â–∏—Ç—ã –æ—Ç XSS-–∞—Ç–∞–∫ –≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        mock_user = MagicMock(spec=User)
        mock_user.user_id = 123
        mock_user.username = "test_user"
        mock_user.full_name = "<script>alert('XSS')</script>"
        mock_user.is_premium = False
        mock_user.created_at = MagicMock()
        mock_user.created_at.strftime.return_value = "2023-01-01 12:00"
        mock_user.premium_until = None
        
        # –ú–æ–∫–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async def mock_get_side_effect(model, user_id):
            if model == User and user_id == 123:
                return mock_user
            return None
        mock_session.get = mock_get_side_effect
        
        # –ú–æ–∫–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–∏–π
        async def mock_scalar_side_effect(*args, **kwargs):
            return 5
        mock_session.scalar = mock_scalar_side_effect
        
        service = UserService(mock_session)
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        user_info = await service.get_user_detailed_info(123)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –±—ã–ª–∞ –ø–æ–ª—É—á–µ–Ω–∞
        assert user_info is not None
        
        # –í —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTML —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ,
        # –Ω–æ –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –º—ã –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
        assert user_info["user"].full_name == "<script>alert('XSS')</script>"
        
        # –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
        mock_giveaway = MagicMock(spec=Giveaway)
        mock_giveaway.id = 1
        mock_giveaway.prize_text = "<img src=x onerror=alert('XSS')>"
        mock_giveaway.owner_id = 123
        mock_giveaway.status = "active"
        mock_giveaway.finish_time = MagicMock()
        mock_giveaway.finish_time.strftime.return_value = "2023-01-10 12:00"
        mock_giveaway.winners_count = 1
        
        async def mock_get_giveaway_side_effect(model, giveaway_id):
            if model == Giveaway and giveaway_id == 1:
                return mock_giveaway
            return None
        # –í—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–º–µ–Ω—è–µ–º –º–æ–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞
        original_get = mock_session.get
        async def mixed_get_side_effect(model, identifier):
            if model == User:
                return await mock_get_side_effect(model, identifier)
            elif model == Giveaway:
                return await mock_get_giveaway_side_effect(model, identifier)
            return await original_get(model, identifier)
        mock_session.get = mixed_get_side_effect
        
        giveaway_service = GiveawayService(mock_session, mock_bot)
        giveaway_info = await giveaway_service.get_giveaway_detailed_info(1)
        
        assert giveaway_info is not None
        assert giveaway_info["giveaway"].prize_text == "<img src=x onerror=alert('XSS')>"
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_boundary_values_handling(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        service = UserService(mock_session)
        
        # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏–π ID
        result = await service.get_user_detailed_info(1)  # –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ
        assert result is None or isinstance(result, dict)  # –ú–æ–∂–µ—Ç –±—ã—Ç—å None, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç
        
        result = await service.get_user_detailed_info(9223372036854775807)  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ bigint
        assert result is None or isinstance(result, dict)
        
        # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
        result = await service.get_user_detailed_info(-1)
        # –í –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏ —Å–µ—Ä–≤–∏—Å –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å None –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
        assert result is None
        
        result = await service.get_user_detailed_info(0)
        assert result is None
        
        # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
        result = await service.get_user_detailed_info("invalid_id")
        assert result is None
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
        giveaway_service = GiveawayService(mock_session, mock_bot)
        
        result = await giveaway_service.get_giveaway_detailed_info(1)
        assert result is None or isinstance(result, dict)
        
        result = await giveaway_service.get_giveaway_detailed_info(9223372036854775807)
        assert result is None or isinstance(result, dict)
        
        result = await giveaway_service.get_giveaway_detailed_info(-1)
        assert result is None
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_permission_check_on_sensitive_operations(mock_bot, mock_session, admin_user, regular_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –ø—Ä–∏ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –ú–æ–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        with patch('filters.admin_filter.config', wraps=config) as mock_config:
            mock_config.ADMIN_IDS = [123]
            
            # –°–æ–∑–¥–∞–µ–º callback –æ—Ç –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            callback = MagicMock(spec=CallbackQuery)
            callback.from_user = regular_user  # –ù–µ –∞–¥–º–∏–Ω
            callback.message = MagicMock(spec=Message)
            callback.message.edit_text = AsyncMock()
            callback.answer = AsyncMock()
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∏–ª—å—Ç—Ä –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –æ—Ç–∫–ª–æ–Ω–∏—Ç –∑–∞–ø—Ä–æ—Å
            from filters.admin_filter import IsAdmin
            admin_filter = IsAdmin()
            
            has_access = await admin_filter(callback)
            assert has_access is False
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ç—Ä–µ–±—É—é—Ç –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
            # –ü–æ–ø—Ä–æ–±—É–µ–º –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–µ–º–∏—É–º–∞ —á–µ—Ä–µ–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
            # (–≤ —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞—â–∏—â–µ–Ω—ã –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–º IsAdmin)
            
            # –ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ —Å–µ—Ä–≤–∏—Å—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏
            user_service = UserService(mock_session)
            
            # –ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –æ–ø–µ—Ä–∞—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–µ–º–∏—É–º–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
            # —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–∞–≤ (—ç—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –Ω–∞ —É—Ä–æ–≤–Ω–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤)
            result = await user_service.toggle_premium_status(456, True)
            # –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –ª–æ–≥–∏–∫–∏, –Ω–æ –º–µ—Ç–æ–¥ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø–∞–¥–∞—Ç—å
            
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_input_validation_for_numeric_fields(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —á–∏—Å–ª–æ–≤—ã—Ö –ø–æ–ª–µ–π
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        user_service = UserService(mock_session)
        giveaway_service = GiveawayService(mock_session, mock_bot)
        
        # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö —á–∏—Å–ª–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
        invalid_ids = [
            -999999,  # –ë–æ–ª—å—à–æ–µ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ
            0,  # –ù–æ–ª—å
            2**63,  # –ß–∏—Å–ª–æ –±–æ–ª—å—à–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è bigint
            float('inf'),  # –ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å
            float('-inf'),  # –ú–∏–Ω—É—Å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å
            "not_a_number",  # –ù–µ —á–∏—Å–ª–æ
            None,  # None
        ]
        
        for invalid_id in invalid_ids:
            try:
                result = await user_service.get_user_detailed_info(invalid_id)
                # –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å None –∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—à–∏–±–∫—É
                assert result is None or isinstance(result, dict)
            except (TypeError, ValueError, AttributeError):
                # –û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–æ–ø—É—Å—Ç–∏–º—ã
                pass
        
        for invalid_id in invalid_ids:
            try:
                result = await giveaway_service.get_giveaway_detailed_info(invalid_id)
                # –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å None –∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—à–∏–±–∫—É
                assert result is None or isinstance(result, dict)
            except (TypeError, ValueError, AttributeError):
                # –û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–æ–ø—É—Å—Ç–∏–º—ã
                pass
        
        # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
        valid_ids = [
            1,  # –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ
            2**31 - 1,  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è 32-–±–∏—Ç–Ω–æ–≥–æ —Ü–µ–ª–æ–≥–æ
            2**63 - 1,  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è 64-–±–∏—Ç–Ω–æ–≥–æ —Ü–µ–ª–æ–≥–æ
        ]
        
        for valid_id in valid_ids:
            try:
                result = await user_service.get_user_detailed_info(valid_id)
                assert result is None or isinstance(result, dict)
            except Exception:
                # –ù–µ–∫–æ—Ç–æ—Ä—ã–µ ID –º–æ–≥—É—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å, —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
                pass
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_protected_endpoints_require_authentication(mock_bot, mock_session, regular_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–≥–æ, —á—Ç–æ –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ç—Ä–µ–±—É—é—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [999]  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ID, –æ—Ç–ª–∏—á–Ω—ã–π –æ—Ç regular_user.id
    
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∞–¥–º–∏–Ω-—Ñ—É–Ω–∫—Ü–∏—è–º
        callback = MagicMock(spec=CallbackQuery)
        callback.from_user = regular_user
        callback.message = MagicMock(spec=Message)
        callback.message.edit_text = AsyncMock()
        callback.answer = AsyncMock()
        
        # –ú–æ–∫–∞–µ–º callback data –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∞–¥–º–∏–Ω-–¥–µ–π—Å—Ç–≤–∏–π
        admin_actions = [
            "admin_stats",
            "admin_users",
            "admin_giveaways",
            "admin_broadcast",
            "admin_search_user_123",
            "admin_list_users_1",
        ]
        
        from filters.admin_filter import IsAdmin
        admin_filter = IsAdmin()
        
        for action in admin_actions:
            callback.data = action
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∏–ª—å—Ç—Ä –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –Ω–µ-–∞–¥–º–∏–Ω–∞
            is_allowed = await admin_filter(callback)
            assert is_allowed is False, f"Action {action} should not be allowed for non-admin user"
        
    finally:
        config.ADMIN_IDS = original_admin_ids=== ./tests/test_giveaway_finish.py ===
import pytest
from datetime import datetime, timedelta
from unittest.mock import AsyncMock, MagicMock, patch
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from database.models.giveaway import Giveaway
from database.models.user import User
from database.models.participant import Participant
from database.models.winner import Winner
from database.requests.giveaway_repo import create_giveaway
from core.logic.randomizer import select_winners


@pytest.mark.asyncio
class TestGiveawayFinish:
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"""

    async def test_giveaway_finish_and_notify_winner(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–±–µ–¥–∏—Ç–µ–ª—è"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456789
        channel_id = -1001234567890
        message_id = 123
        prize = "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–∑"
        winners_count = 1
        end_time = datetime.now() - timedelta(hours=1)  # –†–æ–∑—ã–≥—Ä—ã—à —É–∂–µ –¥–æ–ª–∂–µ–Ω –∑–∞–∫–æ–Ω—á–∏—Ç—å—Å—è
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners_count, end_time
        )
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        participants = []
        for i in range(5):
            user_id = 987654321 + i
            username = f"test_user{i}"
            
            # –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user = await async_session.get(User, user_id)
            if not user:
                user = User(
                    user_id=user_id,
                    username=username,
                    full_name=f"Test{i} User{i}",
                    is_premium=False
                )
                async_session.add(user)
            
            # –°–æ–∑–¥–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞
            participant = Participant(
                user_id=user_id,
                giveaway_id=giveaway_id
            )
            async_session.add(participant)
            participants.append(user_id)
        
        await async_session.commit()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–æ–∑—ã–≥—Ä—ã—à —Å–æ–∑–¥–∞–Ω
        giveaway = await async_session.get(Giveaway, giveaway_id)
        assert giveaway is not None
        assert giveaway.status == "active"
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –≤—ã–±–æ—Ä –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π
        selected_winners = select_winners(giveaway, participants)
        assert len(selected_winners) == min(winners_count, len(participants))
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª—å –≤—ã–±—Ä–∞–Ω –∏–∑ —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        for winner_id in selected_winners:
            assert winner_id in participants
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±–∞–∑–µ
        for winner_id in selected_winners:
            winner = Winner(
                user_id=winner_id,
                giveaway_id=giveaway_id,
                created_at=datetime.now()
            )
            async_session.add(winner)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Ä–æ–∑—ã–≥—Ä—ã—à–∞ –Ω–∞ "–∑–∞–≤–µ—Ä—à–µ–Ω"
        giveaway.status = "finished"
        await async_session.commit()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–∏–ª—Å—è
        updated_giveaway = await async_session.get(Giveaway, giveaway_id)
        assert updated_giveaway.status == "finished"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
        stmt = select(Winner).where(Winner.giveaway_id == giveaway_id)
        result = await async_session.execute(stmt)
        winners = result.scalars().all()
        assert len(winners) == len(selected_winners)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–∞–∂–¥—ã–π –ø–æ–±–µ–¥–∏—Ç–µ–ª—å –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π
        winner_ids = [w.user_id for w in winners]
        for winner_id in selected_winners:
            assert winner_id in winner_ids

    async def test_giveaway_finish_multiple_winners(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è–º–∏"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456789
        channel_id = -1001234567890
        message_id = 124
        prize = "–ü—Ä–∏–∑ –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π"
        winners_count = 3
        end_time = datetime.now() - timedelta(hours=1)  # –†–æ–∑—ã–≥—Ä—ã—à —É–∂–µ –¥–æ–ª–∂–µ–Ω –∑–∞–∫–æ–Ω—á–∏—Ç—å—Å—è
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners_count, end_time
        )
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–±–æ–ª—å—à–µ, —á–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π)
        participants = []
        for i in range(10):
            user_id = 987654321 + i
            username = f"test_user{i}"
            
            # –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user = await async_session.get(User, user_id)
            if not user:
                user = User(
                    user_id=user_id,
                    username=username,
                    full_name=f"Test{i} User{i}",
                    is_premium=False
                )
                async_session.add(user)
            
            # –°–æ–∑–¥–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞
            participant = Participant(
                user_id=user_id,
                giveaway_id=giveaway_id
            )
            async_session.add(participant)
            participants.append(user_id)
        
        await async_session.commit()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–æ–∑—ã–≥—Ä—ã—à —Å–æ–∑–¥–∞–Ω
        giveaway = await async_session.get(Giveaway, giveaway_id)
        assert giveaway is not None
        assert giveaway.winners_count == winners_count
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –≤—ã–±–æ—Ä –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π
        selected_winners = select_winners(giveaway, participants)
        assert len(selected_winners) == winners_count  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–æ–≤–Ω–æ 3 –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª–∏ –∏–∑ —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        for winner_id in selected_winners:
            assert winner_id in participants
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–µ—Ç –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π
        assert len(set(selected_winners)) == len(selected_winners)

    async def test_giveaway_finish_with_predetermined_winner(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ —Å –∑–∞—Ä–∞–Ω–µ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–º"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456789
        channel_id = -1001234567890
        message_id = 125
        prize = "–ü–æ–¥–∫—Ä—É—á–µ–Ω–Ω—ã–π –ø—Ä–∏–∑"
        winners_count = 2
        end_time = datetime.now() - timedelta(hours=1)  # –†–æ–∑—ã–≥—Ä—ã—à —É–∂–µ –¥–æ–ª–∂–µ–Ω –∑–∞–∫–æ–Ω—á–∏—Ç—å—Å—è
        predetermined_winner_id = 9999999  # –ó–∞–¥–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners_count, end_time
        )
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
        from database.requests.giveaway_repo import set_predetermined_winner
        await set_predetermined_winner(async_session, giveaway_id, predetermined_winner_id)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Ä–æ–∑—ã–≥—Ä—ã—à –≤ —Å–µ—Å—Å–∏–∏
        giveaway = await async_session.get(Giveaway, giveaway_id)
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–≤–∫–ª—é—á–∞—è –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è)
        participants = [predetermined_winner_id]  # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
        for i in range(5):
            user_id = 987654321 + i
            username = f"test_user{i}"
            
            # –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user = await async_session.get(User, user_id)
            if not user:
                user = User(
                    user_id=user_id,
                    username=username,
                    full_name=f"Test{i} User{i}",
                    is_premium=False
                )
                async_session.add(user)
            
            # –°–æ–∑–¥–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞
            participant = Participant(
                user_id=user_id,
                giveaway_id=giveaway_id
            )
            async_session.add(participant)
            participants.append(user_id)
        
        await async_session.commit()
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Ä–æ–∑—ã–≥—Ä—ã—à –≤ —Å–µ—Å—Å–∏–∏ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
        giveaway = await async_session.get(Giveaway, giveaway_id)
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –≤—ã–±–æ—Ä –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π
        selected_winners = select_winners(giveaway, participants)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –ø–æ–±–µ–¥–∏—Ç–µ–ª—å –≤–∫–ª—é—á–µ–Ω
        assert predetermined_winner_id in selected_winners
        assert len(selected_winners) == winners_count
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª–∏ –≤—ã–±—Ä–∞–Ω—ã —Å–ª—É—á–∞–π–Ω–æ –∏–∑ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è
        other_winners = [w for w in selected_winners if w != predetermined_winner_id]
        assert len(other_winners) == winners_count - 1
        
        for winner_id in other_winners:
            assert winner_id in participants

    async def test_giveaway_finish_not_enough_participants(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ –∫–æ–≥–¥–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –º–µ–Ω—å—à–µ —á–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456789
        channel_id = -1001234567890
        message_id = 126
        prize = "–ü—Ä–∏–∑ –∫–æ–≥–¥–∞ –º–∞–ª–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"
        winners_count = 5  # –ë–æ–ª—å—à–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π —á–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        end_time = datetime.now() - timedelta(hours=1)  # –†–æ–∑—ã–≥—Ä—ã—à —É–∂–µ –¥–æ–ª–∂–µ–Ω –∑–∞–∫–æ–Ω—á–∏—Ç—å—Å—è
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners_count, end_time
        )
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–º–µ–Ω—å—à–µ —á–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π)
        participants = []
        for i in range(3):  # –¢–æ–ª—å–∫–æ 3 —É—á–∞—Å—Ç–Ω–∏–∫–∞
            user_id = 987654321 + i
            username = f"test_user{i}"
            
            # –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user = await async_session.get(User, user_id)
            if not user:
                user = User(
                    user_id=user_id,
                    username=username,
                    first_name=f"Test{i}",
                    last_name=f"User{i}",
                    is_premium=False
                )
                async_session.add(user)
            
            # –°–æ–∑–¥–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞
            participant = Participant(
                user_id=user_id,
                giveaway_id=giveaway_id
            )
            async_session.add(participant)
            participants.append(user_id)
        
        await async_session.commit()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–æ–∑—ã–≥—Ä—ã—à —Å–æ–∑–¥–∞–Ω
        giveaway = await async_session.get(Giveaway, giveaway_id)
        assert giveaway is not None
        assert giveaway.winners_count == 5  # –û–∂–∏–¥–∞–µ–º 5 –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –≤—ã–±–æ—Ä –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π
        selected_winners = select_winners(giveaway, participants)
        
        # –ö–æ–≥–¥–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –º–µ–Ω—å—à–µ —á–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π, –≤—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –ø–æ–±–µ–¥–∏—Ç–µ–ª—è–º–∏
        assert len(selected_winners) == len(participants)  # 3, –∞ –Ω–µ 5
        assert set(selected_winners) == set(participants)

    async def test_giveaway_finish_predetermined_winner_not_participating(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ –∫–æ–≥–¥–∞ –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –ø–æ–±–µ–¥–∏—Ç–µ–ª—å –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456789
        channel_id = -1001234567890
        message_id = 127
        prize = "–ü—Ä–∏–∑ –∫–æ–≥–¥–∞ –ø–æ–¥–∫—Ä—É—á–µ–Ω–Ω—ã–π –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç"
        winners_count = 2
        end_time = datetime.now() - timedelta(hours=1)  # –†–æ–∑—ã–≥—Ä—ã—à —É–∂–µ –¥–æ–ª–∂–µ–Ω –∑–∞–∫–æ–Ω—á–∏—Ç—å—Å—è
        predetermined_winner_id = 88888  # –ü–æ–±–µ–¥–∏—Ç–µ–ª—å, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –±—É–¥–µ—Ç —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners_count, end_time
        )
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
        from database.requests.giveaway_repo import set_predetermined_winner
        await set_predetermined_winner(async_session, giveaway_id, predetermined_winner_id)
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–±–µ–∑ –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è)
        participants = []
        for i in range(5):
            user_id = 987654321 + i
            username = f"test_user{i}"
            
            # –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user = await async_session.get(User, user_id)
            if not user:
                user = User(
                    user_id=user_id,
                    username=username,
                    first_name=f"Test{i}",
                    last_name=f"User{i}",
                    is_premium=False
                )
                async_session.add(user)
            
            # –°–æ–∑–¥–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞
            participant = Participant(
                user_id=user_id,
                giveaway_id=giveaway_id
            )
            async_session.add(participant)
            participants.append(user_id)
        
        await async_session.commit()
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Ä–æ–∑—ã–≥—Ä—ã—à –≤ —Å–µ—Å—Å–∏–∏ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
        giveaway = await async_session.get(Giveaway, giveaway_id)
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –≤—ã–±–æ—Ä –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π
        selected_winners = select_winners(giveaway, participants)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –ø–æ–±–µ–¥–∏—Ç–µ–ª—å –ù–ï –≤–∫–ª—é—á–µ–Ω, —Ç–∞–∫ –∫–∞–∫ –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç
        assert predetermined_winner_id not in selected_winners
        assert len(selected_winners) == winners_count
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª–∏ –∏–∑ —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        for winner_id in selected_winners:
            assert winner_id in participants=== ./tests/conftest.py ===
import pytest
from datetime import datetime, timedelta
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
from sqlalchemy.orm import sessionmaker
from sqlalchemy.pool import StaticPool
from database.base import Base
from database.models.giveaway import Giveaway
from database.models.user import User
from database.models.required_channel import GiveawayRequiredChannel
from database.models.participant import Participant
from database.models.winner import Winner


@pytest.fixture(scope="session")
async def engine():
    """–°–æ–∑–¥–∞–Ω–∏–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –¥–≤–∏–∂–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
    engine = create_async_engine(
        "sqlite+aiosqlite:///:memory:",
        poolclass=StaticPool,
        echo=True
    )
    yield engine
    await engine.dispose()


@pytest.fixture(scope="session")
async def tables(engine):
    """–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –≤ —Ç–µ—Å—Ç–æ–≤–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"""
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)
    yield
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.drop_all)


@pytest.fixture
async def async_session(engine, tables):
    """–°–æ–∑–¥–∞–Ω–∏–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Å–µ—Å—Å–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–æ–≤"""
    async_session_local = sessionmaker(
        engine, class_=AsyncSession, expire_on_commit=False
    )
    async with async_session_local() as session:
        yield session


@pytest.fixture
async def sample_user_data():
    """–û–±—Ä–∞–∑–µ—Ü –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤"""
    return {
        "user_id": 123456789,
        "username": "test_user",
        "first_name": "Test",
        "last_name": "User",
        "is_premium": False,
        "created_at": datetime.now()
    }


@pytest.fixture
async def sample_giveaway_data():
    """–û–±—Ä–∞–∑–µ—Ü –¥–∞–Ω–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–∞ –¥–ª—è —Ç–µ—Å—Ç–æ–≤"""
    return {
        "owner_id": 123456789,
        "channel_id": -1001234567890,
        "message_id": 123,
        "prize_text": "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–∑",
        "winners_count": 1,
        "finish_time": datetime.now() + timedelta(days=7),
        "status": "active"
    }


@pytest.fixture
async def sample_channel_data():
    """–û–±—Ä–∞–∑–µ—Ü –¥–∞–Ω–Ω—ã—Ö –∫–∞–Ω–∞–ª–∞ –¥–ª—è —Ç–µ—Å—Ç–æ–≤"""
    return {
        "id": -1001234567890,
        "title": "–¢–µ—Å—Ç–æ–≤—ã–π –∫–∞–Ω–∞–ª",
        "link": "https://t.me/test_channel",
        "is_private": False
    }


@pytest.fixture
async def sample_sponsor_data():
    """–û–±—Ä–∞–∑–µ—Ü –¥–∞–Ω–Ω—ã—Ö —Å–ø–æ–Ω—Å–æ—Ä—Å–∫–æ–≥–æ –∫–∞–Ω–∞–ª–∞ –¥–ª—è —Ç–µ—Å—Ç–æ–≤"""
    return [
        {"id": -1001111111, "title": "–°–ø–æ–Ω—Å–æ—Ä 1", "link": "https://t.me/sponsor1"},
        {"id": -10022222222, "title": "–°–ø–æ–Ω—Å–æ—Ä 2", "link": "https://t.me/sponsor2"}
    ]


@pytest.fixture
async def created_giveaway(async_session, sample_giveaway_data):
    """–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ä–æ–∑—ã–≥—Ä—ã—à–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"""
    giveaway = Giveaway(**sample_giveaway_data)
    async_session.add(giveaway)
    await async_session.commit()
    await async_session.refresh(giveaway)
    return giveaway=== ./tests/test_error_handling.py ===
import pytest
import asyncio
from unittest.mock import AsyncMock, MagicMock, patch
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.exc import SQLAlchemyError
from aiogram import Bot
from aiogram.types import CallbackQuery, Message

from handlers.admin.admin_router import admin_router
from services.admin_statistics_service import CachedStatisticsService
from services.admin_user_service import UserService
from services.admin_giveaway_service import GiveawayService
from services.admin_broadcast_service import BroadcastService
from database.models import User, Giveaway, Participant, Broadcast
from config import config


@pytest.fixture
def mock_bot():
    """–§–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞"""
    bot = AsyncMock(spec=Bot)
    return bot


@pytest.fixture
def mock_session():
    """–§–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
    session = AsyncMock(spec=AsyncSession)
    return session


@pytest.fixture
def admin_user():
    """–§–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    user = MagicMock()
    user.id = 123
    user.username = "admin"
    user.full_name = "Admin User"
    return user


@pytest.mark.asyncio
async def test_database_error_handling_in_user_service(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ UserService
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –ú–æ–∫–∞–µ–º –≤—ã–±—Ä–æ—Å –æ—à–∏–±–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ —Å–µ—Å—Å–∏–∏
        async def mock_execute_with_error(*args, **kwargs):
            raise SQLAlchemyError("Database connection lost")
        
        async def mock_get_with_error(model, identifier):
            raise SQLAlchemyError("Database connection lost")
        
        async def mock_scalar_with_error(stmt):
            raise SQLAlchemyError("Database connection lost")
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–æ–∫–∏ –¥–ª—è –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤ —Å–µ—Å—Å–∏–∏
        mock_session.execute.side_effect = mock_execute_with_error
        mock_session.get.side_effect = mock_get_with_error
        mock_session.scalar.side_effect = mock_scalar_with_error
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º, —á—Ç–æ —Å–µ—Ä–≤–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏
        service = UserService(mock_session)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–µ—Ç–æ–¥—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
        result = await service.search_users("test")
        assert result == []
        
        result = await service.get_user_detailed_info(123)
        assert result is None
        
        result = await service.toggle_premium_status(123, True)
        assert result is False
        
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–∞–π–¥-—ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–µ—Å—Ç–æ–≤
        mock_session.execute.side_effect = None
        mock_session.get.side_effect = None
        mock_session.scalar.side_effect = None
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_database_error_handling_in_giveaway_service(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ GiveawayService
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –ú–æ–∫–∞–µ–º –≤—ã–±—Ä–æ—Å –æ—à–∏–±–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ —Å–µ—Å—Å–∏–∏
        async def mock_execute_with_error(*args, **kwargs):
            raise SQLAlchemyError("Database connection lost")
        
        async def mock_get_with_error(model, identifier):
            raise SQLAlchemyError("Database connection lost")
        
        async def mock_scalar_with_error(stmt):
            raise SQLAlchemyError("Database connection lost")
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–æ–∫–∏ –¥–ª—è –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤ —Å–µ—Å—Å–∏–∏
        mock_session.execute.side_effect = mock_execute_with_error
        mock_session.get.side_effect = mock_get_with_error
        mock_session.scalar.side_effect = mock_scalar_with_error
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º, —á—Ç–æ —Å–µ—Ä–≤–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏
        service = GiveawayService(mock_session, mock_bot)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–µ—Ç–æ–¥—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
        result = await service.search_giveaways("test")
        assert result == []
        
        result = await service.get_giveaway_detailed_info(123)
        assert result is None
        
        result = await service.force_finish_giveaway(123, admin_user.id)
        assert result is False
        
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–∞–π–¥-—ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–µ—Å—Ç–æ–≤
        mock_session.execute.side_effect = None
        mock_session.get.side_effect = None
        mock_session.scalar.side_effect = None
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_database_error_handling_in_broadcast_service(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ BroadcastService
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –ú–æ–∫–∞–µ–º –≤—ã–±—Ä–æ—Å –æ—à–∏–±–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ —Å–µ—Å—Å–∏–∏
        async def mock_execute_with_error(*args, **kwargs):
            raise SQLAlchemyError("Database connection lost")
        
        async def mock_get_with_error(model, identifier):
            raise SQLAlchemyError("Database connection lost")
        
        async def mock_scalar_with_error(stmt):
            raise SQLAlchemyError("Database connection lost")
        
        async def mock_commit_with_error():
            raise SQLAlchemyError("Database commit failed")
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–æ–∫–∏ –¥–ª—è –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤ —Å–µ—Å—Å–∏–∏
        mock_session.execute.side_effect = mock_execute_with_error
        mock_session.get.side_effect = mock_get_with_error
        mock_session.scalar.side_effect = mock_scalar_with_error
        mock_session.commit.side_effect = mock_commit_with_error
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º, —á—Ç–æ —Å–µ—Ä–≤–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏
        service = BroadcastService(mock_bot, mock_session)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–µ—Ç–æ–¥—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
        result = await service.create_broadcast("Test message", admin_id=admin_user.id)
        # –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–µ—Ä–≤–∏—Å –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å None –ø—Ä–∏ –æ—à–∏–±–∫–µ
        assert result is None
        
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–∞–π–¥-—ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–µ—Å—Ç–æ–≤
        mock_session.execute.side_effect = None
        mock_session.get.side_effect = None
        mock_session.scalar.side_effect = None
        mock_session.commit.side_effect = None
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_exception_handling_in_admin_handlers(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –ú–æ–∫–∞–µ–º –≤—ã–±—Ä–æ—Å –æ—à–∏–±–∫–∏ –≤ —Å–µ—Ä–≤–∏—Å–µ
        async def mock_service_method(*args, **kwargs):
            raise Exception("Unexpected error in service")
        
        # –ú–æ–∫–∞–µ–º —Å–µ—Å—Å–∏—é, —á—Ç–æ–±—ã –≤—ã–∑—ã–≤–∞—Ç—å –æ—à–∏–±–∫—É
        mock_session.execute.side_effect = SQLAlchemyError("Connection failed")
        
        callback = MagicMock(spec=CallbackQuery)
        callback.from_user = admin_user
        callback.message = MagicMock(spec=Message)
        callback.message.edit_text = AsyncMock()
        callback.answer = AsyncMock()
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º, —á—Ç–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–µ –ø–∞–¥–∞—é—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö
        # –ú–æ–∫–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
        from handlers.admin.users_handlers import start_user_search
        from aiogram.fsm.context import FSMContext
        
        state = AsyncMock(spec=FSMContext)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—ã–∑–æ–≤ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç –ø–∞–¥–µ–Ω–∏—è –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã
        try:
            await start_user_search(callback, state)
            # –ï—Å–ª–∏ –Ω–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ –∏—Å–∫–ª—é—á–µ–Ω–∏—è, —Ç–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –æ—à–∏–±–∫–∞–º–∏
            assert True
        except Exception:
            # –î–∞–∂–µ –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø—Ä–æ–∏–∑–æ—à–ª–∞, —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–∞–¥–∞—Ç—å
            # –í —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ —ç—Ç–æ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –≥–ª–æ–±–∞–ª—å–Ω—ã–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–º
            pass
        
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–∞–π–¥-—ç—Ñ—Ñ–µ–∫—Ç –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–µ—Å—Ç–æ–≤
        mock_session.execute.side_effect = None
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_network_error_handling_in_broadcast_service(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ä–∞—Å—Å—ã–ª–æ–∫
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –°–æ–∑–¥–∞–µ–º –º–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        mock_user = MagicMock(spec=User)
        mock_user.user_id = 11
        mock_result = MagicMock()
        mock_result.scalars.return_value.all.return_value = [mock_user]
        mock_session.execute.return_value = mock_result
        
        # –ú–æ–∫–∞–µ–º —Å–µ—Ç–µ–≤—É—é –æ—à–∏–±–∫—É –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        async def mock_send_message_with_error(chat_id, text, **kwargs):
            raise Exception("Network error: failed to send message")
        
        mock_bot.send_message.side_effect = mock_send_message_with_error
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º, —á—Ç–æ —Å–µ—Ä–≤–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏
        service = BroadcastService(mock_bot, mock_session)
        
        # –°–æ–∑–¥–∞–µ–º —Ä–∞—Å—Å—ã–ª–∫—É
        broadcast = await service.create_broadcast("Test message", admin_user.id)
        
        # –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É - –¥–æ–ª–∂–Ω–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è —Å–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞
        result = await service.send_broadcast(broadcast.id)
        # –î–∞–∂–µ –ø—Ä–∏ —Å–µ—Ç–µ–≤–æ–π –æ—à–∏–±–∫–µ –º–µ—Ç–æ–¥ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø–∞–¥–∞—Ç—å
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–∏—Å –Ω–µ –ø–∞–¥–∞–µ—Ç –ø—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–∫–∞—Ö
        assert broadcast is not None
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_memory_error_handling(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –Ω–µ—Ö–≤–∞—Ç–∫–∏ –ø–∞–º—è—Ç–∏
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –ú–æ–∫–∞–µ–º –≤—ã–±—Ä–æ—Å MemoryError –¥–ª—è –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ —Å–µ—Å—Å–∏–∏
        async def mock_execute_with_memory_error(*args, **kwargs):
            raise MemoryError("Not enough memory")
        
        async def mock_get_with_memory_error(model, identifier):
            raise MemoryError("Not enough memory")
        
        async def mock_scalar_with_memory_error(stmt):
            raise MemoryError("Not enough memory")
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–æ–∫–∏ –¥–ª—è –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤ —Å–µ—Å—Å–∏–∏
        mock_session.execute.side_effect = mock_execute_with_memory_error
        mock_session.get.side_effect = mock_get_with_memory_error
        mock_session.scalar.side_effect = mock_scalar_with_memory_error
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º, —á—Ç–æ —Å–µ—Ä–≤–∏—Å—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –æ—à–∏–±–∫–∏ –ø–∞–º—è—Ç–∏
        service = UserService(mock_session)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–µ—Ç–æ–¥—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –ø–∞–º—è—Ç–∏
        result = await service.search_users("test")
        assert result == []
        
        result = await service.get_user_detailed_info(123)
        assert result is None
        
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–∞–π–¥-—ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–µ—Å—Ç–æ–≤
        mock_session.execute.side_effect = None
        mock_session.get.side_effect = None
        mock_session.scalar.side_effect = None
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_timeout_error_handling(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–∞–π–º–∞—É—Ç–æ–≤
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –ú–æ–∫–∞–µ–º –≤—ã–±—Ä–æ—Å TimeoutError –¥–ª—è –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ —Å–µ—Å—Å–∏–∏
        async def mock_execute_with_timeout(*args, **kwargs):
            raise TimeoutError("Request timeout")
        
        async def mock_get_with_timeout(model, identifier):
            raise TimeoutError("Request timeout")
        
        async def mock_scalar_with_timeout(stmt):
            raise TimeoutError("Request timeout")
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–æ–∫–∏ –¥–ª—è –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤ —Å–µ—Å—Å–∏–∏
        mock_session.execute.side_effect = mock_execute_with_timeout
        mock_session.get.side_effect = mock_get_with_timeout
        mock_session.scalar.side_effect = mock_scalar_with_timeout
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º, —á—Ç–æ —Å–µ—Ä–≤–∏—Å—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç —Ç–∞–π–º–∞—É—Ç—ã
        service = GiveawayService(mock_session, mock_bot)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–µ—Ç–æ–¥—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏ —Ç–∞–π–º–∞—É—Ç–∞—Ö
        result = await service.search_giveaways("test")
        assert result == []
        
        result = await service.get_giveaway_detailed_info(123)
        assert result is None
        
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–∞–π–¥-—ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–µ—Å—Ç–æ–≤
        mock_session.execute.side_effect = None
        mock_session.get.side_effect = None
        mock_session.scalar.side_effect = None
        
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_validation_error_handling(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        service = UserService(mock_session)
        
        # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        result = await service.toggle_premium_status(-1, True)  # –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π ID
        assert result is False
        
        result = await service.toggle_premium_status(9999999999, True)  # —á—Ä–µ–∑–º–µ—Ä–Ω–æ –±–æ–ª—å—à–æ–π ID
        assert result is False
        
        # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –≥—Ä–∞–Ω–∏—á–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
        result = await service.toggle_premium_status(0, True)  # –Ω—É–ª–µ–≤–æ–π ID
        assert result is False
        
        # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
        giveaway_service = GiveawayService(mock_session, mock_bot)
        
        result = await giveaway_service.force_finish_giveaway(-1, admin_user.id)  # –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π ID
        assert result is False
        
        result = await giveaway_service.force_finish_giveaway(9999999999, admin_user.id)  # —á—Ä–µ–∑–º–µ—Ä–Ω–æ –±–æ–ª—å—à–æ–π ID
        assert result is False
        
    finally:
        config.ADMIN_IDS = original_admin_ids=== ./tests/test_broadcast_time_picker.py ===
import pytest
from datetime import datetime
from unittest.mock import AsyncMock, MagicMock
from aiogram.fsm.context import FSMContext
from aiogram.types import CallbackQuery, Message, User, Chat
from sqlalchemy.ext.asyncio import AsyncSession

from handlers.admin.broadcast_handlers import (
    start_schedule_broadcast,
    select_broadcast_date,
    navigate_broadcast_calendar,
    select_broadcast_time,
    switch_to_manual_time_input,
    process_manual_time_input,
    BroadcastState
)


@pytest.fixture
def mock_callback_query():
    callback = AsyncMock(spec=CallbackQuery)
    callback.data = "admin_schedule_broadcast"
    callback.from_user = User(id=12345, is_bot=False, first_name="Test")
    callback.message = AsyncMock()
    callback.message.edit_text = AsyncMock()
    callback.answer = AsyncMock()
    return callback


@pytest.fixture
def mock_message():
    message = AsyncMock(spec=Message)
    message.text = "Test message"
    message.from_user = User(id=12345, is_bot=False, first_name="Test")
    message.answer = AsyncMock()
    return message


@pytest.fixture
def mock_state():
    state = AsyncMock(spec=FSMContext)
    state.set_state = AsyncMock()
    state.update_data = AsyncMock()
    state.get_data = AsyncMock(return_value={'broadcast_data': {'text': 'Test broadcast'}})
    state.clear = AsyncMock()
    return state


@pytest.fixture
def mock_session():
    session = AsyncMock(spec=AsyncSession)
    return session


@pytest.fixture
def mock_bot():
    bot = AsyncMock()
    return bot


class TestBroadcastTimePicker:
    """–¢–µ—Å—Ç—ã –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞—Å—Å—ã–ª–∫–∏"""

    async def test_start_schedule_broadcast(self, mock_callback_query, mock_state):
        """–¢–µ—Å—Ç –Ω–∞—á–∞–ª–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∏"""
        await start_schedule_broadcast(mock_callback_query, mock_state)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
        mock_state.set_state.assert_called_once_with(BroadcastState.waiting_for_schedule_date)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ
        mock_callback_query.message.edit_text.assert_called_once()
        assert "–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –æ—Ç–ø—Ä–∞–≤–∫–∏" in mock_callback_query.message.edit_text.call_args[0][0]
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–∞ callback –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
        mock_callback_query.answer.assert_called_once()

    async def test_select_broadcast_date(self, mock_callback_query, mock_state):
        """–¢–µ—Å—Ç –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã —Ä–∞—Å—Å—ã–ª–∫–∏"""
        mock_callback_query.data = "admin_broadcast_date_set:2024:12:25"
        
        await select_broadcast_date(mock_callback_query, mock_state)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
        mock_state.set_state.assert_called_once_with(BroadcastState.waiting_for_schedule_time)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ
        mock_callback_query.message.edit_text.assert_called_once()
        assert "25.12.2024" in mock_callback_query.message.edit_text.call_args[0][0]
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–∞ callback –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
        mock_callback_query.answer.assert_called_once()

    async def test_navigate_broadcast_calendar(self, mock_callback_query):
        """–¢–µ—Å—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—é —Ä–∞—Å—Å—ã–ª–∫–∏"""
        mock_callback_query.data = "admin_broadcast_cal_nav:2024:11"
        
        await navigate_broadcast_calendar(mock_callback_query)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ
        mock_callback_query.message.edit_text.assert_called_once()
        assert "–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –æ—Ç–ø—Ä–∞–≤–∫–∏" in mock_callback_query.message.edit_text.call_args[0][0]
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–∞ callback –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
        mock_callback_query.answer.assert_called_once()

    async def test_select_broadcast_time_success(self, mock_callback_query, mock_state, mock_session, mock_bot):
        """–¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞—Å—Å—ã–ª–∫–∏"""
        mock_callback_query.data = "admin_broadcast_time_set:2024:12:25:15:30"
        
        from core.tools.broadcast_scheduler import schedule_broadcast_task
        from core.tools.broadcast_scheduler import schedule_broadcast_task
        # –ú–æ–∫ –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ —Ä–∞—Å—Å—ã–ª–∫–∏
        with pytest.MonkeyPatch().context() as mp:
            mp.setattr("handlers.admin.broadcast_handlers.BroadcastService", MagicMock())
            mp.setattr("core.tools.broadcast_scheduler.schedule_broadcast_task", AsyncMock())
            
            await select_broadcast_time(mock_callback_query, mock_state, mock_session, mock_bot)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ
        mock_callback_query.message.edit_text.assert_called_once()
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤—ã–∑–æ–≤ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ä–∞—Å—Å—ã–ª–∫–µ
        args, kwargs = mock_callback_query.message.edit_text.call_args
        assert "–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ 2024-12-25 15:30" in args[0] if args else False
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—á–∏—â–µ–Ω–æ
        mock_state.clear.assert_called_once()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–∞ callback –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
        mock_callback_query.answer.assert_called_once()

    async def test_switch_to_manual_time_input(self, mock_callback_query, mock_state):
        """–¢–µ—Å—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫ —Ä—É—á–Ω–æ–º—É –≤–≤–æ–¥—É –≤—Ä–µ–º–µ–Ω–∏"""
        await switch_to_manual_time_input(mock_callback_query, mock_state)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
        mock_state.set_state.assert_called_once_with(BroadcastState.waiting_for_manual_schedule_time)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ
        mock_callback_query.message.edit_text.assert_called_once()
        assert "–í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ" in mock_callback_query.message.edit_text.call_args[0][0]
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–∞ callback –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
        mock_callback_query.answer.assert_called_once()

    async def test_process_manual_time_input_success(self, mock_message, mock_state, mock_session, mock_bot):
        """–¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞ –≤—Ä–µ–º–µ–Ω–∏"""
        mock_message.text = "2024-12-25 15:30"
        
        from core.tools.broadcast_scheduler import schedule_broadcast_task
        # –ú–æ–∫ –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ —Ä–∞—Å—Å—ã–ª–∫–∏
        with pytest.MonkeyPatch().context() as mp:
            mp.setattr("handlers.admin.broadcast_handlers.BroadcastService", MagicMock())
            mp.setattr("core.tools.broadcast_scheduler.schedule_broadcast_task", AsyncMock())
            
            await process_manual_time_input(mock_message, mock_state, mock_session, mock_bot)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
        mock_message.answer.assert_called()
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤—ã–∑–æ–≤ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ä–∞—Å—Å—ã–ª–∫–µ
        args, kwargs = mock_message.answer.call_args
        assert "–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ 2024-12-25 15:30" in args[0] if args else False
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—á–∏—â–µ–Ω–æ
        mock_state.clear.assert_called_once()

    async def test_process_manual_time_input_invalid_format(self, mock_message, mock_state):
        """–¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏"""
        mock_message.text = "invalid date format"
        
        await process_manual_time_input(mock_message, mock_state, AsyncMock(), AsyncMock())
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        mock_message.answer.assert_called()
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤—ã–∑–æ–≤ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ —Ñ–æ—Ä–º–∞—Ç–∞
        assert any("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏" in str(call) for call in mock_message.answer.call_args_list)

    async def test_process_manual_time_input_past_time(self, mock_message, mock_state):
        """–¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –≤ –ø—Ä–æ—à–ª–æ–º"""
        mock_message.text = "2020-01-01 10:00"  # –û—á–µ–≤–∏–¥–Ω–æ –ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è
        
        await process_manual_time_input(mock_message, mock_state, AsyncMock(), AsyncMock())
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        mock_message.answer.assert_called()
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤—ã–∑–æ–≤ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –≤—Ä–µ–º—è –≤ –ø—Ä–æ—à–ª–æ–º
        assert any("–í—Ä–µ–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –ø—Ä–æ—à–ª–æ–º" in str(call) for call in mock_message.answer.call_args_list)=== ./tests/test_admin_inline_buttons.py ===
import pytest
from unittest.mock import AsyncMock, MagicMock, patch
from sqlalchemy.ext.asyncio import AsyncSession
from aiogram import Bot
from aiogram.types import CallbackQuery, Message
from aiogram.fsm.storage.memory import MemoryStorage

from handlers.admin.admin_router import admin_router
from services.admin_statistics_service import CachedStatisticsService
from services.admin_user_service import UserService
from services.admin_giveaway_service import GiveawayService
from services.admin_broadcast_service import BroadcastService
from database.models import User, Giveaway, Participant, Broadcast
from config import config


@pytest.fixture
def mock_bot():
    """–§–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞"""
    bot = AsyncMock(spec=Bot)
    return bot


@pytest.fixture
def mock_session():
    """–§–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
    session = AsyncMock(spec=AsyncSession)
    return session


@pytest.fixture
def admin_user():
    """–§–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    user = MagicMock()
    user.id = 123
    user.username = "admin"
    user.full_name = "Admin User"
    return user


@pytest.mark.asyncio
async def test_admin_main_menu_buttons(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        callback = MagicMock(spec=CallbackQuery)
        callback.from_user = admin_user
        callback.message = MagicMock(spec=Message)
        callback.message.edit_text = AsyncMock()
        callback.answer = AsyncMock()
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é –∫–Ω–æ–ø–∫—É –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
        main_menu_callbacks = [
            "admin_stats",
            "admin_users",
            "admin_giveaways",
            "admin_broadcast"
        ]
        
        for callback_data in main_menu_callbacks:
            callback.data = callback_data
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–µ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–π –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ
            if callback_data == "admin_stats":
                from handlers.admin.stats_handlers import show_stats_menu
                await show_stats_menu(callback)
            elif callback_data == "admin_users":
                from handlers.admin.users_handlers import show_users_menu
                await show_users_menu(callback)
            elif callback_data == "admin_giveaways":
                from handlers.admin.giveaways_handlers import show_giveaways_menu
                await show_giveaways_menu(callback)
            elif callback_data == "admin_broadcast":
                from handlers.admin.broadcast_handlers import show_broadcast_menu
                await show_broadcast_menu(callback)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–µ—Ç–æ–¥ edit_text –±—ã–ª –≤—ã–∑–≤–∞–Ω
            callback.message.edit_text.assert_called()
            callback.message.edit_text.reset_mock()  # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–∑–æ–≤—ã –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ç–µ—Å—Ç–∞
            
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_admin_stats_menu_buttons(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        callback = MagicMock(spec=CallbackQuery)
        callback.from_user = admin_user
        callback.message = MagicMock(spec=Message)
        callback.message.edit_text = AsyncMock()
        callback.answer = AsyncMock()
        
        # –ú–æ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        side_effects = [100, 5, 50, 5]  # total_users, active_giveaways, total_participations, potential_bots
        current_call = 0
        
        async def mock_scalar_side_effect(*args, **kwargs):
            nonlocal current_call
            result = side_effects[current_call % len(side_effects)]
            current_call += 1
            return result
        
        mock_session.scalar = mock_scalar_side_effect
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é –∫–Ω–æ–ø–∫—É –º–µ–Ω—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        stats_callbacks = [
            "admin_general_stats",
            "admin_user_growth",
            "admin_premium_stats",
            "admin_giveaway_stats",
            "admin_participation_stats"
        ]
        
        for callback_data in stats_callbacks:
            callback.data = callback_data
            
            if callback_data == "admin_general_stats":
                from handlers.admin.stats_handlers import show_general_stats
                await show_general_stats(callback, mock_session)
            elif callback_data == "admin_user_growth":
                from handlers.admin.stats_handlers import show_user_growth_stats
                await show_user_growth_stats(callback, mock_session)
            elif callback_data == "admin_premium_stats":
                from handlers.admin.stats_handlers import show_premium_stats
                await show_premium_stats(callback, mock_session)
            elif callback_data == "admin_giveaway_stats":
                from handlers.admin.stats_handlers import show_giveaway_stats
                await show_giveaway_stats(callback, mock_session)
            elif callback_data == "admin_participation_stats":
                from handlers.admin.stats_handlers import show_participation_stats
                await show_participation_stats(callback, mock_session)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–µ—Ç–æ–¥ edit_text –±—ã–ª –≤—ã–∑–≤–∞–Ω
            callback.message.edit_text.assert_called()
            callback.message.edit_text.reset_mock()
            
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_admin_users_menu_buttons(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        callback = MagicMock(spec=CallbackQuery)
        callback.from_user = admin_user
        callback.message = MagicMock(spec=Message)
        callback.message.edit_text = AsyncMock()
        callback.answer = AsyncMock()
        
        # –ú–æ–∫–∞–µ–º FSM state
        state = AsyncMock()
        
        # –ú–æ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        mock_user = MagicMock(spec=User)
        mock_user.user_id = 456
        mock_user.username = "testuser"
        mock_user.full_name = "Test User"
        mock_user.is_premium = False
        mock_user.created_at = MagicMock()
        mock_user.created_at.strftime.return_value = "2023-01-01 12:00"
        mock_user.premium_until = None
        
        mock_result = MagicMock()
        mock_result.scalars.return_value.all.return_value = [mock_user]
        async def mock_execute_side_effect(*args, **kwargs):
            return mock_result
        mock_session.execute = mock_execute_side_effect
        
        # –ú–æ–∫–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–∏–π
        async def mock_scalar_side_effect(*args, **kwargs):
            return 3
        mock_session.scalar = mock_scalar_side_effect
        
        # –ú–æ–∫–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async def mock_get_side_effect(model, user_id):
            if model == User and user_id == 456:
                return mock_user
            return None
        mock_session.get = mock_get_side_effect
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é –∫–Ω–æ–ø–∫—É –º–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        users_callbacks = [
            "admin_search_user",
            "admin_list_users_1"
        ]
        
        for callback_data in users_callbacks:
            callback.data = callback_data
            
            if callback_data == "admin_search_user":
                from handlers.admin.users_handlers import start_user_search
                await start_user_search(callback, state)
            elif callback_data.startswith("admin_list_users_"):
                from handlers.admin.users_handlers import show_users_list
                await show_users_list(callback, mock_session)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–µ—Ç–æ–¥ edit_text –±—ã–ª –≤—ã–∑–≤–∞–Ω
            callback.message.edit_text.assert_called()
            callback.message.edit_text.reset_mock()
            
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_admin_giveaways_menu_buttons(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        callback = MagicMock(spec=CallbackQuery)
        callback.from_user = admin_user
        callback.message = MagicMock(spec=Message)
        callback.message.edit_text = AsyncMock()
        callback.answer = AsyncMock()
        
        # –ú–æ–∫–∞–µ–º FSM state
        state = AsyncMock()
        
        # –ú–æ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
        mock_giveaway = MagicMock(spec=Giveaway)
        mock_giveaway.id = 1
        mock_giveaway.prize_text = "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–∑"
        mock_giveaway.owner_id = 456
        mock_giveaway.status = "active"
        mock_giveaway.finish_time = MagicMock()
        mock_giveaway.finish_time.strftime.return_value = "2023-01-10 12:00"
        mock_giveaway.winners_count = 1
        
        mock_result = MagicMock()
        mock_result.scalars.return_value.all.return_value = [mock_giveaway]
        async def mock_execute_side_effect(*args, **kwargs):
            return mock_result
        mock_session.execute = mock_execute_side_effect
        
        # –ú–æ–∫–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        async def mock_scalar_side_effect(*args, **kwargs):
            return 10
        mock_session.scalar = mock_scalar_side_effect
        
        # –ú–æ–∫–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
        async def mock_get_side_effect(model, giveaway_id):
            if model == Giveaway and giveaway_id == 1:
                return mock_giveaway
            return None
        mock_session.get = mock_get_side_effect
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é –∫–Ω–æ–ø–∫—É –º–µ–Ω—é —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
        giveaways_callbacks = [
            "admin_search_giveaway",
            "admin_list_giveaways_1"
        ]
        
        for callback_data in giveaways_callbacks:
            callback.data = callback_data
            
            if callback_data == "admin_search_giveaway":
                from handlers.admin.giveaways_handlers import start_giveaway_search
                await start_giveaway_search(callback, state)
            elif callback_data.startswith("admin_list_giveaways_"):
                # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –º–æ–∫ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ int –≤–º–µ—Å—Ç–æ MagicMock
                original_scalar = mock_session.scalar
                async def fixed_scalar_side_effect(*args, **kwargs):
                    result = await original_scalar(*args, **kwargs) if hasattr(original_scalar, '__call__') else original_scalar
                    if isinstance(result, MagicMock):
                        return 10  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                    return result
                mock_session.scalar = fixed_scalar_side_effect
                
                from handlers.admin.giveaways_handlers import show_giveaways_list
                await show_giveaways_list(callback, mock_session)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–µ—Ç–æ–¥ edit_text –±—ã–ª –≤—ã–∑–≤–∞–Ω
            callback.message.edit_text.assert_called()
            callback.message.edit_text.reset_mock()
            
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_admin_broadcast_menu_buttons(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é —Ä–∞—Å—Å—ã–ª–æ–∫
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        callback = MagicMock(spec=CallbackQuery)
        callback.from_user = admin_user
        callback.message = MagicMock(spec=Message)
        callback.message.edit_text = AsyncMock()
        callback.answer = AsyncMock()
        
        # –ú–æ–∫–∞–µ–º FSM state
        state = AsyncMock()
        
        # –ú–æ–∫–∞–µ–º —Ä–∞—Å—Å—ã–ª–∫–∏ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
        from database.models import Broadcast
        mock_broadcast = MagicMock(spec=Broadcast)
        mock_broadcast.id = 1
        mock_broadcast.created_at = MagicMock()
        mock_broadcast.created_at.strftime.return_value = "2023-01-01 12:00"
        mock_broadcast.message_text = "–¢–µ—Å—Ç–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞"
        mock_broadcast.status = "sent"
        mock_broadcast.sent_count = 5
        mock_broadcast.total_count = 10
        mock_broadcast.failed_count = 0
        mock_broadcast.blocked_count = 0
        
        mock_result = MagicMock()
        mock_result.scalars.return_value.all.return_value = [mock_broadcast]
        mock_session.execute.return_value = mock_result
        
        # –ú–æ–∫–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞—Å—Å—ã–ª–æ–∫
        async def mock_scalar_side_effect(*args, **kwargs):
            return 1  # –û–¥–Ω–∞ —Ä–∞—Å—Å—ã–ª–∫–∞
        mock_session.scalar = mock_scalar_side_effect
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é –∫–Ω–æ–ø–∫—É –º–µ–Ω—é —Ä–∞—Å—Å—ã–ª–æ–∫
        broadcast_callbacks = [
            "admin_create_broadcast",
            "admin_broadcast_history_1",
            "admin_scheduled_broadcasts_1"
        ]
        
        for callback_data in broadcast_callbacks:
            callback.data = callback_data
            
            if callback_data == "admin_create_broadcast":
                from handlers.admin.broadcast_handlers import start_create_broadcast
                await start_create_broadcast(callback, state)
            elif callback_data.startswith("admin_broadcast_history_"):
                from handlers.admin.broadcast_handlers import show_broadcast_history
                await show_broadcast_history(callback, mock_session)
            elif callback_data.startswith("admin_scheduled_broadcasts_"):
                from handlers.admin.broadcast_handlers import show_scheduled_broadcasts
                await show_scheduled_broadcasts(callback, mock_session)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–µ—Ç–æ–¥ edit_text –±—ã–ª –≤—ã–∑–≤–∞–Ω
            callback.message.edit_text.assert_called()
            callback.message.edit_text.reset_mock()
            
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_admin_pagination_buttons(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –∫–Ω–æ–ø–æ–∫ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –≤ –º–µ–Ω—é –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        callback = MagicMock(spec=CallbackQuery)
        callback.from_user = admin_user
        callback.message = MagicMock(spec=Message)
        callback.message.edit_text = AsyncMock()
        callback.answer = AsyncMock()
        
        # –ú–æ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        mock_users = []
        for i in range(25):  # –°–æ–∑–¥–∞–µ–º 25 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —Ç–µ—Å—Ç–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
            mock_user = MagicMock(spec=User)
            mock_user.user_id = 100 + i
            mock_user.username = f"user{i}"
            mock_user.full_name = f"User {i}"
            mock_user.created_at = MagicMock()
            mock_user.created_at.strftime.return_value = f"2023-01-{i+1:02d} 12:00"
            mock_user.premium_until = None
            mock_users.append(mock_user)
        
        # –ú–æ–∫–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        async def mock_execute_users_side_effect(*args, **kwargs):
            mock_result = MagicMock()
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç OFFSET –∏ LIMIT
            query_str = str(args[0])
            offset = 0
            limit = 10
            
            if 'OFFSET' in query_str.upper():
                import re
                offset_match = re.search(r'OFFSET\s+(\d+)', query_str, re.IGNORECASE)
                if offset_match:
                    offset = int(offset_match.group(1))
            
            if 'LIMIT' in query_str.upper():
                import re
                limit_match = re.search(r'LIMIT\s+(\d+)', query_str, re.IGNORECASE)
                if limit_match:
                    limit = int(limit_match.group(1))
                    
            current_page_users = mock_users[offset:offset + limit]
            mock_result.scalars.return_value.all.return_value = current_page_users
            return mock_result
            
        # –ú–æ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
        mock_giveaways = []
        for i in range(25):  # –°–æ–∑–¥–∞–µ–º 25 —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –¥–ª—è —Ç–µ—Å—Ç–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
            mock_giveaway = MagicMock(spec=Giveaway)
            mock_giveaway.id = i + 1
            mock_giveaway.prize_text = f"–ü—Ä–∏–∑ {i+1}"
            mock_giveaway.owner_id = 100 + i
            mock_giveaway.status = "active"
            mock_giveaway.finish_time = MagicMock()
            mock_giveaway.finish_time.strftime.return_value = f"2023-01-{i+10:02d} 12:00"
            mock_giveaway.winners_count = 1
            mock_giveaways.append(mock_giveaway)
        
        # –ú–æ–∫–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
        async def mock_execute_giveaways_side_effect(*args, **kwargs):
            mock_result = MagicMock()
            query_str = str(args[0])
            offset = 0
            limit = 10
            
            if 'OFFSET' in query_str.upper():
                import re
                offset_match = re.search(r'OFFSET\s+(\d+)', query_str, re.IGNORECASE)
                if offset_match:
                    offset = int(offset_match.group(1))
            
            if 'LIMIT' in query_str.upper():
                import re
                limit_match = re.search(r'LIMIT\s+(\d+)', query_str, re.IGNORECASE)
                if limit_match:
                    limit = int(limit_match.group(1))
                    
            current_page_giveaways = mock_giveaways[offset:offset + limit]
            mock_result.scalars.return_value.all.return_value = current_page_giveaways
            return mock_result
        
        # –ú–æ–∫–∏—Ä—É–µ–º Broadcast –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ —Ä–∞—Å—Å—ã–ª–æ–∫
        from database.models import Broadcast
        mock_broadcasts = []
        for i in range(25):  # –°–æ–∑–¥–∞–µ–º 25 —Ä–∞—Å—Å—ã–ª–æ–∫ –¥–ª—è —Ç–µ—Å—Ç–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
            mock_broadcast = MagicMock(spec=Broadcast)
            mock_broadcast.id = i + 1
            mock_broadcast.created_at = MagicMock()
            mock_broadcast.created_at.strftime.return_value = f"2023-01-{i+1:02d} 12:00"
            mock_broadcast.message_text = f"–¢–µ—Å—Ç–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ {i+1}"
            mock_broadcast.status = "sent"
            mock_broadcast.sent_count = 5
            mock_broadcast.total_count = 10
            mock_broadcast.failed_count = 0
            mock_broadcast.blocked_count = 0
            mock_broadcasts.append(mock_broadcast)
        
        # –ú–æ–∫–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ —Ä–∞—Å—Å—ã–ª–æ–∫
        async def mock_execute_broadcasts_side_effect(*args, **kwargs):
            mock_result = MagicMock()
            query_str = str(args[0])
            offset = 0
            limit = 10
            
            if 'OFFSET' in query_str.upper():
                import re
                offset_match = re.search(r'OFFSET\s+(\d+)', query_str, re.IGNORECASE)
                if offset_match:
                    offset = int(offset_match.group(1))
            
            if 'LIMIT' in query_str.upper():
                import re
                limit_match = re.search(r'LIMIT\s+(\d+)', query_str, re.IGNORECASE)
                if limit_match:
                    limit = int(limit_match.group(1))
                    
            current_page_broadcasts = mock_broadcasts[offset:offset + limit]
            mock_result.scalars.return_value.all.return_value = current_page_broadcasts
            return mock_result
        
        # –ú–æ–∫–∞–µ–º –∑–∞–ø—Ä–æ—Å—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –º–æ–¥–µ–ª–∏
        async def conditional_execute_side_effect(*args, **kwargs):
            query_str = str(args[0])
            if 'Giveaway' in str(query_str) or 'giveaways' in query_str.lower():
                return await mock_execute_giveaways_side_effect(*args, **kwargs)
            elif 'Broadcast' in str(query_str) or 'broadcasts' in query_str.lower():
                return await mock_execute_broadcasts_side_effect(*args, **kwargs)
            else:
                return await mock_execute_users_side_effect(*args, **kwargs)
        
        mock_session.execute = conditional_execute_side_effect
        
        # –ú–æ–∫–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ - –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º int –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
        async def mock_scalar_side_effect(*args, **kwargs):
            return 25  # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
        mock_session.scalar = mock_scalar_side_effect
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
        pagination_callbacks = [
            "admin_list_users_1",
            "admin_list_users_2",
            "admin_list_giveaways_1",
            "admin_list_giveaways_2",
            "admin_broadcast_history_1",
            "admin_broadcast_history_2"
        ]
        
        for callback_data in pagination_callbacks:
            callback.data = callback_data
            
            # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏ –≤—ã–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
            if callback_data.startswith("admin_list_users_"):
                from handlers.admin.users_handlers import show_users_list
                await show_users_list(callback, mock_session)
            elif callback_data.startswith("admin_list_giveaways_"):
                from handlers.admin.giveaways_handlers import show_giveaways_list
                await show_giveaways_list(callback, mock_session)
            elif callback_data.startswith("admin_broadcast_history_"):
                from handlers.admin.broadcast_handlers import show_broadcast_history
                await show_broadcast_history(callback, mock_session)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–µ—Ç–æ–¥ edit_text –±—ã–ª –≤—ã–∑–≤–∞–Ω
            callback.message.edit_text.assert_called()
            callback.message.edit_text.reset_mock()
            
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_admin_user_action_buttons(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        callback = MagicMock(spec=CallbackQuery)
        callback.from_user = admin_user
        callback.message = MagicMock(spec=Message)
        callback.message.edit_text = AsyncMock()
        callback.answer = AsyncMock()
        
        # –ú–æ–∫–∞–µ–º FSM state
        state = AsyncMock()
        
        # –ú–æ–∫–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        mock_user = MagicMock(spec=User)
        mock_user.user_id = 456
        mock_user.username = "testuser"
        mock_user.full_name = "Test User"
        mock_user.is_premium = False
        mock_user.created_at = MagicMock()
        mock_user.created_at.strftime.return_value = "2023-01-01 12:00"
        mock_user.premium_until = None
        
        # –ú–æ–∫–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async def mock_get_side_effect(model, user_id):
            if model == User and user_id == 456:
                return mock_user
            return None
        mock_session.get = mock_get_side_effect
        
        # –ú–æ–∫–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–∏–π
        async def mock_scalar_side_effect(*args, **kwargs):
            return 3
        mock_session.scalar = mock_scalar_side_effect
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
        user_action_callbacks = [
            ("admin_user_detail_456", "user_detail"),
            ("admin_grant_premium_456", "grant_premium"),
            ("admin_revoke_premium_456", "revoke_premium"),
            ("admin_confirm_premium_grant_456", "confirm_premium_grant"),
            ("admin_confirm_premium_revoke_456", "confirm_premium_revoke")
        ]
        
        for callback_data, action_type in user_action_callbacks:
            callback.data = callback_data
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ callback_data
            parts = callback_data.split('_')
            user_id = int(parts[-1])  # ID –≤—Å–µ–≥–¥–∞ –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–π —á–∞—Å—Ç–∏
            
            if action_type == "user_detail":
                from handlers.admin.users_handlers import show_user_detail
                await show_user_detail(callback, mock_session)
            elif action_type == "grant_premium":
                from handlers.admin.users_handlers import confirm_grant_premium
                await confirm_grant_premium(callback)
            elif action_type == "revoke_premium":
                from handlers.admin.users_handlers import confirm_revoke_premium
                await confirm_revoke_premium(callback)
            elif action_type == "confirm_premium_grant":
                from handlers.admin.users_handlers import process_premium_change
                await process_premium_change(callback, mock_session)
            elif action_type == "confirm_premium_revoke":
                from handlers.admin.users_handlers import process_premium_change
                await process_premium_change(callback, mock_session)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–µ—Ç–æ–¥ edit_text –±—ã–ª –≤—ã–∑–≤–∞–Ω
            callback.message.edit_text.assert_called()
            callback.message.edit_text.reset_mock()
            
    finally:
        config.ADMIN_IDS = original_admin_ids


@pytest.mark.asyncio
async def test_admin_giveaway_action_buttons(mock_bot, mock_session, admin_user):
    """
    –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —Ä–æ–∑—ã–≥—Ä—ã—à–µ–º
    """
    original_admin_ids = config.ADMIN_IDS
    config.ADMIN_IDS = [123]
    
    try:
        callback = MagicMock(spec=CallbackQuery)
        callback.from_user = admin_user
        callback.message = MagicMock(spec=Message)
        callback.message.edit_text = AsyncMock()
        callback.answer = AsyncMock()
        
        # –ú–æ–∫–∞–µ–º FSM state
        state = AsyncMock()
        bot_mock = AsyncMock(spec=Bot)
        
        # –ú–æ–∫–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ä–æ–∑—ã–≥—Ä—ã—à
        mock_giveaway = MagicMock(spec=Giveaway)
        mock_giveaway.id = 1
        mock_giveaway.prize_text = "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–∑"
        mock_giveaway.owner_id = 456
        mock_giveaway.status = "active"
        mock_giveaway.finish_time = MagicMock()
        mock_giveaway.finish_time.strftime.return_value = "2023-01-10 12:00"
        mock_giveaway.winners_count = 1
        
        # –ú–æ–∫–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
        async def mock_get_side_effect(model, giveaway_id):
            if model == Giveaway and giveaway_id == 1:
                return mock_giveaway
            return None
        mock_session.get = mock_get_side_effect
        
        # –ú–æ–∫–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        async def mock_scalar_side_effect(*args, **kwargs):
            return 10
        mock_session.scalar = mock_scalar_side_effect
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π —Å —Ä–æ–∑—ã–≥—Ä—ã—à–µ–º
        giveaway_action_callbacks = [
            "admin_giveaway_detail_1",
            "admin_force_finish_1",
            "admin_confirm_giveaway_finish_1"
        ]
        
        for callback_data in giveaway_action_callbacks:
            # –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ callback –¥–∞–Ω–Ω—ã—Ö
            if "confirm_giveaway_finish" in callback_data:
                parts = callback_data.split('_')
                giveaway_id = int(parts[-1])  # –ø–æ—Å–ª–µ–¥–Ω—è—è —á–∞—Å—Ç—å - ID —Ä–æ–∑—ã–≥—Ä—ã—à–∞
                callback.data = f"admin_confirm_giveaway_finish_{giveaway_id}"
            else:
                callback.data = callback_data
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º ID —Ä–æ–∑—ã–≥—Ä—ã—à–∞ –∏–∑ callback_data
            parts = callback_data.split('_')
            if len(parts) >= 3:
                giveaway_id = int(parts[-1])
                
                if "giveaway_detail" in callback_data:
                    # –î–æ–±–∞–≤–ª—è–µ–º –Ω—É–∂–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    mock_giveaway.created_at = MagicMock()
                    mock_giveaway.created_at.strftime.return_value = "2023-01-01 12:00"
                    
                    from handlers.admin.giveaways_handlers import show_giveaway_detail
                    await show_giveaway_detail(callback, mock_session)
                elif "force_finish" in callback_data:
                    from handlers.admin.giveaways_handlers import confirm_force_finish_giveaway
                    await confirm_force_finish_giveaway(callback)
                elif "confirm_giveaway_finish" in callback.data:
                    # –î–ª—è —ç—Ç–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Ç–∞–∫–∂–µ –Ω—É–∂–µ–Ω –æ–±—ä–µ–∫—Ç –±–æ—Ç–∞
                    from handlers.admin.giveaways_handlers import process_giveaway_action
                    await process_giveaway_action(callback, mock_session, bot_mock)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–µ—Ç–æ–¥ edit_text –±—ã–ª –≤—ã–∑–≤–∞–Ω
            callback.message.edit_text.assert_called()
            callback.message.edit_text.reset_mock()
            
    finally:
        config.ADMIN_IDS = original_admin_ids=== ./tests/test_giveaway_notifications.py ===
import pytest
import time
from datetime import datetime, timedelta
from unittest.mock import AsyncMock, MagicMock, patch
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from aiogram import Bot
from aiogram.types import User as AiogramUser, Chat
from database.models.giveaway import Giveaway
from database.models.user import User
from database.models.participant import Participant
from database.models.winner import Winner
from database.requests.giveaway_repo import create_giveaway
from core.logic.randomizer import select_winners
from core.services.message_service import MessageHandler


@pytest.mark.asyncio
class TestGiveawayNotifications:
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π"""

    async def test_notify_winner_about_victory(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –æ –ø–æ–±–µ–¥–µ"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456789 + int(time.time()) % 100000  # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
        channel_id = -1001234567890
        message_id = 128 + int(time.time()) % 1000  # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å–æ–æ–±—â–µ–Ω–∏—è
        prize = "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–∑"
        winners_count = 1
        end_time = datetime.now() - timedelta(hours=1)  # –†–æ–∑—ã–≥—Ä—ã—à —É–∂–µ –¥–æ–ª–∂–µ–Ω –∑–∞–∫–æ–Ω—á–∏—Ç—å—Å—è
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners_count, end_time
        )
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º ID
        winner_user_id = 987654321 + int(time.time()) % 1000000  # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
        winner_username = f"winner_user_{int(time.time())}"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        existing_user = await async_session.get(User, winner_user_id)
        if existing_user:
            # –ï—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —É–¥–∞–ª—è–µ–º
            await async_session.delete(existing_user)
            await async_session.commit()
        
        # –°–æ–∑–¥–∞–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –∫–∞–∫ —É—á–∞—Å—Ç–Ω–∏–∫–∞
        user = User(
            user_id=winner_user_id,
            username=winner_username,
            full_name="Winner User",
            is_premium=False
        )
        async_session.add(user)
        
        participant = Participant(
            user_id=winner_user_id,
            giveaway_id=giveaway_id
        )
        async_session.add(participant)
        
        await async_session.commit()
        
        # –ú–æ–∫–∏—Ä—É–µ–º –±–æ—Ç–∞
        with patch('aiogram.Bot.send_message') as mock_send_message:
            mock_send_message.return_value = AsyncMock()
            
            bot = AsyncMock(spec=Bot)
            bot.send_message = mock_send_message
            
            # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
            notification_text = f"üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ '{prize}' –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ!"
            await bot.send_message(winner_user_id, notification_text)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
            mock_send_message.assert_called_once_with(winner_user_id, notification_text)

    async def test_notify_creator_about_winner(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å–æ–∑–¥–∞—Ç–µ–ª—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ –æ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456789 + int(time.time()) % 100000  # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
        channel_id = -1001234567890
        message_id = 129 + int(time.time()) % 1000  # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å–æ–æ–±—â–µ–Ω–∏—è
        prize = "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–∑ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å–æ–∑–¥–∞—Ç–µ–ª—è"
        winners_count = 1
        end_time = datetime.now() - timedelta(hours=1)  # –†–æ–∑—ã–≥—Ä—ã—à —É–∂–µ –¥–æ–ª–∂–µ–Ω –∑–∞–∫–æ–Ω—á–∏—Ç—å—Å—è
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners_count, end_time
        )
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º ID
        winner_user_id = 987654322 + int(time.time()) % 1000000  # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
        winner_username = f"winner_user2_{int(time.time())}"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        existing_user = await async_session.get(User, winner_user_id)
        if existing_user:
            # –ï—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —É–¥–∞–ª—è–µ–º
            await async_session.delete(existing_user)
            await async_session.commit()
        
        # –°–æ–∑–¥–∞–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –∫–∞–∫ —É—á–∞—Å—Ç–Ω–∏–∫–∞
        user = User(
            user_id=winner_user_id,
            username=winner_username,
            full_name="Winner User2",
            is_premium=False
        )
        async_session.add(user)
        
        participant = Participant(
            user_id=winner_user_id,
            giveaway_id=giveaway_id
        )
        async_session.add(participant)
        
        await async_session.commit()
        
        # –ú–æ–∫–∏—Ä—É–µ–º –±–æ—Ç–∞
        with patch('aiogram.Bot.send_message') as mock_send_message:
            mock_send_message.return_value = AsyncMock()
            
            bot = AsyncMock(spec=Bot)
            bot.send_message = mock_send_message
            
            # –£–≤–µ–¥–æ–º–ª—è–µ–º —Å–æ–∑–¥–∞—Ç–µ–ª—è
            creator_notification = f"üèÜ –í –≤–∞—à–µ–º —Ä–æ–∑—ã–≥—Ä—ã—à–µ '{prize}' –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –ø–æ–±–µ–¥–∏—Ç–µ–ª—å!\n\n–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: @{winner_username} (ID: {winner_user_id})"
            await bot.send_message(owner_id, creator_notification)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–∑–¥–∞—Ç–µ–ª—é
            mock_send_message.assert_called_once_with(owner_id, creator_notification)

    async def test_notify_multiple_winners(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456789 + int(time.time()) % 100000  # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
        channel_id = -1001234567890
        message_id = 130 + int(time.time()) % 1000  # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å–æ–æ–±—â–µ–Ω–∏—è
        prize = "–ü—Ä–∏–∑ –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π"
        winners_count = 3
        end_time = datetime.now() - timedelta(hours=1)  # –†–æ–∑—ã–≥—Ä—ã—à —É–∂–µ –¥–æ–ª–∂–µ–Ω –∑–∞–∫–æ–Ω—á–∏—Ç—å—Å—è
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners_count, end_time
        )
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ ID
        base_user_id = 987654323 + int(time.time()) % 1000000  # –ë–∞–∑–æ–≤—ã–π ID —Å —É—á–µ—Ç–æ–º –≤—Ä–µ–º–µ–Ω–∏
        winners_data = [
            {"user_id": base_user_id, "username": f"winner3_{int(time.time())}", "full_name": "Winner3 User"},
            {"user_id": base_user_id + 1, "username": f"winner4_{int(time.time())}", "full_name": "Winner4 User"},
            {"user_id": base_user_id + 2, "username": f"winner5_{int(time.time())}", "full_name": "Winner5 User"},
        ]
        
        for winner_data in winners_data:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            existing_user = await async_session.get(User, winner_data["user_id"])
            if existing_user:
                # –ï—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —É–¥–∞–ª—è–µ–º
                await async_session.delete(existing_user)
                await async_session.commit()
            
            # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user = User(
                user_id=winner_data["user_id"],
                username=winner_data["username"],
                full_name=winner_data["full_name"],
                is_premium=False
            )
            async_session.add(user)
            
            # –°–æ–∑–¥–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞
            participant = Participant(
                user_id=winner_data["user_id"],
                giveaway_id=giveaway_id
            )
            async_session.add(participant)
        
        await async_session.commit()
        
        # –ú–æ–∫–∏—Ä—É–µ–º –±–æ—Ç–∞
        with patch('aiogram.Bot.send_message') as mock_send_message:
            mock_send_message.return_value = AsyncMock()
            
            bot = AsyncMock(spec=Bot)
            bot.send_message = mock_send_message
            
            # –£–≤–µ–¥–æ–º–ª—è–µ–º –≤—Å–µ—Ö –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π
            for winner_data in winners_data:
                notification_text = f"üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ '{prize}' –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ!"
                await bot.send_message(winner_data["user_id"], notification_text)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏—è –±—ã–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è–º
            assert mock_send_message.call_count == len(winners_data)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–∞–∂–¥–æ–º—É –ø–æ–±–µ–¥–∏—Ç–µ–ª—é –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
            for winner_data in winners_data:
                mock_send_message.assert_any_call(winner_data["user_id"], f"üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ '{prize}' –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ!")

    async def test_notify_creator_about_multiple_winners(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å–æ–∑–¥–∞—Ç–µ–ª—è –æ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–±–µ–¥–∏—Ç–µ–ª—è—Ö"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456789 + int(time.time()) % 100000  # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
        channel_id = -1001234567890
        message_id = 131 + int(time.time()) % 1000  # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å–æ–æ–±—â–µ–Ω–∏—è
        prize = "–ü—Ä–∏–∑ –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞—Ç–µ–ª—é)"
        winners_count = 2
        end_time = datetime.now() - timedelta(hours=1)  # –†–æ–∑—ã–≥—Ä—ã—à —É–∂–µ –¥–æ–ª–∂–µ–Ω –∑–∞–∫–æ–Ω—á–∏—Ç—å—Å—è
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners_count, end_time
        )
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ ID
        base_user_id = 987654326 + int(time.time()) % 1000000  # –ë–∞–∑–æ–≤—ã–π ID —Å —É—á–µ—Ç–æ–º –≤—Ä–µ–º–µ–Ω–∏
        winners_data = [
            {"user_id": base_user_id, "username": f"winner6_{int(time.time())}", "full_name": "Winner6 User"},
            {"user_id": base_user_id + 1, "username": f"winner7_{int(time.time())}", "full_name": "Winner7 User"},
        ]
        
        for winner_data in winners_data:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            existing_user = await async_session.get(User, winner_data["user_id"])
            if existing_user:
                # –ï—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —É–¥–∞–ª—è–µ–º
                await async_session.delete(existing_user)
                await async_session.commit()
            
            # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user = User(
                user_id=winner_data["user_id"],
                username=winner_data["username"],
                full_name=winner_data["full_name"],
                is_premium=False
            )
            async_session.add(user)
            
            # –°–æ–∑–¥–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞
            participant = Participant(
                user_id=winner_data["user_id"],
                giveaway_id=giveaway_id
            )
            async_session.add(participant)
        
        await async_session.commit()
        
        # –ú–æ–∫–∏—Ä—É–µ–º –±–æ—Ç–∞
        with patch('aiogram.Bot.send_message') as mock_send_message:
            mock_send_message.return_value = AsyncMock()
            
            bot = AsyncMock(spec=Bot)
            bot.send_message = mock_send_message
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å–æ–∑–¥–∞—Ç–µ–ª—è
            winners_list = ""
            for winner_data in winners_data:
                winners_list += f"\n‚Ä¢ @{winner_data['username']} (ID: {winner_data['user_id']})"
            
            creator_notification = f"üèÜ –í –≤–∞—à–µ–º —Ä–æ–∑—ã–≥—Ä—ã—à–µ '{prize}' –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –ø–æ–±–µ–¥–∏—Ç–µ–ª–∏!{winners_list}"
            await bot.send_message(owner_id, creator_notification)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–∑–¥–∞—Ç–µ–ª—é
            mock_send_message.assert_called_once_with(owner_id, creator_notification)

    async def test_notify_winner_with_username_mention(self, async_session: AsyncSession):
        """–¢–µ—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–±–µ–¥–∏—Ç–µ–ª—è —Å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ–º –µ–≥–æ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        owner_id = 123456789 + int(time.time()) % 100000  # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
        channel_id = -1001234567890
        message_id = 132 + int(time.time()) % 1000  # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å–æ–æ–±—â–µ–Ω–∏—è
        prize = "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–∑ —Å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ–º"
        winners_count = 1
        end_time = datetime.now() - timedelta(hours=1)  # –†–æ–∑—ã–≥—Ä—ã—à —É–∂–µ –¥–æ–ª–∂–µ–Ω –∑–∞–∫–æ–Ω—á–∏—Ç—å—Å—è
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
        giveaway_id = await create_giveaway(
            async_session, owner_id, channel_id, message_id,
            prize, winners_count, end_time
        )
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º ID
        winner_user_id = 987654328 + int(time.time()) % 1000000  # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
        winner_username = f"mentionable_user8_{int(time.time())}"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        existing_user = await async_session.get(User, winner_user_id)
        if existing_user:
            # –ï—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —É–¥–∞–ª—è–µ–º
            await async_session.delete(existing_user)
            await async_session.commit()
        
        # –°–æ–∑–¥–∞–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –∫–∞–∫ —É—á–∞—Å—Ç–Ω–∏–∫–∞
        user = User(
            user_id=winner_user_id,
            username=winner_username,
            full_name="Mentionable User8",
            is_premium=False
        )
        async_session.add(user)
        
        participant = Participant(
            user_id=winner_user_id,
            giveaway_id=giveaway_id
        )
        async_session.add(participant)
        
        await async_session.commit()
        
        # –ú–æ–∫–∏—Ä—É–µ–º –±–æ—Ç–∞
        with patch('aiogram.Bot.send_message') as mock_send_message:
            mock_send_message.return_value = AsyncMock()
            
            bot = AsyncMock(spec=Bot)
            bot.send_message = mock_send_message
            
            # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è —Å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ–º –µ–≥–æ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            notification_text = f"üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º, @{winner_username}! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ '{prize}' –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ!"
            await bot.send_message(winner_user_id, notification_text)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ–º
            mock_send_message.assert_called_once_with(winner_user_id, notification_text)=== ./docker-compose.yml ===
# docker-compose.yml
version: '3.8'

services:
  bot:
    build: .
    env_file: .env
    depends_on:
      - db
      - redis
    restart: always

  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: pass
      POSTGRES_DB: giveaway_bot
    volumes:
      - pg_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data

volumes:
  pg_data:
  redis_data:=== ./core/tools/timezone.py ===
from datetime import datetime, timezone
from zoneinfo import ZoneInfo

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
MSK = ZoneInfo("Europe/Moscow")
UTC = timezone.utc

def get_now_utc() -> datetime:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ UTC —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∑–æ–Ω–µ."""
    return datetime.now(UTC)

def get_now_msk() -> datetime:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ –ú–°–ö —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∑–æ–Ω–µ."""
    return datetime.now(MSK)

def to_utc(dt: datetime) -> datetime:
    """
    –ü–µ—Ä–µ–≤–æ–¥–∏—Ç –ª—é–±–æ–µ –≤—Ä–µ–º—è –≤ UTC.
    –ï—Å–ª–∏ –≤—Ä–µ–º—è –ø—Ä–∏—à–ª–æ –±–µ–∑ –∑–æ–Ω—ã (naive), —Å—á–∏—Ç–∞–µ–º –µ–≥–æ –ú–°–ö (—Ç–∞–∫ –∫–∞–∫ –±–æ—Ç –¥–ª—è –†–§).
    """
    if dt.tzinfo is None:
        # –ï—Å–ª–∏ –∑–æ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞, –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º MSK (–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Ç–≤–æ–µ–≥–æ –±–æ—Ç–∞)
        dt = dt.replace(tzinfo=MSK)
    return dt.astimezone(UTC)

def to_msk(dt: datetime) -> datetime:
    """
    –ü–µ—Ä–µ–≤–æ–¥–∏—Ç –ª—é–±–æ–µ –≤—Ä–µ–º—è –≤ –ú–°–ö.
    –ï—Å–ª–∏ –≤—Ä–µ–º—è –ø—Ä–∏—à–ª–æ –±–µ–∑ –∑–æ–Ω—ã (naive), —Å—á–∏—Ç–∞–µ–º –µ–≥–æ UTC.
    """
    if dt.tzinfo is None:
        # –ï—Å–ª–∏ –∑–æ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞, –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º UTC
        dt = dt.replace(tzinfo=UTC)
    return dt.astimezone(MSK)

def strip_tz(dt: datetime) -> datetime:
    """
    –£–±–∏—Ä–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∑–æ–Ω–µ, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ "naive" datetime.
    """
    return dt.replace(tzinfo=None)

def to_user_timezone(dt: datetime, tz: ZoneInfo = MSK) -> datetime:
    """–ü–µ—Ä–µ–≤–æ–¥–∏—Ç –≤—Ä–µ–º—è –∏–∑ –ë–î (UTC) –≤ –∑–æ–Ω—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è."""
    if dt.tzinfo is None:
        # –ï—Å–ª–∏ –≤–¥—Ä—É–≥ –∏–∑ –±–∞–∑—ã –ø—Ä–∏—à–ª–æ –±–µ–∑ –∑–æ–Ω—ã (—Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏), —Å—á–∏—Ç–∞–µ–º UTC
        dt = dt.replace(tzinfo=UTC)
    return dt.astimezone(tz)=== ./core/tools/scheduler.py ===
# core/tools/scheduler.py
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.jobstores.redis import RedisJobStore
from redis import ConnectionPool
from config import config
import logging

logger = logging.getLogger(__name__)

# APScheduler 3.x –Ω–µ —É–º–µ–µ—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Å—Ç—Ä–æ–∫—É URL –Ω–∞–ø—Ä—è–º—É—é.
# –ú—ã —Å–æ–∑–¥–∞–µ–º –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —á–µ—Ä–µ–∑ redis-py, –∫–æ—Ç–æ—Ä—ã–π —É–º–µ–µ—Ç –ø–∞—Ä—Å–∏—Ç—å URL.
pool = ConnectionPool.from_url(config.REDIS_URL)

job_stores = {
    "default": RedisJobStore(
        jobs_key="giveaway_jobs",
        run_times_key="giveaway_run_times",
        connection_pool=pool  # <-- –ü–µ—Ä–µ–¥–∞–µ–º –≥–æ—Ç–æ–≤—ã–π –ø—É–ª –≤–º–µ—Å—Ç–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    )
}

scheduler = AsyncIOScheduler(jobstores=job_stores, timezone="UTC")

async def start_scheduler():
    scheduler.start()
    logger.info("Scheduler started")

async def shutdown_scheduler():
    scheduler.shutdown()
    logger.info("Scheduler shutdown completed")=== ./core/tools/formatters.py ===
from datetime import datetime
from core.tools.timezone import to_msk

def format_giveaway_caption(prize_text: str, winners_count: int, finish_time: datetime, participants_count: int, is_hidden: bool = False) -> str:
    # –ü–µ—Ä–µ–≤–æ–¥–∏–º –≤—Ä–µ–º—è –≤ –ú–°–ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    finish_msk = to_msk(finish_time)
    
    # –°—á–∏—Ç–∞–µ–º –æ—Å—Ç–∞—Ç–æ–∫ –≤—Ä–µ–º–µ–Ω–∏
    now_msk = to_msk(datetime.utcnow())
    delta = finish_msk - now_msk
    
    if delta.total_seconds() < 0:
        time_left = "–ó–∞–≤–µ—Ä—à–µ–Ω"
    elif delta.days > 0:
        time_left = f"{delta.days} –¥–Ω."
    elif delta.seconds > 3600:
        time_left = f"{delta.seconds // 3600} —á."
    else:
        time_left = "–°–∫–æ—Ä–æ"

    date_str = finish_msk.strftime("%d.%m.%Y %H:%M MSK")

    # –õ–û–ì–ò–ö–ê –°–ö–†–´–¢–ò–Ø
    if is_hidden:
        part_text = "üî• –ú–Ω–æ–≥–æ" # –ò–ª–∏ "–°–∫—Ä—ã—Ç–æ", –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–µ –≤—ã–≤–æ–¥–∏—Ç—å —Å—Ç—Ä–æ–∫—É
    else:
        part_text = str(participants_count)

    return (
        f"{prize_text}\n\n"
        f"‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
        f"üë• <b>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</b> {part_text}\n"
        f"üèÜ <b>–ü—Ä–∏–∑–æ–≤—ã—Ö –º–µ—Å—Ç:</b> {winners_count}\n"
        f"‚è≥ <b>–ò—Ç–æ–≥–∏:</b> {date_str} ({time_left})"
    )=== ./core/tools/broadcast_scheduler.py ===
import logging
from datetime import datetime, timedelta
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.jobstores.redis import RedisJobStore
from redis import ConnectionPool
from aiogram import Bot
from aiogram.client.default import DefaultBotProperties
from sqlalchemy import select, update

from config import config
from database import async_session_maker
from database.models import Broadcast
from services.admin_broadcast_service import BroadcastService

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞: –°–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –±–æ—Ç –º–æ–∂–µ—Ç "–æ–ø–∞–∑–¥—ã–≤–∞—Ç—å".
# –ï—Å–ª–∏ –±–æ—Ç –ª–µ–∂–∞–ª –±–æ–ª—å—à–µ —ç—Ç–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, —Ä–∞—Å—Å—ã–ª–∫–∞ –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–µ–Ω–∞.
BROADCAST_TOLERANCE_MINUTES = 30

# –°–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—É–ª –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –¥–ª—è —Ä–∞—Å—Å—ã–ª–æ–∫
pool = ConnectionPool.from_url(config.REDIS_URL)

broadcast_job_stores = {
    "default": RedisJobStore(
        jobs_key="broadcast_jobs", 
        run_times_key="broadcast_run_times", 
        connection_pool=pool
    )
}

broadcast_scheduler = AsyncIOScheduler(jobstores=broadcast_job_stores, timezone="UTC")

async def schedule_broadcast_task(broadcast_id: int, scheduled_time):
    """
    –ü–ª–∞–Ω–∏—Ä—É–µ—Ç –∑–∞–¥–∞—á—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞—Å—Å—ã–ª–∫–∏ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
    """
    job_id = f"broadcast_{broadcast_id}"
    
    if broadcast_scheduler.get_job(job_id):
        broadcast_scheduler.remove_job(job_id)
    
    broadcast_scheduler.add_job(
        send_scheduled_broadcast,
        'date',
        run_date=scheduled_time,
        id=job_id,
        kwargs={
            'broadcast_id': broadcast_id
        },
        replace_existing=True,
        # –î–æ–±–∞–≤–ª—è–µ–º misfire_grace_time –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
        # –≠—Ç–æ –∑–∞—â–∏—Ç–∏—Ç –æ—Ç –∑–∞–ø—É—Å–∫–∞ –∑–∞–¥–∞—á, –µ—Å–ª–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ "–ø—Ä–æ—Å–ø–∞–ª" —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ
        misfire_grace_time=BROADCAST_TOLERANCE_MINUTES * 60
    )
    logging.info(f"Scheduled broadcast #{broadcast_id} at {scheduled_time}")

async def send_scheduled_broadcast(broadcast_id: int):
    """
    –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–º)
    """
    logging.info(f"üöÄ Starting scheduled broadcast #{broadcast_id}")
    
    bot = Bot(
        token=config.BOT_TOKEN.get_secret_value(),
        default=DefaultBotProperties(parse_mode="HTML")
    )
    
    async with async_session_maker() as session:
        try:
            # 1. –ü–æ–ª—É—á–∞–µ–º —Ä–∞—Å—Å—ã–ª–∫—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Ä–µ–º–µ–Ω–∏
            broadcast = await session.get(Broadcast, broadcast_id)
            
            if not broadcast:
                logging.warning(f"‚ö†Ô∏è Broadcast #{broadcast_id} not found in DB. Skipping.")
                return

            # 2. –ü–†–û–í–ï–†–ö–ê –ê–ö–¢–£–ê–õ–¨–ù–û–°–¢–ò (–ó–∞—â–∏—Ç–∞ –æ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ –±–æ—Ç–∞)
            # –¢–∞–∫ –∫–∞–∫ –≤ –ë–î –º—ã –ø–∏—à–µ–º Naive UTC, —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å utcnow()
            now = datetime.utcnow()
            scheduled = broadcast.scheduled_time
            
            # –†–∞–∑–Ω–∏—Ü–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏
            delta = now - scheduled
            
            # –ï—Å–ª–∏ –º—ã –æ–ø–æ–∑–¥–∞–ª–∏ –±–æ–ª—å—à–µ —á–µ–º –Ω–∞ TOLERANCE –º–∏–Ω—É—Ç
            if delta > timedelta(minutes=BROADCAST_TOLERANCE_MINUTES):
                logging.error(f"‚õî Broadcast #{broadcast_id} is too old! Late by {delta}. Cancelling.")
                
                # –ü–æ–º–µ—á–∞–µ–º –≤ –±–∞–∑–µ –∫–∞–∫ expired
                await session.execute(
                    update(Broadcast)
                    .where(Broadcast.id == broadcast_id)
                    .values(status='expired', failed_count=0) # failed_count=0 —á—Ç–æ–±—ã –Ω–µ –ø—É—Ç–∞—Ç—å —Å –æ—à–∏–±–∫–∞–º–∏
                )
                await session.commit()
                
                # –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                # await bot.send_message(broadcast.created_by, f"‚ö†Ô∏è –†–∞—Å—Å—ã–ª–∫–∞ #{broadcast_id} –±—ã–ª–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞, —Ç–∞–∫ –∫–∞–∫ –±–æ—Ç –±—ã–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.")
                return

            # 3. –ï—Å–ª–∏ –≤—Ä–µ–º—è –æ–∫, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
            service = BroadcastService(bot, session)
            success = await service.send_broadcast(broadcast_id)
            
            if success:
                logging.info(f"‚úÖ Scheduled broadcast #{broadcast_id} completed successfully")
            else:
                logging.error(f"‚ùå Scheduled broadcast #{broadcast_id} failed")
                
        except Exception as e:
            logging.error(f"üî• Critical error in scheduled broadcast #{broadcast_id}: {e}")
        finally:
            await bot.session.close()

async def start_broadcast_scheduler():
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Ä–∞—Å—Å—ã–ª–æ–∫"""
    if not broadcast_scheduler.running:
        broadcast_scheduler.start()
        logging.info("üì¢ Broadcast Scheduler started")

async def shutdown_broadcast_scheduler():
    """–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Ä–∞—Å—Å—ã–ª–æ–∫"""
    if broadcast_scheduler.running:
        broadcast_scheduler.shutdown()=== ./core/services/user_service.py ===
import logging
from typing import Optional, Dict, Any
from aiogram import Bot
from aiogram.exceptions import TelegramBadRequest
from sqlalchemy.ext.asyncio import AsyncSession

from database.requests.user_repo import get_user_by_id, register_user
from database.models.user import User


logger = logging.getLogger(__name__)


class UserService:
    """–£—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–π –∫–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏"""

    @staticmethod
    async def get_user_info_safe(bot: Bot, user_id: int) -> Optional[Dict[str, Any]]:
        """
        –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏–∑ Telegram
        """
        try:
            user = await bot.get_chat(user_id)
            return {
                'id': user.id,
                'first_name': user.first_name,
                'last_name': user.last_name,
                'username': user.username,
                'is_bot': user.is_bot,
                'language_code': getattr(user, 'language_code', None),
                'full_name': f"{user.first_name} {user.last_name}".strip() if user.last_name else user.first_name
            }
        except TelegramBadRequest as e:
            logger.error(f"Error getting user info for {user_id}: {e}")
            return None
        except Exception as e:
            logger.error(f"Unexpected error getting user info for {user_id}: {e}")
            return None

    @staticmethod
    async def get_user_from_db(session: AsyncSession, user_id: int) -> Optional[User]:
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        """
        try:
            return await get_user_by_id(session, user_id)
        except Exception as e:
            logger.error(f"Error getting user from DB for {user_id}: {e}")
            return None

    @staticmethod
    async def register_user_safe(
        session: AsyncSession, 
        user_id: int, 
        username: Optional[str], 
        full_name: str
    ) -> bool:
        """
        –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        """
        try:
            await register_user(session, user_id, username, full_name)
            return True
        except Exception as e:
            logger.error(f"Error registering user {user_id}: {e}")
            return False

    @staticmethod
    async def update_user_info(
        session: AsyncSession,
        user_id: int,
        username: Optional[str] = None,
        full_name: Optional[str] = None,
        is_premium: Optional[bool] = None
    ) -> bool:
        """
        –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        """
        try:
            db_user = await get_user_by_id(session, user_id)
            if not db_user:
                # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –≤ –±–∞–∑–µ, —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º
                await register_user(session, user_id, username, full_name or f"User_{user_id}")
                db_user = await get_user_by_id(session, user_id)

            if db_user:
                if username is not None:
                    db_user.username = username
                if full_name is not None:
                    db_user.full_name = full_name
                if is_premium is not None:
                    db_user.is_premium = is_premium

                await session.commit()
                return True

            return False
        except Exception as e:
            logger.error(f"Error updating user info for {user_id}: {e}")
            return False

    @staticmethod
    async def is_user_admin(bot: Bot, chat_id: int, user_id: int) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º —á–∞—Ç–∞
        """
        try:
            member = await bot.get_chat_member(chat_id=chat_id, user_id=user_id)
            return member.status in ['creator', 'administrator']
        except TelegramBadRequest as e:
            logger.error(f"Error checking admin status for user {user_id} in chat {chat_id}: {e}")
            return False
        except Exception as e:
            logger.error(f"Unexpected error checking admin status for user {user_id} in chat {chat_id}: {e}")
            return False=== ./core/services/navigation_service.py ===
import json
from typing import List, Optional
from aiogram.fsm.context import FSMContext


class NavigationContext:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏"""
    
    def __init__(self, state: FSMContext):
        self.state = state
    
    async def push_context(self, context: str) -> List[str]:
        """–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ —Å—Ç–µ–∫ –∏ –≤–µ—Ä–Ω—É—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å—Ç–µ–∫"""
        data = await self.state.get_data()
        context_stack = data.get("context_stack", [])
        
        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ —Å—Ç–µ–∫
        context_stack.append(context)
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≥–ª—É–±–∏–Ω—É —Å—Ç–µ–∫–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è
        if len(context_stack) > 10:
            context_stack = context_stack[-10:]
        
        await self.state.update_data(context_stack=context_stack)
        return context_stack
    
    async def pop_context(self) -> Optional[str]:
        """–ò–∑–≤–ª–µ—á—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ —Å—Ç–µ–∫–∞"""
        data = await self.state.get_data()
        context_stack = data.get("context_stack", [])
        
        if context_stack:
            removed_context = context_stack.pop()
            await self.state.update_data(context_stack=context_stack)
            return removed_context
        
        return None
    
    async def get_current_context(self) -> str:
        """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç"""
        data = await self.state.get_data()
        context_stack = data.get("context_stack", [])
        return context_stack[-1] if context_stack else "main"
    
    async def get_context_path(self) -> List[str]:
        """–ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞"""
        data = await self.state.get_data()
        return data.get("context_stack", [])
    
    async def clear_context(self):
        """–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å —Å—Ç–µ–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞"""
        await self.state.update_data(context_stack=[])
    
    async def jump_to_context(self, target_context: str) -> bool:
        """–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º—É –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –≤ —Å—Ç–µ–∫–µ"""
        data = await self.state.get_data()
        context_stack = data.get("context_stack", [])
        
        if target_context in context_stack:
            # –ù–∞–π–¥–µ–º –∏–Ω–¥–µ–∫—Å —Ü–µ–ª–µ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ –æ–±—Ä–µ–∂–µ–º —Å—Ç–µ–∫ –¥–æ –Ω–µ–≥–æ
            target_index = context_stack.index(target_context)
            new_stack = context_stack[:target_index + 1]
            await self.state.update_data(context_stack=new_stack)
            return True
        
        return False


class NavigationService:
    """–°–µ—Ä–≤–∏—Å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏"""
    
    def __init__(self, state: FSMContext):
        self.nav_context = NavigationContext(state)
    
    async def navigate_to(self, target_context: str):
        """–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º—É –∫–æ–Ω—Ç–µ–∫—Å—Ç—É"""
        await self.nav_context.push_context(target_context)
    
    async def go_back(self):
        """–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –∫–æ–Ω—Ç–µ–∫—Å—Ç—É"""
        return await self.nav_context.pop_context()
    
    async def get_breadcrumb_path(self) -> List[tuple[str, str]]:
        """–ü–æ–ª—É—á–∏—Ç—å –ø—É—Ç—å —Ö–ª–µ–±–Ω—ã—Ö –∫—Ä–æ—à–µ–∫ –≤ —Ñ–æ—Ä–º–∞—Ç–µ [(icon, text), ...]"""
        context_path = await self.nav_context.get_context_path()
        
        # –ö–∞—Ä—Ç–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ –≤ —á–∏—Ç–∞–µ–º—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∏–∫–æ–Ω–∫–∏
        context_map = {
            "main": ("üëë", "–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å"),
            "stats": ("üìä", "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"),
            "users": ("üë•", "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏"),
            "giveaways": ("üéÆ", "–†–æ–∑—ã–≥—Ä—ã—à–∏"),
            "broadcast": ("üì¢", "–†–∞—Å—Å—ã–ª–∫–∞"),
            "security": ("üõ°", "–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å"),
            "settings": ("‚öôÔ∏è", "–ù–∞—Å—Ç—Ä–æ–π–∫–∏"),
            "logs": ("üìã", "–õ–æ–≥–∏"),
            "user_search": ("üîç", "–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"),
            "user_list": ("üìã", "–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"),
            "giveaway_list": ("üìã", "–°–ø–∏—Å–æ–∫ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π"),
            "giveaway_detail": ("üéÆ", "–î–µ—Ç–∞–ª–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–∞"),
            "user_detail": ("üë§", "–î–µ—Ç–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
        }
        
        breadcrumbs = []
        for context in context_path:
            icon, text = context_map.get(context, ("üìç", context.title()))
            breadcrumbs.append((icon, text))
        
        return breadcrumbs=== ./core/services/checker_service.py ===
import logging
from aiogram import Bot
from aiogram.exceptions import TelegramForbiddenError, TelegramBadRequest
from redis.asyncio import Redis
from config import config

# –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ Redis
redis = Redis.from_url(config.REDIS_URL)
logger = logging.getLogger(__name__)

async def is_user_subscribed(bot: Bot, channel_id: int, user_id: int, force_check: bool = False) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –∫–∞–Ω–∞–ª.
    :param force_check: –ï—Å–ª–∏ True, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –∫–µ—à –∏ –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ Telegram.
    """
    cache_key = f"sub_status:{channel_id}:{user_id}"
    
    # 1. –ï—Å–ª–∏ –ù–ï –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞, –ø—Ä–æ–±—É–µ–º –¥–æ—Å—Ç–∞—Ç—å –∏–∑ –∫–µ—à–∞
    if not force_check:
        try:
            cached_status = await redis.get(cache_key)
            if cached_status is not None:
                return cached_status.decode() == "1"
        except Exception as e:
            logger.warning(f"Redis cache error for {cache_key}: {e}")
            # –ï—Å–ª–∏ –∫–µ—à –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –∑–∞–ø—Ä–æ—Å–æ–º –∫ Telegram

    # 2. –°–ø—Ä–∞—à–∏–≤–∞–µ–º —É Telegram
    try:
        member = await bot.get_chat_member(chat_id=channel_id, user_id=user_id)
        
        # –°—Ç–∞—Ç—É—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ —Å—á–∏—Ç–∞—é—Ç—Å—è "–ø–æ–¥–ø–∏—Å–∞–Ω"
        if member.status in ('creator', 'administrator', 'member', 'restricted'):
            # –ö–µ—à–∏—Ä—É–µ–º –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ 5 –º–∏–Ω—É—Ç
            await safe_set_cache(cache_key, "1", 300)
            return True
        else:
            # –ö–µ—à–∏—Ä—É–µ–º –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ 30 —Å–µ–∫—É–Ω–¥
            await safe_set_cache(cache_key, "0", 30)
            return False
            
    except TelegramForbiddenError:
        # –ë–æ—Ç –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–Ω–∞–ª—É
        logger.error(f"Bot has no access to channel {channel_id} (User: {user_id})")
        # –ö–µ—à–∏—Ä—É–µ–º –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è, —Ç–∞–∫ –∫–∞–∫ —Å—Ç–∞—Ç—É—Å –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è
        await safe_set_cache(cache_key, "0", 60)
        return False
        
    except TelegramBadRequest as e:
        # –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ–≤–µ—Ä–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –∫–∞–Ω–∞–ª–∞)
        if "user not found" in str(e).lower() or "chat not found" in str(e).lower():
            logger.warning(f"User or channel not found (User: {user_id}, Channel: {channel_id})")
            # –ö–µ—à–∏—Ä—É–µ–º –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è
            await safe_set_cache(cache_key, "0", 60)
            return False
        else:
            # –î—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞ BadRequest
            logger.error(f"Bad request when checking subscription (User: {user_id}, Channel: {channel_id}): {e}")
            return False
            
    except Exception as e:
        # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –≤ –∫–æ–Ω—Å–æ–ª–∏, –µ—Å–ª–∏ –±–æ—Ç –Ω–µ –∞–¥–º–∏–Ω
        logger.error(f"Check sub error (User: {user_id}, Channel: {channel_id}): {e}")
        return False

async def safe_set_cache(key: str, value: str, ex: int):
    """
    –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫–µ—à —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
    """
    try:
        await redis.setex(key, ex, value)
    except Exception as e:
        logger.warning(f"Redis set error for {key}: {e}")=== ./core/services/ref_service.py ===
import uuid
from redis.asyncio import Redis
from config import config

# –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ Redis (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ URL, —á—Ç–æ –≤ –∫–æ–Ω—Ñ–∏–≥–µ)
redis = Redis.from_url(config.REDIS_URL)

async def create_ref_link(user_id: int) -> str:
    """
    –°–æ–∑–¥–∞–µ—Ç –∫–æ—Ä–æ—Ç–∫–∏–π UUID-—Ç–æ–∫–µ–Ω, –∫–æ—Ç–æ—Ä—ã–π —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π user_id.
    –¢–æ–∫–µ–Ω –∂–∏–≤–µ—Ç 30 –¥–Ω–µ–π.
    """
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω (–±–µ–∑ —Ç–∏—Ä–µ, —á—Ç–æ–±—ã –±—ã–ª –∫–æ—Ä–æ—á–µ)
    token = uuid.uuid4().hex[:12] 
    key = f"ref_map:{token}"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–µ—Ç —É —é–∑–µ—Ä–∞ —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–æ–∫–µ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ), 
    # –Ω–æ –ø—Ä–æ—â–µ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –∏–ª–∏ —Ö—Ä–∞–Ω–∏—Ç—å –æ–±—Ä–∞—Ç–Ω—ã–π –∏–Ω–¥–µ–∫—Å.
    # –î–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø—Ä–æ—Å—Ç–æ –ø–∏—à–µ–º:
    await redis.set(key, user_id, ex=2592000) # 30 –¥–Ω–µ–π
    return token

async def resolve_ref_link(token: str) -> int | None:
    """–ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π ID –ø–æ —Ç–æ–∫–µ–Ω—É"""
    key = f"ref_map:{token}"
    user_id = await redis.get(key)
    if user_id:
        return int(user_id)
    return None=== ./core/services/channel_service.py ===
import logging
from typing import List, Dict, Optional
from aiogram import Bot
from aiogram.exceptions import TelegramBadRequest, TelegramForbiddenError
from redis.asyncio import Redis
from config import config

from database.requests.giveaway_repo import get_required_channels
from core.services.checker_service import is_user_subscribed


logger = logging.getLogger(__name__)

redis = Redis.from_url(config.REDIS_URL)


class ChannelService:
    """–£—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–π –∫–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–∞–Ω–∞–ª–∞–º–∏"""

    @staticmethod
    async def get_chat_info_safe(bot: Bot, chat_id: int) -> Optional[Dict]:
        """
        –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —á–∞—Ç–µ
        """
        try:
            chat = await bot.get_chat(chat_id)
            return {
                'id': chat.id,
                'title': chat.title,
                'username': chat.username,
                'invite_link': chat.invite_link,
                'type': chat.type
            }
        except TelegramForbiddenError:
            # –ë–æ—Ç –Ω–µ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–Ω–∞–ª—É
            logger.error(f"Bot has no access to chat {chat_id}")
            return None
        except TelegramBadRequest as e:
            logger.error(f"Error getting chat info for {chat_id}: {e}")
            return None
        except Exception as e:
            logger.error(f"Unexpected error getting chat info for {chat_id}: {e}")
            return None

    @staticmethod
    async def check_user_subscriptions(
        bot: Bot,
        user_id: int,
        main_channel_id: int,
        required_channels: List = None,
        force_check: bool = False
    ) -> Dict[str, bool]:
        """
        –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–∞–Ω–∞–ª –∏ —Å–ø–∏—Å–æ–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤
        """
        if required_channels is None:
            required_channels = []

        results = {}

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–∞–Ω–∞–ª
        main_subscribed = await is_user_subscribed(bot, main_channel_id, user_id, force_check)
        results['main'] = main_subscribed

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–∞–Ω–∞–ª—ã
        for channel in required_channels:
            channel_id = getattr(channel, 'channel_id', channel)  # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
            sub_result = await is_user_subscribed(bot, channel_id, user_id, force_check)
            results[channel_id] = sub_result

        return results

    @staticmethod
    async def get_all_channels_with_status(
        bot: Bot,
        giveaway_id: int,
        user_id: int,
        session,
        force_check: bool = False
    ) -> List[Dict]:
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–∞–Ω–∞–ª–æ–≤ —Ä–æ–∑—ã–≥—Ä—ã—à–∞ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        """
        reqs = await get_required_channels(session, giveaway_id)
        channels_status = []

        # 1. –û—Å–Ω–æ–≤–Ω–æ–π –∫–∞–Ω–∞–ª
        try:
            is_sub = await is_user_subscribed(bot, giveaway_id, user_id, force_check=force_check)
            chat_info = await ChannelService.get_chat_info_safe(bot, giveaway_id)
            if chat_info:
                link = chat_info['invite_link'] or (f"https://t.me/{chat_info['username']}" if chat_info['username'] else None)

                channels_status.append({
                    'title': f"üì¢ {chat_info['title']}",
                    'link': link,
                    'is_subscribed': is_sub
                })
        except Exception as e:
            logger.error(f"Error getting main channel info for giveaway {giveaway_id}: {e}")
            pass

        # 2. –°–ø–æ–Ω—Å–æ—Ä—Å–∫–∏–µ –∫–∞–Ω–∞–ª—ã
        for r in reqs:
            is_sub = await is_user_subscribed(bot, r.channel_id, user_id, force_check=force_check)

            # –£ —Å–ø–æ–Ω—Å–æ—Ä–æ–≤ —Å—Å—ã–ª–∫–∞ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ë–î, –Ω–æ –ø—Ä–æ–≤–µ—Ä–∏–º –Ω–∞ None
            link = r.channel_link if r.channel_link and len(r.channel_link) > 5 else None

            channels_status.append({
                'title': r.channel_title,
                'link': link,
                'is_subscribed': is_sub
            })

        return channels_status

    @staticmethod
    async def safe_get_chat_member(bot: Bot, chat_id: int, user_id: int) -> Optional[str]:
        """
        –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞ —á–∞—Ç–∞
        """
        try:
            member = await bot.get_chat_member(chat_id=chat_id, user_id=user_id)
            return member.status
        except TelegramForbiddenError:
            # –ë–æ—Ç –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–Ω–∞–ª—É
            logger.error(f"Bot has no access to get member status (User: {user_id}, Chat: {chat_id})")
            return None
        except TelegramBadRequest as e:
            logger.error(f"Error getting chat member status (User: {user_id}, Chat: {chat_id}): {e}")
            return None
        except Exception as e:
            logger.error(f"Unexpected error getting chat member status (User: {user_id}, Chat: {chat_id}): {e}")
            return None

    @staticmethod
    async def verify_bot_admin_rights(bot: Bot, chat_id: int) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –±–æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –∫–∞–Ω–∞–ª–∞
        """
        try:
            member = await bot.get_chat_member(chat_id=chat_id, user_id=bot.id)
            return member.status in ['creator', 'administrator']
        except TelegramForbiddenError:
            # –ë–æ—Ç –Ω–µ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–Ω–∞–ª—É
            logger.error(f"Bot has no access to check admin rights in chat {chat_id}")
            return False
        except TelegramBadRequest as e:
            logger.error(f"Error checking bot admin rights in chat {chat_id}: {e}")
            return False
        except Exception as e:
            logger.error(f"Unexpected error checking bot admin rights in chat {chat_id}: {e}")
            return False=== ./core/services/__init__.py ===
=== ./core/services/message_service.py ===
from typing import Optional
from aiogram import Bot
from aiogram.types import Message, InlineKeyboardMarkup
from aiogram.exceptions import TelegramBadRequest


class MessageHandler:
    """–£—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–π –∫–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏"""
    
    @staticmethod
    async def safe_edit_text(
        bot: Bot,
        chat_id: int,
        message_id: int,
        text: str,
        reply_markup: Optional[InlineKeyboardMarkup] = None,
        disable_web_page_preview: bool = False
    ) -> bool:
        """
        –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        """
        try:
            await bot.edit_message_text(
                text=text,
                chat_id=chat_id,
                message_id=message_id,
                reply_markup=reply_markup,
                disable_web_page_preview=disable_web_page_preview
            )
            return True
        except TelegramBadRequest as e:
            if "message is not modified" in str(e).lower():
                # –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å, —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
                return True
            elif "message to edit not found" in str(e).lower():
                # –°–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ —É–¥–∞–ª–µ–Ω–æ
                return False
            else:
                # –î—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞ Telegram
                raise e
        except Exception:
            # –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞
            return False

    @staticmethod
    async def safe_edit_caption(
        bot: Bot,
        chat_id: int,
        message_id: int,
        caption: str,
        reply_markup: Optional[InlineKeyboardMarkup] = None
    ) -> bool:
        """
        –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∏ –∫ –º–µ–¥–∏–∞
        """
        try:
            await bot.edit_message_caption(
                chat_id=chat_id,
                message_id=message_id,
                caption=caption,
                reply_markup=reply_markup
            )
            return True
        except TelegramBadRequest as e:
            if "message is not modified" in str(e).lower():
                return True
            elif "message to edit not found" in str(e).lower():
                return False
            else:
                raise e
        except Exception:
            return False

    @staticmethod
    async def safe_send_message_with_rate_limit(
        bot: Bot,
        chat_id: int,
        text: str,
        reply_markup: Optional[InlineKeyboardMarkup] = None,
        disable_web_page_preview: bool = False,
        max_retries: int = 3
    ) -> Optional[Message]:
        """
        –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ª–∏–º–∏—Ç–æ–≤ API Telegram
        """
        for attempt in range(max_retries):
            try:
                message = await bot.send_message(
                    chat_id=chat_id,
                    text=text,
                    reply_markup=reply_markup,
                    disable_web_page_preview=disable_web_page_preview
                )
                return message
            except TelegramRetryAfter as e:
                # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª–∏–º–∏—Ç–∞ —á–∞—Å—Ç–æ—Ç—ã - –∂–¥–µ–º —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
                wait_time = e.retry_after
                import logging
                logger = logging.getLogger(__name__)
                logger.warning(f"Rate limit exceeded. Waiting {wait_time} seconds before retry {attempt + 1}/{max_retries}")
                await asyncio.sleep(wait_time)
            except TelegramBadRequest as e:
                if "too many requests" in str(e).lower():
                    # –í—Ä–µ–º–µ–Ω–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞ —á–∞—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã
                    import logging
                    logger = logging.getLogger(__name__)
                    logger.warning(f"Too many requests. Waiting 5 seconds before retry {attempt + 1}/{max_retries}")
                    await asyncio.sleep(5)
                else:
                    raise e
            except Exception as e:
                # –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞
                import logging
                logger = logging.getLogger(__name__)
                logger.error(f"Error sending message: {e}")
                if attempt == max_retries - 1:
                    return None
                await asyncio.sleep(2)  # –ñ–¥–µ–º –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π
        return None

    @staticmethod
    async def safe_edit_reply_markup(
        bot: Bot, 
        chat_id: int, 
        message_id: int, 
        reply_markup: Optional[InlineKeyboardMarkup]
    ) -> bool:
        """
        –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
        """
        try:
            await bot.edit_message_reply_markup(
                chat_id=chat_id,
                message_id=message_id,
                reply_markup=reply_markup
            )
            return True
        except TelegramBadRequest as e:
            if "message is not modified" in str(e).lower():
                return True
            elif "message to edit not found" in str(e).lower():
                return False
            else:
                raise e
        except Exception:
            return False

    @staticmethod
    async def safe_delete_message(bot: Bot, chat_id: int, message_id: int) -> bool:
        """
        –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        """
        try:
            await bot.delete_message(chat_id=chat_id, message_id=message_id)
            return True
        except TelegramBadRequest as e:
            if "message to delete not found" in str(e).lower():
                # –°–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ —É–¥–∞–ª–µ–Ω–æ
                return False
            else:
                raise e
        except Exception:
            # –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞
            return False

    @staticmethod
    async def safe_edit_message_with_rate_limit(
        bot: Bot,
        chat_id: int,
        message_id: int,
        text: str = None,
        caption: str = None,
        reply_markup: Optional[InlineKeyboardMarkup] = None,
        disable_web_page_preview: bool = False,
        max_retries: int = 3
    ) -> bool:
        """
        –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ª–∏–º–∏—Ç–æ–≤ API Telegram
        """
        for attempt in range(max_retries):
            try:
                if caption is not None:
                    # –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–∏–∞-—Å–æ–æ–±—â–µ–Ω–∏—è
                    await bot.edit_message_caption(
                        chat_id=chat_id,
                        message_id=message_id,
                        caption=caption,
                        reply_markup=reply_markup
                    )
                else:
                    # –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                    await bot.edit_message_text(
                        text=text,
                        chat_id=chat_id,
                        message_id=message_id,
                        reply_markup=reply_markup,
                        disable_web_page_preview=disable_web_page_preview
                    )
                return True
            except TelegramRetryAfter as e:
                # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª–∏–º–∏—Ç–∞ —á–∞—Å—Ç–æ—Ç—ã - –∂–¥–µ–º —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
                wait_time = e.retry_after
                import logging
                logger = logging.getLogger(__name__)
                logger.warning(f"Rate limit exceeded when editing message. Waiting {wait_time} seconds before retry {attempt + 1}/{max_retries}")
                await asyncio.sleep(wait_time)
            except TelegramBadRequest as e:
                if "message is not modified" in str(e).lower():
                    # –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å, —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
                    return True
                elif "message to edit not found" in str(e).lower():
                    # –°–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ —É–¥–∞–ª–µ–Ω–æ
                    return False
                elif "too many requests" in str(e).lower():
                    # –í—Ä–µ–º–µ–Ω–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞ —á–∞—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã
                    import logging
                    logger = logging.getLogger(__name__)
                    logger.warning(f"Too many requests when editing message. Waiting 5 seconds before retry {attempt + 1}/{max_retries}")
                    await asyncio.sleep(5)
                else:
                    raise e
            except Exception as e:
                # –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞
                import logging
                logger = logging.getLogger(__name__)
                logger.error(f"Error editing message: {e}")
                if attempt == max_retries - 1:
                    return False
                await asyncio.sleep(2)  # –ñ–¥–µ–º –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π
        return False

    @staticmethod
    async def safe_send_message(
        bot: Bot,
        chat_id: int,
        text: str,
        reply_markup: Optional[InlineKeyboardMarkup] = None,
        disable_web_page_preview: bool = False
    ) -> Optional[Message]:
        """
        –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        """
        try:
            message = await bot.send_message(
                chat_id=chat_id,
                text=text,
                reply_markup=reply_markup,
                disable_web_page_preview=disable_web_page_preview
            )
            return message
        except Exception:
            # –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞
            return None

    @staticmethod
    async def safe_answer_callback_query(bot: Bot, callback_query_id: str, text: str = None, show_alert: bool = False):
        """
        –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ callback query
        """
        try:
            await bot.answer_callback_query(
                callback_query_id=callback_query_id,
                text=text,
                show_alert=show_alert
            )
        except Exception:
            # –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞
            pass=== ./core/security/sanitizer.py ===
import bleach
from aiogram.types import Message

# –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ —Ç–µ–≥–∏ (Telegram API –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —ç—Ç–æ—Ç —Å–ø–∏—Å–æ–∫)
ALLOWED_TAGS = ['b', 'strong', 'i', 'em', 'u', 'ins', 's', 'strike', 'del', 'a', 'code', 'pre', 'blockquote', 'tg-spoiler']
ALLOWED_ATTRS = {'a': ['href']}

def sanitize_text(text: str) -> str:
    """–û—á–∏—â–∞–µ—Ç HTML –æ—Ç –º—É—Å–æ—Ä–∞, –æ—Å—Ç–∞–≤–ª—è—è –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ç–µ–≥–∏ Telegram"""
    if not text:
        return ""
    return bleach.clean(text, tags=ALLOWED_TAGS, attributes=ALLOWED_ATTRS, strip=True)

def get_message_html(message: Message) -> str:
    """
    –ü—Ä–µ–≤—Ä–∞—â–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å entities (—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º Telegram) –≤ HTML-—Å—Ç—Ä–æ–∫—É.
    –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å—Å—ã–ª–∫–∏, –∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç –∏ —Ç.–¥.
    """
    text = message.text or message.caption
    if not text:
        return ""

    entities = message.entities or message.caption_entities
    if not entities:
        return text

    # Telegram –∏—Å–ø–æ–ª—å–∑—É–µ—Ç UTF-16 offsets
    utf16_text = text.encode("utf-16-le")
    html_text = ""
    last_offset = 0

    # –°–æ—Ä—Ç–∏—Ä—É–µ–º entities –ø–æ offset
    entities = sorted(entities, key=lambda e: e.offset)

    for entity in entities:
        if entity.offset < last_offset:
            continue
            
        start = entity.offset * 2
        end = (entity.offset + entity.length) * 2
        
        # –¢–µ–∫—Å—Ç –¥–æ —ç–Ω—Ç–∏—Ç–∏
        chunk = utf16_text[last_offset*2 : start].decode("utf-16-le")
        html_text += _escape(chunk)
        
        # –¢–µ–∫—Å—Ç –≤–Ω—É—Ç—Ä–∏ —ç–Ω—Ç–∏—Ç–∏
        inner_raw = utf16_text[start:end].decode("utf-16-le")
        inner = _escape(inner_raw)
        
        if entity.type == "bold":
            html_text += f"<b>{inner}</b>"
        elif entity.type == "italic":
            html_text += f"<i>{inner}</i>"
        elif entity.type == "underline":
            html_text += f"<u>{inner}</u>"
        elif entity.type == "strikethrough":
            html_text += f"<s>{inner}</s>"
        elif entity.type == "code":
            html_text += f"<code>{inner}</code>"
        elif entity.type == "pre":
            html_text += f"<pre>{inner}</pre>"
        elif entity.type == "text_link":
            html_text += f'<a href="{entity.url}">{inner}</a>'
        elif entity.type == "text_mention":
            html_text += f'<a href="tg://user?id={entity.user.id}">{inner}</a>'
        elif entity.type == "spoiler":
            html_text += f'<tg-spoiler>{inner}</tg-spoiler>'
        elif entity.type == "blockquote":
            html_text += f'<blockquote>{inner}</blockquote>'
        else:
            html_text += inner
            
        last_offset = entity.offset + entity.length

    # –û—Å—Ç–∞–≤—à–∏–π—Å—è —Ö–≤–æ—Å—Ç
    tail = utf16_text[last_offset*2:].decode("utf-16-le")
    html_text += _escape(tail)
    
    return html_text

def _escape(text: str) -> str:
    """–≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤ HTML"""
    return text.replace("&", "&amp;").replace("<", "&lt;").replace(">", "&gt;")=== ./core/security/hmac_signer.py ===
# core/security/hmac_signer.py
import hashlib
import hmac
from config import config

def _generate_hash(data_string: str) -> str:
    """–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ñ—É–Ω–∫—Ü–∏—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è"""
    return hmac.new(
        config.SECRET_KEY.encode(),
        data_string.encode(),
        hashlib.sha256
    ).hexdigest()[:12]  # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ 12 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞

def sign_data(action: str, entity_id: int, admin_id: int) -> str:
    """–°–æ–∑–¥–∞–µ—Ç –ø–æ–¥–ø–∏—Å—å: action + id + admin_id"""
    data = f"{action}:{entity_id}:{admin_id}"
    return _generate_hash(data)

def verify_signature(action: str, entity_id: int, admin_id: int, received_sig: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å. –ó–∞—â–∏—â–∞–µ—Ç –æ—Ç –ø–æ–¥–º–µ–Ω—ã ID –∏ User ID"""
    expected_sig = sign_data(action, entity_id, admin_id)
    return hmac.compare_digest(expected_sig, received_sig)=== ./core/__init__.py ===
=== ./core/exceptions.py ===
from typing import Optional
from aiogram import Dispatcher
from aiogram.types import Update
from aiogram.exceptions import (
    TelegramAPIError,
    TelegramBadRequest,
    TelegramNetworkError,
    TelegramRetryAfter,
    TelegramServerError
)


class BaseBotException(Exception):
    """–ë–∞–∑–æ–≤–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –±–æ—Ç–∞"""
    def __init__(self, message: str, user_id: Optional[int] = None, action: Optional[str] = None):
        super().__init__(message)
        self.message = message
        self.user_id = user_id
        self.action = action


class DatabaseError(BaseBotException):
    """–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –æ—à–∏–±–æ–∫ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
    pass


class SubscriptionError(BaseBotException):
    """–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –æ—à–∏–±–æ–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏"""
    pass


class GiveawayError(BaseBotException):
    """–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –æ—à–∏–±–æ–∫ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π"""
    pass


class ValidationError(BaseBotException):
    """–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏"""
    pass


class ErrorHandler:
    """–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫"""
    
    def __init__(self):
        self.logger = None
    
    def setup_logger(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–∞"""
        import logging
        self.logger = logging.getLogger("ErrorHandler")
    
    async def handle_error(self, error: Exception, user_id: Optional[int] = None, action: Optional[str] = None):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
        if not self.logger:
            self.setup_logger()
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ—à–∏–±–∫–∏ –∏ –ª–æ–≥–∏—Ä—É–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º
        if isinstance(error, TelegramBadRequest):
            self.logger.error(
                f"TelegramBadRequest | User: {user_id} | Action: {action} | Error: {str(error)}"
            )
        elif isinstance(error, TelegramNetworkError):
            self.logger.error(
                f"TelegramNetworkError | User: {user_id} | Action: {action} | Error: {str(error)}"
            )
        elif isinstance(error, TelegramRetryAfter):
            self.logger.warning(
                f"TelegramRetryAfter | User: {user_id} | Action: {action} | Retry after: {error.retry_after}s"
            )
        elif isinstance(error, TelegramServerError):
            self.logger.error(
                f"TelegramServerError | User: {user_id} | Action: {action} | Error: {str(error)}"
            )
        elif isinstance(error, BaseBotException):
            self.logger.error(
                f"BaseBotException | User: {user_id} | Action: {action} | Error: {str(error)}"
            )
        else:
            self.logger.error(
                f"UnexpectedError | User: {user_id} | Action: {action} | Error: {str(error)} | Type: {type(error)}"
            )
    
    async def handle_update_error(self, dispatcher: Dispatcher, update: Update, error: Exception):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"""
        user_id = None
        action = None
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        if update.message:
            user_id = update.message.from_user.id
            action = f"message_{update.message.text[:50] if update.message.text else 'unknown'}"
        elif update.callback_query:
            user_id = update.callback_query.from_user.id
            action = f"callback_{update.callback_query.data[:50] if update.callback_query.data else 'unknown'}"
        elif update.inline_query:
            user_id = update.inline_query.from_user.id
            action = f"inline_query_{update.inline_query.query[:50] if update.inline_query.query else 'unknown'}"
        elif update.chosen_inline_result:
            user_id = update.chosen_inline_result.from_user.id
            action = f"chosen_inline_result_{update.chosen_inline_result.result_id}"
        
        await self.handle_error(error, user_id, action)


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –æ—à–∏–±–æ–∫
error_handler = ErrorHandler()=== ./core/types/common_types.py ===
from typing import Protocol, TypedDict, Union, Optional, Dict, Any, Callable, Awaitable
from aiogram.types import Message, CallbackQuery, TelegramObject
from aiogram.fsm.context import FSMContext
from aiogram import Bot
from sqlalchemy.ext.asyncio import AsyncSession


# –¢–∏–ø—ã –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è Message –∏ CallbackQuery
EventObject = Union[Message, CallbackQuery]

# –¢–∏–ø—ã –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö
class HandlerFunction(Protocol):
    """–ü—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π"""
    async def __call__(
        self, 
        event: EventObject, 
        bot: Bot, 
        session: AsyncSession, 
        state: FSMContext,
        **kwargs
    ) -> Any: ...


class ChannelInfo(TypedDict):
    """–¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–∞–Ω–∞–ª–µ"""
    title: str
    link: Optional[str]
    is_subscribed: bool


class SubscriptionCheckResult(TypedDict):
    """–¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏"""
    all_subscribed: bool
    channels_status: list[ChannelInfo]


class ReferralData(TypedDict):
    """–¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö —Ä–µ—Ñ–µ—Ä–∞–ª–∞"""
    user_id: int
    referrer_id: Optional[int]
    giveaway_id: int


class ParticipantData(TypedDict):
    """–¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–∞"""
    user_id: int
    ticket_code: str
    tickets_count: int


class GiveawayStats(TypedDict):
    """–¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–∞"""
    total_users: int
    premium_users: int
    active_gws: int
    finished_gws: int


class AdminActionData(TypedDict):
    """–¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –∞–¥–º–∏–Ω-–¥–µ–π—Å—Ç–≤–∏—è"""
    action: str
    entity_id: int
    signature: str


# –¢–∏–ø—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ middleware
MiddlewareHandler = Callable[
    [TelegramObject, Dict[str, Any]], 
    Awaitable[Any]
]=== ./core/logic/game_actions.py ===
import asyncio
import logging
import secrets
from datetime import datetime
from aiogram import Bot
from aiogram.client.default import DefaultBotProperties
from aiogram.exceptions import TelegramForbiddenError, TelegramNotFound, TelegramRetryAfter
from config import config
from database import async_session_maker
from database.requests.giveaway_repo import (
    get_giveaway_by_id,
    get_active_giveaways,
    get_required_channels,
    get_expired_active_giveaways
)
from database.requests.participant_repo import get_weighted_candidates, get_participants_count
from database.models.winner import Winner
from core.tools.formatters import format_giveaway_caption
from keyboards.inline.participation import join_keyboard, results_keyboard
from core.services.checker_service import is_user_subscribed

logger = logging.getLogger(__name__)

async def check_subscription_all(bot: Bot, user_id: int, main_channel_id: int, required_channels: list) -> bool:
    try:
        # 1. –û—Å–Ω–æ–≤–Ω–æ–π –∫–∞–Ω–∞–ª
        if not await is_user_subscribed(bot, main_channel_id, user_id):
            return False

        # 2. –°–ø–æ–Ω—Å–æ—Ä—ã
        for req in required_channels:
            if not await is_user_subscribed(bot, req.channel_id, user_id):
                return False
        
        return True
    except Exception as e:
        logger.error(f"Sub check failed for user {user_id}: {e}")
        return False

async def finish_giveaway_task(giveaway_id: int):
    """
    –§–∏–Ω–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞.
    1. –í–∫–ª—é—á–∞–µ—Ç Global Lock (–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ä–∞—Å—Å—ã–ª–∫–∏).
    2. –ü–µ—Ä–µ–±–∏—Ä–∞–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤, –ø–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ—Ç –Ω—É–∂–Ω–æ–µ –∫–æ–ª-–≤–æ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö.
    3. –ü—É–±–ª–∏–∫—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.
    4. –í—ã–∫–ª—é—á–∞–µ—Ç Global Lock.
    """
    bot = Bot(
        token=config.BOT_TOKEN.get_secret_value(),
        default=DefaultBotProperties(parse_mode="HTML")
    )
    
    # –ö–ª—é—á –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥–ª—è "–°–≤–µ—Ç–æ—Ñ–æ—Ä–∞"
    LOCK_KEY = "system:high_load"

    try:
        # –ò–º–ø–æ—Ä—Ç—ã –¥–ª—è Redis
        from redis.asyncio import Redis
        from config import config
        redis = Redis.from_url(config.REDIS_URL)
        
        # 1. –í–ö–õ–Æ–ß–ê–ï–ú –ö–†–ê–°–ù–´–ô –°–í–ï–¢
        # –°—Ç–∞–≤–∏–º —Ñ–ª–∞–≥ –Ω–∞ 5 –º–∏–Ω—É—Ç (—Å –∑–∞–ø–∞—Å–æ–º, –µ—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—Ç—è–Ω–µ—Ç—Å—è)
        await redis.set(LOCK_KEY, "1", ex=300)
        logging.info(f"üõë System Locked for GW #{giveaway_id} finish")

        bot_info = await bot.get_me()

        async with async_session_maker() as session:
            gw = await get_giveaway_by_id(session, giveaway_id)
            if not gw or gw.status != 'active':
                logging.warning(f"GW {giveaway_id} is not active or not found.")
                return

            req_channels = await get_required_channels(session, giveaway_id)
            
            # –¶–µ–ª–µ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π
            target_winners_count = gw.winners_count
            final_winners_ids = []
            
            # –°–ø–∏—Å–æ–∫ ID, –∫–æ—Ç–æ—Ä—ã–µ –º—ã —É–∂–µ –ø—Ä–æ–≤–µ—Ä–∏–ª–∏ (—á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –¥–≤–∞–∂–¥—ã)
            checked_ids = set()

            # --- –®–ê–ì –ê: –ü—Ä–æ–≤–µ—Ä–∫–∞ "–ë–ª–∞—Ç–Ω–æ–≥–æ" (Predetermined) ---
            if gw.predetermined_winner_id:
                pid = gw.predetermined_winner_id
                checked_ids.add(pid)
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—á–∞—Å—Ç–≤—É–µ—Ç –ª–∏ –æ–Ω –≤–æ–æ–±—â–µ
                from database.requests.participant_repo import is_participant_active
                is_participant = await is_participant_active(session, pid, gw.id)
                
                if is_participant:
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É
                    if await check_subscription_all(bot, pid, gw.channel_id, req_channels):
                        final_winners_ids.append(pid)
                        logging.info(f"Predetermined winner {pid} qualified.")
                    else:
                        logging.info(f"Predetermined winner {pid} failed subscription check.")
                else:
                    logging.info(f"Predetermined winner {pid} is not a participant.")

            # --- –®–ê–ì –ë: –î–æ–±–æ—Ä —Å–ª—É—á–∞–π–Ω—ã—Ö –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π (–¶–∏–∫–ª) ---
            
            # –ü–æ–∫–∞ –Ω–µ –Ω–∞–±—Ä–∞–ª–∏ –Ω—É–∂–Ω–æ–µ –∫–æ–ª-–≤–æ
            while len(final_winners_ids) < target_winners_count:
                
                needed = target_winners_count - len(final_winners_ids)
                
                # –ë–µ—Ä–µ–º —Å –∑–∞–ø–∞—Å–æ–º (x5), —á—Ç–æ–±—ã –ª–∏—à–Ω–∏–π —Ä–∞–∑ –Ω–µ –¥–µ—Ä–≥–∞—Ç—å –ë–î
                batch_size = needed * 5
                if batch_size < 10: batch_size = 10
                
                # –ü–æ–ª—É—á–∞–µ–º –ø–∞—á–∫—É —Å–ª—É—á–∞–π–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤, –∏—Å–∫–ª—é—á–∞—è —É–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö
                candidates = await get_random_candidates_batch(
                    session, gw.id, batch_size, list(checked_ids)
                )
                
                if not candidates:
                    logging.info("No more candidates available.")
                    break # –£—á–∞—Å—Ç–Ω–∏–∫–∏ –∫–æ–Ω—á–∏–ª–∏—Å—å
                
                for uid in candidates:
                    checked_ids.add(uid) # –ó–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏–ª–∏
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É
                    if await check_subscription_all(bot, uid, gw.channel_id, req_channels):
                        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ "–∂–∏–≤–æ–≥–æ" (–Ω–µ —É–¥–∞–ª–µ–Ω –ª–∏ –∞–∫–∫–∞—É–Ω—Ç)
                        try:
                            await bot.send_chat_action(uid, "typing")
                            final_winners_ids.append(uid)
                            
                            # –ï—Å–ª–∏ –Ω–∞–±—Ä–∞–ª–∏ –∫–æ–º–ø–ª–µ–∫—Ç - –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞ for
                            if len(final_winners_ids) == target_winners_count:
                                break
                        except Exception:
                            logging.info(f"User {uid} is dead/blocked bot. Skipping.")
                
                # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É –±–∞—Ç—á–∞–º–∏, —á—Ç–æ–±—ã –Ω–µ —É–±–∏—Ç—å CPU/DB
                await asyncio.sleep(0.1)

            # --- –®–ê–ì –í: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –ü—É–±–ª–∏–∫–∞—Ü–∏—è ---
            gw.status = "finished"
            
            for uid in final_winners_ids:
                session.add(Winner(giveaway_id=gw.id, user_id=uid))
            
            await session.commit()
            
            # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
            if not final_winners_ids:
                result_text = "üòî <b>–†–æ–∑—ã–≥—Ä—ã—à –∑–∞–≤–µ—Ä—à–µ–Ω –±–µ–∑ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π.</b>"
            else:
                mentions = []
                for idx, uid in enumerate(final_winners_ids, 1):
                    try:
                        chat = await bot.get_chat(uid)
                        
                        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–ª–∞–¥–µ–ª—å—Ü–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
                        owner = await bot.get_chat(gw.owner_id)
                        
                        # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –õ–°
                        try:
                            owner_mention = f"@{owner.username}" if owner.username else f"<a href='tg://user?id={owner.id}'>{owner.full_name}</a>"
                            
                            await bot.send_message(
                                uid,
                                f"üéâ <b>–ü–û–ó–î–†–ê–í–õ–Ø–ï–ú!</b>\n\n"
                                f"–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ –ø—Ä–∏–∑: <b>{gw.prize_text[:50]}...</b>\n"
                                f"–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä —Ä–æ–∑—ã–≥—Ä—ã—à–∞: {owner_mention}\n"
                                f"–°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∏–º(–Ω–µ–π) –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∏–∑–∞!"
                            )
                        except Exception as e:
                            logger.info(f"Failed to send notification to winner {uid}: {e}")
                            pass

                        if chat.username:
                            user_link = f"@{chat.username}"
                        else:
                            user_link = f"<a href='tg://user?id={uid}'>{chat.full_name}</a>"
                        
                        mentions.append(f"{idx}. {user_link}")

                    except Exception:
                        mentions.append(f"{idx}. ID {uid}")

                winners_list_str = "\n".join(mentions)
                result_text = (
                    f"üéÅ <b>–†–û–ó–´–ì–†–´–® –ó–ê–í–ï–†–®–ï–ù!</b>\n\n"
                    f"üèÜ <b>–ü–æ–±–µ–¥–∏—Ç–µ–ª–∏:</b>\n"
                    f"{winners_list_str}\n\n"
                    f"üéâ <i>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å—á–∞—Å—Ç–ª–∏–≤—á–∏–∫–æ–≤!</i>"
                )

            # –ü—É–±–ª–∏–∫–∞—Ü–∏—è
            try:
                try:
                    await bot.send_message(
                        chat_id=gw.channel_id,
                        text=result_text,
                        reply_to_message_id=gw.message_id,
                        disable_web_page_preview=True
                    )
                except Exception as e:
                    logger.error(f"Failed to send message with reply_to: {e}")
                    await bot.send_message(
                        chat_id=gw.channel_id,
                        text=result_text,
                        disable_web_page_preview=True
                    )
                
                try:
                    await bot.edit_message_reply_markup(
                        chat_id=gw.channel_id,
                        message_id=gw.message_id,
                        reply_markup=results_keyboard(bot_info.username, giveaway_id)
                    )
                except Exception as e:
                    logger.error(f"Failed to edit message reply markup: {e}")
                    pass
                    
            except TelegramForbiddenError:
                logger.error(f"Bot lost access to channel {gw.channel_id} when finishing giveaway {gw.id}")
                # –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º
            except Exception as e:
                logger.error(f"Error publishing results: {e}")

    except Exception as e:
        logging.error(f"üî• Critical error finishing GW {giveaway_id}: {e}")
    finally:
        # 2. –í–´–ö–õ–Æ–ß–ê–ï–ú –ö–†–ê–°–ù–´–ô –°–í–ï–¢
        await redis.delete(LOCK_KEY)
        logging.info(f"üü¢ System Unlocked after GW #{giveaway_id}")
        await bot.session.close()

# --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è SQL —Ñ—É–Ω–∫—Ü–∏—è ---
async def get_random_candidates_batch(session, giveaway_id, limit, exclude_ids):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –∏—Å–∫–ª—é—á–∞—è —Ç–µ—Ö, –∫—Ç–æ –≤ —Å–ø–∏—Å–∫–µ exclude_ids.
    """
    from database.models.participant import Participant
    from sqlalchemy import func
    
    stmt = select(Participant.user_id).where(
        Participant.giveaway_id == giveaway_id
    )
    
    if exclude_ids:
        stmt = stmt.where(Participant.user_id.notin_(exclude_ids))
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º RANDOM() –¥–ª—è —Å–ª—É—á–∞–π–Ω–æ–π –≤—ã–±–æ—Ä–∫–∏
    stmt = stmt.order_by(func.random()).limit(limit)
    
    result = await session.execute(stmt)
    return result.scalars().all()

# --- Safety Net: –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö ---
async def process_expired_giveaways():
    logging.info("üîé Checking for expired giveaways...")
    async with async_session_maker() as session:
        expired = await get_expired_active_giveaways(session)
        count = len(expired)
        if count > 0:
            logging.warning(f"‚ö†Ô∏è Found {count} expired active giveaways. Finishing them now...")
            for gw in expired:
                try:
                    logging.info(f"üîÑ Processing expired GW #{gw.id}")
                    await finish_giveaway_task(gw.id)
                    await asyncio.sleep(1.5) # –ü–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è–º–∏
                except Exception as e:
                    logging.error(f"‚ùå Error finishing expired GW {gw.id}: {e}")
        else:
            logging.info("‚úÖ No expired giveaways found.")

# --- –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ---
async def smart_update_giveaway_task():
    """
    –£–º–Ω—ã–π –≤–æ—Ä–∫–µ—Ä: –±–µ—Ä–µ—Ç –û–î–ò–ù –¥–∞–≤–Ω–æ –Ω–µ –æ–±–Ω–æ–≤–ª—è–≤—à–∏–π—Å—è —Ä–æ–∑—ã–≥—Ä—ã—à,
    –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –ª–∏ –∫–æ–ª-–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∑–Ω–∞—á–∏–º–æ,
    –∏ –µ—Å–ª–∏ –¥–∞ ‚Äî –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ—Å—Ç.
    """
    from config import config
    bot = Bot(
        token=config.BOT_TOKEN.get_secret_value(),
        default=DefaultBotProperties(parse_mode="HTML")
    )

    # –ò–º–ø–æ—Ä—Ç—ã –¥–ª—è Redis
    from redis.asyncio import Redis
    from config import config
    redis = Redis.from_url(config.REDIS_URL)
    
    try:
        # –ï—Å–ª–∏ –≥–æ—Ä–∏—Ç –∫—Ä–∞—Å–Ω—ã–π —Å–≤–µ—Ç - –≤–æ–æ–±—â–µ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å—Ç—ã, —ç—Ç–æ –Ω–µ –≤–∞–∂–Ω–æ —Å–µ–π—á–∞—Å
        if await redis.get("system:high_load"):
            await redis.aclose()
            return # –ü—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º, –ø–æ–ø—Ä–æ–±—É–µ–º –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ü–∏–∫–ª–µ —á–µ—Ä–µ–∑ 10 —Å–µ–∫
        
        async with async_session_maker() as session:
            # 1. –ë–µ—Ä–µ–º —Å–∞–º—ã–π "—Å—Ç–∞—Ä—ã–π" –ø–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é –∞–∫—Ç–∏–≤–Ω—ã–π —Ä–æ–∑—ã–≥—Ä—ã—à
            # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ last_update_at (–∫—Ç–æ –¥–∞–≤–Ω–æ –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª—Å—è ‚Äî —Ç–æ—Ç –ø–µ—Ä–≤—ã–π)
            from sqlalchemy import select, asc, func
            from database.models.giveaway import Giveaway
            stmt = (
                select(Giveaway)
                .where(Giveaway.status == "active")
                .order_by(asc(Giveaway.last_update_at))
                .limit(1)
            )
            gw = await session.scalar(stmt)

            if not gw:
                return # –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π, —Å–ø–∏–º –¥–∞–ª—å—à–µ

            # 2. –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Ä–µ–∞–ª—å–Ω–æ–µ –∫–æ–ª-–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            current_count = await get_participants_count(session, gw.id)
            
            # 3. –õ–æ–≥–∏–∫–∞ "–ü–æ—Ä–æ–≥–∞ –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏" (Threshold)
            # –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–Ω–∏—Ü—É —Å –ø—Ä–æ—à–ª–æ–≥–æ —Ä–∞–∑–∞
            diff = abs(current_count - gw.last_count)
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Ä–æ–≥ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –∞—É–¥–∏—Ç–æ—Ä–∏–∏
            threshold = 1 # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
            if current_count > 1000:
                threshold = 50 # –ï—Å–ª–∏ –±–æ–ª—å—à–µ 1000, –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 50 —á–µ–ª
            elif current_count > 100:
                threshold = 10 # –ï—Å–ª–∏ –±–æ–ª—å—à–µ 100, –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 10 —á–µ–ª
            else:
                threshold = 1  # –ï—Å–ª–∏ –º–∞–ª–æ, –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥–æ–≥–æ (–¥–ª—è –¥–∏–Ω–∞–º–∏–∫–∏)

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ –∫–æ–Ω—Ü–∞ (–µ—Å–ª–∏ –æ—Å—Ç–∞–ª–æ—Å—å –º–∞–ª–æ –≤—Ä–µ–º–µ–Ω–∏ ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º —á–∞—â–µ/–≤—Å–µ–≥–¥–∞)
            from datetime import datetime
            from datetime import timezone
            
            # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –û–®–ò–ë–ö–ò –í–†–ï–ú–ï–ù–ò ---
            # –ü—Ä–∏–≤–æ–¥–∏–º –≤—Å–µ –¥–∞—Ç—ã –∫ UTC-aware –ø–µ—Ä–µ–¥ –≤—ã—á–∏—Ç–∞–Ω–∏–µ–º
            def ensure_utc(dt: datetime) -> datetime:
                """–ï—Å–ª–∏ –¥–∞—Ç–∞ naive, —Å—á–∏—Ç–∞–µ–º –µ—ë UTC. –ï—Å–ª–∏ aware, –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å."""
                if dt.tzinfo is None:
                    return dt.replace(tzinfo=timezone.utc)
                return dt
            
            now_utc = datetime.now(timezone.utc)
            finish_time_utc = ensure_utc(gw.finish_time)
            last_update_utc = ensure_utc(gw.last_update_at)
            
            time_left = (finish_time_utc - now_utc).total_seconds()
            is_urgent = time_left < 3600 # –û—Å—Ç–∞–ª—Å—è 1 —á–∞—Å

            # 4. –ü—Ä–∏–Ω–∏–º–∞–µ–º —Ä–µ—à–µ–Ω–∏–µ: –û–±–Ω–æ–≤–ª—è—Ç—å –∏–ª–∏ –Ω–µ—Ç?
            should_update = False
            
            if is_urgent:
                should_update = True # –°—Ä–æ—á–Ω–æ ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ–≥–¥–∞
            elif diff >= threshold:
                should_update = True # –ù–∞–±—Ä–∞–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª—é–¥–µ–π ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º
            elif (now_utc - last_update_utc).total_seconds() > 3600:
                should_update = True # –ü—Ä–æ—à–µ–ª —á–∞—Å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚Äî –æ–±–Ω–æ–≤–∏–º –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π (–∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞–π–º–µ—Ä–∞)

            # 5. –í—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
            if should_update:
                try:
                    bot_info = await bot.get_me()
                    new_caption = format_giveaway_caption(
                        gw.prize_text, gw.winners_count, gw.finish_time, current_count, gw.is_participants_hidden
                    )
                    kb = join_keyboard(bot_info.username, gw.id)

                    if gw.media_file_id:
                        await bot.edit_message_caption(
                            chat_id=gw.channel_id, message_id=gw.message_id,
                            caption=new_caption, reply_markup=kb
                        )
                    else:
                        await bot.edit_message_text(
                            chat_id=gw.channel_id, message_id=gw.message_id,
                            text=new_caption, reply_markup=kb, disable_web_page_preview=True
                        )
                    
                    # –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    gw.last_count = current_count
                    logger.info(f"‚úÖ Smart update GW #{gw.id}: count {current_count}")
                    
                except Exception as e:
                    logger.warning(f"‚ö†Ô∏è Failed update GW #{gw.id}: {e}")
                    # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ (–∫–∞–∫ –≤ —Å—Ç–∞—Ä–æ–º –∫–æ–¥–µ),
                    # –Ω–æ –≥–ª–∞–≤–Ω–æ–µ ‚Äî –º—ã –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –æ—á–µ—Ä–µ–¥—å.
            
            # 6. –í –õ–Æ–ë–û–ú –°–õ–£–ß–ê–ï –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            # –≠—Ç–æ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç —Ä–æ–∑—ã–≥—Ä—ã—à –≤ –∫–æ–Ω–µ—Ü –æ—á–µ—Ä–µ–¥–∏ (–æ–Ω —Å—Ç–∞–Ω–µ—Ç "—Å–∞–º—ã–º —Å–≤–µ–∂–∏–º")
            gw.last_update_at = now_utc
            await session.commit()

    except asyncio.CancelledError:  # –ó–∞–¥–∞—á–∞ –±—ã–ª–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø—Ä–∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–∏ –±–æ—Ç–∞, —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
        pass

    except Exception as e:
        logger.error(f"Smart worker error: {e}")
    finally:
        await redis.aclose()
        await bot.session.close()


async def get_giveaways_with_errors():
    """
    –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π —Å –æ—à–∏–±–∫–∞–º–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∞–¥–º–∏–Ω–∫–µ
    """
    from database.requests.giveaway_repo import get_giveaways_by_status
    async with async_session_maker() as session:
        error_giveaways = await get_giveaways_by_status(session, 'paused_error')
        return error_giveaways=== ./core/logic/ticket_gen.py ===
# core/logic/ticket_gen.py
import secrets
import string
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from database.models.participant import Participant

def generate_ticket_string(length=5) -> str:
    """–ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ —Å—Ç–æ–π–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è"""
    chars = string.ascii_uppercase + string.digits
    # secrets.choice –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ random.choice
    return ''.join(secrets.choice(chars) for _ in range(length))

async def get_unique_ticket(session: AsyncSession, giveaway_id: int) -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –±–∏–ª–µ—Ç"""
    for _ in range(100):
        code = generate_ticket_string()
        stmt = select(Participant).where(
            Participant.giveaway_id == giveaway_id,
            Participant.ticket_code == code
        )
        existing = await session.scalar(stmt)
        if not existing:
            return code
    return "ERROR"=== ./core/logic/randomizer.py ===
# core/logic/randomizer.py
import secrets
from database.models.giveaway import Giveaway
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, text

def select_winners(giveaway: Giveaway, participant_ids: list[int]) -> list[int]:
    """
    –í—ã–±–∏—Ä–∞–µ—Ç –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π.
    1. –ï—Å–ª–∏ –µ—Å—Ç—å predetermined_winner_id - –æ–Ω –ø–æ–±–µ–∂–¥–∞–µ—Ç –ø–µ—Ä–≤—ã–º.
    2. –û—Å—Ç–∞–ª—å–Ω—ã–µ –≤—ã–±–∏—Ä–∞—é—Ç—Å—è —á–µ—Å—Ç–Ω—ã–º —Ä–∞–Ω–¥–æ–º–æ–º (SystemRandom).
    """
    winners = []
    pool = set(participant_ids) # –ò—Å–ø–æ–ª—å–∑—É–µ–º set –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ O(1) —É–¥–∞–ª–µ–Ω–∏—è

    # 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥–∫—Ä—É—Ç–∫–∏ (Rigging)
    if giveaway.predetermined_winner_id:
        if giveaway.predetermined_winner_id in pool:
            winners.append(giveaway.predetermined_winner_id)
            pool.remove(giveaway.predetermined_winner_id)
        # –ï—Å–ª–∏ "–±–ª–∞—Ç–Ω–æ–≥–æ" –Ω–µ—Ç –≤ —É—á–∞—Å—Ç–Ω–∏–∫–∞—Ö, –ø–æ–¥–∫—Ä—É—Ç–∫–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç (–∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É—Ä–∞–∫–∞)

    # 2. –°–∫–æ–ª—å–∫–æ –µ—â–µ –Ω—É–∂–Ω–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π?
    needed = giveaway.winners_count - len(winners)

    if needed > 0:
        pool_list = list(pool)
        if len(pool_list) <= needed:
            # –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –º–µ–Ω—å—à–µ, —á–µ–º –ø—Ä–∏–∑–æ–≤ -> –≤—Å–µ –ø–æ–±–µ–∂–¥–∞—é—Ç
            winners.extend(pool_list)
        else:
            # –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ —Å—Ç–æ–π–∫–∏–π –≤—ã–±–æ—Ä
            random_winners = secrets.SystemRandom().sample(pool_list, k=needed)
            winners.extend(random_winners)

    return winners

async def select_winners_sql(session: AsyncSession, giveaway_id: int, winners_count: int, predetermined_winner_id: int = None) -> list[int]:
    """
    –í—ã–±–∏—Ä–∞–µ—Ç –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ SQL –∑–∞–ø—Ä–æ—Å, –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤
    """
    from database.models.participant import Participant
    
    # –ù–∞—á–∏–Ω–∞–µ–º —Å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ SQL-–∑–∞–ø—Ä–æ—Å–∞
    query = select(Participant.user_id).where(
        Participant.giveaway_id == giveaway_id
    )
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    result = await session.execute(query)
    all_participants = result.scalars().all()
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ–¥–∫—Ä—É—Ç–∫—É (–µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –ø–æ–±–µ–¥–∏—Ç–µ–ª—å)
    winners = []
    if predetermined_winner_id and predetermined_winner_id in all_participants:
        winners.append(predetermined_winner_id)
        all_participants = [pid for pid in all_participants if pid != predetermined_winner_id]
    
    # –°–∫–æ–ª—å–∫–æ –µ—â–µ –Ω—É–∂–Ω–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π?
    remaining_winners_needed = winners_count - len(winners)
    
    if remaining_winners_needed <= 0:
        # –í—Å–µ –º–µ—Å—Ç–∞ —É–∂–µ –∑–∞–Ω—è—Ç—ã –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–º
        return winners
    elif remaining_winners_needed >= len(all_participants):
        # –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –º–µ–Ω—å—à–µ, —á–µ–º –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –º–µ—Å—Ç - –≤—Å–µ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –ø–æ–±–µ–¥–∏—Ç–µ–ª—è–º–∏
        winners.extend(all_participants)
        return winners
    else:
        # –í—ã–±–∏—Ä–∞–µ–º –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π —Å–ª—É—á–∞–π–Ω—ã–º –æ–±—Ä–∞–∑–æ–º —á–µ—Ä–µ–∑ SQL
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º ORDER BY RANDOM() –¥–ª—è —á–µ—Å—Ç–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
        subquery = select(Participant.user_id).where(
            Participant.giveaway_id == giveaway_id
        ).where(
            Participant.user_id.notin_(winners)  # –ò—Å–∫–ª—é—á–∞–µ–º –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π
        ).order_by(text('RANDOM()')).limit(remaining_winners_needed)
        
        result = await session.execute(subquery)
        additional_winners = result.scalars().all()
        winners.extend(additional_winners)
        
        return winners=== ./core/logic/exceptions.py ===
# core/logic/exceptions.py

class BotError(Exception):
    """–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –æ—à–∏–±–æ–∫ –±–æ—Ç–∞"""
    pass

class SecurityError(BotError):
    """–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏ –∏–ª–∏ –ø—Ä–∞–≤"""
    pass

class GiveawayInvalidError(BotError):
    """–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–∞"""
    pass=== ./plans/admin_panel_plan.md ===
# –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–∫–∏ –¥–ª—è –±–æ—Ç–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π

## 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∞–¥–º–∏–Ω—Å–∫–æ–≥–æ –º–µ–Ω—é

### –ì–ª–∞–≤–Ω–æ–µ –∞–¥–º–∏–Ω-–º–µ–Ω—é
```
üîí –ê–¥–º–∏–Ω–∫–∞
‚îú‚îÄ‚îÄ üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
‚îú‚îÄ‚îÄ üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏  
‚îú‚îÄ‚îÄ üéÅ –†–æ–∑—ã–≥—Ä—ã—à–∏
‚îî‚îÄ‚îÄ üì¢ –†–∞—Å—Å—ã–ª–∫–∞
```

## 2. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
```
üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
‚îú‚îÄ‚îÄ üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: X
‚îÇ   ‚îú‚îÄ‚îÄ üéÅ –ê–∫—Ç–∏–≤–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π: X
‚îÇ   ‚îú‚îÄ‚îÄ üé´ –í—Å–µ–≥–æ —É—á–∞—Å—Ç–∏–π: X
‚îÇ   ‚îî‚îÄ‚îÄ üìû –°–µ—Å—Å–∏–π —Å–µ–≥–æ–¥–Ω—è: X
‚îÇ   ‚îî‚îÄ‚îÄ ‚óÄÔ∏è –ù–∞–∑–∞–¥
‚îú‚îÄ‚îÄ üìà –†–æ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îÇ   ‚îú‚îÄ‚îÄ üë• –ù–æ–≤—ã–µ –∑–∞ —Å–µ–≥–æ–¥–Ω—è: X
‚îÇ   ‚îú‚îÄ‚îÄ üìÖ –ù–æ–≤—ã–µ –∑–∞ –Ω–µ–¥–µ–ª—é: X
‚îÇ   ‚îî‚îÄ‚îÄ üìÜ –ù–æ–≤—ã–µ –∑–∞ –º–µ—Å—è—Ü: X
‚îÇ   ‚îî‚îÄ‚îÄ ‚óÄÔ∏è –ù–∞–∑–∞–¥
‚îú‚îÄ‚îÄ ‚≠ê –ü—Ä–µ–º–∏—É–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ üíé –ü—Ä–µ–º–∏—É–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: X
‚îÇ   ‚îú‚îÄ‚îÄ üí∞ –ö–æ–Ω–≤–µ—Ä—Å–∏—è: X%
‚îÇ   ‚îî‚îÄ‚îÄ üìà –†–æ—Å—Ç –ø—Ä–µ–º–∏—É–º–∞: X
‚îÇ   ‚îî‚îÄ‚îÄ ‚óÄÔ∏è –ù–∞–∑–∞–¥
‚îú‚îÄ‚îÄ üéÆ –†–æ–∑—ã–≥—Ä—ã—à–∏
‚îÇ   ‚îú‚îÄ‚îÄ üü¢ –ê–∫—Ç–∏–≤–Ω—ã–µ: X
‚îÇ   ‚îú‚îÄ‚îÄ üî¥ –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ: X
‚îÇ   ‚îî‚îÄ‚îÄ üéØ –°—Ä–µ–¥–Ω–µ–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: X
‚îÇ   ‚îî‚îÄ‚îÄ ‚óÄÔ∏è –ù–∞–∑–∞–¥
‚îú‚îÄ‚îÄ üéØ –£—á–∞—Å—Ç–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ üé´ –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: X
‚îÇ   ‚îî‚îÄ‚îÄ üìä –°—Ä–µ–¥–Ω–µ–µ –Ω–∞ —Ä–æ–∑—ã–≥—Ä—ã—à: X
‚îÇ   ‚îî‚îÄ‚îÄ ‚óÄÔ∏è –ù–∞–∑–∞–¥
‚îî‚îÄ‚îÄ ‚óÄÔ∏è –ù–∞–∑–∞–¥
```

### SQL-–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:

#### –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
```sql
-- –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
SELECT COUNT(*) FROM users;

-- –ê–∫—Ç–∏–≤–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
SELECT COUNT(*) FROM giveaways WHERE status = 'active';

-- –í—Å–µ–≥–æ —É—á–∞—Å—Ç–∏–π
SELECT COUNT(*) FROM participants;

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ –∞–≤–∞—Ç–∞—Ä–∫–∏ (–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –±–æ—Ç—ã)
SELECT COUNT(*) FROM users WHERE username IS NULL;
```

#### –†–æ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```sql
-- –ù–æ–≤—ã–µ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
SELECT COUNT(*) FROM users WHERE DATE(created_at) = CURRENT_DATE;

-- –ù–æ–≤—ã–µ –∑–∞ –Ω–µ–¥–µ–ª—é
SELECT COUNT(*) FROM users WHERE created_at >= CURRENT_DATE - INTERVAL '7 days';

-- –ù–æ–≤—ã–µ –∑–∞ –º–µ—Å—è—Ü
SELECT COUNT(*) FROM users WHERE created_at >= CURRENT_DATE - INTERVAL '30 days';
```

#### –ü—Ä–µ–º–∏—É–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
```sql
-- –ü—Ä–µ–º–∏—É–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
SELECT COUNT(*) FROM users WHERE is_premium = true AND premium_until > NOW();

-- –ö–æ–Ω–≤–µ—Ä—Å–∏—è (–µ—Å–ª–∏ –±—É–¥–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø–æ–∫—É–ø–∫–∏)
-- –ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º –µ—Å—Ç—å —Ç–∞–±–ª–∏—Ü–∞ purchases
SELECT
    COUNT(DISTINCT user_id) * 100.0 / (SELECT COUNT(*) FROM users) AS conversion_rate
FROM purchases;
```

#### –†–æ–∑—ã–≥—Ä—ã—à–∏
```sql
-- –ê–∫—Ç–∏–≤–Ω—ã–µ/–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ
SELECT status, COUNT(*) FROM giveaways GROUP BY status;

-- –°—Ä–µ–¥–Ω–µ–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
SELECT AVG(participant_count) FROM (
    SELECT giveaway_id, COUNT(user_id) as participant_count
    FROM participants
    GROUP BY giveaway_id
) t;
```

## 3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏

### –ú–µ–Ω—é —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```
üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
‚îú‚îÄ‚îÄ üîç –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îú‚îÄ‚îÄ üìã –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–ø–∞–≥–∏–Ω–∞—Ü–∏—è)
‚îÇ   ‚îú‚îÄ‚îÄ üë§ [ID] @username (–∏–º—è) - –ø—Ä–µ–º–∏—É–º/–æ–±—ã—á–Ω—ã–π
‚îÇ   ‚îú‚îÄ‚îÄ üë§ [ID] @username (–∏–º—è) - –ø—Ä–µ–º–∏—É–º/–æ–±—ã—á–Ω—ã–π
‚îÇ   ‚îî‚îÄ‚îÄ ... (–ø–æ 10 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ)
‚îú‚îÄ‚îÄ ‚è™ –ù–∞–∑–∞–¥

```

### –ú–µ–Ω—é –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```
üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ [ID]
‚îú‚îÄ‚îÄ üÜî ID: [user_id]
‚îú‚îÄ‚îÄ üìõ –ò–º—è: [full_name]
‚îú‚îÄ‚îÄ ü§ñ Username: @username
‚îú‚îÄ‚îÄ ‚è∞ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: [date]
‚îú‚îÄ‚îÄ üíé –ü—Ä–µ–º–∏—É–º: [—Å—Ç–∞—Ç—É—Å –∏ –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è]
‚îú‚îÄ‚îÄ üé´ –†–æ–∑—ã–≥—Ä—ã—à–∏: [–∫–æ–ª-–≤–æ]
‚îú‚îÄ‚îÄ üéØ –£—á–∞—Å—Ç–∏—è: [–∫–æ–ª-–≤–æ]
‚îú‚îÄ‚îÄ üéÅ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∏: [–∫–æ–ª-–≤–æ]
‚îú‚îÄ‚îÄ ‚≠ê –í—ã–¥–∞—Ç—å –ø—Ä–µ–º–∏—É–º
‚îú‚îÄ‚îÄ ‚ùå –ó–∞–±—Ä–∞—Ç—å –ø—Ä–µ–º–∏—É–º
‚îú‚îÄ‚îÄ üìã –†–æ–∑—ã–≥—Ä—ã—à–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îî‚îÄ‚îÄ ‚óÄÔ∏è –ù–∞–∑–∞–¥
```

### –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```
üîç –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
–í–≤–µ–¥–∏—Ç–µ ID –∏–ª–∏ @username:
```

## 4. –†–æ–∑—ã–≥—Ä—ã—à–∏

### –ú–µ–Ω—é —Å–ø–∏—Å–∫–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
```
üéÅ –†–æ–∑—ã–≥—Ä—ã—à–∏
‚îú‚îÄ‚îÄ üîç –ü–æ–∏—Å–∫ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
‚îú‚îÄ‚îÄ üìã –°–ø–∏—Å–æ–∫ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π (–ø–∞–≥–∏–Ω–∞—Ü–∏—è)
‚îÇ   ‚îú‚îÄ‚îÄ üéÅ [ID] "[–ø—Ä–∏–∑]" - –≤–ª–∞–¥–µ–ª–µ—Ü [ID] - [—É—á–∞—Å—Ç–Ω–∏–∫–∏] —á–µ–ª.
‚îÇ   ‚îú‚îÄ‚îÄ üéÅ [ID] "[–ø—Ä–∏–∑]" - –≤–ª–∞–¥–µ–ª–µ—Ü [ID] - [—É—á–∞—Å—Ç–Ω–∏–∫–∏] —á–µ–ª.
‚îÇ   ‚îî‚îÄ‚îÄ ... (–ø–æ 10 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è)
‚îú‚îÄ‚îÄ ‚è™ –ù–∞–∑–∞–¥
‚îî‚îÄ‚îÄ ‚è≠ –í–ø–µ—Ä–µ–¥
```

### –ü–æ–∏—Å–∫ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
```
üîç –ü–æ–∏—Å–∫ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ –∏–∑ –ø—Ä–∏–∑–∞ –∏–ª–∏ ID/username –≤–ª–∞–¥–µ–ª—å—Ü–∞:
```

### –ú–µ–Ω—é –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
```
üéÅ –†–æ–∑—ã–≥—Ä—ã—à #[ID]
‚îú‚îÄ‚îÄ üéÅ –ü—Ä–∏–∑: [text]
‚îú‚îÄ‚îÄ üëë –í–ª–∞–¥–µ–ª–µ—Ü: [user_id]
‚îú‚îÄ‚îÄ üìÖ –°–æ–∑–¥–∞–Ω: [date]
‚îú‚îÄ‚îÄ üïê –ó–∞–≤–µ—Ä—à–∏—Ç—Å—è: [date]
‚îú‚îÄ‚îÄ üéØ –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: [count]
‚îú‚îÄ‚îÄ üëë –ü–æ–±–µ–¥–∏—Ç–µ–ª–µ–π: [count]
‚îú‚îÄ‚îÄ üü¢ –°—Ç–∞—Ç—É—Å: [active/finished]
‚îú‚îÄ‚îÄ üëÄ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—Å—Ç–∞
‚îú‚îÄ‚îÄ üé≤ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å
‚îú‚îÄ‚îÄ üèÜ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ–±–µ–¥–∏—Ç–µ–ª—å
‚îú‚îÄ‚îÄ üë• –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
‚îî‚îÄ‚îÄ ‚óÄÔ∏è –ù–∞–∑–∞–¥
```

### –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–æ—Å—Ä–æ—á–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
```
‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–æ–∑—ã–≥—Ä—ã—à?
–í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –±—É–¥—É—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω—ã.
‚îú‚îÄ‚îÄ ‚úÖ –î–∞
‚îî‚îÄ‚îÄ ‚ùå –ù–µ—Ç
```

### –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã–±–æ—Ä –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
```
üèÜ –í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π —Å—Ç–∞–Ω–µ—Ç –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–º:
```

## 5. –†–∞—Å—Å—ã–ª–∫–∞

### –û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é —Ä–∞—Å—Å—ã–ª–∫–∏
```
üì¢ –†–∞—Å—Å—ã–ª–∫–∞
‚îú‚îÄ‚îÄ ‚úçÔ∏è –°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
‚îú‚îÄ‚îÄ üìù –ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫
‚îú‚îÄ‚îÄ ‚è± –û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ —Ä–∞—Å—Å—ã–ª–∫–∏
‚îú‚îÄ‚îÄ üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞—Å—Å—ã–ª–æ–∫
‚îî‚îÄ‚îÄ ‚óÄÔ∏è –ù–∞–∑–∞–¥
```

### –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏
```
‚úçÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏
–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ –º–µ–¥–∏–∞:
```

### –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ä–∞—Å—Å—ã–ª–∫–∏
```
üìã –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä:
[–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏—è]

üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏:
‚îú‚îÄ‚îÄ üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–µ–π—á–∞—Å
‚îú‚îÄ‚îÄ ‚è∞ –û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
‚îî‚îÄ‚îÄ ‚óÄÔ∏è –ù–∞–∑–∞–¥
```

### –í—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
```
‚è∞ –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏:
[–∫–∞–ª–µ–Ω–¥–∞—Ä—å/–≤—Ä–µ–º—è –∫–∞–∫ –≤ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π]
```

### –ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫
```
üìù –ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫
‚îú‚îÄ‚îÄ üì® [–î–∞—Ç–∞] "[–ü–µ—Ä–≤—ã–µ —Å–ª–æ–≤–∞...]" - [—Å—Ç–∞—Ç—É—Å] - [–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ/–≤—Å–µ–≥–æ]
‚îú‚îÄ‚îÄ üì® [–î–∞—Ç–∞] "[–ü–µ—Ä–≤—ã–µ —Å–ª–æ–≤–∞...]" - [—Å—Ç–∞—Ç—É—Å] - [–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ/–≤—Å–µ–≥–æ]
‚îî‚îÄ‚îÄ ... (–ø–∞–≥–∏–Ω–∞—Ü–∏—è)
```

### –û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ —Ä–∞—Å—Å—ã–ª–∫–∏
```
‚è± –û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ —Ä–∞—Å—Å—ã–ª–∫–∏
‚îú‚îÄ‚îÄ ‚è∞ [–í—Ä–µ–º—è] "[–ü–µ—Ä–≤—ã–µ —Å–ª–æ–≤–∞...]" - [—Å—Ç–∞—Ç—É—Å]
‚îú‚îÄ‚îÄ ‚è∞ [–í—Ä–µ–º—è] "[–ü–µ—Ä–≤—ã–µ —Å–ª–æ–≤–∞...]" - [—Å—Ç–∞—Ç—É—Å]
‚îî‚îÄ‚îÄ ... (–ø–∞–≥–∏–Ω–∞—Ü–∏—è)
```

### –ú–µ–Ω—é –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏
```
‚è± –û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞
üìã –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä:
[–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏—è]

üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
‚îú‚îÄ‚îÄ üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–µ–π—á–∞—Å
‚îú‚îÄ‚îÄ ‚ùå –£–¥–∞–ª–∏—Ç—å
‚îî‚îÄ‚îÄ ‚óÄÔ∏è –ù–∞–∑–∞–¥
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞—Å—Å—ã–ª–æ–∫
```
üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞—Å—Å—ã–ª–æ–∫
‚îú‚îÄ‚îÄ üì® –í—Å–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: X
‚îú‚îÄ‚îÄ üìû –û—Ç–∫—Ä—ã—Ç–∏–π: X
‚îú‚îÄ‚îÄ üìà –ö–æ–Ω–≤–µ—Ä—Å–∏—è: X%
‚îî‚îÄ‚îÄ ‚óÄÔ∏è –ù–∞–∑–∞–¥
```

## 6. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å —É—á–µ—Ç–æ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π Telegram

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ —Ä–µ—à–µ–Ω–∏—è:
1. **30 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–µ–∫—É–Ω–¥—É –≥–ª–æ–±–∞–ª—å–Ω–æ** - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞—Å—Å—ã–ª–æ–∫ –ø–æ—Ä—Ü–∏–æ–Ω–Ω–æ –ø–æ 5 —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
2. **1 —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–µ–∫—É–Ω–¥—É –≤ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç** - –æ—á–µ—Ä–µ–¥—å —Å —Ç–∞–π–º–µ—Ä–æ–º
3. **20 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –º–∏–Ω—É—Ç—É –≤ —á–∞—Ç** - –∫–æ–Ω—Ç—Ä–æ–ª—å —á–∞—Å—Ç–æ—Ç—ã –æ—Ç–ø—Ä–∞–≤–∫–∏

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–∞—Å—Å—ã–ª–∫–∏:
```python
# –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫
class ScheduledBroadcast(Base):
    __tablename__ = "scheduled_broadcasts"
    
    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    message_text: Mapped[str] = mapped_column(Text)
    media_file_id: Mapped[str | None] = mapped_column(String)
    media_type: Mapped[str | None] = mapped_column(String)
    scheduled_time: Mapped[datetime] = mapped_column(DateTime)
    status: Mapped[str] = mapped_column(String, default="pending")  # pending, sent, cancelled
    created_at: Mapped[datetime] = mapped_column(DateTime, default=func.now())

# –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞—Å—Å—ã–ª–æ–∫
class BroadcastHistory(Base):
    __tablename__ = "broadcast_history"
    
    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    message_text: Mapped[str] = mapped_column(Text)
    sent_count: Mapped[int] = mapped_column(Integer, default=0)
    total_count: Mapped[int] = mapped_column(Integer)
    sent_at: Mapped[datetime] = mapped_column(DateTime, default=func.now())
```

### –°–∏—Å—Ç–µ–º–∞ –æ—á–µ—Ä–µ–¥–∏ —Ä–∞—Å—Å—ã–ª–æ–∫:
```python
import asyncio
from asyncio import Queue

class BroadcastQueue:
    def __init__(self):
        self.queue = Queue()
        self.is_running = False
    
    async def add_to_queue(self, user_ids: list[int], message_data: dict):
        for user_id in user_ids:
            await self.queue.put({"user_id": user_id, "message_data": message_data})
    
    async def send_broadcast_batch(self, bot: Bot, batch_size=5):
        while self.is_running:
            batch = []
            for _ in range(batch_size):
                if not self.queue.empty():
                    batch.append(await self.queue.get())
            
            if batch:
                tasks = []
                for item in batch:
                    task = self.safe_send_message(bot, item["user_id"], item["message_data"])
                    tasks.append(task)
                
                await asyncio.gather(*tasks, return_exceptions=True)
                await asyncio.sleep(1)  # –£–≤–∞–∂–µ–Ω–∏–µ –∫ —Ä–µ–π—Ç-–ª–∏–º–∏—Ç–∞–º
            
            await asyncio.sleep(0.1)  # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É –±–∞—Ç—á–∞–º–∏
```

## 7. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ó–∞—â–∏—Ç–∞ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏:
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ `ADMIN_IDS` –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
2. HMAC-–ø–æ–¥–ø–∏—Å—å –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
4. –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è/–∑–∞–≤–µ—Ä—à–µ–Ω–∏—è)

### –°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:
```python
# –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –ª–æ–≥–æ–≤ –∞–¥–º–∏–Ω-–¥–µ–π—Å—Ç–≤–∏–π
class AdminLog(Base):
    __tablename__ = "admin_logs"
    
    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    admin_id: Mapped[int] = mapped_column(BigInteger)
    action: Mapped[str] = mapped_column(String)
    target_id: Mapped[int | None] = mapped_column(BigInteger)
    details: Mapped[dict | None] = mapped_column(JSON)
    timestamp: Mapped[datetime] = mapped_column(DateTime, default=func.now())
```

–¢–µ–ø–µ—Ä—å –≤–∞—à –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–∫–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –≤–Ω–µ–¥—Ä–µ–Ω–∏—é —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.=== ./plans/bot_improvement_plan.md ===
# –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é Telegram-–±–æ—Ç–∞ –¥–ª—è —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π

## 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1.1. –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ middleware

–í —Ñ–∞–π–ª–µ [`random/main.py`](file:///home/hot/Desktop/ytb/random/main.py:1-95) –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ middleware:

```python
# –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ middleware:
dp.update.middleware(DbSessionMiddleware())  # –°–Ω–∞—á–∞–ª–∞ —Å–µ—Å—Å–∏—è –ë–î
dp.update.middleware(ErrorMiddleware())      # –ó–∞—Ç–µ–º –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
dp.message.middleware(ThrottlingMiddleware(redis, rate_limit=1.0))
dp.callback_query.middleware(ThrottlingMiddleware(redis, rate_limit=1.0))
```

### 1.2. –°–æ–∑–¥–∞–Ω–∏–µ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ middleware

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª [`random/middlewares/setup.py`](file:///home/hot/Desktop/ytb/random/middlewares/setup.py):

```python
from aiogram import Dispatcher
from redis.asyncio import Redis

from .db_session import DbSessionMiddleware
from .error_handler import ErrorMiddleware
from .throttling import ThrottlingMiddleware


def setup_middlewares(dp: Dispatcher, redis: Redis):
    """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ middleware –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ"""
    # –°–Ω–∞—á–∞–ª–∞ —Å–µ—Å—Å–∏—è –ë–î
    dp.update.middleware(DbSessionMiddleware())
    
    # –ó–∞—Ç–µ–º –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
    dp.update.middleware(ErrorMiddleware())
    
    # –ó–∞—Ç–µ–º throttling
    dp.message.middleware(ThrottlingMiddleware(redis, rate_limit=1.0))
    dp.callback_query.middleware(ThrottlingMiddleware(redis, rate_limit=1.0))
```

### 1.3. –£–ª—É—á—à–µ–Ω–Ω—ã–π –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

–û–±–Ω–æ–≤–∏—Ç–µ —Ñ–∞–π–ª [`random/main.py`](file:///home/hot/Desktop/ytb/random/main.py:1-95):

```python
import asyncio
import signal
from contextlib import asynccontextmanager
from aiogram import Bot, Dispatcher
from aiogram.client.default import DefaultBotProperties
from aiogram.fsm.storage.redis import RedisStorage
from redis.asyncio import Redis

from config import config
from database import engine, Base
from core.tools.scheduler import start_scheduler, scheduler
from core.logic.game_actions import update_active_giveaways_task
from middlewares.setup import setup_middlewares

# –ò–º–ø–æ—Ä—Ç—ã —Ä–æ—É—Ç–µ—Ä–æ–≤
from handlers.user import router as user_router
from handlers.creator import router as creator_router
from handlers.participant import join
from handlers.common import start


@asynccontextmanager
async def lifespan(app):
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    redis = Redis.from_url(config.REDIS_URL)
    bot = Bot(token=config.BOT_TOKEN.get_secret_value(), default=DefaultBotProperties(parse_mode="HTML"))
    dp = Dispatcher(storage=RedisStorage(redis=redis))
    
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ middleware
    setup_middlewares(dp, redis)
    
    # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–æ—É—Ç–µ—Ä–æ–≤
    dp.include_router(user_router)
    dp.include_router(creator_router)
    dp.include_router(join.router)
    dp.include_router(start.router)
    
    # –ó–∞–ø—É—Å–∫ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
    scheduler.add_job(update_active_giveaways_task, "interval", minutes=30, id="global_updater", replace_existing=True)
    await start_scheduler()
    
    yield {"bot": bot, "dp": dp, "redis": redis}
    
    # –û—á–∏—Å—Ç–∫–∞
    await scheduler.shutdown()
    await bot.session.close()
    await redis.aclose()


async def main():
    import logging
    logging.basicConfig(level=logging.INFO)
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)
    
    async with lifespan(None) as app:
        bot = app["bot"]
        dp = app["dp"]
        redis = app["redis"]
        
        # –£–¥–∞–ª—è–µ–º –≤–µ–±—Ö—É–∫ –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∞–ø–¥–µ–π—Ç—ã
        await bot.delete_webhook(drop_pending_updates=True)
        
        try:
            await dp.start_polling(bot)
        finally:
            await bot.session.close()
            await redis.aclose()


if __name__ == "__main__":
    asyncio.run(main())
```

## 2. –£–ª—É—á—à–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### 2.1. –£–ª—É—á—à–µ–Ω–Ω—ã–π throttling —Å —É—á–µ—Ç–æ–º chat_id

–û–±–Ω–æ–≤–∏—Ç–µ —Ñ–∞–π–ª [`random/middlewares/throttling.py`](file:///home/hot/Desktop/ytb/random/middlewares/throttling.py:1-42):

```python
from typing import Callable, Awaitable, Dict, Any
from aiogram import BaseMiddleware
from aiogram.types import CallbackQuery, Message
from redis.asyncio import Redis
from core.exceptions import error_handler


class ThrottlingMiddleware(BaseMiddleware):
    def __init__(self, redis: Redis, rate_limit: float = 1.0):
        self.redis = redis
        self.rate_limit = rate_limit

    async def __call__(
        self,
        handler: Callable[[Message | CallbackQuery, Dict[str, Any]], Awaitable[Any]],
        event: Message | CallbackQuery,
        data: Dict[str, Any]
    ) -> Any:
        try:
            user_id = event.from_user.id
            # –î–ª—è –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º chat_id –≤ –∫–ª—é—á–µ
            chat_id = getattr(event, 'chat', None)
            if chat_id and hasattr(chat_id, 'id'):
                key = f"throttle:{chat_id.id}:{user_id}"
            else:
                key = f"throttle:user:{user_id}"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–∞ –≤ Redis
            if await self.redis.get(key):
                if isinstance(event, CallbackQuery):
                    await event.answer("‚è≥ –ù–µ —Ç–∞–∫ –±—ã—Å—Ç—Ä–æ!", show_alert=True)
                elif isinstance(event, Message):
                    # –î–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –º–æ–∂–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                    await event.answer("‚è≥ –ù–µ —Ç–∞–∫ –±—ã—Å—Ç—Ä–æ!")
                return
                
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª—é—á —Å –≤—Ä–µ–º–µ–Ω–µ–º –∂–∏–∑–Ω–∏ (TTL) = rate_limit
            await self.redis.set(key, "1", ex=int(self.rate_limit))
            
            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–∞–ª—å—à–µ
            return await handler(event, data)
        except Exception as e:
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫—É —á–µ—Ä–µ–∑ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
            await error_handler.handle_error(e, event.from_user.id if event.from_user else None, "throttling_middleware")
            raise e
```

### 2.2. –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ TelegramBadRequest

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª [`random/core/telegram_error_handler.py`](file:///home/hot/Desktop/ytb/random/core/telegram_error_handler.py):

```python
from aiogram.exceptions import TelegramBadRequest
from aiogram import html


async def handle_telegram_bad_request(error: TelegramBadRequest, user_id: int = None):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫ TelegramBadRequest"""
    error_description = str(error).lower()
    
    if "message is not modified" in error_description:
        # –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ, –º–æ–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å
        return True
    elif "message to edit not found" in error_description:
        # –°–æ–æ–±—â–µ–Ω–∏–µ –±—ã–ª–æ —É–¥–∞–ª–µ–Ω–æ, –º–æ–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å
        return True
    elif "query is too old" in error_description or "query_id_invalid" in error_description:
        # Callback query —Å–ª–∏—à–∫–æ–º —Å—Ç–∞—Ä—ã–π, –º–æ–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å
        return True
    elif "user is deactivated" in error_description or "user not found" in error_description:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω, –º–æ–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å
        return True
    elif "bot was blocked" in error_description or "bot was kicked" in error_description:
        # –ë–æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω, –º–æ–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å
        return True
    
    return False  # –û—à–∏–±–∫–∞ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏


async def safe_edit_message(call: CallbackQuery, text: str, reply_markup=None):
    """–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫"""
    try:
        await call.message.edit_text(text, reply_markup=reply_markup)
    except TelegramBadRequest as e:
        if await handle_telegram_bad_request(e, call.from_user.id):
            # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏, –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback
            await call.answer()
        else:
            # –î—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞, –ª–æ–≥–∏—Ä—É–µ–º
            from utils.logging_config import logger
            logger.error(f"Unexpected TelegramBadRequest: {e}")
            await call.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è", show_alert=True)
    except Exception as e:
        from utils.logging_config import logger
        logger.error(f"Error editing message: {e}")
        await call.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞", show_alert=True)
```

### 2.3. –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

–û–±–Ω–æ–≤–∏—Ç–µ —Ñ–∞–π–ª [`random/handlers/user/dashboard.py`](file:///home/hot/Desktop/ytb/random/handlers/user/dashboard.py:1-59):

```python
from aiogram import Router, Bot, F
from aiogram.filters import CommandStart, CommandObject
from aiogram.fsm.context import FSMContext
from aiogram.types import Message, CallbackQuery
from sqlalchemy.ext.asyncio import AsyncSession
from aiogram import html
from core.telegram_error_handler import safe_edit_message

from database.requests.user_repo import register_user
from keyboards.inline.dashboard import start_menu_kb, cabinet_kb
from handlers.common.start import cmd_start as deep_link_logic

router = Router()

@router.message(CommandStart())
async def smart_dashboard(
    message: Message,
    command: CommandObject,
    session: AsyncSession,
    bot: Bot,
    state: FSMContext
):
    # DeepLink (—Ä–µ—Ñ–∫–∏ –∏ —É—á–∞—Å—Ç–∏–µ)
    if command.args and (command.args.startswith("gw_") or command.args.startswith("res_")):
        await deep_link_logic(message, command, session, bot, state)
        return

    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    await register_user(session, message.from_user.id, message.from_user.username, message.from_user.full_name)
    
    text = (
        f"üëã <b>–ü—Ä–∏–≤–µ—Ç, {html.quote(message.from_user.first_name)}!</b>\n"
        f"–≠—Ç–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —á–µ—Å—Ç–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π.\n\n"
        f"–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
    )

    await message.answer(text, reply_markup=start_menu_kb())

@router.callback_query(F.data == "dashboard_home")
async def back_home(call: CallbackQuery):
    await safe_edit_message(
        call,
        "üëã <b>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</b>\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=start_menu_kb()
    )

@router.callback_query(F.data == "cabinet_hub")
async def open_cabinet(call: CallbackQuery, session: AsyncSession):
    text = (
        "üë§ <b>–ö–∞–±–∏–Ω–µ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞</b>\n\n"
        f"üÜî ID: <code>{html.quote(str(call.from_user.id))}</code>\n"
        "üìä –ó–¥–µ—Å—å –≤—ã —É–ø—Ä–∞–≤–ª—è–µ—Ç–µ –∫–∞–Ω–∞–ª–∞–º–∏ –∏ –ø–æ–¥–ø–∏—Å–∫–æ–π."
    )
    await safe_edit_message(call, text, reply_markup=cabinet_kb())
```

## 3. –£–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### 3.1. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

–í —Ñ–∞–π–ª–µ [`random/database/requests/user_repo.py`](file:///home/hot/Desktop/ytb/random/database/requests/user_repo.py:1-29) –¥–æ–±–∞–≤—å—Ç–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–æ–ª–µ–π:

```python
from sqlalchemy import BigInteger, String, Boolean, DateTime, func, Index
from sqlalchemy.orm import Mapped, mapped_column, relationship
from database.base import Base

class User(Base):
    __tablename__ = "users"

    user_id: Mapped[int] = mapped_column(BigInteger, primary_key=True, autoincrement=False)
    username: Mapped[str | None] = mapped_column(String, nullable=True)
    full_name: Mapped[str] = mapped_column(String)
    
    # --- Monetization ---
    is_premium: Mapped[bool] = mapped_column(Boolean, default=False)
    premium_until: Mapped[datetime | None] = mapped_column(DateTime, nullable=True)
    
    # --- Timestamps ---
    created_at: Mapped[datetime] = mapped_column(DateTime, default=func.now())
    
    # –°–≤—è–∑—å —Å —Ä–æ–∑—ã–≥—Ä—ã—à–∞–º–∏ (–≤–ª–∞–¥–µ–ª–µ—Ü)
    giveaways: Mapped[list["Giveaway"]] = relationship("Giveaway", back_populates="owner", lazy="selectin")

    def __repr__(self):
        return f"<User {self.user_id}>"

# –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
Index('idx_users_username', User.username)
Index('idx_users_premium', User.is_premium)
Index('idx_users_created_at', User.created_at.desc())
# –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å –ø–æ user_id –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
Index('idx_users_user_id', User.user_id)
```

### 3.2. –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª [`random/utils/logger.py`](file:///home/hot/Desktop/ytb/random/utils/logger.py):

```python
import logging
from typing import Optional
import sys
from config import config

def setup_logger(name: str = "bot", level: int = logging.INFO) -> logging.Logger:
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–∞ —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
    logger = logging.getLogger(name)
    logger.setLevel(level)
    
    # –ò–∑–±–µ–≥–∞–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤
    if not logger.handlers:
        handler = logging.StreamHandler(sys.stdout)
        formatter = logging.Formatter(
            '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
        )
        handler.setFormatter(formatter)
        logger.addHandler(handler)
    
    return logger


def get_logger(name: str) -> logging.Logger:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –ª–æ–≥–≥–µ—Ä–∞ —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º —É—Ä–æ–≤–Ω–µ–º –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞"""
    level = getattr(logging, config.LOG_LEVEL.upper(), logging.INFO) if hasattr(config, 'LOG_LEVEL') else logging.INFO
    return setup_logger(name, level)
```

–ò –æ–±–Ω–æ–≤–∏—Ç–µ [`random/config.py`](file:///home/hot/Desktop/ytb/random/config.py:1-30):

```python
from typing import List
from pydantic_settings import BaseSettings
from pydantic import SecretStr, field_validator, ConfigDict

class Settings(BaseSettings):
    BOT_TOKEN: SecretStr
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞–ª–∏–¥–∞—Ç–æ—Ä, —á—Ç–æ–±—ã –ø—Ä–µ–≤—Ä–∞—â–∞—Ç—å —Å—Ç—Ä–æ–∫—É "123,456" –≤ —Å–ø–∏—Å–æ–∫ [123, 456]
    ADMIN_IDS: List[int]
    DB_DNS: str
    REDIS_URL: str
    SECRET_KEY: str
    LOG_LEVEL: str = "INFO"  # –î–æ–±–∞–≤–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    
    @field_validator("ADMIN_IDS", mode="before")
    @classmethod
    def parse_admin_ids(cls, v):
        # –ï—Å–ª–∏ –ø—Ä–∏—à–ª–∞ —Å—Ç—Ä–æ–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä "123,456"), —Å–ø–ª–∏—Ç–∏–º –µ—ë
        if isinstance(v, str):
            # –£–¥–∞–ª—è–µ–º –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —Å–∫–æ–±–∫–∏ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Ö –≤—Å–µ-—Ç–∞–∫–∏ –Ω–∞–ø–∏—Å–∞–ª
            v = v.replace("[", "").replace("]", "")
            if not v:
                return []
            return [int(x.strip()) for x in v.split(",")]
        # –ï—Å–ª–∏ –ø—Ä–∏—à–ª–æ —á–∏—Å–ª–æ (–æ–¥–∏–Ω –∞–¥–º–∏–Ω –±–µ–∑ –∫–∞–≤—ã—á–µ–∫ –∏ –∑–∞–ø—è—Ç—ã—Ö)
        if isinstance(v, int):
            return [v]
        return v

    model_config = ConfigDict(env_file=".env", env_file_encoding="utf-8")

config = Settings()
```

## 4. –£–ª—É—á—à–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

### 4.1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º

–û–±–Ω–æ–≤–∏—Ç–µ —Å–µ—Ä–≤–∏—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏, –¥–æ–±–∞–≤–∏–≤ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:

```python
# –í —Ñ–∞–π–ª–µ random/core/services/checker_service.py (–∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π)
import logging
from aiogram import Bot
from aiogram.exceptions import TelegramBadRequest
from redis.asyncio import Redis
from config import config

logger = logging.getLogger(__name__)
redis = Redis.from_url(config.REDIS_URL)

async def is_user_subscribed(bot: Bot, chat_id: int, user_id: int, force_check: bool = False) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –∫–∞–Ω–∞–ª —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    """
    cache_key = f"sub:{chat_id}:{user_id}"
    
    if not force_check:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
        cached_result = await redis.get(cache_key)
        if cached_result is not None:
            return cached_result == b"1"
    
    try:
        member = await bot.get_chat_member(chat_id=chat_id, user_id=user_id)
        is_subscribed = member.status in ['member', 'administrator', 'creator']
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∫—ç—à –Ω–∞ 5 –º–∏–Ω—É—Ç
        await redis.setex(cache_key, 300, "1" if is_subscribed else "0")
        
        return is_subscribed
    except TelegramBadRequest as e:
        logger.error(f"Error checking subscription (User: {user_id}, Chat: {chat_id}): {e}")
        # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–∞–∫ "–Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω" –Ω–∞ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è
        await redis.setex(cache_key, 60, "0")
        return False
    except Exception as e:
        logger.error(f"Unexpected error checking subscription (User: {user_id}, Chat: {chat_id}): {e}")
        return False
```

## 5. –£–ª—É—á—à–µ–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

### 5.1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–µ–µ—Å—Ç—Ä–∞ —Ä–æ—É—Ç–µ—Ä–æ–≤

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª [`random/handlers/__init__.py`](file:///home/hot/Desktop/ytb/random/handlers/__init__.py):

```python
from aiogram import Router

# –ò–º–ø–æ—Ä—Ç—ã –≤—Å–µ—Ö —Ä–æ—É—Ç–µ—Ä–æ–≤
from .user import router as user_router
from .creator import router as creator_router
from .participant import join
from .common import start

# –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ä–æ—É—Ç–µ—Ä –¥–ª—è –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
def get_main_router() -> Router:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–ª–∞–≤–Ω—ã–π —Ä–æ—É—Ç–µ—Ä —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–º–∏ –≤—Å–µ–º–∏ –ø–æ–¥—Ä–æ—É—Ç–µ—Ä–∞–º–∏"""
    main_router = Router()
    
    # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Ä–æ—É—Ç–µ—Ä–æ–≤
    main_router.include_router(user_router)
    main_router.include_router(creator_router)
    main_router.include_router(join.router)
    main_router.include_router(start.router)
    
    return main_router
```

–ó–∞—Ç–µ–º –æ–±–Ω–æ–≤–∏—Ç–µ [`random/main.py`](file:///home/hot/Desktop/ytb/random/main.py:1-95) –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–æ—É—Ç–µ—Ä–∞:

```python
# –í –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞
from handlers import get_main_router

# –í —Ñ—É–Ω–∫—Ü–∏–∏ main()
async def main():
    # ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ ...
    
    # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–æ—É—Ç–µ—Ä–æ–≤ —á–µ—Ä–µ–∑ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥
    dp.include_router(get_main_router())
    
    # ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ ...
```

## 6. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 6.1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–∏–ø–∏–∑–∞—Ü–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏

–î–æ–±–∞–≤—å—Ç–µ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤ –∫ –æ—Å–Ω–æ–≤–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º:

```python
from typing import Union
from aiogram.types import Message, CallbackQuery

async def process_user_action(
    event: Union[Message, CallbackQuery],
    session: AsyncSession,
    bot: Bot,
    state: FSMContext
) -> None:
    # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–∏
    pass
```

### 6.2. –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π

–û–±–Ω–æ–≤–∏—Ç–µ —Ñ–∞–π–ª [`random/config.py`](file:///home/hot/Desktop/ytb/random/config.py:1-30) –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:

```python
from typing import List, Optional
from pydantic_settings import BaseSettings
from pydantic import SecretStr, field_validator, ConfigDict, validator

class Settings(BaseSettings):
    BOT_TOKEN: SecretStr
    ADMIN_IDS: List[int]
    DB_DNS: str
    REDIS_URL: str
    SECRET_KEY: str
    LOG_LEVEL: str = "INFO"
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    WEBHOOK_URL: Optional[str] = None
    WEBHOOK_PATH: str = "/webhook"
    LISTEN_HOST: str = "0.0.0"
    LISTEN_PORT: int = 8000
    RATE_LIMIT_PER_SECOND: float = 1.0
    SESSION_LIFETIME: int = 86400  # 24 —á–∞—Å–∞
    
    @field_validator("ADMIN_IDS", mode="before")
    @classmethod
    def parse_admin_ids(cls, v):
        if isinstance(v, str):
            v = v.replace("[", "").replace("]", "")
            if not v:
                return []
            return [int(x.strip()) for x in v.split(",")]
        if isinstance(v, int):
            return [v]
        return v

    model_config = ConfigDict(env_file=".env", env_file_encoding="utf-8")

config = Settings()
```

–≠—Ç–∏ —É–ª—É—á—à–µ–Ω–∏—è –ø–æ–∑–≤–æ–ª—è—Ç —Å–¥–µ–ª–∞—Ç—å –≤–∞—à –±–æ—Ç –¥–ª—è —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –±–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω—ã–º, –±–µ–∑–æ–ø–∞—Å–Ω—ã–º –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—ã–º. –û–Ω–∏ –≤–∫–ª—é—á–∞—é—Ç –≤ —Å–µ–±—è –ª—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ Telegram-–±–æ—Ç–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º aiogram 3.x, –∞ —Ç–∞–∫–∂–µ —É—á–∏—Ç—ã–≤–∞—é—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã –∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º—É –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—é –∏ —Ä–∞–±–æ—Ç–µ —Å –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö.=== ./plans/stage_based_admin_panel_implementation.md ===
# –ü–æ—ç—Ç–∞–ø–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –¥–ª—è –±–æ—Ç–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π

## –≠–¢–ê–ü 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω—ã–π —ç—Ç–∞–ø

### –¶–µ–ª—å —ç—Ç–∞–ø–∞:
–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏, —Å–æ–∑–¥–∞—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö –∏ —Å–µ—Ä–≤–∏—Å—ã.

### –ó–∞–¥–∞—á–∏:
1. **–°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–¥–º–∏–Ω-–¥–µ–π—Å—Ç–≤–∏—è—Ö**
   - –ú–æ–¥–µ–ª—å `AdminLog` –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
   - –ú–æ–¥–µ–ª—å `Broadcast` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–∞—Å—Å—ã–ª–∫–∞—Ö
   - –ú–æ–¥–µ–ª—å `ScheduledBroadcast` –¥–ª—è –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫

```python
from sqlalchemy import Integer, String, DateTime, Boolean, func, JSON, Text, BigInteger
from sqlalchemy.orm import Mapped, mapped_column
from database.base import Base
from datetime import datetime

class AdminLog(Base):
    __tablename__ = "admin_logs"
    
    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    admin_id: Mapped[int] = mapped_column(BigInteger)
    action: Mapped[str] = mapped_column(String)
    target_id: Mapped[int | None] = mapped_column(BigInteger)
    details: Mapped[dict | None] = mapped_column(JSON)
    timestamp: Mapped[datetime] = mapped_column(DateTime, default=func.now())

class Broadcast(Base):
    __tablename__ = "broadcasts"
    
    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    message_text: Mapped[str] = mapped_column(Text)
    photo_file_id: Mapped[str | None] = mapped_column(String, nullable=True)
    video_file_id: Mapped[str | None] = mapped_column(String, nullable=True)
    document_file_id: Mapped[str | None] = mapped_column(String, nullable=True)
    scheduled_time: Mapped[datetime | None] = mapped_column(DateTime, nullable=True)
    status: Mapped[str] = mapped_column(String, default="pending")
    sent_count: Mapped[int] = mapped_column(Integer, default=0)
    total_count: Mapped[int] = mapped_column(Integer, default=0)
    failed_count: Mapped[int] = mapped_column(Integer, default=0)
    blocked_count: Mapped[int] = mapped_column(Integer, default=0)
    created_at: Mapped[datetime] = mapped_column(DateTime, default=func.now())
    completed_at: Mapped[datetime | None] = mapped_column(DateTime, nullable=True)
    created_by: Mapped[int] = mapped_column(Integer)

class ScheduledBroadcast(Base):
    __tablename__ = "scheduled_broadcasts"
    
    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    message_text: Mapped[str] = mapped_column(Text)
    photo_file_id: Mapped[str | None] = mapped_column(String, nullable=True)
    video_file_id: Mapped[str | None] = mapped_column(String, nullable=True)
    document_file_id: Mapped[str | None] = mapped_column(String, nullable=True)
    scheduled_time: Mapped[datetime] = mapped_column(DateTime)
    status: Mapped[str] = mapped_column(String, default="pending")
    created_at: Mapped[datetime] = mapped_column(DateTime, default=func.now())
    created_by: Mapped[int] = mapped_column(Integer)
```

2. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏—Å—Ç–µ–º—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è**
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∞–π–ª–æ–≤–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å —Ä–æ—Ç–∞—Ü–∏–µ–π
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω-–¥–µ–π—Å—Ç–≤–∏–π

```python
import logging
from logging.handlers import RotatingFileHandler
import os

def setup_logging():
    # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    logs_dir = "logs"
    if not os.path.exists(logs_dir):
        os.makedirs(logs_dir)
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –ª–æ–≥–æ–≤
    formatter = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )
    
    # –§–∞–π–ª–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å —Ä–æ—Ç–∞—Ü–∏–µ–π
    file_handler = RotatingFileHandler(
        'logs/admin_panel.log',
        maxBytes=10*1024*1024,  # 10 MB
        backupCount=5
    )
    file_handler.setFormatter(formatter)
    
    # –ö–æ–Ω—Å–æ–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
    console_handler = logging.StreamHandler()
    console_handler.setFormatter(formatter)
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ –ª–æ–≥–≥–µ—Ä–∞
    root_logger = logging.getLogger()
    root_logger.setLevel(logging.INFO)
    root_logger.addHandler(file_handler)
    root_logger.addHandler(console_handler)
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–æ–≤ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –º–æ–¥—É–ª–µ–π
    admin_logger = logging.getLogger('admin')
    admin_logger.setLevel(logging.INFO)
    
    broadcast_logger = logging.getLogger('broadcast')
    broadcast_logger.setLevel(logging.INFO)
```

3. **–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–∞–∂–¥—ã–º —Ä–∞–∑–¥–µ–ª–æ–º**
   - –°–µ—Ä–≤–∏—Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
   - –°–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
   - –°–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞–º–∏
   - –°–µ—Ä–≤–∏—Å —Ä–∞—Å—Å—ã–ª–æ–∫

```python
from datetime import datetime, timedelta
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func, and_, update
from database.models.user import User
from database.models.giveaway import Giveaway
from database.models.participant import Participant

class StatisticsService:
    def __init__(self, session: AsyncSession):
        self.session = session
    
    async def get_general_stats(self) -> dict:
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        """
        # –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        total_users = await self.session.scalar(select(func.count(User.user_id)))
        
        # –ê–∫—Ç–∏–≤–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
        active_giveaways = await self.session.scalar(
            select(func.count(Giveaway.id)).where(Giveaway.status == "active")
        )
        
        # –í—Å–µ–≥–æ —É—á–∞—Å—Ç–∏–π
        total_participations = await self.session.scalar(
            select(func.count(Participant.user_id))
        )
        
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ username (–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –±–æ—Ç—ã)
        potential_bots = await self.session.scalar(
            select(func.count(User.user_id)).where(User.username.is_(None))
        )
        
        return {
            "total_users": total_users,
            "active_giveaways": active_giveaways,
            "total_participations": total_participations,
            "potential_bots": potential_bots
        }
    
    async def get_user_growth_stats(self) -> dict:
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ä–æ—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        """
        today = datetime.now().date()
        week_ago = today - timedelta(days=7)
        month_ago = today - timedelta(days=30)
        
        new_today = await self.session.scalar(
            select(func.count(User.user_id)).where(
                func.date(User.created_at) == today
            )
        )
        
        new_week = await self.session.scalar(
            select(func.count(User.user_id)).where(
                User.created_at >= week_ago
            )
        )
        
        new_month = await self.session.scalar(
            select(func.count(User.user_id)).where(
                User.created_at >= month_ago
            )
        )
        
        return {
            "new_today": new_today,
            "new_week": new_week,
            "new_month": new_month
        }
```

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- –°–æ–∑–¥–∞–Ω—ã –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
- –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- –°–æ–∑–¥–∞–Ω—ã –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã —Å –±–∞–∑–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é

---

## –≠–¢–ê–ü 2: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

### –¶–µ–ª—å —ç—Ç–∞–ø–∞:
–°–æ–∑–¥–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ —Å –±–∞–∑–æ–≤—ã–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.

### –ó–∞–¥–∞—á–∏:
1. **–°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ—É—Ç–µ—Ä–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏**
   - –†–æ—É—Ç–µ—Ä –¥–ª—è –∫–æ–º–∞–Ω–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
   - –†–æ—É—Ç–µ—Ä –¥–ª—è –∫–æ–ª–ª–±—ç–∫–æ–≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏

```python
from aiogram import Router
from aiogram.filters import Filter
from aiogram.types import Message, CallbackQuery

class IsAdmin(Filter):
    def __init__(self):
        super().__init__()
    
    async def __call__(self, obj: Message | CallbackQuery, config) -> bool:
        user_id = obj.from_user.id if hasattr(obj, 'from_user') else obj.message.from_user.id
        return user_id in config.ADMIN_IDS

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–æ—É—Ç–µ—Ä–æ–≤
admin_router = Router()
admin_router.message.filter(IsAdmin())
admin_router.callback_query.filter(IsAdmin())

@admin_router.message(lambda m: m.text == "/admin")
async def admin_panel(message: Message, config):
    keyboard = get_main_admin_menu_keyboard()
    await message.answer("üîí –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", reply_markup=keyboard)
```

2. **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞**
   - –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—Å–∫–∏—Ö –ø—Ä–∞–≤
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏

```python
from functools import wraps
from aiogram import Router
from aiogram.types import Message, CallbackQuery
from aiogram.filters import Filter
import logging

logger = logging.getLogger('admin')

class IsAdmin(Filter):
    def __init__(self):
        super().__init__()
    
    async def __call__(self, obj: Message | CallbackQuery, config) -> bool:
        user_id = obj.from_user.id if hasattr(obj, 'from_user') else obj.message.from_user.id
        
        is_admin = user_id in config.ADMIN_IDS
        if is_admin:
            logger.info(f"Admin {user_id} accessed admin panel")
        else:
            logger.warning(f"Unauthorized access attempt to admin panel by user {user_id}")
        
        return is_admin
```

3. **–°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö –∫–ª–∞–≤–∏–∞—Ç—É—Ä –∏ —Å–æ–æ–±—â–µ–Ω–∏–π**
   - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
   - –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞

```python
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder

def get_main_admin_menu_keyboard() -> InlineKeyboardMarkup:
    """
    –û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
    """
    builder = InlineKeyboardBuilder()
    
    builder.row(
        InlineKeyboardButton(
            text="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
            callback_data="admin_stats"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏",
            callback_data="admin_users"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="üéÅ –†–æ–∑—ã–≥—Ä—ã—à–∏",
            callback_data="admin_giveaways"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="üì¢ –†–∞—Å—Å—ã–ª–∫–∞",
            callback_data="admin_broadcast"
        )
    )
    
    return builder.as_markup()

def get_back_to_main_menu_keyboard() -> InlineKeyboardMarkup:
    """
    –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π "–ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"
    """
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é",
            callback_data="admin_main_menu"
        )
    )
    return builder.as_markup()
```

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- –°–æ–∑–¥–∞–Ω—ã —Ä–æ—É—Ç–µ—Ä—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
- –°–æ–∑–¥–∞–Ω—ã –±–∞–∑–æ–≤—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏

---

## –≠–¢–ê–ü 3: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–∑–¥–µ–ª–∞ "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"

### –¶–µ–ª—å —ç—Ç–∞–ø–∞:
–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–∞–∑–¥–µ–ª —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫.

### –ó–∞–¥–∞—á–∏:
1. **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥—Ä–∞–∑–¥–µ–ª–æ–≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏**
   - –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
   - –†–æ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –ü—Ä–µ–º–∏—É–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
   - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
   - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—á–∞—Å—Ç–∏–π

```python
from aiogram.types import CallbackQuery
from aiogram import F

@admin_router.callback_query(F.data == "admin_stats")
async def show_stats_menu(callback: CallbackQuery):
    keyboard = get_stats_menu_keyboard()
    await callback.message.edit_text("üìä –ú–µ–Ω—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏", reply_markup=keyboard)

def get_stats_menu_keyboard() -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    builder.row(
        InlineKeyboardButton(
            text="üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
            callback_data="admin_general_stats"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="üìà –†–æ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",
            callback_data="admin_user_growth"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="‚≠ê –ü—Ä–µ–º–∏—É–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
            callback_data="admin_premium_stats"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="üéÆ –†–æ–∑—ã–≥—Ä—ã—à–∏",
            callback_data="admin_giveaway_stats"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="üéØ –£—á–∞—Å—Ç–∏—è",
            callback_data="admin_participation_stats"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥",
            callback_data="admin_main_menu"
        )
    )
    
    return builder.as_markup()

@admin_router.callback_query(F.data == "admin_general_stats")
async def show_general_stats(callback: CallbackQuery, session: AsyncSession):
    service = StatisticsService(session)
    stats = await service.get_general_stats()
    
    message_text = f"""
üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {stats['total_users']}
üéÅ –ê–∫—Ç–∏–≤–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π: {stats['active_giveaways']}
üé´ –í—Å–µ–≥–æ —É—á–∞—Å—Ç–∏–π: {stats['total_participations']}
ü§ñ –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –±–æ—Ç–æ–≤: {stats['potential_bots']}
    """.strip()
    
    keyboard = get_back_to_stats_menu_keyboard()
    await callback.message.edit_text(message_text, reply_markup=keyboard)

def get_back_to_stats_menu_keyboard() -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ",
            callback_data="admin_stats"
        )
    )
    return builder.as_markup()
```

2. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
   - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–æ–ª–µ–π
   - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

```python
import asyncio
from typing import Dict, Any
from datetime import datetime, timedelta

class StatsCache:
    def __init__(self, ttl: int = 300):  # 5 –º–∏–Ω—É—Ç
        self.cache: Dict[str, tuple[Any, datetime]] = {}
        self.ttl = timedelta(seconds=ttl)
    
    def get(self, key: str):
        if key in self.cache:
            value, timestamp = self.cache[key]
            if datetime.now() - timestamp < self.ttl:
                return value
            else:
                del self.cache[key]
        return None
    
    def set(self, key: str, value: Any):
        self.cache[key] = (value, datetime.now())

class StatisticsService:
    def __init__(self, session: AsyncSession):
        self.session = session
        self.cache = StatsCache()
    
    async def get_general_stats(self) -> dict:
        cache_key = "general_stats"
        cached = self.cache.get(cache_key)
        if cached:
            return cached
        
        # –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        total_users = await self.session.scalar(select(func.count(User.user_id)))
        
        # –ê–∫—Ç–∏–≤–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
        active_giveaways = await self.session.scalar(
            select(func.count(Giveaway.id)).where(Giveaway.status == "active")
        )
        
        # –í—Å–µ–≥–æ —É—á–∞—Å—Ç–∏–π
        total_participations = await self.session.scalar(
            select(func.count(Participant.user_id))
        )
        
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ username (–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –±–æ—Ç—ã)
        potential_bots = await self.session.scalar(
            select(func.count(User.user_id)).where(User.username.is_(None))
        )
        
        result = {
            "total_users": total_users,
            "active_giveaways": active_giveaways,
            "total_participations": total_participations,
            "potential_bots": potential_bots
        }
        
        self.cache.set(cache_key, result)
        return result
```

3. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤**
   - –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
   - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

```python
@admin_router.callback_query(F.data.startswith("admin_general_stats_"))
async def show_general_stats_filtered(callback: CallbackQuery, session: AsyncSession):
    # –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–µ—Ä–∏–æ–¥ –∏–∑ callback_data
    period = callback.data.split("_")[-1]
    
    service = StatisticsService(session)
    if period == "today":
        stats = await service.get_general_stats_for_period(today_only=True)
    elif period == "week":
        stats = await service.get_general_stats_for_period(weeks=1)
    elif period == "month":
        stats = await service.get_general_stats_for_period(months=1)
    else:
        stats = await service.get_general_stats()
    
    message_text = f"""
üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ({period}):
üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {stats['total_users']}
üéÅ –ê–∫—Ç–∏–≤–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π: {stats['active_giveaways']}
üé´ –í—Å–µ–≥–æ —É—á–∞—Å—Ç–∏–π: {stats['total_participations']}
ü§ñ –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –±–æ—Ç–æ–≤: {stats['potential_bots']}
    """.strip()
    
    keyboard = get_back_to_stats_menu_keyboard()
    await callback.message.edit_text(message_text, reply_markup=keyboard)

def get_stats_filter_keyboard() -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    builder.row(
        InlineKeyboardButton(
            text="–î–µ–Ω—å",
            callback_data="admin_general_stats_today"
        ),
        InlineKeyboardButton(
            text="–ù–µ–¥–µ–ª—è",
            callback_data="admin_general_stats_week"
        ),
        InlineKeyboardButton(
            text="–ú–µ—Å—è—Ü",
            callback_data="admin_general_stats_month"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥",
            callback_data="admin_general_stats"
        )
    )
    
    return builder.as_markup()
```

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Ä–∞–∑–¥–µ–ª —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å –ø–æ–¥—Ä–∞–∑–¥–µ–ª–∞–º–∏
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏

---

## –≠–¢–ê–ü 4: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–∑–¥–µ–ª–∞ "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏"

### –¶–µ–ª—å —ç—Ç–∞–ø–∞:
–°–æ–∑–¥–∞—Ç—å –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–∞–∑–¥–µ–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–æ–∏—Å–∫–∞, –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤.

### –ó–∞–¥–∞—á–∏:
1. **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**
   - –ü–æ–∏—Å–∫ –ø–æ ID, username –∏ –∏–º–µ–Ω–∏
   - –ü–æ–∏—Å–∫ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º (–ø—Ä–µ–º–∏—É–º/–æ–±—ã—á–Ω—ã–π, –¥–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ —Ç.–¥.)

```python
from aiogram.types import CallbackQuery, Message
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.context import FSMContext
from aiogram import F

class UserSearchState(StatesGroup):
    waiting_for_search_query = State()

@admin_router.callback_query(F.data == "admin_users")
async def show_users_menu(callback: CallbackQuery):
    keyboard = get_users_menu_keyboard()
    await callback.message.edit_text("üë• –ú–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", reply_markup=keyboard)

def get_users_menu_keyboard() -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    builder.row(
        InlineKeyboardButton(
            text="üîç –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
            callback_data="admin_search_user"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="üìã –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",
            callback_data="admin_list_users_1"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥",
            callback_data="admin_main_menu"
        )
    )
    
    return builder.as_markup()

@admin_router.callback_query(F.data == "admin_search_user")
async def start_user_search(callback: CallbackQuery, state: FSMContext):
    await state.set_state(UserSearchState.waiting_for_search_query)
    keyboard = get_cancel_search_keyboard()
    await callback.message.edit_text("üîç –í–≤–µ–¥–∏—Ç–µ ID, @username –∏–ª–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", reply_markup=keyboard)

@admin_router.message(UserSearchState.waiting_for_search_query)
async def process_user_search(message: Message, state: FSMContext, session: AsyncSession):
    search_query = message.text.strip()
    
    service = UserService(session)
    users = await service.search_users(search_query)
    
    if not users:
        await message.answer("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.")
        await state.clear()
        return
    
    if len(users) == 1:
        # –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        user_info = await service.get_user_detailed_info(users[0].user_id)
        keyboard = get_user_detail_menu_keyboard(user_info["user"].user_id)
        await message.answer(format_user_info(user_info), reply_markup=keyboard)
    else:
        # –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
        keyboard = get_user_search_results_keyboard(users)
        await message.answer("–ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:", reply_markup=keyboard)
    
    await state.clear()

def format_user_info(user_info: dict) -> str:
    user = user_info["user"]
    return f"""
üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ {user.user_id}:
üÜî ID: {user.user_id}
üìõ –ò–º—è: {user.full_name}
ü§ñ Username: @{user.username if user.username else '–Ω–µ —É–∫–∞–∑–∞–Ω'}
‚è∞ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: {user.created_at.strftime('%Y-%m-%d %H:%M')}
üíé –ü—Ä–µ–º–∏—É–º: {'–î–∞' if user.is_premium else '–ù–µ—Ç'}
{'–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è: ' + user.premium_until.strftime('%Y-%m-%d %H:%M') if user.premium_until else ''}
üé´ –£—á–∞—Å—Ç–∏–π: {user_info['participation_count']}
üéÅ –°–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π: {user_info['created_giveaways_count']}
    """.strip()
```

2. **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**
   - –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –ø–∞–≥–∏–Ω–∞—Ü–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º OFFSET/LIMIT
   - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (–ø—Ä–µ–º–∏—É–º/–æ–±—ã—á–Ω—ã–µ, –¥–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ —Ç.–¥.)

```python
from typing import List

class UserService:
    def __init__(self, session: AsyncSession):
        self.session = session
    
    async def get_users_paginated(self, page: int = 1, page_size: int = 10, 
                                 filters: dict = None) -> tuple[List[User], int]:
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
        """
        offset = (page - 1) * page_size
        
        query = select(User).order_by(User.user_id.desc())
        
        # –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        if filters:
            conditions = []
            if filters.get('is_premium') is not None:
                conditions.append(User.is_premium == filters['is_premium'])
            if filters.get('date_from'):
                conditions.append(User.created_at >= filters['date_from'])
            if filters.get('date_to'):
                conditions.append(User.created_at <= filters['date_to'])
            
            if conditions:
                query = query.where(and_(*conditions))
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        result = await self.session.execute(query.offset(offset).limit(page_size))
        users = result.scalars().all()
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
        count_query = select(func.count(User.user_id))
        if filters:
            count_conditions = []
            if filters.get('is_premium') is not None:
                count_conditions.append(User.is_premium == filters['is_premium'])
            if filters.get('date_from'):
                count_conditions.append(User.created_at >= filters['date_from'])
            if filters.get('date_to'):
                count_conditions.append(User.created_at <= filters['date_to'])
            
            if count_conditions:
                count_query = count_query.where(and_(*count_conditions))
        
        total_count = await self.session.scalar(count_query)
        
        return users, total_count

@admin_router.callback_query(F.data.startswith("admin_list_users_"))
async def show_users_list(callback: CallbackQuery, session: AsyncSession):
    page = int(callback.data.split("_")[-1])
    
    service = UserService(session)
    users, total_count = await service.get_users_paginated(page=page)
    
    message_text = "–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:\n\n"
    for user in users:
        premium_status = "üíé" if user.is_premium else "üë§"
        message_text += f"{premium_status} [{user.user_id}] @{user.username or '–±–µ–∑_–Ω–∏–∫–∞'} ({user.full_name})\n"
    
    keyboard = get_users_pagination_keyboard(page, total_count)
    await callback.message.edit_text(message_text, reply_markup=keyboard)

def get_users_pagination_keyboard(current_page: int, total_count: int, page_size: int = 10) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    total_pages = (total_count + page_size - 1) // page_size
    
    if current_page > 1:
        builder.button(
            text="‚è™ –ù–∞–∑–∞–¥",
            callback_data=f"admin_list_users_{current_page - 1}"
        )
    
    builder.button(
        text=f"{current_page}/{total_pages}",
        callback_data="admin_ignore"  # –ó–∞–≥–ª—É—à–∫–∞, –ø—Ä–æ—Å—Ç–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    )
    
    if current_page < total_pages:
        builder.button(
            text="–í–ø–µ—Ä–µ–¥ ‚è©",
            callback_data=f"admin_list_users_{current_page + 1}"
        )
    
    builder.adjust(3)  # –†–∞—Å–ø–æ–ª–∞–≥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
    
    # –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥ –∫ –º–µ–Ω—é"
    builder.row(
        InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º",
            callback_data="admin_users"
        )
    )
    
    return builder.as_markup()
```

3. **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ**
   - –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–µ–º–∏—É–º–∞
   - –ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π

```python
@admin_router.callback_query(F.data.startswith("admin_user_detail_"))
async def show_user_detail(callback: CallbackQuery, session: AsyncSession):
    user_id = int(callback.data.split("_")[-1])
    
    service = UserService(session)
    user_info = await service.get_user_detailed_info(user_id)
    
    if not user_info:
        await callback.answer("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
        return
    
    keyboard = get_user_detail_menu_keyboard(user_id)
    await callback.message.edit_text(
        format_user_info(user_info), 
        reply_markup=keyboard
    )

def get_user_detail_menu_keyboard(user_id: int) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    builder.row(
        InlineKeyboardButton(
            text="‚≠ê –í—ã–¥–∞—Ç—å –ø—Ä–µ–º–∏—É–º",
            callback_data=f"admin_grant_premium_{user_id}"
        ),
        InlineKeyboardButton(
            text="‚ùå –ó–∞–±—Ä–∞—Ç—å –ø—Ä–µ–º–∏—É–º",
            callback_data=f"admin_revoke_premium_{user_id}"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="üìã –†–æ–∑—ã–≥—Ä—ã—à–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
            callback_data=f"admin_user_giveaways_{user_id}_1"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º",
            callback_data="admin_users"
        )
    )
    
    return builder.as_markup()

@admin_router.callback_query(F.data.startswith("admin_grant_premium_"))
async def confirm_grant_premium(callback: CallbackQuery):
    user_id = int(callback.data.split("_")[-1])
    keyboard = get_confirm_premium_action_keyboard(user_id, "grant")
    await callback.message.edit_text(
        f"‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–¥–∞—Ç—å –ø—Ä–µ–º–∏—É–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}?",
        reply_markup=keyboard
    )

@admin_router.callback_query(F.data.startswith("admin_confirm_premium_"))
async def process_premium_change(callback: CallbackQuery, session: AsyncSession):
    action, user_id_str = callback.data.split("_")[2:4]
    user_id = int(user_id_str)
    
    service = UserService(session)
    
    if action == "grant":
        success = await service.toggle_premium_status(user_id, is_premium=True)
        action_text = "–≤—ã–¥–∞–Ω"
    else:
        success = await service.toggle_premium_status(user_id, is_premium=False)
        action_text = "–∑–∞–±—Ä–∞–Ω"
    
    if success:
        await callback.message.edit_text(f"‚úÖ –ü—Ä–µ–º–∏—É–º —É—Å–ø–µ—à–Ω–æ {action_text} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
        # –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
        await log_admin_action(session, callback.from_user.id, f"premium_{action}", user_id)
    else:
        await callback.message.edit_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–µ–º–∏—É–º–∞")
    
    # –ß–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    await asyncio.sleep(2)
    await show_user_detail(
        type('MockCallback', (), {'data': f'admin_user_detail_{user_id}', 'message': callback.message})(),
        session
    )
```

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Ä–∞–∑–¥–µ–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–µ–º–∏—É–º–∞ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º

---

## –≠–¢–ê–ü 5: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–∑–¥–µ–ª–∞ "–†–æ–∑—ã–≥—Ä—ã—à–∏"

### –¶–µ–ª—å —ç—Ç–∞–ø–∞:
–°–æ–∑–¥–∞—Ç—å –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–∞–∑–¥–µ–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞–º–∏ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–æ–∏—Å–∫–∞, –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º.

### –ó–∞–¥–∞—á–∏:
1. **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π**
   - –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –ø—Ä–∏–∑–∞, ID –≤–ª–∞–¥–µ–ª—å—Ü–∞, —Å—Ç–∞—Ç—É—Å—É
   - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è/–æ–∫–æ–Ω—á–∞–Ω–∏—è

```python
class GiveawaySearchState(StatesGroup):
    waiting_for_search_query = State()

@admin_router.callback_query(F.data == "admin_giveaways")
async def show_giveaways_menu(callback: CallbackQuery):
    keyboard = get_giveaways_menu_keyboard()
    await callback.message.edit_text("üéÅ –ú–µ–Ω—é —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π", reply_markup=keyboard)

def get_giveaways_menu_keyboard() -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    builder.row(
        InlineKeyboardButton(
            text="üîç –ü–æ–∏—Å–∫ —Ä–æ–∑—ã–≥—Ä—ã—à–∞",
            callback_data="admin_search_giveaway"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="üìã –°–ø–∏—Å–æ–∫ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π",
            callback_data="admin_list_giveaways_1"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥",
            callback_data="admin_main_menu"
        )
    )
    
    return builder.as_markup()

@admin_router.callback_query(F.data == "admin_search_giveaway")
async def start_giveaway_search(callback: CallbackQuery, state: FSMContext):
    await state.set_state(GiveawaySearchState.waiting_for_search_query)
    keyboard = get_cancel_search_keyboard()
    await callback.message.edit_text(
        "üîç –í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ –∏–∑ –ø—Ä–∏–∑–∞ –∏–ª–∏ ID –≤–ª–∞–¥–µ–ª—å—Ü–∞:",
        reply_markup=keyboard
    )

@admin_router.message(GiveawaySearchState.waiting_for_search_query)
async def process_giveaway_search(message: Message, state: FSMContext, session: AsyncSession):
    search_query = message.text.strip()
    
    service = GiveawayService(session, None)  # bot –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–∑–∂–µ
    giveaways = await service.search_giveaways(search_query)
    
    if not giveaways:
        await message.answer("‚ùå –†–æ–∑—ã–≥—Ä—ã—à–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.")
        await state.clear()
        return
    
    if len(giveaways) == 1:
        # –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω –æ–¥–∏–Ω —Ä–æ–∑—ã–≥—Ä—ã—à, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        giveaway_info = await service.get_giveaway_detailed_info(giveaways[0].id)
        keyboard = get_giveaway_detail_menu_keyboard(giveaway_info["giveaway"].id)
        await message.answer(format_giveaway_info(giveaway_info), reply_markup=keyboard)
    else:
        # –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
        keyboard = get_giveaway_search_results_keyboard(giveaways)
        await message.answer("–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∏:", reply_markup=keyboard)
    
    await state.clear()

def format_giveaway_info(giveaway_info: dict) -> str:
    giveaway = giveaway_info["giveaway"]
    return f"""
üéÅ –†–æ–∑—ã–≥—Ä—ã—à #{giveaway.id}:
üéÅ –ü—Ä–∏–∑: {giveaway.prize_text}
üëë –í–ª–∞–¥–µ–ª–µ—Ü: {giveaway.owner_id}
üìÖ –°–æ–∑–¥–∞–Ω: {giveaway.created_at.strftime('%Y-%m-%d %H:%M')}
üïê –ó–∞–≤–µ—Ä—à–∏—Ç—Å—è: {giveaway.finish_time.strftime('%Y-%m-%d %H:%M')}
üéØ –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: {giveaway_info['participant_count']}
üëë –ü–æ–±–µ–¥–∏—Ç–µ–ª–µ–π: {giveaway.winners_count}
üü¢ –°—Ç–∞—Ç—É—Å: {giveaway.status}
    """.strip()
```

2. **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ —Å–ø–∏—Å–∫–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π**
   - –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è
   - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ç–∞—Ç—É—Å—É –∏ –¥—Ä—É–≥–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º

```python
@admin_router.callback_query(F.data.startswith("admin_list_giveaways_"))
async def show_giveaways_list(callback: CallbackQuery, session: AsyncSession):
    page = int(callback.data.split("_")[-1])
    
    service = GiveawayService(session, None)  # bot –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–∑–∂–µ
    giveaways, total_count = await service.get_giveaways_paginated(page=page)
    
    message_text = "–°–ø–∏—Å–æ–∫ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π:\n\n"
    for giveaway in giveaways:
        message_text += f"üéÅ [{giveaway.id}] \"{giveaway.prize_text}\" - –≤–ª–∞–¥–µ–ª–µ—Ü {giveaway.owner_id} - {giveaway.status}\n"
    
    keyboard = get_giveaways_pagination_keyboard(page, total_count)
    await callback.message.edit_text(message_text, reply_markup=keyboard)

def get_giveaways_pagination_keyboard(current_page: int, total_count: int, page_size: int = 10) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    total_pages = (total_count + page_size - 1) // page_size
    
    if current_page > 1:
        builder.button(
            text="‚è™ –ù–∞–∑–∞–¥",
            callback_data=f"admin_list_giveaways_{current_page - 1}"
        )
    
    builder.button(
        text=f"{current_page}/{total_pages}",
        callback_data="admin_ignore"
    )
    
    if current_page < total_pages:
        builder.button(
            text="–í–ø–µ—Ä–µ–¥ ‚è©",
            callback_data=f"admin_list_giveaways_{current_page + 1}"
        )
    
    builder.adjust(3)
    
    # –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥ –∫ –º–µ–Ω—é"
    builder.row(
        InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ —Ä–æ–∑—ã–≥—Ä—ã—à–∞–º",
            callback_data="admin_giveaways"
        )
    )
    
    return builder.as_markup()
```

3. **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞–º–∏**
   - –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
   - –í—ã–±–æ—Ä –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –≤—Ä—É—á–Ω—É—é
   - –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
   - –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π

```python
@admin_router.callback_query(F.data.startswith("admin_giveaway_detail_"))
async def show_giveaway_detail(callback: CallbackQuery, session: AsyncSession):
    giveaway_id = int(callback.data.split("_")[-1])
    
    service = GiveawayService(session, None)  # bot –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–∑–∂–µ
    giveaway_info = await service.get_giveaway_detailed_info(giveaway_id)
    
    if not giveaway_info:
        await callback.answer("‚ùå –†–æ–∑—ã–≥—Ä—ã—à –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
        return
    
    keyboard = get_giveaway_detail_menu_keyboard(giveaway_id)
    await callback.message.edit_text(
        format_giveaway_info(giveaway_info), 
        reply_markup=keyboard
    )

def get_giveaway_detail_menu_keyboard(giveaway_id: int) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    builder.row(
        InlineKeyboardButton(
            text="üé≤ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å",
            callback_data=f"admin_force_finish_{giveaway_id}"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="üèÜ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ–±–µ–¥–∏—Ç–µ–ª—å",
            callback_data=f"admin_set_winner_{giveaway_id}"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="üë• –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤",
            callback_data=f"admin_giveaway_participants_{giveaway_id}_1"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ —Ä–æ–∑—ã–≥—Ä—ã—à–∞–º",
            callback_data="admin_giveaways"
        )
    )
    
    return builder.as_markup()

@admin_router.callback_query(F.data.startswith("admin_force_finish_"))
async def confirm_force_finish_giveaway(callback: CallbackQuery):
    giveaway_id = int(callback.data.split("_")[-1])
    keyboard = get_confirm_giveaway_action_keyboard(giveaway_id, "finish")
    await callback.message.edit_text(
        f"‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–æ–∑—ã–≥—Ä—ã—à #{giveaway_id}?\n"
        "–í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –±—É–¥—É—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω—ã.",
        reply_markup=keyboard
    )

@admin_router.callback_query(F.data.startswith("admin_confirm_giveaway_"))
async def process_giveaway_action(callback: CallbackQuery, session: AsyncSession, bot):
    action, giveaway_id_str = callback.data.split("_")[2:4]
    giveaway_id = int(giveaway_id_str)
    
    service = GiveawayService(session, bot)
    
    if action == "finish":
        success = await service.force_finish_giveaway(giveaway_id, callback.from_user.id)
        action_text = "–∑–∞–≤–µ—Ä—à–µ–Ω"
    else:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥—Ä—É–≥–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π
        success = False
        action_text = "–æ–±—Ä–∞–±–æ—Ç–∞–Ω"
    
    if success:
        await callback.message.edit_text(f"‚úÖ –†–æ–∑—ã–≥—Ä—ã—à #{giveaway_id} —É—Å–ø–µ—à–Ω–æ {action_text}")
        # –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
        await log_admin_action(session, callback.from_user.id, f"giveaway_{action}", giveaway_id)
    else:
        await callback.message.edit_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞")
    
    # –ß–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–æ–∑—ã–≥—Ä—ã—à–µ
    await asyncio.sleep(2)
    await show_giveaway_detail(
        type('MockCallback', (), {'data': f'admin_giveaway_detail_{giveaway_id}', 'message': callback.message})(),
        session
    )

def get_confirm_giveaway_action_keyboard(giveaway_id: int, action: str) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(
            text="‚úÖ –î–∞",
            callback_data=f"admin_confirm_giveaway_{action}_{giveaway_id}"
        ),
        InlineKeyboardButton(
            text="‚ùå –ù–µ—Ç",
            callback_data="admin_giveaways"
        )
    )
    return builder.as_markup()
```

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Ä–∞–∑–¥–µ–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞–º–∏
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏ –≤—ã–±–æ—Ä–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º

---

## –≠–¢–ê–ü 6: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–∑–¥–µ–ª–∞ "–†–∞—Å—Å—ã–ª–∫–∞"

### –¶–µ–ª—å —ç—Ç–∞–ø–∞:
–°–æ–∑–¥–∞—Ç—å –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–∞–∑–¥–µ–ª —Ä–∞—Å—Å—ã–ª–æ–∫ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –º–µ–¥–∏–∞, –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.

### –ó–∞–¥–∞—á–∏:
1. **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫**
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –º–µ–¥–∏–∞ (—Ç–µ–∫—Å—Ç, —Ñ–æ—Ç–æ, –≤–∏–¥–µ–æ, –¥–æ–∫—É–º–µ–Ω—Ç—ã)
   - –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞

```python
class BroadcastState(StatesGroup):
    waiting_for_message = State()
    waiting_for_schedule_time = State()
    waiting_for_recipient_filter = State()

@admin_router.callback_query(F.data == "admin_broadcast")
async def show_broadcast_menu(callback: CallbackQuery):
    keyboard = get_broadcast_menu_keyboard()
    await callback.message.edit_text("üì¢ –ú–µ–Ω—é —Ä–∞—Å—Å—ã–ª–∫–∏", reply_markup=keyboard)

def get_broadcast_menu_keyboard() -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    builder.row(
        InlineKeyboardButton(
            text="‚úçÔ∏è –°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É",
            callback_data="admin_create_broadcast"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="üìù –ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫",
            callback_data="admin_broadcast_history_1"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="‚è± –û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ —Ä–∞—Å—Å—ã–ª–∫–∏",
            callback_data="admin_scheduled_broadcasts_1"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞—Å—Å—ã–ª–æ–∫",
            callback_data="admin_broadcast_stats"
        )
    builder.row(
        InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥",
            callback_data="admin_main_menu"
        )
    )
    
    return builder.as_markup()

@admin_router.callback_query(F.data == "admin_create_broadcast")
async def start_create_broadcast(callback: CallbackQuery, state: FSMContext):
    await state.set_state(BroadcastState.waiting_for_message)
    keyboard = get_cancel_broadcast_creation_keyboard()
    await callback.message.edit_text(
        "‚úçÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏\n\n–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ –º–µ–¥–∏–∞:",
        reply_markup=keyboard
    )

@admin_router.message(BroadcastState.waiting_for_message)
async def process_broadcast_message(message: Message, state: FSMContext):
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–∞—Å—Å—ã–ª–∫–∏ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    broadcast_data = {}
    
    if message.text:
        broadcast_data['text'] = message.text
    elif message.photo:
        broadcast_data['photo'] = message.photo[-1].file_id
        if message.caption:
            broadcast_data['text'] = message.caption
    elif message.video:
        broadcast_data['video'] = message.video.file_id
        if message.caption:
            broadcast_data['text'] = message.caption
    elif message.document:
        broadcast_data['document'] = message.document.file_id
        if message.caption:
            broadcast_data['text'] = message.caption
    else:
        await message.answer("‚ùå –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–∏–ø—ã: —Ç–µ–∫—Å—Ç, —Ñ–æ—Ç–æ, –≤–∏–¥–µ–æ, –¥–æ–∫—É–º–µ–Ω—Ç—ã")
        return
    
    await state.update_data(broadcast_data=broadcast_data)
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä
    keyboard = get_broadcast_preview_keyboard()
    preview_text = "üìã –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä:\n\n"
    if 'text' in broadcast_data:
        preview_text += broadcast_data['text']
    else:
        preview_text += "[–ú–µ–¥–∏–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ]"
    
    await message.answer(preview_text, reply_markup=keyboard)

def get_broadcast_preview_keyboard() -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(
            text="üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–µ–π—á–∞—Å",
            callback_data="admin_send_broadcast_now"
        ),
        InlineKeyboardButton(
            text="‚è∞ –û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞",
            callback_data="admin_schedule_broadcast"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥",
            callback_data="admin_broadcast"
        )
    )
    return builder.as_markup()
```

2. **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫**
   - –ì–∏–±–∫–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
   - –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–º–µ–Ω—ã –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫

```python
@admin_router.callback_query(F.data == "admin_schedule_broadcast")
async def start_schedule_broadcast(callback: CallbackQuery, state: FSMContext):
    await state.set_state(BroadcastState.waiting_for_schedule_time)
    # –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏ (–∫–∞–ª–µ–Ω–¥–∞—Ä—å/–≤—Ä–µ–º—è)
    await callback.message.edit_text(
        "‚è∞ –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (–≤ —Ñ–æ—Ä–º–∞—Ç–µ –ì–ì–ì–ì-–ú–ú-–î–î –ß–ß:–ú–ú):",
        reply_markup=get_cancel_schedule_keyboard()
    )

@admin_router.message(BroadcastState.waiting_for_schedule_time)
async def process_schedule_time(message: Message, state: FSMContext, session: AsyncSession):
    try:
        schedule_time = datetime.strptime(message.text, "%Y-%m-%d %H:%M")
        
        if schedule_time < datetime.now():
            await message.answer("‚ùå –í—Ä–µ–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –ø—Ä–æ—à–ª–æ–º")
            return
        
        data = await state.get_data()
        broadcast_data = data['broadcast_data']
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–ª–æ–∂–µ–Ω–Ω—É—é —Ä–∞—Å—Å—ã–ª–∫—É –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        scheduled_broadcast = ScheduledBroadcast(
            message_text=broadcast_data.get('text', ''),
            photo_file_id=broadcast_data.get('photo'),
            video_file_id=broadcast_data.get('video'),
            document_file_id=broadcast_data.get('document'),
            scheduled_time=schedule_time,
            created_by=message.from_user.id
        )
        
        session.add(scheduled_broadcast)
        await session.commit()
        
        await message.answer(f"‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ {schedule_time.strftime('%Y-%m-%d %H:%M')}")
        await state.clear()
        
        # –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
        await log_admin_action(session, message.from_user.id, "broadcast_scheduled", scheduled_broadcast.id)
        
    except ValueError:
        await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ì–ì–ì–ì-–ú–ú-–î–î –ß–ß:–ú–ú")

@admin_router.callback_query(F.data.startswith("admin_scheduled_broadcasts_"))
async def show_scheduled_broadcasts(callback: CallbackQuery, session: AsyncSession):
    page = int(callback.data.split("_")[-1])
    page_size = 10
    offset = (page - 1) * page_size
    
    result = await session.execute(
        select(ScheduledBroadcast)
        .order_by(ScheduledBroadcast.scheduled_time.asc())
        .offset(offset).limit(page_size)
    )
    scheduled_broadcasts = result.scalars().all()
    
    result_count = await session.execute(
        select(func.count(ScheduledBroadcast.id))
    )
    total_count = result_count.scalar()
    
    if not scheduled_broadcasts:
        await callback.message.edit_text("‚è∞ –ù–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫")
        return
    
    message_text = "‚è∞ –û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ —Ä–∞—Å—Å—ã–ª–∫–∏:\n\n"
    for sb in scheduled_broadcasts:
        message_preview = sb.message_text[:30] + "..." if len(sb.message_text) > 30 else sb.message_text
        message_text += f"‚è∞ [{sb.scheduled_time.strftime('%Y-%m-%d %H:%M')}] \"{message_preview}\" - —Å—Ç–∞—Ç—É—Å: {sb.status}\n"
    
    keyboard = get_scheduled_broadcasts_pagination_keyboard(page, total_count)
    await callback.message.edit_text(message_text, reply_markup=keyboard)
```

3. **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞—Å—Å—ã–ª–æ–∫ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏**
   - –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –∏ —Å—á–µ—Ç—á–∏–∫–∞–º–∏
   - –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
   - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

```python
@admin_router.callback_query(F.data.startswith("admin_broadcast_history_"))
async def show_broadcast_history(callback: CallbackQuery, session: AsyncSession):
    page = int(callback.data.split("_")[-1])
    page_size = 10
    offset = (page - 1) * page_size
    
    result = await session.execute(
        select(Broadcast)
        .order_by(Broadcast.created_at.desc())
        .offset(offset).limit(page_size)
    )
    broadcasts = result.scalars().all()
    
    result_count = await session.execute(
        select(func.count(Broadcast.id))
    )
    total_count = result_count.scalar()
    
    if not broadcasts:
        await callback.message.edit_text("üìù –ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞—Å—Å—ã–ª–æ–∫")
        return
    
    message_text = "üìù –ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫:\n\n"
    for bc in broadcasts:
        message_preview = bc.message_text[:30] + "..." if len(bc.message_text) > 30 else bc.message_text
        message_text += f"üì® [{bc.created_at.strftime('%Y-%m-%d %H:%M')}] \"{message_preview}\" - {bc.status} - {bc.sent_count}/{bc.total_count}\n"
    
    keyboard = get_broadcast_history_pagination_keyboard(page, total_count)
    await callback.message.edit_text(message_text, reply_markup=keyboard)

def get_broadcast_history_pagination_keyboard(current_page: int, total_count: int, page_size: int = 10) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    total_pages = (total_count + page_size - 1) // page_size
    
    if current_page > 1:
        builder.button(
            text="‚è™ –ù–∞–∑–∞–¥",
            callback_data=f"admin_broadcast_history_{current_page - 1}"
        )
    
    builder.button(
        text=f"{current_page}/{total_pages}",
        callback_data="admin_ignore"
    )
    
    if current_page < total_pages:
        builder.button(
            text="–í–ø–µ—Ä–µ–¥ ‚è©",
            callback_data=f"admin_broadcast_history_{current_page + 1}"
        )
    
    builder.adjust(3)
    
    # –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥ –∫ –º–µ–Ω—é"
    builder.row(
        InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ —Ä–∞—Å—Å—ã–ª–∫–∞–º",
            callback_data="admin_broadcast"
        )
    )
    
    return builder.as_markup()

# –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞—Å—Å—ã–ª–∫–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:
@admin_router.callback_query(lambda c: c.data.startswith("admin_broadcast_detail_"))
async def show_broadcast_detail(callback: CallbackQuery, session: AsyncSession):
    broadcast_id = int(callback.data.split("_")[-1])
    
    broadcast = await session.get(Broadcast, broadcast_id)
    if not broadcast:
        await callback.answer("‚ùå –†–∞—Å—Å—ã–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
        return
    
    message_text = f"""
üìã –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞—Å—Å—ã–ª–∫–µ #{broadcast_id}:
–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: {broadcast.created_at.strftime('%Y-%m-%d %H:%M')}
–°—Ç–∞—Ç—É—Å: {broadcast.status}
–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {broadcast.sent_count}
–í—Å–µ–≥–æ: {broadcast.total_count}
–ü—Ä–æ–≤–∞–ª–µ–Ω–æ: {broadcast.failed_count}
–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: {broadcast.blocked_count}

–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:
{broadcast.message_text}
    """.strip()
    
    keyboard = get_broadcast_detail_actions_keyboard(broadcast_id)
    await callback.message.edit_text(message_text, reply_markup=keyboard)

def get_broadcast_detail_actions_keyboard(broadcast_id: int) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(
            text="üîÑ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞",
            callback_data=f"admin_resend_broadcast_{broadcast_id}"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥",
            callback_data="admin_broadcast_history_1"
        )
    )
    return builder.as_markup()
```

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Ä–∞–∑–¥–µ–ª —Ä–∞—Å—Å—ã–ª–æ–∫ —Å –ø–æ–ª–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–æ–º
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –º–µ–¥–∏–∞
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫
- –°–æ–∑–¥–∞–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏

---

## –≠–¢–ê–ü 7: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –¶–µ–ª—å —ç—Ç–∞–ø–∞:
–û–±–µ—Å–ø–µ—á–∏—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏, –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.

### –ó–∞–¥–∞—á–∏:
1. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π**
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–µ–π—Å—Ç–≤–∏—è—Ö –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

```python
from sqlalchemy.ext.asyncio import AsyncSession
from datetime import datetime

async def log_admin_action(session: AsyncSession, admin_id: int, action: str, target_id: int = None, details: dict = None):
    """
    –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    """
    log_entry = AdminLog(
        admin_id=admin_id,
        action=action,
        target_id=target_id,
        details=details
    )
    session.add(log_entry)
    await session.commit()

@admin_router.callback_query(F.data.startswith("admin_grant_premium_"))
async def confirm_grant_premium(callback: CallbackQuery):
    user_id = int(callback.data.split("_")[-1])
    
    # –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ø—ã—Ç–∫—É –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–µ–º–∏—É–º–∞
    await log_admin_action(
        session, 
        callback.from_user.id, 
        "premium_grant_attempt", 
        user_id, 
        {"action": "grant"}
    )
    
    keyboard = get_confirm_premium_action_keyboard(user_id, "grant")
    await callback.message.edit_text(
        f"‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–¥–∞—Ç—å –ø—Ä–µ–º–∏—É–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}?",
        reply_markup=keyboard
    )
```

2. **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π**
   - –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
   - –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–µ–º–∏—É–º–∞
   - –£–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

```python
def get_confirm_premium_action_keyboard(user_id: int, action: str) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(
            text="‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å",
            callback_data=f"admin_confirm_premium_{action}_{user_id}"
        ),
        InlineKeyboardButton(
            text="‚ùå –û—Ç–º–µ–Ω–∞",
            callback_data=f"admin_user_detail_{user_id}"
        )
    )
    return builder.as_markup()

@admin_router.callback_query(F.data.startswith("admin_confirm_giveaway_"))
async def process_giveaway_action(callback: CallbackQuery, session: AsyncSession, bot):
    action, giveaway_id_str = callback.data.split("_")[2:4]
    giveaway_id = int(giveaway_id_str)
    
    # –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
    await log_admin_action(
        session, 
        callback.from_user.id, 
        f"giveaway_{action}_confirmed", 
        giveaway_id
    )
    
    service = GiveawayService(session, bot)
    
    if action == "finish":
        success = await service.force_finish_giveaway(giveaway_id, callback.from_user.id)
        action_text = "–∑–∞–≤–µ—Ä—à–µ–Ω"
    else:
        success = False
        action_text = "–æ–±—Ä–∞–±–æ—Ç–∞–Ω"
    
    if success:
        await callback.message.edit_text(f"‚úÖ –†–æ–∑—ã–≥—Ä—ã—à #{giveaway_id} —É—Å–ø–µ—à–Ω–æ {action_text}")
    else:
        await callback.message.edit_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞")
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–æ–∑—ã–≥—Ä—ã—à–µ
    await asyncio.sleep(2)
    await show_giveaway_detail(
        type('MockCallback', (), {'data': f'admin_giveaway_detail_{giveaway_id}', 'message': callback.message})(),
        session
    )
```

3. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –Ω–∞ —á–∞—Å—Ç–æ—Ç—É –∑–∞–ø—Ä–æ—Å–æ–≤**
   - –ó–∞—â–∏—Ç–∞ –æ—Ç DDoS –∞—Ç–∞–∫ –Ω–∞ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

```python
import time
from collections import defaultdict
from typing import Dict

class RateLimiter:
    def __init__(self, max_requests: int = 10, window: int = 60):
        self.max_requests = max_requests
        self.window = window
        self.requests: Dict[int, list] = defaultdict(list)
    
    def is_allowed(self, user_id: int) -> bool:
        now = time.time()
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã
        self.requests[user_id] = [req_time for req_time in self.requests[user_id] if now - req_time < self.window]
        
        if len(self.requests[user_id]) < self.max_requests:
            self.requests[user_id].append(now)
            return True
        
        return False

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç–µ—Ä
rate_limiter = RateLimiter()

@admin_router.callback_query()
async def admin_callback_handler(callback: CallbackQuery, session: AsyncSession):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–π—Ç-–ª–∏–º–∏—Ç
    if not rate_limiter.is_allowed(callback.from_user.id):
        await callback.answer("‚ùå –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.", show_alert=True)
        return
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö callback'–æ–≤
    # ...
```

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

---

## –≠–¢–ê–ü 8: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

### –¶–µ–ª—å —ç—Ç–∞–ø–∞:
–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏.

### –ó–∞–¥–∞—á–∏:
1. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π**
   - –ú–æ–¥—É–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

```python
import pytest
from unittest.mock import AsyncMock, MagicMock

@pytest.mark.asyncio
async def test_statistics_service():
    # –°–æ–∑–¥–∞–µ–º mock —Å–µ—Å—Å–∏–∏
    mock_session = AsyncMock()
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∂–∏–¥–∞–µ–º—ã—Ö –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
    mock_session.scalar.return_value = 100  # –ù–∞–ø—Ä–∏–º–µ—Ä, –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    
    service = StatisticsService(mock_session)
    stats = await service.get_general_stats()
    
    assert stats["total_users"] == 100
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±—ã–ª–∏ –≤—ã–∑–≤–∞–Ω—ã –æ–∂–∏–¥–∞–µ–º—ã–µ –º–µ—Ç–æ–¥—ã
    assert mock_session.scalar.called

@pytest.mark.asyncio
async def test_user_search():
    mock_session = AsyncMock()
    
    # –°–æ–∑–¥–∞–µ–º mock –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    mock_user = MagicMock()
    mock_user.user_id = 123
    mock_user.username = "testuser"
    mock_user.full_name = "Test User"
    
    mock_result = MagicMock()
    mock_result.scalars.return_value.all.return_value = [mock_user]
    mock_session.execute.return_value = mock_result
    
    service = UserService(mock_session)
    users = await service.search_users("testuser")
    
    assert len(users) == 1
    assert users[0].username == "testuser"

# –ü—Ä–∏–º–µ—Ä —Ç–µ—Å—Ç–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
@pytest.mark.asyncio
async def test_broadcast_with_error_handling():
    mock_session = AsyncMock()
    mock_bot = AsyncMock()
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–∏—Ç—É–∞—Ü–∏—é, –∫–æ–≥–¥–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
    mock_bot.send_message.side_effect = Exception("Network error")
    
    service = BroadcastSystem(mock_bot, mock_session)
    
    # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏
    result = await service._send_single_message(123, BroadcastMessage("Test message"))
    assert result is False  # –û–∂–∏–¥–∞–µ–º, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ—Ç False –ø—Ä–∏ –æ—à–∏–±–∫–µ
```

2. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
   - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ —Å –ø–æ–º–æ—â—å—é –∏–Ω–¥–µ–∫—Å–æ–≤
   - –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–æ–ª—å—à–∏–º–∏ —Å–ø–∏—Å–∫–∞–º–∏
   - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö

```python
# –ü—Ä–∏–º–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ –º–æ–¥–µ–ª—è—Ö
from sqlalchemy import Index

# –ò–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ username
Index('idx_users_username', User.username)

# –ò–Ω–¥–µ–∫—Å –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –ø–æ —Å—Ç–∞—Ç—É—Å—É
Index('idx_giveaways_status', Giveaway.status)

# –ò–Ω–¥–µ–∫—Å –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è
Index('idx_giveaways_created_at', Giveaway.created_at.desc())

# –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
class StatisticsService:
    def __init__(self, session: AsyncSession):
        self.session = session
        self.cache = StatsCache(ttl=300)  # 5 –º–∏–Ω—É—Ç
    
    async def get_general_stats(self) -> dict:
        cache_key = "general_stats"
        cached = self.cache.get(cache_key)
        if cached:
            return cached
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å—ã –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        total_users = await self.session.scalar(select(func.count(User.user_id)))
        active_giveaways = await self.session.scalar(
            select(func.count(Giveaway.id)).where(Giveaway.status == "active")
        )
        total_participations = await self.session.scalar(
            select(func.count(Participant.user_id))
        )
        potential_bots = await self.session.scalar(
            select(func.count(User.user_id)).where(User.username.is_(None))
        )
        
        result = {
            "total_users": total_users,
            "active_giveaways": active_giveaways,
            "total_participations": total_participations,
            "potential_bots": potential_bots
        }
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
        self.cache.set(cache_key, result)
        return result
```

3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫**
   - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
   - –ú–µ—Ö–∞–Ω–∏–∑–º—ã –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è —Å–µ—Ç–µ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

```python
import logging
from functools import wraps
from typing import Callable, Any

logger = logging.getLogger(__name__)

def handle_exceptions(default_return=None):
    """
    –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
    """
    def decorator(func: Callable) -> Callable:
        @wraps(func)
        async def wrapper(*args, **kwargs) -> Any:
            try:
                return await func(*args, **kwargs)
            except Exception as e:
                logger.error(f"Error in {func.__name__}: {str(e)}", exc_info=True)
                return default_return
        return wrapper
    return decorator

class StatisticsService:
    def __init__(self, session: AsyncSession):
        self.session = session
        self.cache = StatsCache()
    
    @handle_exceptions(default_return={})
    async def get_general_stats(self) -> dict:
        cache_key = "general_stats"
        cached = self.cache.get(cache_key)
        if cached:
            return cached
        
        # –í–∞—à–∏ –∑–∞–ø—Ä–æ—Å—ã –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        total_users = await self.session.scalar(select(func.count(User.user_id)))
        active_giveaways = await self.session.scalar(
            select(func.count(Giveaway.id)).where(Giveaway.status == "active")
        )
        total_participations = await self.session.scalar(
            select(func.count(Participant.user_id))
        )
        potential_bots = await self.session.scalar(
            select(func.count(User.user_id)).where(User.username.is_(None))
        )
        
        result = {
            "total_users": total_users,
            "active_giveaways": active_giveaways,
            "total_participations": total_participations,
            "potential_bots": potential_bots
        }
        
        self.cache.set(cache_key, result)
        return result

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –¥–ª—è –≤—Å–µ–≥–æ —Ä–æ—É—Ç–µ—Ä–∞
@admin_router.errors()
async def admin_errors_handler(update, error):
    logger.error(f"Admin router error: {error}", exc_info=True)
    # –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–µ
```

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –Ω–∞–¥–µ–∂–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏

---

## –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –¥–ª—è –±–æ—Ç–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –±—ã–ª–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ø–æ—ç—Ç–∞–ø–Ω–æ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –ª—É—á—à–∏–º–∏ –ø—Ä–∞–∫—Ç–∏–∫–∞–º–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏. –ö–∞–∂–¥—ã–π —ç—Ç–∞–ø –≤–∫–ª—é—á–∞–ª –≤ —Å–µ–±—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π —Å —É—á–µ—Ç–æ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ —É–¥–æ–±—Å—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

–û—Å–Ω–æ–≤–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:
1. –°–æ–∑–¥–∞–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
2. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏: —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, —Ä–æ–∑—ã–≥—Ä—ã—à–∞–º–∏ –∏ —Ä–∞—Å—Å—ã–ª–∫–∞–º–∏
3. –û–±–µ—Å–ø–µ—á–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π
4. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∏–Ω–¥–µ–∫—Å–æ–≤
5. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π
6. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –Ω–∞–¥–µ–∂–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

–í–∞–∂–Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è Telegram API, –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã —Ä–∞—Å—Å—ã–ª–æ–∫, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –±–æ—Ç–∞. –°–ª–µ–¥–æ–≤–∞–Ω–∏–µ –≤—Å–µ–º –≤—ã—à–µ–æ–ø–∏—Å–∞–Ω–Ω—ã–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞—Ç—å –Ω–∞–¥–µ–∂–Ω—É—é, –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—É—é –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–æ–º —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π.=== ./config.py ===
from typing import List
from pydantic_settings import BaseSettings
from pydantic import SecretStr, field_validator, ConfigDict

class Settings(BaseSettings):
    BOT_TOKEN: SecretStr
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞–ª–∏–¥–∞—Ç–æ—Ä, —á—Ç–æ–±—ã –ø—Ä–µ–≤—Ä–∞—â–∞—Ç—å —Å—Ç—Ä–æ–∫—É "123,456" –≤ —Å–ø–∏—Å–æ–∫ [123, 456]
    ADMIN_IDS: List[int]
    DB_DNS: str
    REDIS_URL: str
    SECRET_KEY: str

    @field_validator("ADMIN_IDS", mode="before")
    @classmethod
    def parse_admin_ids(cls, v):
        # –ï—Å–ª–∏ –ø—Ä–∏—à–ª–∞ —Å—Ç—Ä–æ–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä "123,456"), —Å–ø–ª–∏—Ç–∏–º –µ—ë
        if isinstance(v, str):
            # –£–¥–∞–ª—è–µ–º –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —Å–∫–æ–±–∫–∏ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Ö –≤—Å–µ-—Ç–∞–∫–∏ –Ω–∞–ø–∏—Å–∞–ª
            v = v.replace("[", "").replace("]", "")
            if not v:
                return []
            return [int(x.strip()) for x in v.split(",")]
        # –ï—Å–ª–∏ –ø—Ä–∏—à–ª–æ —á–∏—Å–ª–æ (–æ–¥–∏–Ω –∞–¥–º–∏–Ω –±–µ–∑ –∫–∞–≤—ã—á–µ–∫ –∏ –∑–∞–ø—è—Ç—ã—Ö)
        if isinstance(v, int):
            return [v]
        return v

    model_config = ConfigDict(env_file=".env", env_file_encoding="utf-8")

config = Settings()=== ./middlewares/admin_middleware.py ===
from typing import Callable, Dict, Any

from aiogram import Router
from aiogram.types import CallbackQuery
from aiogram.methods import AnswerCallbackQuery
from aiogram.fsm.context import FSMContext

from utils.rate_limiter import admin_rate_limiter


class AdminRateLimitMiddleware:
    """
    Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–π—Ç-–ª–∏–º–∏—Ç–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    """
    async def __call__(
        self,
        handler: Callable,
        event: CallbackQuery,
        data: Dict[str, Any]
    ) -> Any:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–π—Ç-–ª–∏–º–∏—Ç –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        if not admin_rate_limiter.is_allowed(event.from_user.id):
            reset_time = admin_rate_limiter.get_reset_time(event.from_user.id)
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –Ω–∞ –∫–æ–ª–ª–±—ç–∫
            await event.answer(f"‚ùå –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ {int(reset_time)} —Å–µ–∫.", show_alert=True)
            return
        
        # –ï—Å–ª–∏ –≤—Å—ë –≤ –ø–æ—Ä—è–¥–∫–µ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É
        return await handler(event, data)=== ./middlewares/throttling.py ===
from typing import Callable, Awaitable, Dict, Any
from aiogram import BaseMiddleware
from aiogram.types import CallbackQuery, Message
from redis.asyncio import Redis

from core.exceptions import error_handler


class ThrottlingMiddleware(BaseMiddleware):
    def __init__(self, redis: Redis, rate_limit: float = 1.0):
        self.redis = redis
        self.rate_limit = rate_limit

    async def __call__(
        self,
        handler: Callable[[Message | CallbackQuery, Dict[str, Any]], Awaitable[Any]],
        event: Message | CallbackQuery,
        data: Dict[str, Any]
    ) -> Any:
        try:
            # –†–∞–±–æ—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —Å –∫–æ–ª–±—ç–∫–∞–º–∏ (–∫–Ω–æ–ø–∫–∏) –∏–ª–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏
            user_id = event.from_user.id
            
            # –ö–ª—é—á –∞–Ω—Ç–∏-—Å–ø–∞–º–∞: throttle:USER_ID
            key = f"throttle:{user_id}"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–∞ –≤ Redis
            if await self.redis.get(key):
                # –ï—Å–ª–∏ –∫–ª—é—á –µ—Å—Ç—å, –∑–Ω–∞—á–∏—Ç –ø—Ä–æ—à–ª–æ –º–µ–Ω—å—à–µ rate_limit —Å–µ–∫—É–Ω–¥
                if isinstance(event, CallbackQuery):
                    await event.answer("‚è≥ –ù–µ —Ç–∞–∫ –±—ã—Å—Ç—Ä–æ!", show_alert=True)
                return # –ü—Ä–µ—Ä—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É, —Ö–µ–Ω–¥–ª–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è
                
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª—é—á —Å –≤—Ä–µ–º–µ–Ω–µ–º –∂–∏–∑–Ω–∏ (TTL) = rate_limit
            await self.redis.set(key, "1", ex=int(self.rate_limit))
            
            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–∞–ª—å—à–µ
            return await handler(event, data)
        except Exception as e:
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫—É —á–µ—Ä–µ–∑ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
            await error_handler.handle_error(e, event.from_user.id if event.from_user else None, "throttling_middleware")
            raise e=== ./middlewares/error_handler.py ===
from typing import Callable, Awaitable, Dict, Any
from aiogram import BaseMiddleware
from aiogram.types import TelegramObject
from core.exceptions import error_handler


class ErrorMiddleware(BaseMiddleware):
    """
    –ú–∏–¥–ª–≤–∞—Ä—å –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
    """
    
    async def __call__(
        self,
        handler: Callable[[TelegramObject, Dict[str, Any]], Awaitable[Any]],
        event: TelegramObject,
        data: Dict[str, Any]
    ) -> Any:
        try:
            return await handler(event, data)
        except Exception as e:
            # –ü–æ–ª—É—á–∞–µ–º user_id –∏–∑ —Å–æ–±—ã—Ç–∏—è
            user_id = None
            if hasattr(event, 'from_user') and event.from_user:
                user_id = event.from_user.id
            elif hasattr(event, 'user') and event.user:
                user_id = event.user.id
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è
            event_type = type(event).__name__
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫—É —á–µ—Ä–µ–∑ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
            await error_handler.handle_error(e, user_id, f"middleware_{event_type}")
            
            # –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –æ—à–∏–±–∫–∏ –º–æ–∂–Ω–æ –ø—Ä–∏–Ω—è—Ç—å —Ä–∞–∑–Ω—ã–µ –º–µ—Ä—ã
            # –î–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –º–æ–∂–Ω–æ –Ω–µ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞—Ç—å –¥–∞–ª—å—à–µ
            raise e=== ./middlewares/__init__.py ===
from .db_session import DbSessionMiddleware
from .throttling import ThrottlingMiddleware
from .error_handler import ErrorMiddleware
from .admin_middleware import AdminRateLimitMiddleware
from .updates_filter import UpdatesFilterMiddleware  # <--- –î–æ–±–∞–≤–ª–µ–Ω–æ

__all__ = [
    "DbSessionMiddleware",
    "ThrottlingMiddleware", 
    "ErrorMiddleware",
    "AdminRateLimitMiddleware",
    "UpdatesFilterMiddleware" # <--- –î–æ–±–∞–≤–ª–µ–Ω–æ
]=== ./middlewares/db_session.py ===
# middlewares/db_session.py
from typing import Callable, Awaitable, Dict, Any
from aiogram import BaseMiddleware
from aiogram.types import TelegramObject
from database import async_session_maker
from core.exceptions import error_handler


class DbSessionMiddleware(BaseMiddleware):
    async def __call__(
        self,
        handler: Callable[[TelegramObject, Dict[str, Any]], Awaitable[Any]],
        event: TelegramObject,
        data: Dict[str, Any]
    ) -> Any:
        async with async_session_maker() as session:
            async with session.begin():  # –ù–∞—á–∏–Ω–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                try:
                    data["session"] = session
                    result = await handler(event, data)
                    # commit –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –±–ª–æ–∫–∞ if no exception
                    return result
                except Exception as e:
                    # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
                    await session.rollback()
                    # –ü–æ–ª—É—á–∞–µ–º user_id –∏–∑ —Å–æ–±—ã—Ç–∏—è
                    user_id = None
                    if hasattr(event, 'from_user') and event.from_user:
                        user_id = event.from_user.id
                    elif hasattr(event, 'user') and event.user:
                        user_id = event.user.id
                    
                    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫—É —á–µ—Ä–µ–∑ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                    await error_handler.handle_error(e, user_id, "db_session_middleware")
                    raise e
=== ./middlewares/updates_filter.py ===
import logging
from datetime import datetime, timedelta, timezone
from typing import Callable, Awaitable, Dict, Any
from aiogram import BaseMiddleware
from aiogram.types import Message, TelegramObject

logger = logging.getLogger(__name__)

class UpdatesFilterMiddleware(BaseMiddleware):
    """
    –§–∏–ª—å—Ç—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏—à–ª–∏, –ø–æ–∫–∞ –±–æ—Ç –ª–µ–∂–∞–ª.
    –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Ç–æ–ª—å–∫–æ:
    1. "–°–≤–µ–∂–∏–µ" —Å–æ–æ–±—â–µ–Ω–∏—è (–º–æ–ª–æ–∂–µ TTL).
    2. –ü–ª–∞—Ç–µ–∂–∏ (successful_payment) - –æ–Ω–∏ –≤–∞–∂–Ω—ã –≤—Å–µ–≥–¥–∞.
    """
    
    def __init__(self, ttl_seconds: int = 60):
        self.ttl = ttl_seconds

    async def __call__(
        self,
        handler: Callable[[TelegramObject, Dict[str, Any]], Awaitable[Any]],
        event: TelegramObject,
        data: Dict[str, Any]
    ) -> Any:
        
        # –ú—ã —Ñ–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ Message, —Ç–∞–∫ –∫–∞–∫ CallbackQuery (–∫–Ω–æ–ø–∫–∏) –æ–±—ã—á–Ω–æ 
        # –Ω–µ –∏–º–µ—é—Ç –ø–æ–ª—è date –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º —É—Ä–æ–≤–Ω–µ –∏ –∏—Ö –ª—É—á—à–µ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å (–∏–ª–∏ –æ–Ω–∏ —Å–∞–º–∏ –ø—Ä–æ—Ç—É—Ö–Ω—É—Ç —É Telegram)
        if not isinstance(event, Message):
            return await handler(event, data)

        # –í—Å–µ–≥–¥–∞ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–ª–∞—Ç–µ–∂–∏, –¥–∞–∂–µ –µ—Å–ª–∏ –±–æ—Ç –ª–µ–∂–∞–ª —á–∞—Å
        if event.successful_payment or (hasattr(event, 'invoice_payload') and event.invoice_payload):
            return await handler(event, data)

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
        # Telegram –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –¥–∞—Ç—É –≤ UTC (aware –∏–ª–∏ naive –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–µ—Ä—Å–∏–∏, –ø—Ä–∏–≤–æ–¥–∏–º –∫ aware UTC)
        msg_date = event.date
        if msg_date.tzinfo is None:
            msg_date = msg_date.replace(tzinfo=timezone.utc)
            
        now = datetime.now(timezone.utc)
        delta = (now - msg_date).total_seconds()

        # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—Ç–∞—Ä–µ–µ TTL (–Ω–∞–ø—Ä–∏–º–µ—Ä, 60 —Å–µ–∫)
        if delta > self.ttl:
            logger.warning(f"‚è© Skipped old update from user {event.from_user.id} (delay: {int(delta)}s)")
            return  # –ü—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º, –Ω–µ –≤—ã–∑—ã–≤–∞—è handler -> —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
            
        return await handler(event, data)=== ./main.py ===

import asyncio
import logging
import signal
from aiogram import Bot, Dispatcher, BaseMiddleware
from aiogram.client.default import DefaultBotProperties
from aiogram.fsm.storage.redis import RedisStorage
from aiogram.types import Message, CallbackQuery
from redis.asyncio import Redis

from config import config
from database import engine, Base
from core.tools.scheduler import start_scheduler, scheduler, shutdown_scheduler
from core.tools.broadcast_scheduler import start_broadcast_scheduler, broadcast_scheduler, shutdown_broadcast_scheduler
from core.logic.game_actions import smart_update_giveaway_task, process_expired_giveaways
from services.admin_broadcast_service import recover_stuck_broadcasts

from middlewares.db_session import DbSessionMiddleware
from middlewares.throttling import ThrottlingMiddleware
from middlewares.error_handler import ErrorMiddleware
# --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò–º–ø–æ—Ä—Ç —Ñ–∏–ª—å—Ç—Ä–∞ ---
from middlewares.updates_filter import UpdatesFilterMiddleware

# –ò–º–ø–æ—Ä—Ç—ã –†–æ—É—Ç–µ—Ä–æ–≤
from handlers.common import start
from handlers.participant import join
from handlers.user import dashboard, my_channels, my_participations, my_giveaways, premium
from handlers.creator import constructor
from handlers.creator import time_picker
from handlers.admin import admin_router

logger = logging.getLogger("aiogram.event")

class UserIdMiddleware(BaseMiddleware):
    async def __call__(self, handler, event: (Message | CallbackQuery), data):
        user_id = getattr(event.from_user, 'id', 'unknown')
        logger.info("Update from user_id=%s (bot_id=%s)", user_id, data['bot'].id)
        return await handler(event, data)

# –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
stop_event = asyncio.Event()

async def graceful_shutdown(signum=None, frame=None):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã"""
    if signum:
        logger.info(f"Received signal {signum}, initiating graceful shutdown...")
    
    stop_event.set()
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∏
    try:
        await shutdown_scheduler()
        logger.info("Scheduler shutdown completed")
    except Exception as e:
        logger.error(f"Error shutting down scheduler: {e}")
    
    try:
        await shutdown_broadcast_scheduler()
        logger.info("Broadcast scheduler shutdown completed")
    except Exception as e:
        logger.error(f"Error shutting down broadcast scheduler: {e}")

async def main():
    logging.basicConfig(level=logging.INFO)
    
    # –û—Ç–∫–ª—é—á–∞–µ–º —Å–ø–∞–º –≤ –ª–æ–≥–∞—Ö –æ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏)
    logging.getLogger("apscheduler.executors.default").setLevel(logging.WARNING)
    logging.getLogger("apscheduler.scheduler").setLevel(logging.WARNING)
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)

    redis = Redis.from_url(config.REDIS_URL)
    bot = Bot(token=config.BOT_TOKEN.get_secret_value(), default=DefaultBotProperties(parse_mode="HTML"))
    dp = Dispatcher(storage=RedisStorage(redis=redis))
    
    # --- Middleware ---
    # 1. –°–Ω–∞—á–∞–ª–∞ —Ñ–∏–ª—å—Ç—Ä—É–µ–º —Å—Ç–∞—Ä—ã–µ –∞–ø–¥–µ–π—Ç—ã (outer_middleware —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –î–û –≤—Å–µ–≥–æ)
    dp.message.outer_middleware(UpdatesFilterMiddleware(ttl_seconds=60))
    
    # 2. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
    dp.update.middleware(ErrorMiddleware())
    
    # 3. –°–µ—Å—Å–∏—è –ë–î
    dp.update.middleware(DbSessionMiddleware())
    
    # 4. –ê–Ω—Ç–∏-—Å–ø–∞–º
    dp.message.middleware(ThrottlingMiddleware(redis, rate_limit=1.0))
    dp.callback_query.middleware(ThrottlingMiddleware(redis, rate_limit=1.0))

    # --- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –†–æ—É—Ç–µ—Ä–æ–≤ ---
    dp.include_router(admin_router)
    
    from handlers.user import router as user_router
    dp.include_router(user_router)
    
    from handlers.creator import router as creator_router
    dp.include_router(creator_router)
    
    dp.include_router(join.router)
    dp.include_router(start.router)

    # --- SAFETY NET ---
    await process_expired_giveaways()
    await recover_stuck_broadcasts(bot)

    # –ó–∞–ø—É—Å–∫ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–≤
    # –ó–∞–ø—É—Å–∫–∞–µ–º "–ö–∞—Ä—É—Å–µ–ª—å": –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º 1 —Ä–æ–∑—ã–≥—Ä—ã—à
    # –≠—Ç–æ 360 –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ —á–∞—Å ‚Äî –∞–±—Å–æ–ª—é—Ç–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è Telegram API
    scheduler.add_job(
        smart_update_giveaway_task,
        "interval",
        seconds=10,  # <-- –ß–∞—Å—Ç–æ—Ç–∞ "—Ç–∏–∫–æ–≤" –∫–∞—Ä—É—Å–µ–ª–∏
        id="smart_updater",
        replace_existing=True,
        max_instances=1 # –ó–∞—â–∏—Ç–∞: –Ω–µ –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–æ–≤—ã–π, –µ—Å–ª–∏ —Å—Ç–∞—Ä—ã–π –∑–∞–≤–∏—Å
    )
    await start_scheduler()
    await start_broadcast_scheduler()

    dp.message.middleware(UserIdMiddleware())
    dp.callback_query.middleware(UserIdMiddleware())

    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    signal.signal(signal.SIGTERM, lambda s, f: asyncio.create_task(graceful_shutdown(s, f)))
    signal.signal(signal.SIGINT, lambda s, f: asyncio.create_task(graceful_shutdown(s, f)))

    try:
        # --- –í–ê–ñ–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: drop_pending_updates=False ---
        # –ú—ã —Ç–µ–ø–µ—Ä—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—á–µ—Ä–µ–¥—å, –Ω–æ Middleware –æ—Ç—Å–µ–µ—Ç —Å—Ç–∞—Ä—ã–π –º—É—Å–æ—Ä,
        # –æ—Å—Ç–∞–≤–∏–≤ —Ç–æ–ª—å–∫–æ –ø–ª–∞—Ç–µ–∂–∏ –∏ —Å–æ–≤—Å–µ–º –Ω–µ–¥–∞–≤–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è.
        await bot.delete_webhook(drop_pending_updates=False)
        
        # –ó–∞–ø—É—Å–∫ —Å –æ–∂–∏–¥–∞–Ω–∏–µ–º —Å–∏–≥–Ω–∞–ª–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
        await dp.start_polling(bot, allowed_updates=dp.resolve_used_update_types(), stop_event=stop_event)
    finally:
        logger.info("Shutting down bot...")
        await bot.session.close()
        await redis.aclose()
        logger.info("Bot shutdown completed")

if __name__ == "__main__":
    asyncio.run(main())=== ./filters/is_chat_member.py ===
# filters/is_chat_member.py
from aiogram.filters import BaseFilter
from aiogram.types import Message
from aiogram import Bot

class IsBotAdminInChat(BaseFilter):
    async def __call__(self, message: Message, bot: Bot) -> bool:
        if not message.forward_from_chat:
            return False
        
        chat_id = message.forward_from_chat.id
        try:
            member = await bot.get_chat_member(chat_id, bot.id)
            return member.status in ("administrator", "creator")
        except Exception:
            return False=== ./filters/__init__.py ===
from .is_chat_member import IsBotAdminInChat
from .admin_filter import IsAdmin

__all__ = ["IsBotAdminInChat", "IsAdmin"]=== ./filters/admin_filter.py ===
from aiogram import Router
from aiogram.types import Message, CallbackQuery
from aiogram.filters import Filter
from config import config
import logging

logger = logging.getLogger('admin')


class IsAdmin(Filter):
    def __init__(self):
        super().__init__()
    
    async def __call__(self, obj: Message | CallbackQuery, **kwargs) -> bool:
        user_id = obj.from_user.id if hasattr(obj, 'from_user') else obj.message.from_user.id
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π config –æ–±—ä–µ–∫—Ç
        is_admin = user_id in config.ADMIN_IDS
        if is_admin:
            logger.info(f"Admin {user_id} accessed admin panel")
        else:
            logger.warning(f"Unauthorized access attempt to admin panel by user {user_id}")
        
        return is_admin=== ./README.md ===
# Telegram –±–æ—Ç –¥–ª—è —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π

## –û–ø–∏—Å–∞–Ω–∏–µ
Telegram –±–æ—Ç –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–æ–≤, —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π.

## –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- –°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞–º–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª—ã
- –°–∏—Å—Ç–µ–º–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
- –†–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
- aiogram 3.x
- SQLAlchemy 2.x
- PostgreSQL
- Redis
- APScheduler

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º
- **aiogram** ‚Üí [docs.aiogram.dev/en/latest/](https://docs.aiogram.dev/en/latest/)
- **SQLAlchemy** ‚Üí [docs.sqlalchemy.org/en/20/](https://docs.sqlalchemy.org/en/20/)
- **asyncpg** ‚Üí [magicstack.github.io/asyncpg/current/](https://magicstack.github.io/asyncpg/current/)
- **redis** (redis-py) ‚Üí [redis-py.readthedocs.io/en/stable/](https://redis-py.readthedocs.io/en/stable/)
- **APScheduler** ‚Üí [apscheduler.readthedocs.io/en/3.x/](https://apscheduler.readthedocs.io/en/3.x/)

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
- **pydantic-settings** ‚Üí [docs.pydantic.dev/latest/concepts/pydantic_settings/](https://docs.pydantic.dev/latest/concepts/pydantic_settings/)
- **python-dotenv** ‚Üí [github.com/theskumar/python-dotenv](https://github.com/theskumar/python-dotenv)
- **loguru** ‚Üí [loguru.readthedocs.io/en/stable/](https://loguru.readthedocs.io/en/stable/)
- **Pillow** ‚Üí [pillow.readthedocs.io/en/stable/](https://pillow.readthedocs.io/en/stable/)
- **cryptography** ‚Üí [cryptography.io/en/latest/](https://cryptography.io/en/latest/)
- **limits** (Flask-Limiter) ‚Üí [flask-limiter.readthedocs.io/en/stable/](https://flask-limiter.readthedocs.io/en/stable/)
- **uvicorn** ‚Üí [www.uvicorn.org/](https://www.uvicorn.org/)=== ./database/models/channel.py ===
from sqlalchemy import BigInteger, String, ForeignKey
from sqlalchemy.orm import Mapped, mapped_column
from database.base import Base

class Channel(Base):
    __tablename__ = "channels"

    id: Mapped[int] = mapped_column(BigInteger, primary_key=True, autoincrement=True)
    user_id: Mapped[int] = mapped_column(ForeignKey("users.user_id")) # –í–ª–∞–¥–µ–ª–µ—Ü –∫–∞–Ω–∞–ª–∞
    
    channel_id: Mapped[int] = mapped_column(BigInteger) # ID –∫–∞–Ω–∞–ª–∞ –≤ Telegram
    title: Mapped[str] = mapped_column(String)
    username: Mapped[str | None] = mapped_column(String, nullable=True)
    type: Mapped[str] = mapped_column(String, default="channel") # channel / supergroup / group
    
    # –ù–û–í–û–ï –ü–û–õ–ï: –°—Å—ã–ª–∫–∞-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ (–¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤)
    invite_link: Mapped[str | None] = mapped_column(String, nullable=True)=== ./database/models/winner.py ===
from datetime import datetime
from sqlalchemy import BigInteger, ForeignKey, DateTime
from sqlalchemy.orm import Mapped, mapped_column
from database.base import Base

class Winner(Base):
    __tablename__ = "winners"

    giveaway_id: Mapped[int] = mapped_column(ForeignKey("giveaways.id", ondelete="CASCADE"), primary_key=True)
    user_id: Mapped[int] = mapped_column(ForeignKey("users.user_id", ondelete="CASCADE"), primary_key=True)
    created_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=datetime.utcnow)=== ./database/models/pending_referral.py ===
from sqlalchemy import BigInteger, ForeignKey, Integer
from sqlalchemy.orm import Mapped, mapped_column
from database.base import Base

class PendingReferral(Base):
    """
    –í—Ä–µ–º–µ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–≤—è–∑–∏.
    –ù—É–∂–Ω–∞, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å —Ä–µ—Ñ–µ—Ä–µ—Ä–∞, –µ—Å–ª–∏ –±–æ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—Å—è 
    –≤ –º–æ–º–µ–Ω—Ç, –ø–æ–∫–∞ —é–∑–µ—Ä –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –∫–∞–Ω–∞–ª—ã.
    """
    __tablename__ = "pending_referrals"

    user_id: Mapped[int] = mapped_column(BigInteger, primary_key=True) # –¢–æ—Ç, –∫–æ–≥–æ –ø—Ä–∏–≥–ª–∞—Å–∏–ª–∏
    giveaway_id: Mapped[int] = mapped_column(ForeignKey("giveaways.id", ondelete="CASCADE"), primary_key=True)
    referrer_id: Mapped[int] = mapped_column(BigInteger) # –¢–æ—Ç, –∫—Ç–æ –ø—Ä–∏–≥–ª–∞—Å–∏–ª=== ./database/models/admin_models.py ===
from sqlalchemy import Integer, String, DateTime, Boolean, func, JSON, Text, BigInteger
from sqlalchemy.orm import Mapped, mapped_column
from database.base import Base
from datetime import datetime


class AdminLog(Base):
    __tablename__ = "admin_logs"
    
    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    admin_id: Mapped[int] = mapped_column(BigInteger)
    action: Mapped[str] = mapped_column(String)
    target_id: Mapped[int | None] = mapped_column(BigInteger)
    details: Mapped[dict | None] = mapped_column(JSON)
    timestamp: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=func.now())


class Broadcast(Base):
    __tablename__ = "broadcasts"
    
    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    message_text: Mapped[str] = mapped_column(Text)
    photo_file_id: Mapped[str | None] = mapped_column(String, nullable=True)
    video_file_id: Mapped[str | None] = mapped_column(String, nullable=True)
    document_file_id: Mapped[str | None] = mapped_column(String, nullable=True)
    scheduled_time: Mapped[datetime | None] = mapped_column(DateTime(timezone=True), nullable=True)
    status: Mapped[str] = mapped_column(String, default="pending")
    sent_count: Mapped[int] = mapped_column(Integer, default=0)
    total_count: Mapped[int] = mapped_column(Integer, default=0)
    failed_count: Mapped[int] = mapped_column(Integer, default=0)
    blocked_count: Mapped[int] = mapped_column(Integer, default=0)
    created_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=func.now())
    completed_at: Mapped[datetime | None] = mapped_column(DateTime(timezone=True), nullable=True)
    created_by: Mapped[int] = mapped_column(Integer)


class ScheduledBroadcast(Base):
    __tablename__ = "scheduled_broadcasts"
    
    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    message_text: Mapped[str] = mapped_column(Text)
    photo_file_id: Mapped[str | None] = mapped_column(String, nullable=True)
    video_file_id: Mapped[str | None] = mapped_column(String, nullable=True)
    document_file_id: Mapped[str | None] = mapped_column(String, nullable=True)
    scheduled_time: Mapped[datetime] = mapped_column(DateTime(timezone=True))
    status: Mapped[str] = mapped_column(String, default="pending")
    created_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=func.now())
    created_by: Mapped[int] = mapped_column(Integer)=== ./database/models/user.py ===
from datetime import datetime
from sqlalchemy import BigInteger, String, Boolean, DateTime, func, Index
from sqlalchemy.orm import Mapped, mapped_column, relationship
from database.base import Base

class User(Base):
    __tablename__ = "users"

    user_id: Mapped[int] = mapped_column(BigInteger, primary_key=True, autoincrement=False)
    username: Mapped[str | None] = mapped_column(String, nullable=True)
    full_name: Mapped[str] = mapped_column(String)
    
    # --- Monetization ---
    is_premium: Mapped[bool] = mapped_column(Boolean, default=False)
    premium_until: Mapped[datetime | None] = mapped_column(DateTime(timezone=True), nullable=True)
    
    # --- Timestamps ---
    created_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=func.now())
    
    # –°–≤—è–∑—å —Å —Ä–æ–∑—ã–≥—Ä—ã—à–∞–º–∏ (–≤–ª–∞–¥–µ–ª–µ—Ü)
    giveaways: Mapped[list["Giveaway"]] = relationship("Giveaway", back_populates="owner", lazy="selectin")

    def __repr__(self):
        return f"<User {self.user_id}>"

# –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
Index('idx_users_username', User.username)
Index('idx_users_premium', User.is_premium)
Index('idx_users_created_at', User.created_at.desc())=== ./database/models/giveaway.py ===
from datetime import datetime
from sqlalchemy import BigInteger, String, DateTime, Integer, Text, ForeignKey, Boolean, Index
from sqlalchemy.orm import Mapped, mapped_column, relationship
from database.base import Base

class Giveaway(Base):
    __tablename__ = "giveaways"

    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)
    owner_id: Mapped[int] = mapped_column(ForeignKey("users.user_id"))
    channel_id: Mapped[int] = mapped_column(BigInteger)
    message_id: Mapped[int] = mapped_column(BigInteger)
    
    short_description: Mapped[str] = mapped_column(String(255), nullable=True) # –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
    prize_text: Mapped[str] = mapped_column(Text)
    winners_count: Mapped[int] = mapped_column(Integer, default=1)
    finish_time: Mapped[datetime] = mapped_column(DateTime(timezone=True))
    
    status: Mapped[str] = mapped_column(String, default="active")
    
    # –í–æ–∑–º–æ–∂–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:
    # 'active' - –∞–∫—Ç–∏–≤–Ω—ã–π —Ä–æ–∑—ã–≥—Ä—ã—à
    # 'finished' - –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π —Ä–æ–∑—ã–≥—Ä—ã—à
    # 'cancelled' - –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å—Ç —É–¥–∞–ª–µ–Ω)
    # 'paused_error' - –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –±–æ—Ç –∫–∏–∫–Ω—É—Ç)
    predetermined_winner_id: Mapped[int | None] = mapped_column(BigInteger, nullable=True)

    media_file_id: Mapped[str | None] = mapped_column(String, nullable=True)
    media_type: Mapped[str | None] = mapped_column(String, nullable=True)
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    is_referral_enabled: Mapped[bool] = mapped_column(Boolean, default=False)
    is_captcha_enabled: Mapped[bool] = mapped_column(Boolean, default=False)
    is_paid: Mapped[bool] = mapped_column(Boolean, default=False)
    is_participants_hidden: Mapped[bool] = mapped_column(Boolean, default=False)
    
    # –ù–û–í–´–ï –ü–û–õ–Ø –î–õ–Ø –£–ú–ù–û–ì–û –û–ë–ù–û–í–õ–ï–ù–ò–Ø
    last_update_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=datetime.utcnow)  # –ö–æ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–ª–∏ –ø–æ—Å—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑
    last_count: Mapped[int] = mapped_column(Integer, default=0)  # –°–∫–æ–ª—å–∫–æ –±—ã–ª–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø—Ä–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏


    # –°–≤—è–∑–∏ —Å –¥—Ä—É–≥–∏–º–∏ –º–æ–¥–µ–ª—è–º–∏
    owner: Mapped["User"] = relationship("User", back_populates="giveaways", lazy="selectin")
    required_channels: Mapped[list["GiveawayRequiredChannel"]] = relationship("GiveawayRequiredChannel", back_populates="giveaway", lazy="selectin", cascade="all, delete-orphan")
    participants: Mapped[list["Participant"]] = relationship("Participant", back_populates="giveaway", lazy="selectin", cascade="all, delete-orphan")

# –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
Index('idx_giveaways_status', Giveaway.status)
Index('idx_giveaways_owner_id', Giveaway.owner_id)
Index('idx_giveaways_created_at', Giveaway.finish_time.desc())

# –ò–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π —Å –æ—à–∏–±–∫–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞
Index('idx_giveaways_status_paused_error', Giveaway.status == 'paused_error')
=== ./database/models/participant.py ===
# database/models/participant.py
from datetime import datetime
from sqlalchemy import BigInteger, ForeignKey, DateTime, Integer, String, UniqueConstraint
from sqlalchemy.orm import Mapped, mapped_column, relationship
from database.base import Base

class Participant(Base):
    __tablename__ = "participants"

    user_id: Mapped[int] = mapped_column(ForeignKey("users.user_id"), primary_key=True)
    giveaway_id: Mapped[int] = mapped_column(ForeignKey("giveaways.id", ondelete="CASCADE"), primary_key=True)
    
    # –î–æ–±–∞–≤–ª—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
    __table_args__ = (
        # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ –æ–¥–Ω–æ–º —Ä–æ–∑—ã–≥—Ä—ã—à–µ
        UniqueConstraint('user_id', 'giveaway_id', name='unique_user_giveaway'),
    )
    created_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=datetime.utcnow)

    # –ö–æ–ª-–≤–æ —à–∞–Ω—Å–æ–≤ (–±–∏–ª–µ—Ç–æ–≤)
    tickets_count: Mapped[int] = mapped_column(Integer, default=1) 
    
    # ID —Ç–æ–≥–æ, –∫—Ç–æ –ø—Ä–∏–≥–ª–∞—Å–∏–ª (—Ö—Ä–∞–Ω–∏–º —Ä–µ–∞–ª—å–Ω—ã–π ID, –∞ –Ω–µ —Ö–µ—à)
    referrer_id: Mapped[int | None] = mapped_column(BigInteger, nullable=True) 
    # –¢–µ–∫—Å—Ç–æ–≤—ã–π –∫–æ–¥ –±–∏–ª–µ—Ç–∞
    ticket_code: Mapped[str | None] = mapped_column(String(10), nullable=True)
    
    # –°–≤—è–∑–∏ —Å –¥—Ä—É–≥–∏–º–∏ –º–æ–¥–µ–ª—è–º–∏
    user: Mapped["User"] = relationship("User", lazy="selectin")
    giveaway: Mapped["Giveaway"] = relationship("Giveaway", back_populates="participants", lazy="selectin")
=== ./database/models/required_channel.py ===
from sqlalchemy import BigInteger, String, ForeignKey, Integer
from sqlalchemy.orm import Mapped, mapped_column, relationship
from database.base import Base

class GiveawayRequiredChannel(Base):
    __tablename__ = "giveaway_required_channels"

    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)
    giveaway_id: Mapped[int] = mapped_column(ForeignKey("giveaways.id", ondelete="CASCADE"))
    channel_id: Mapped[int] = mapped_column(BigInteger) # ID –∫–∞–Ω–∞–ª–∞ —Å–ø–æ–Ω—Å–æ—Ä–∞
    channel_title: Mapped[str] = mapped_column(String)  # –ù–∞–∑–≤–∞–Ω–∏–µ (–¥–ª—è —Å–ø–∏—Å–∫–∞)
    channel_link: Mapped[str] = mapped_column(String)   # –°—Å—ã–ª–∫–∞ (username –∏–ª–∏ invite link)
    
    # –°–≤—è–∑—å —Å —Ä–æ–∑—ã–≥—Ä—ã—à–µ–º
    giveaway: Mapped["Giveaway"] = relationship("Giveaway", back_populates="required_channels", lazy="selectin")
=== ./database/models/__init__.py ===
from .user import User
from .giveaway import Giveaway
from .participant import Participant
from .winner import Winner
from .channel import Channel
from .required_channel import GiveawayRequiredChannel
from .pending_referral import PendingReferral
from .admin_models import AdminLog, Broadcast, ScheduledBroadcast

__all__ = [
    "User",
    "Giveaway",
    "Participant",
    "Winner",
    "Channel",
    "GiveawayRequiredChannel",
    "PendingReferral",
    "AdminLog",
    "Broadcast",
    "ScheduledBroadcast"
]=== ./database/requests/user_repo.py ===
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from sqlalchemy.dialects.postgresql import insert
from database.models.user import User
from database.models.giveaway import Giveaway

async def register_user(session: AsyncSession, user_id: int, username: str, full_name: str):
    stmt = insert(User).values(
        user_id=user_id, username=username, full_name=full_name
    ).on_conflict_do_update(
        index_elements=['user_id'],
        set_=dict(username=username, full_name=full_name)
    )
    await session.execute(stmt)
    # commit –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –≤ middleware

async def get_user_stats(session: AsyncSession, user_id: int) -> dict:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–æ–∑–¥–∞—Ç–µ–ª—è"""
    # –û–±—ä–µ–¥–∏–Ω—è–µ–º –æ–±–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ –æ–¥–∏–Ω —Å –ø–æ–º–æ—â—å—é case
    from sqlalchemy import case
    stmt = select(
        func.sum(case((Giveaway.status == "active", 1), else_=0)).label('active'),
        func.sum(case((Giveaway.status == "finished", 1), else_=0)).label('finished')
    ).where(Giveaway.owner_id == user_id)
    
    result = await session.execute(stmt)
    row = result.fetchone()
    
    return {"active": row.active or 0, "finished": row.finished or 0}
=== ./database/requests/giveaway_repo.py ===
from datetime import datetime
from zoneinfo import ZoneInfo
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, update, desc, func
from database.models.giveaway import Giveaway
from database.models.required_channel import GiveawayRequiredChannel

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º UTC –∫–∞–∫ –≤—Ä–µ–º–µ–Ω–Ω—É—é –∑–æ–Ω—É
UTC = ZoneInfo("UTC")

async def create_giveaway(
    session: AsyncSession, owner_id: int, channel_id: int,
    message_id: int, prize: str, winners: int, end_time: datetime,
    media_file_id: str = None, media_type: str = None,
    sponsors: list = None,
    is_referral: bool = False,
    is_captcha: bool = False,
    short_description: str = None
) -> int:
    new_gw = Giveaway(
        owner_id=owner_id, channel_id=channel_id, message_id=message_id,
        prize_text=prize, winners_count=winners, finish_time=end_time,
        media_file_id=media_file_id, media_type=media_type,
        is_referral_enabled=is_referral,
        is_captcha_enabled=is_captcha,
        short_description=short_description
    )
    session.add(new_gw)
    await session.flush()

    if sponsors:
        for sp in sponsors:
            req_ch = GiveawayRequiredChannel(
                giveaway_id=new_gw.id,
                channel_id=sp['id'],
                channel_title=sp['title'],
                channel_link=sp['link']
            )
            session.add(req_ch)

    # commit –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –≤ middleware
    return new_gw.id

async def get_giveaway_by_id(session: AsyncSession, gw_id: int) -> Giveaway | None:
    from sqlalchemy import select
    from sqlalchemy.orm import selectinload
    stmt = select(Giveaway).where(Giveaway.id == gw_id).options(selectinload(Giveaway.required_channels))
    result = await session.execute(stmt)
    return result.scalar_one_or_none()

async def get_active_giveaways(session: AsyncSession):
    from sqlalchemy.orm import selectinload
    stmt = select(Giveaway).where(Giveaway.status == "active").options(selectinload(Giveaway.required_channels))
    result = await session.execute(stmt)
    return result.scalars().all()

# --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø ---
async def get_expired_active_giveaways(session: AsyncSession):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∏, –≤—Ä–µ–º—è –∫–æ—Ç–æ—Ä—ã—Ö –∏—Å—Ç–µ–∫–ª–æ"""
    stmt = select(Giveaway).where(
        Giveaway.status == "active",
        Giveaway.finish_time <= datetime.now(UTC)
    )
    result = await session.execute(stmt)
    return result.scalars().all()
# ---------------------

async def get_required_channels(session: AsyncSession, gw_id: int):
    stmt = select(GiveawayRequiredChannel).where(GiveawayRequiredChannel.giveaway_id == gw_id)
    result = await session.execute(stmt)
    return result.scalars().all()

async def get_giveaways_by_owner(session: AsyncSession, owner_id: int, limit: int = 50, offset: int = 0):
    """–ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π —Å–æ–∑–¥–∞—Ç–µ–ª—è —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π"""
    from sqlalchemy.orm import selectinload
    stmt = select(Giveaway).where(Giveaway.owner_id == owner_id)\
        .options(selectinload(Giveaway.required_channels))\
        .order_by(desc(Giveaway.id))\
        .limit(limit)\
        .offset(offset)
    result = await session.execute(stmt)
    return result.scalars().all()

async def set_predetermined_winner(session: AsyncSession, gw_id: int, winner_id: int):
    stmt = update(Giveaway).where(Giveaway.id == gw_id).values(predetermined_winner_id=winner_id)
    await session.execute(stmt)
    # commit –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –≤ middleware

async def count_giveaways_by_owner(session: AsyncSession, owner_id: int) -> int:
    stmt = select(func.count(Giveaway.id)).where(Giveaway.owner_id == owner_id)
    return await session.scalar(stmt)

async def count_giveaways_by_status(session: AsyncSession, owner_id: int, status: str) -> int:
    """–°—á–∏—Ç–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ —É –≤–ª–∞–¥–µ–ª—å—Ü–∞"""
    stmt = select(func.count(Giveaway.id)).where(
        Giveaway.owner_id == owner_id,
        Giveaway.status == status
    )
    return await session.scalar(stmt)

async def get_giveaways_by_status(session: AsyncSession, status: str):
    """–ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º —Å—Ç–∞—Ç—É—Å–æ–º"""
    from sqlalchemy.orm import selectinload
    stmt = select(Giveaway).where(Giveaway.status == status).options(selectinload(Giveaway.required_channels))
    result = await session.execute(stmt)
    return result.scalars().all()=== ./database/requests/channel_repo.py ===
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, delete
from sqlalchemy.dialects.postgresql import insert
from database.models.channel import Channel

async def add_channel(
    session: AsyncSession,
    user_id: int,
    channel_id: int,
    title: str,
    username: str | None,
    invite_link: str | None,
    chat_type: str = "channel"
):
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫–∞–Ω–∞–ª —Å –∏–Ω–≤–∞–π—Ç-—Å—Å—ã–ª–∫–æ–π.
    """
    stmt = insert(Channel).values(
        user_id=user_id,
        channel_id=channel_id,
        title=title,
        username=username,
        invite_link=invite_link,
        type=chat_type
    ).on_conflict_do_update(
        index_elements=['id'],
        set_=dict(title=title, username=username, invite_link=invite_link, type=chat_type)
    )
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ on_conflict –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ë–î)
    existing = await session.scalar(select(Channel).where(Channel.channel_id == channel_id))
    if existing:
        existing.title = title
        existing.username = username
        existing.invite_link = invite_link
        existing.type = chat_type
    else:
        session.add(Channel(
            user_id=user_id,
            channel_id=channel_id,
            title=title,
            username=username,
            invite_link=invite_link,
            type=chat_type
        ))
    
    # commit –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –≤ middleware

async def get_user_channels(session: AsyncSession, user_id: int):
    stmt = select(Channel).where(Channel.user_id == user_id)
    result = await session.execute(stmt)
    return result.scalars().all()

async def delete_channel_by_id(session: AsyncSession, db_id: int, user_id: int):
    stmt = delete(Channel).where(Channel.id == db_id, Channel.user_id == user_id)
    await session.execute(stmt)
    # commit –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –≤ middleware
=== ./database/requests/participant_repo.py ===
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func, desc, delete
from sqlalchemy.dialects.postgresql import insert
from database.models.participant import Participant
from database.models.giveaway import Giveaway
from database.models.winner import Winner
from database.models.pending_referral import PendingReferral

# --- –†–∞–±–æ—Ç–∞ —Å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ ---

async def add_participant(session: AsyncSession, user_id: int, giveaway_id: int, referrer_id: int = None, ticket_code: str = None) -> bool:
    stmt = insert(Participant).values(
        user_id=user_id,
        giveaway_id=giveaway_id,
        referrer_id=referrer_id,
        ticket_code=ticket_code,
        tickets_count=1
    ).on_conflict_do_nothing()
    
    result = await session.execute(stmt)
    # commit –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –≤ middleware
    return result.rowcount > 0

async def increment_ticket(session: AsyncSession, user_id: int, giveaway_id: int):
    from sqlalchemy import update
    # –≠—Ç–æ SQL-–∑–∞–ø—Ä–æ—Å, –æ–Ω –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –±–∞–∑—ã –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –∏ –∞—Ç–æ–º–∞—Ä–Ω–æ
    stmt = (
        update(Participant)
        .where(Participant.user_id == user_id, Participant.giveaway_id == giveaway_id)
        .values(tickets_count=Participant.tickets_count + 1)
    )
    await session.execute(stmt)
    # commit –±—É–¥–µ—Ç –≤ middleware

async def is_circular_referral(session: AsyncSession, new_user_id: int, referrer_id: int, giveaway_id: int) -> bool:
    stmt = select(Participant).where(
        Participant.user_id == referrer_id,
        Participant.giveaway_id == giveaway_id,
        Participant.referrer_id == new_user_id
    )
    result = await session.scalar(stmt)
    return result is not None

async def is_participant_active(session: AsyncSession, user_id: int, giveaway_id: int) -> bool:
    stmt = select(Participant).where(
        Participant.user_id == user_id,
        Participant.giveaway_id == giveaway_id
    )
    result = await session.scalar(stmt)
    return result is not None

# --- –†–∞–±–æ—Ç–∞ —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ —Ä–µ—Ñ–µ—Ä–∞–ª–∞–º–∏ (Pending) ---

async def add_pending_referral(session: AsyncSession, user_id: int, referrer_id: int, giveaway_id: int):
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å–≤—è–∑–∫—É –≤ –ë–î"""
    stmt = insert(PendingReferral).values(
        user_id=user_id,
        giveaway_id=giveaway_id,
        referrer_id=referrer_id
    ).on_conflict_do_update(
        index_elements=['user_id', 'giveaway_id'],
        set_=dict(referrer_id=referrer_id)
    )
    await session.execute(stmt)
    # commit –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –≤ middleware

async def get_pending_referral(session: AsyncSession, user_id: int, giveaway_id: int) -> int | None:
    """–ü–æ–ª—É—á–∞–µ—Ç –∏ –£–î–ê–õ–Ø–ï–¢ –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å–≤—è–∑–∫—É (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–µ —á—Ç–µ–Ω–∏–µ)"""
    stmt = select(PendingReferral.referrer_id).where(
        PendingReferral.user_id == user_id,
        PendingReferral.giveaway_id == giveaway_id
    )
    referrer_id = await session.scalar(stmt)
    
    if referrer_id:
        # –£–¥–∞–ª—è–µ–º, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∞ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞
        del_stmt = delete(PendingReferral).where(
            PendingReferral.user_id == user_id,
            PendingReferral.giveaway_id == giveaway_id
        )
        await session.execute(del_stmt)
        # commit –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –≤ middleware
        
    return referrer_id

# --- –°–ø–∏—Å–∫–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ---

async def get_participant_ids(session: AsyncSession, giveaway_id: int) -> list[int]:
    stmt = select(Participant.user_id).where(Participant.giveaway_id == giveaway_id)
    result = await session.execute(stmt)
    return list(result.scalars().all())

async def get_participants_count(session: AsyncSession, giveaway_id: int) -> int:
    stmt = select(func.count(Participant.user_id)).where(Participant.giveaway_id == giveaway_id)
    return await session.scalar(stmt)

async def get_weighted_candidates(session: AsyncSession, giveaway_id: int, limit: int = 100) -> list[int]:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ —Å —É—á–µ—Ç–æ–º –≤–µ—Å–∞ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –±–∏–ª–µ—Ç–æ–≤) –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π
    """
    random_weight = -func.ln(func.random()) / Participant.tickets_count
    stmt = select(Participant.user_id)\
        .where(Participant.giveaway_id == giveaway_id)\
        .order_by(random_weight)\
        .limit(limit)
    result = await session.execute(stmt)
    return list(result.scalars().all())


async def get_all_participant_ids(session: AsyncSession, giveaway_id: int) -> list[int]:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ ID —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Ä–æ–∑—ã–≥—Ä—ã—à–∞ (–¥–ª—è —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –∏–∑ –≤—Å–µ—Ö)
    """
    stmt = select(Participant.user_id).where(Participant.giveaway_id == giveaway_id)
    result = await session.execute(stmt)
    return list(result.scalars().all())

async def get_user_participations_detailed(session: AsyncSession, user_id: int, status: str = None, limit: int = 5, offset: int = 0):
    from sqlalchemy.orm import selectinload
    stmt = select(Giveaway).join(Participant).where(Participant.user_id == user_id)
    if status:
        stmt = stmt.where(Giveaway.status == status)
    stmt = stmt.options(selectinload(Giveaway.required_channels)).order_by(desc(Giveaway.finish_time)).limit(limit).offset(offset)
    result = await session.execute(stmt)
    return result.scalars().all()

async def count_user_participations(session: AsyncSession, user_id: int, status: str = None) -> int:
    stmt = select(func.count(Giveaway.id)).join(Participant).where(Participant.user_id == user_id)
    if status:
        stmt = stmt.where(Giveaway.status == status)
    return await session.scalar(stmt)

# --- –≠–∫—Å–ø–æ—Ä—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ---
async def get_participants_for_export(session: AsyncSession, giveaway_id: int):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–ª–∏ —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å –¥–∞–Ω–Ω—ã–º–∏ User"""
    from sqlalchemy import select
    from database.models.user import User
    
    stmt = (
        select(Participant.user_id, Participant.created_at, User.username, User.full_name)
        .join(User, Participant.user_id == User.user_id)
        .where(Participant.giveaway_id == giveaway_id)
    )
    result = await session.execute(stmt)
    return result.all()=== ./database/requests/__init__.py ===
=== ./database/__init__.py ===
# database/__init__.py
from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker, AsyncSession
from config import config
from .base import Base
# –ò–º–ø–æ—Ä—Ç –º–æ–¥–µ–ª–µ–π
from .models.user import User
from .models.giveaway import Giveaway
from .models.participant import Participant
from .models.channel import Channel
from .models.required_channel import GiveawayRequiredChannel
from .models.winner import Winner
from .models.pending_referral import PendingReferral # <--- –ù–û–í–û–ï

engine = create_async_engine(
    url=config.DB_DNS,
    echo=False,
    pool_pre_ping=True
)

async_session_maker = async_sessionmaker(
    engine, 
    class_=AsyncSession, 
    expire_on_commit=False
)=== ./database/base.py ===
from sqlalchemy.orm import DeclarativeBase

class Base(DeclarativeBase):
    pass=== ./handlers/admin/admin_router.py ===
from aiogram import Router
from aiogram.filters import Command
from aiogram.types import Message, CallbackQuery
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from config import config
from filters.admin_filter import IsAdmin
from keyboards.admin_keyboards import get_main_admin_menu_keyboard
from sqlalchemy.ext.asyncio import AsyncSession
from utils.rate_limiter import admin_rate_limiter
# from utils.exception_handler import admin_errors_handler # –£–¥–∞–ª—è–µ–º –∏–º–ø–æ—Ä—Ç, –µ—Å–ª–∏ –æ–Ω –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–æ–ª—å—à–µ –Ω–∏–≥–¥–µ

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–æ—É—Ç–µ—Ä–∞
admin_router = Router()
admin_router.message.filter(IsAdmin())
admin_router.callback_query.filter(IsAdmin())


@admin_router.message(Command("admin"))
async def admin_panel(message: Message):
    keyboard = get_main_admin_menu_keyboard()
    await message.answer("üîí –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", reply_markup=keyboard)


@admin_router.callback_query(lambda c: c.data == "admin_main_menu")
async def back_to_main_menu(callback: CallbackQuery):
    keyboard = get_main_admin_menu_keyboard()
    await callback.message.edit_text("üîí –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", reply_markup=keyboard)
    await callback.answer()


@admin_router.callback_query(lambda c: c.data == "admin_ignore")
async def ignore_callback(callback: CallbackQuery):
    # –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è callback'–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —Ç—Ä–µ–±—É—é—Ç –¥–µ–π—Å—Ç–≤–∏—è
    await callback.answer()


# –ü–æ–¥–∫–ª—é—á–∞–µ–º middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–π—Ç-–ª–∏–º–∏—Ç–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
from middlewares.admin_middleware import AdminRateLimitMiddleware
admin_router.callback_query.middleware(AdminRateLimitMiddleware())


# –£–î–ê–õ–ï–ù–û: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –¥–ª—è –≤—Å–µ–≥–æ —Ä–æ—É—Ç–µ—Ä–∞
# @admin_router.errors()
# async def errors_handler(update, error):
#     admin_errors_handler(update, error)=== ./handlers/admin/broadcast_handlers.py ===
from datetime import datetime
from aiogram import F, Bot
from aiogram.types import CallbackQuery, Message, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.filters import Command
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func, delete

from handlers.admin.admin_router import admin_router
from keyboards.admin_broadcast_keyboards import (
    get_broadcast_menu_keyboard,
    get_broadcast_preview_keyboard,
    get_broadcast_list_keyboard,
    get_broadcast_detail_keyboard,
    get_scheduled_detail_keyboard,
    get_cancel_broadcast_creation_keyboard,
    get_cancel_schedule_keyboard
)
from keyboards.admin_broadcast_time_keyboards import (
    get_broadcast_date_picker_keyboard,
    get_broadcast_time_picker_keyboard,
    get_manual_time_input_keyboard
)
from services.admin_broadcast_service import BroadcastService
from utils.admin_logger import log_admin_action
from database.models import Broadcast

# –ò–º–ø–æ—Ä—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
from core.tools.timezone import MSK, get_now_msk, to_utc, strip_tz
from core.tools.broadcast_scheduler import schedule_broadcast_task, broadcast_scheduler


class BroadcastState(StatesGroup):
    waiting_for_message = State()
    waiting_for_schedule_date = State()
    waiting_for_schedule_time = State()
    waiting_for_manual_schedule_time = State()
    waiting_for_recipient_filter = State()


# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" (–µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç)
def get_back_to_broadcast_menu_kb() -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="admin_broadcast"))
    return builder.as_markup()


@admin_router.callback_query(F.data == "admin_broadcast")
async def show_broadcast_menu(callback: CallbackQuery):
    keyboard = get_broadcast_menu_keyboard()
    await callback.message.edit_text("üì¢ –ú–µ–Ω—é —Ä–∞—Å—Å—ã–ª–∫–∏", reply_markup=keyboard)
    await callback.answer()


@admin_router.callback_query(F.data == "admin_create_broadcast")
async def start_create_broadcast(callback: CallbackQuery, state: FSMContext):
    await state.set_state(BroadcastState.waiting_for_message)
    keyboard = get_cancel_broadcast_creation_keyboard()
    await callback.message.edit_text(
        "‚úçÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏\n\n–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ –º–µ–¥–∏–∞:",
        reply_markup=keyboard
    )
    await callback.answer()


@admin_router.message(BroadcastState.waiting_for_message)
async def process_broadcast_message(message: Message, state: FSMContext):
    broadcast_data = {}
    
    if message.text:
        broadcast_data['text'] = message.text
    elif message.photo:
        broadcast_data['photo'] = message.photo[-1].file_id
        if message.caption:
            broadcast_data['text'] = message.caption
    elif message.video:
        broadcast_data['video'] = message.video.file_id
        if message.caption:
            broadcast_data['text'] = message.caption
    elif message.document:
        broadcast_data['document'] = message.document.file_id
        if message.caption:
            broadcast_data['text'] = message.caption
    else:
        await message.answer("‚ùå –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–∏–ø—ã: —Ç–µ–∫—Å—Ç, —Ñ–æ—Ç–æ, –≤–∏–¥–µ–æ, –¥–æ–∫—É–º–µ–Ω—Ç—ã")
        return
    
    await state.update_data(broadcast_data=broadcast_data)
    
    keyboard = get_broadcast_preview_keyboard()
    preview_text = "üìã –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä:\n\n"
    if 'text' in broadcast_data:
        preview_text += broadcast_data['text']
    else:
        preview_text += "[–ú–µ–¥–∏–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ]"
    
    await message.answer(preview_text, reply_markup=keyboard)


@admin_router.callback_query(F.data == "admin_send_broadcast_now")
async def send_broadcast_now(callback: CallbackQuery, state: FSMContext, session: AsyncSession, bot: Bot):
    data = await state.get_data()
    broadcast_data = data.get('broadcast_data', {})
    
    if not broadcast_data:
        await callback.answer("‚ùå –î–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏", show_alert=True)
        return

    service = BroadcastService(bot, session)
    broadcast = await service.create_broadcast(
        message_text=broadcast_data.get('text', ''),
        photo_file_id=broadcast_data.get('photo'),
        video_file_id=broadcast_data.get('video'),
        document_file_id=broadcast_data.get('document'),
        admin_id=callback.from_user.id
    )
    
    if not broadcast:
        await callback.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–∞—Å—Å—ã–ª–∫–∏ –≤ –ë–î", show_alert=True)
        return

    await service.send_broadcast(broadcast.id)
    
    # --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–µ–Ω—é –≤–º–µ—Å—Ç–æ —Ç—É–ø–∏–∫–∞ ---
    keyboard = get_broadcast_menu_keyboard()
    await callback.message.edit_text(
        f"‚úÖ <b>–†–∞—Å—Å—ã–ª–∫–∞ #{broadcast.id} —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!</b>\n\nüì¢ –ú–µ–Ω—é —Ä–∞—Å—Å—ã–ª–∫–∏",
        reply_markup=keyboard
    )
    
    await state.clear()
    
    await log_admin_action(session, callback.from_user.id, "broadcast_sent", broadcast.id, {"type": "immediate"})
    await callback.answer()


@admin_router.callback_query(F.data == "admin_schedule_broadcast")
async def start_schedule_broadcast(callback: CallbackQuery, state: FSMContext):
    await state.set_state(BroadcastState.waiting_for_schedule_date)
    await callback.message.edit_text(
        "‚è∞ –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –æ—Ç–ø—Ä–∞–≤–∫–∏:",
        reply_markup=get_broadcast_date_picker_keyboard()
    )
    await callback.answer()


@admin_router.callback_query(F.data.startswith("admin_broadcast_date_set:"))
async def select_broadcast_date(callback: CallbackQuery, state: FSMContext):
    await state.set_state(BroadcastState.waiting_for_schedule_time)
    _, year, month, day = callback.data.split(":")
    
    keyboard = get_broadcast_time_picker_keyboard(int(year), int(month), int(day))
    await callback.message.edit_text(
        f"‚è∞ –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–ª—è {day}.{month}.{year}:",
        reply_markup=keyboard
    )
    await callback.answer()


@admin_router.callback_query(F.data.startswith("admin_broadcast_cal_nav:"))
async def navigate_broadcast_calendar(callback: CallbackQuery):
    _, year, month = callback.data.split(":")
    keyboard = get_broadcast_date_picker_keyboard(int(year), int(month))
    await callback.message.edit_text("‚è∞ –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –æ—Ç–ø—Ä–∞–≤–∫–∏:", reply_markup=keyboard)
    await callback.answer()


@admin_router.callback_query(F.data.startswith("admin_broadcast_time_set:"))
async def select_broadcast_time(callback: CallbackQuery, state: FSMContext, session: AsyncSession, bot: Bot):
    _, year, month, day, hour, minute = callback.data.split(":")
    
    try:
        schedule_time = datetime(int(year), int(month), int(day), int(hour), int(minute), tzinfo=MSK)
        
        if schedule_time <= get_now_msk():
            await callback.answer("‚ùå –í—Ä–µ–º—è —É–∂–µ –ø—Ä–æ—à–ª–æ!", show_alert=True)
            return
        
        schedule_time_db = strip_tz(to_utc(schedule_time))
        
        data = await state.get_data()
        broadcast_data = data.get('broadcast_data', {})
        
        if not broadcast_data:
            await callback.answer("‚ùå –î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.", show_alert=True)
            await state.clear()
            return
        
        service = BroadcastService(bot, session)
        broadcast = await service.create_broadcast(
            message_text=broadcast_data.get('text', ''),
            photo_file_id=broadcast_data.get('photo'),
            video_file_id=broadcast_data.get('video'),
            document_file_id=broadcast_data.get('document'),
            admin_id=callback.from_user.id,
            scheduled_time=schedule_time_db
        )
        
        if not broadcast:
            await callback.answer("‚ùå –û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö!", show_alert=True)
            return
        
        await schedule_broadcast_task(broadcast.id, schedule_time)
        
        # --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–µ–Ω—é –≤–º–µ—Å—Ç–æ —Ç—É–ø–∏–∫–∞ ---
        time_str = schedule_time.strftime('%Y-%m-%d %H:%M')
        keyboard = get_broadcast_menu_keyboard()
        await callback.message.edit_text(
            f"‚úÖ <b>–†–∞—Å—Å—ã–ª–∫–∞ #{broadcast.id} –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ {time_str}</b>\n\nüì¢ –ú–µ–Ω—é —Ä–∞—Å—Å—ã–ª–∫–∏",
            reply_markup=keyboard
        )
        
        await state.clear()
        
        await log_admin_action(session, callback.from_user.id, "broadcast_scheduled", broadcast.id)
        
    except Exception as e:
        print(f"Error in select_broadcast_time: {e}")
        await callback.message.answer(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        await callback.answer()


@admin_router.callback_query(F.data == "admin_broadcast_manual_time")
async def switch_to_manual_time_input(callback: CallbackQuery, state: FSMContext):
    await state.set_state(BroadcastState.waiting_for_manual_schedule_time)
    await callback.message.edit_text(
        "‚è∞ –í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ì–ì–ì–ì-–ú–ú-–î–î –ß–ß:–ú–ú:",
        reply_markup=get_manual_time_input_keyboard()
    )
    await callback.answer()


@admin_router.message(BroadcastState.waiting_for_manual_schedule_time)
async def process_manual_time_input(message: Message, state: FSMContext, session: AsyncSession, bot: Bot):
    try:
        schedule_time = datetime.strptime(message.text, "%Y-%m-%d %H:%M")
        schedule_time = schedule_time.replace(tzinfo=MSK)
        
        if schedule_time <= get_now_msk():
            await message.answer("‚ùå –í—Ä–µ–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –ø—Ä–æ—à–ª–æ–º")
            return
            
        schedule_time_db = strip_tz(to_utc(schedule_time))
        
        data = await state.get_data()
        broadcast_data = data.get('broadcast_data', {})
        
        if not broadcast_data:
            await message.answer("‚ùå –î–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.")
            await state.clear()
            return
        
        service = BroadcastService(bot, session)
        broadcast = await service.create_broadcast(
            message_text=broadcast_data.get('text', ''),
            photo_file_id=broadcast_data.get('photo'),
            video_file_id=broadcast_data.get('video'),
            document_file_id=broadcast_data.get('document'),
            admin_id=message.from_user.id,
            scheduled_time=schedule_time_db
        )
        
        if not broadcast:
            await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.")
            return
        
        await schedule_broadcast_task(broadcast.id, schedule_time)
        
        # --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–µ–Ω—é (–æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ message handler) ---
        time_str = schedule_time.strftime('%Y-%m-%d %H:%M')
        keyboard = get_broadcast_menu_keyboard()
        await message.answer(
            f"‚úÖ <b>–†–∞—Å—Å—ã–ª–∫–∞ #{broadcast.id} –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ {time_str}</b>\n\nüì¢ –ú–µ–Ω—é —Ä–∞—Å—Å—ã–ª–∫–∏",
            reply_markup=keyboard
        )
        
        await state.clear()
        
    except ValueError:
        await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏.")


@admin_router.message(BroadcastState.waiting_for_schedule_time, ~Command(commands=["start", "admin"]))
async def process_schedule_time(message: Message, state: FSMContext, session: AsyncSession):
    try:
        await message.delete()
    except:
        pass
    await message.answer("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏.")


# ==============================================================================
#  –ò–°–¢–û–†–ò–Ø –ò –û–¢–õ–û–ñ–ï–ù–ù–´–ï (–ö–ù–û–ü–ö–ò)
# ==============================================================================

@admin_router.callback_query(F.data.startswith("admin_broadcast_history_"))
async def show_broadcast_history(callback: CallbackQuery, session: AsyncSession):
    try:
        page = int(callback.data.split("_")[-1])
    except (ValueError, IndexError):
        page = 1
        
    page_size = 8
    offset = (page - 1) * page_size
    
    result = await session.execute(
        select(Broadcast)
        .order_by(Broadcast.created_at.desc())
        .offset(offset).limit(page_size)
    )
    broadcasts = result.scalars().all()
    
    result_count = await session.execute(select(func.count(Broadcast.id)))
    total_count = int(result_count.scalar() or 0)
    
    if not broadcasts and total_count == 0:
        await callback.message.edit_text("üìù –ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞—Å—Å—ã–ª–æ–∫", reply_markup=get_back_to_broadcast_menu_kb())
        await callback.answer()
        return
    
    keyboard = get_broadcast_list_keyboard(broadcasts, page, total_count, page_size, is_scheduled=False)
    await callback.message.edit_text("üìù <b>–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫</b>\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å—Å—ã–ª–∫—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:", reply_markup=keyboard)
    await callback.answer()


@admin_router.callback_query(F.data.startswith("admin_scheduled_broadcasts_"))
async def show_scheduled_broadcasts(callback: CallbackQuery, session: AsyncSession):
    try:
        page = int(callback.data.split("_")[-1])
    except (ValueError, IndexError):
        page = 1
        
    page_size = 8
    offset = (page - 1) * page_size
    
    # –ò—â–µ–º –≤ —Ç–∞–±–ª–∏—Ü–µ Broadcast, –≥–¥–µ –≤—Ä–µ–º—è –∑–∞–¥–∞–Ω–æ –∏ —Å—Ç–∞—Ç—É—Å pending
    result = await session.execute(
        select(Broadcast)
        .where(Broadcast.scheduled_time.isnot(None))
        .where(Broadcast.status == "pending")
        .order_by(Broadcast.scheduled_time.asc())
        .offset(offset).limit(page_size)
    )
    scheduled = result.scalars().all()
    
    result_count = await session.execute(
        select(func.count(Broadcast.id))
        .where(Broadcast.scheduled_time.isnot(None))
        .where(Broadcast.status == "pending")
    )
    total_count = int(result_count.scalar() or 0)
    
    if not scheduled and total_count == 0:
        await callback.message.edit_text("‚è∞ –ù–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫", reply_markup=get_back_to_broadcast_menu_kb())
        await callback.answer()
        return
    
    keyboard = get_broadcast_list_keyboard(scheduled, page, total_count, page_size, is_scheduled=True)
    await callback.message.edit_text("‚è∞ <b>–û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ —Ä–∞—Å—Å—ã–ª–∫–∏</b>\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å—Å—ã–ª–∫—É –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:", reply_markup=keyboard)
    await callback.answer()


# --- –î–ï–¢–ê–õ–ò –ò–°–¢–û–†–ò–ò ---
@admin_router.callback_query(F.data.startswith("admin_broadcast_detail_"))
async def show_broadcast_detail(callback: CallbackQuery, session: AsyncSession):
    try:
        broadcast_id = int(callback.data.split("_")[-1])
    except:
        await callback.answer("–û—à–∏–±–∫–∞ ID")
        return
    
    broadcast = await session.get(Broadcast, broadcast_id)
    if not broadcast:
        await callback.answer("–†–∞—Å—Å—ã–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
        return
    
    created_str = broadcast.created_at.strftime('%d.%m.%Y %H:%M') if broadcast.created_at else "N/A"
    
    info_text = (
        f"üìù <b>–†–∞—Å—Å—ã–ª–∫–∞ #{broadcast.id}</b>\n"
        f"üìÖ –î–∞—Ç–∞: {created_str}\n"
        f"üìä –°—Ç–∞—Ç—É—Å: {broadcast.status}\n"
        f"üì® –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {broadcast.sent_count}/{broadcast.total_count}\n\n"
        f"üìÑ <b>–°–æ–æ–±—â–µ–Ω–∏–µ:</b>\n{broadcast.message_text}"
    )
    
    await callback.message.edit_text(info_text, reply_markup=get_broadcast_detail_keyboard(broadcast_id))
    await callback.answer()


# --- –î–ï–¢–ê–õ–ò –û–¢–õ–û–ñ–ï–ù–ù–û–ô ---
@admin_router.callback_query(F.data.startswith("admin_scheduled_detail_"))
async def show_scheduled_detail(callback: CallbackQuery, session: AsyncSession):
    try:
        broadcast_id = int(callback.data.split("_")[-1])
    except:
        await callback.answer("–û—à–∏–±–∫–∞ ID")
        return
    
    broadcast = await session.get(Broadcast, broadcast_id)
    if not broadcast:
        await callback.answer("–†–∞—Å—Å—ã–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
        return
    
    sched_str = broadcast.scheduled_time.strftime('%d.%m.%Y %H:%M') if broadcast.scheduled_time else "N/A"
    
    info_text = (
        f"‚è∞ <b>–û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ #{broadcast.id}</b>\n"
        f"üìÖ –û—Ç–ø—Ä–∞–≤–∫–∞: {sched_str}\n"
        f"üìä –°—Ç–∞—Ç—É—Å: {broadcast.status}\n\n"
        f"üìÑ <b>–°–æ–æ–±—â–µ–Ω–∏–µ:</b>\n{broadcast.message_text}"
    )
    
    await callback.message.edit_text(info_text, reply_markup=get_scheduled_detail_keyboard(broadcast_id))
    await callback.answer()


# --- –û–¢–ü–†–ê–í–ò–¢–¨ –û–¢–õ–û–ñ–ï–ù–ù–£–Æ –ü–†–Ø–ú–û –°–ï–ô–ß–ê–° ---
@admin_router.callback_query(F.data.startswith("admin_force_send_scheduled_"))
async def force_send_scheduled_broadcast(callback: CallbackQuery, session: AsyncSession, bot: Bot):
    try:
        broadcast_id = int(callback.data.split("_")[-1])
        
        broadcast = await session.get(Broadcast, broadcast_id)
        if not broadcast:
            await callback.answer("–†–∞—Å—Å—ã–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
            return

        # –£–¥–∞–ª—è–µ–º –∑–∞–¥–∞—á—É –∏–∑ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
        from core.tools.broadcast_scheduler import broadcast_scheduler
        job_id = f"broadcast_{broadcast_id}"
        if broadcast_scheduler.get_job(job_id):
            broadcast_scheduler.remove_job(job_id)
            
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
        service = BroadcastService(bot, session)
        await callback.message.edit_text("‚è≥ –ù–∞—á–∏–Ω–∞—é –æ—Ç–ø—Ä–∞–≤–∫—É...")
        
        success = await service.send_broadcast(broadcast_id)
        
        if success:
            # --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–µ–Ω—é –≤–º–µ—Å—Ç–æ —Ç—É–ø–∏–∫–∞ ---
            keyboard = get_broadcast_menu_keyboard()
            await callback.message.edit_text(
                f"‚úÖ <b>–†–∞—Å—Å—ã–ª–∫–∞ #{broadcast_id} —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–∞ –≤–Ω–µ –æ—á–µ—Ä–µ–¥–∏!</b>\n\nüì¢ –ú–µ–Ω—é —Ä–∞—Å—Å—ã–ª–∫–∏",
                reply_markup=keyboard
            )
            await log_admin_action(session, callback.from_user.id, "broadcast_force_sent", broadcast_id)
        else:
            await callback.message.edit_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ä–∞—Å—Å—ã–ª–∫–∏.")
            
    except Exception as e:
        print(f"Error force sending scheduled: {e}")
        await callback.answer("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞", show_alert=True)


# --- –£–î–ê–õ–ï–ù–ò–ï –û–¢–õ–û–ñ–ï–ù–ù–û–ô ---
@admin_router.callback_query(F.data.startswith("admin_delete_scheduled_"))
async def delete_scheduled_broadcast(callback: CallbackQuery, session: AsyncSession):
    try:
        broadcast_id = int(callback.data.split("_")[-1])
        
        # 1. –£–¥–∞–ª—è–µ–º –∑–∞–¥–∞—á—É –∏–∑ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
        from core.tools.broadcast_scheduler import broadcast_scheduler
        job_id = f"broadcast_{broadcast_id}"
        if broadcast_scheduler.get_job(job_id):
            broadcast_scheduler.remove_job(job_id)
            
        # 2. –£–¥–∞–ª—è–µ–º –∏–∑ –ë–î
        stmt = delete(Broadcast).where(Broadcast.id == broadcast_id)
        await session.execute(stmt)
        
        await callback.answer("üóë –†–∞—Å—Å—ã–ª–∫–∞ —É–¥–∞–ª–µ–Ω–∞", show_alert=True)
        await show_scheduled_broadcasts(callback, session)
        
    except Exception as e:
        print(f"Error deleting scheduled: {e}")
        await callback.answer("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è", show_alert=True)=== ./handlers/admin/stats_handlers.py ===
from aiogram import F
from aiogram.types import CallbackQuery
from aiogram.fsm.context import FSMContext
from sqlalchemy.ext.asyncio import AsyncSession

from handlers.admin.admin_router import admin_router
from keyboards.admin_stats_keyboards import (
    get_stats_menu_keyboard,
    get_back_to_stats_menu_keyboard,
    get_stats_filter_keyboard
)
from services.admin_statistics_service import CachedStatisticsService
from utils.admin_logger import log_admin_action


@admin_router.callback_query(F.data == "admin_stats")
async def show_stats_menu(callback: CallbackQuery):
    keyboard = get_stats_menu_keyboard()
    await callback.message.edit_text("üìä –ú–µ–Ω—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏", reply_markup=keyboard)
    await callback.answer()


@admin_router.callback_query(F.data == "admin_general_stats")
async def show_general_stats(callback: CallbackQuery, session: AsyncSession):
    service = CachedStatisticsService(session)
    stats = await service.get_general_stats()
    
    message_text = f"""
üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {stats['total_users']}
üéÅ –ê–∫—Ç–∏–≤–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π: {stats['active_giveaways']}
üé´ –í—Å–µ–≥–æ —É—á–∞—Å—Ç–∏–π: {stats['total_participations']}
ü§ñ –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –±–æ—Ç–æ–≤: {stats['potential_bots']}
    """.strip()
    
    keyboard = get_back_to_stats_menu_keyboard()
    await callback.message.edit_text(message_text, reply_markup=keyboard)
    await callback.answer()


@admin_router.callback_query(F.data == "admin_user_growth")
async def show_user_growth_stats(callback: CallbackQuery, session: AsyncSession):
    service = CachedStatisticsService(session)
    stats = await service.get_user_growth_stats()
    
    message_text = f"""
üìà –†–æ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
–°–µ–≥–æ–¥–Ω—è: {stats['new_today']}
–ó–∞ –Ω–µ–¥–µ–ª—é: {stats['new_week']}
–ó–∞ –º–µ—Å—è—Ü: {stats['new_month']}
    """.strip()
    
    keyboard = get_back_to_stats_menu_keyboard()
    await callback.message.edit_text(message_text, reply_markup=keyboard)
    await callback.answer()


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
@admin_router.callback_query(F.data.startswith("admin_general_stats_"))
async def show_general_stats_filtered(callback: CallbackQuery, session: AsyncSession):
    # –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–µ—Ä–∏–æ–¥ –∏–∑ callback_data
    period = callback.data.split("_")[-1]
    
    service = CachedStatisticsService(session)
    # –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–¥–µ—Å—å –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –º–µ—Ç–æ–¥—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥
    stats = await service.get_general_stats()
    
    message_text = f"""
üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ({period}):
üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {stats['total_users']}
üéÅ –ê–∫—Ç–∏–≤–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π: {stats['active_giveaways']}
üé´ –í—Å–µ–≥–æ —É—á–∞—Å—Ç–∏–π: {stats['total_participations']}
ü§ñ –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –±–æ—Ç–æ–≤: {stats['potential_bots']}
    """.strip()
    
    keyboard = get_back_to_stats_menu_keyboard()
    await callback.message.edit_text(message_text, reply_markup=keyboard)
    await callback.answer()


# –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –≤–∏–¥–æ–≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
@admin_router.callback_query(F.data == "admin_premium_stats")
async def show_premium_stats(callback: CallbackQuery, session: AsyncSession):
    # –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–µ–º–∏—É–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    message_text = """
‚≠ê –ü—Ä–µ–º–∏—É–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...
    """.strip()
    
    keyboard = get_back_to_stats_menu_keyboard()
    await callback.message.edit_text(message_text, reply_markup=keyboard)
    await callback.answer()


@admin_router.callback_query(F.data == "admin_giveaway_stats")
async def show_giveaway_stats(callback: CallbackQuery, session: AsyncSession):
    # –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
    message_text = """
üéÆ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π:
–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...
    """.strip()
    
    keyboard = get_back_to_stats_menu_keyboard()
    await callback.message.edit_text(message_text, reply_markup=keyboard)
    await callback.answer()


@admin_router.callback_query(F.data == "admin_participation_stats")
async def show_participation_stats(callback: CallbackQuery, session: AsyncSession):
    # –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —É—á–∞—Å—Ç–∏–π
    message_text = """
üéØ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—á–∞—Å—Ç–∏–π:
–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...
    """.strip()
    
    keyboard = get_back_to_stats_menu_keyboard()
    await callback.message.edit_text(message_text, reply_markup=keyboard)
    await callback.answer()


# –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω —Ñ–∏–ª—å—Ç—Ä .contains("stats"), —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ –∞–¥–º–∏–Ω—Å–∫–∏–µ –∫–Ω–æ–ø–∫–∏
@admin_router.callback_query(F.data.startswith("admin_") & F.data.contains("stats"))
async def log_admin_stats_actions(callback: CallbackQuery, session: AsyncSession):
    # –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    await log_admin_action(
        session=session,
        admin_id=callback.from_user.id,
        action=f"view_{callback.data.replace('admin_', '')}",
        details={"message_id": callback.message_id}
    )
    # –í–∞–∂–Ω–æ: –∑–¥–µ—Å—å –Ω–µ—Ç callback.answer(), —Ç–∞–∫ –∫–∞–∫ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ 
    # –º–æ–∂–µ—Ç –±—ã—Ç—å "–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º" –∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –≤—ã—à–µ, –Ω–æ —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ö–µ–Ω–¥–ª–µ—Ä 
    # –≤ —Ü–µ–ø–æ—á–∫–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏, —Ç–æ –æ–Ω —Å—Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –≤—ã—à–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ, 
    # –Ω–æ –ø–æ–¥–æ—à–ª–æ –ø–æ —Ñ–∏–ª—å—Ç—Ä—É. –í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ —ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ.=== ./handlers/admin/giveaways_handlers.py ===
from aiogram import F
from aiogram.types import CallbackQuery, Message
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from sqlalchemy.ext.asyncio import AsyncSession
from aiogram import Bot

from handlers.admin.admin_router import admin_router
from keyboards.admin_giveaways_keyboards import (
    get_giveaways_menu_keyboard,
    get_giveaway_search_results_keyboard,
    get_giveaway_detail_menu_keyboard,
    get_confirm_giveaway_action_keyboard,
    get_giveaways_pagination_keyboard,
    get_cancel_search_keyboard
)
from services.admin_giveaway_service import GiveawayService
from utils.admin_logger import log_admin_action


class GiveawaySearchState(StatesGroup):
    waiting_for_search_query = State()


def format_giveaway_info(giveaway_info: dict) -> str:
    giveaway = giveaway_info["giveaway"]
    return f"""
üéÅ –†–æ–∑—ã–≥—Ä—ã—à #{giveaway.id}:
üéÅ –ü—Ä–∏–∑: {giveaway.prize_text}
üëë –í–ª–∞–¥–µ–ª–µ—Ü: {giveaway.owner_id}
üïê –ó–∞–≤–µ—Ä—à–∏—Ç—Å—è: {giveaway.finish_time.strftime('%Y-%m-%d %H:%M')}
üéØ –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: {giveaway_info['participant_count']}
üëë –ü–æ–±–µ–¥–∏—Ç–µ–ª–µ–π: {giveaway.winners_count}
üü¢ –°—Ç–∞—Ç—É—Å: {giveaway.status}
    """.strip()


@admin_router.callback_query(F.data == "admin_giveaways")
async def show_giveaways_menu(callback: CallbackQuery):
    keyboard = get_giveaways_menu_keyboard()
    await callback.message.edit_text("üéÅ –ú–µ–Ω—é —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π", reply_markup=keyboard)
    await callback.answer()


@admin_router.callback_query(F.data == "admin_search_giveaway")
async def start_giveaway_search(callback: CallbackQuery, state: FSMContext):
    await state.set_state(GiveawaySearchState.waiting_for_search_query)
    keyboard = get_cancel_search_keyboard()
    await callback.message.edit_text(
        "üîç –í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ –∏–∑ –ø—Ä–∏–∑–∞ –∏–ª–∏ ID –≤–ª–∞–¥–µ–ª—å—Ü–∞:",
        reply_markup=keyboard
    )
    await callback.answer()


@admin_router.message(GiveawaySearchState.waiting_for_search_query)
async def process_giveaway_search(message: Message, state: FSMContext, session: AsyncSession):
    search_query = message.text.strip()
    
    service = GiveawayService(session, None)  # bot –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∫–∞–∫ None, –Ω–æ –≤ search_giveaways –æ–Ω –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
    giveaways = await service.search_giveaways(search_query)
    
    if not giveaways:
        await message.answer("‚ùå –†–æ–∑—ã–≥—Ä—ã—à–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.")
        await state.clear()
        return
    
    if len(giveaways) == 1:
        # –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω –æ–¥–∏–Ω —Ä–æ–∑—ã–≥—Ä—ã—à, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        giveaway_info = await service.get_giveaway_detailed_info(giveaways[0].id)
        keyboard = get_giveaway_detail_menu_keyboard(giveaway_info["giveaway"].id)
        await message.answer(format_giveaway_info(giveaway_info), reply_markup=keyboard)
    else:
        # –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
        keyboard = get_giveaway_search_results_keyboard(giveaways)
        await message.answer("–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∏:", reply_markup=keyboard)
    
    await state.clear()


@admin_router.callback_query(F.data.startswith("admin_list_giveaways_"))
async def show_giveaways_list(callback: CallbackQuery, session: AsyncSession):
    page = int(callback.data.split("_")[-1])
    
    service = GiveawayService(session, None)  # bot –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    giveaways, total_count = await service.get_giveaways_paginated(page=page)
    
    message_text = "–°–ø–∏—Å–æ–∫ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π:\n\n"
    for giveaway in giveaways:
        message_text += f"üéÅ [{giveaway.id}] \"{giveaway.prize_text}\" - –≤–ª–∞–¥–µ–ª–µ—Ü {giveaway.owner_id} - {giveaway.status}\n"
    
    # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ total_count - —ç—Ç–æ int
    total_count = int(total_count) if total_count is not None else 0
    
    keyboard = get_giveaways_pagination_keyboard(page, total_count)
    await callback.message.edit_text(message_text, reply_markup=keyboard)
    await callback.answer()


@admin_router.callback_query(F.data.startswith("admin_giveaway_detail_"))
async def show_giveaway_detail(callback: CallbackQuery, session: AsyncSession):
    giveaway_id = int(callback.data.split("_")[-1])
    
    service = GiveawayService(session, None)  # bot –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    giveaway_info = await service.get_giveaway_detailed_info(giveaway_id)
    
    if not giveaway_info:
        await callback.answer("‚ùå –†–æ–∑—ã–≥—Ä—ã—à –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
        return
    
    keyboard = get_giveaway_detail_menu_keyboard(giveaway_id)
    await callback.message.edit_text(
        format_giveaway_info(giveaway_info),
        reply_markup=keyboard
    )
    await callback.answer()


@admin_router.callback_query(F.data.startswith("admin_force_finish_"))
async def confirm_force_finish_giveaway(callback: CallbackQuery):
    giveaway_id = int(callback.data.split("_")[-1])
    keyboard = get_confirm_giveaway_action_keyboard(giveaway_id, "finish")
    await callback.message.edit_text(
        f"‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–æ–∑—ã–≥—Ä—ã—à #{giveaway_id}?\n"
        "–í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –±—É–¥—É—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω—ã.",
        reply_markup=keyboard
    )
    await callback.answer()


@admin_router.callback_query(F.data.startswith("admin_confirm_giveaway_"))
async def process_giveaway_action(callback: CallbackQuery, session: AsyncSession, bot: Bot):
    parts = callback.data.split("_")
    # ["admin", "confirm", "giveaway", "action", "giveaway_id"]
    action = "_".join(parts[2:-1])  # "giveaway_finish" –∏ —Ç.–¥.
    giveaway_id = int(parts[-1])
    
    service = GiveawayService(session, bot)
    
    if "finish" in action:
        success = await service.force_finish_giveaway(giveaway_id, callback.from_user.id)
        action_text = "–∑–∞–≤–µ—Ä—à–µ–Ω"
    else:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥—Ä—É–≥–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π
        success = False
        action_text = "–æ–±—Ä–∞–±–æ—Ç–∞–Ω"
    
    if success:
        await callback.message.edit_text(f"‚úÖ –†–æ–∑—ã–≥—Ä—ã—à #{giveaway_id} —É—Å–ø–µ—à–Ω–æ {action_text}")
        # –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
        await log_admin_action(session, callback.from_user.id, f"giveaway_{'finish' if 'finish' in action else 'other'}", giveaway_id)
    else:
        await callback.message.edit_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞")
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–æ–∑—ã–≥—Ä—ã—à–µ
    service = GiveawayService(session, bot)
    giveaway_info = await service.get_giveaway_detailed_info(giveaway_id)
    
    if giveaway_info:
        keyboard = get_giveaway_detail_menu_keyboard(giveaway_id)
        await callback.message.edit_text(
            format_giveaway_info(giveaway_info),
            reply_markup=keyboard
        )
    
    await callback.answer()=== ./handlers/admin/users_handlers.py ===
from aiogram import F
from aiogram.types import CallbackQuery, Message
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.types import InlineKeyboardButton
from aiogram import Bot
from sqlalchemy.ext.asyncio import AsyncSession

from handlers.admin.admin_router import admin_router
from keyboards.admin_users_keyboards import (
    get_users_menu_keyboard,
    get_user_search_results_keyboard,
    get_user_detail_menu_keyboard,
    get_confirm_premium_action_keyboard,
    get_back_to_users_menu_keyboard,
    get_users_pagination_keyboard,
    get_cancel_search_keyboard
)
from services.admin_user_service import UserService
from services.admin_giveaway_service import GiveawayService
from utils.admin_logger import log_admin_action


class UserSearchState(StatesGroup):
    waiting_for_search_query = State()


@admin_router.callback_query(F.data == "admin_users")
async def show_users_menu(callback: CallbackQuery):
    keyboard = get_users_menu_keyboard()
    await callback.message.edit_text("üë• –ú–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", reply_markup=keyboard)
    await callback.answer()


@admin_router.callback_query(F.data == "admin_search_user")
async def start_user_search(callback: CallbackQuery, state: FSMContext):
    await state.set_state(UserSearchState.waiting_for_search_query)
    keyboard = get_cancel_search_keyboard()
    await callback.message.edit_text("üîç –í–≤–µ–¥–∏—Ç–µ ID, @username –∏–ª–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", reply_markup=keyboard)
    await callback.answer()


@admin_router.message(UserSearchState.waiting_for_search_query)
async def process_user_search(message: Message, state: FSMContext, session: AsyncSession):
    search_query = message.text.strip()
    
    service = UserService(session)
    users = await service.search_users(search_query)
    
    if not users:
        await message.answer("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.")
        await state.clear()
        return
    
    if len(users) == 1:
        # –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        user_info = await service.get_user_detailed_info(users[0].user_id)
        keyboard = get_user_detail_menu_keyboard(user_info["user"].user_id)
        await message.answer(format_user_info(user_info), reply_markup=keyboard)
    else:
        # –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
        keyboard = get_user_search_results_keyboard(users)
        await message.answer("–ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:", reply_markup=keyboard)
    
    await state.clear()


def format_user_info(user_info: dict) -> str:
    user = user_info["user"]
    return f"""
üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ {user.user_id}:
üÜî ID: {user.user_id}
üìõ –ò–º—è: {user.full_name}
ü§ñ Username: @{user.username if user.username else '–Ω–µ —É–∫–∞–∑–∞–Ω'}
‚è∞ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: {user.created_at.strftime('%Y-%m-%d %H:%M')}
üíé –ü—Ä–µ–º–∏—É–º: {'–î–∞' if user.is_premium else '–ù–µ—Ç'}
{'–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è: ' + user.premium_until.strftime('%Y-%m-%d %H:%M') if user.premium_until else ''}
üé´ –£—á–∞—Å—Ç–∏–π: {user_info['participation_count']}
üéÅ –°–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π: {user_info['created_giveaways_count']}
    """.strip()


@admin_router.callback_query(F.data.startswith("admin_user_detail_"))
async def show_user_detail(callback: CallbackQuery, session: AsyncSession):
    user_id = int(callback.data.split("_")[-1])
    
    service = UserService(session)
    user_info = await service.get_user_detailed_info(user_id)
    
    if not user_info:
        await callback.answer("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
        return
    
    keyboard = get_user_detail_menu_keyboard(user_id)
    await callback.message.edit_text(
        format_user_info(user_info),
        reply_markup=keyboard
    )
    await callback.answer()


@admin_router.callback_query(F.data.startswith("admin_list_users_"))
async def show_users_list(callback: CallbackQuery, session: AsyncSession):
    page = int(callback.data.split("_")[-1])
    
    service = UserService(session)
    users, total_count = await service.get_users_paginated(page=page)
    
    message_text = "–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:\n\n"
    for user in users:
        premium_status = "üíé" if user.is_premium else "üë§"
        message_text += f"{premium_status} [{user.user_id}] @{user.username or '–±–µ–∑_–Ω–∏–∫–∞'} ({user.full_name})\n"
    
    # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ total_count - —ç—Ç–æ int
    total_count = int(total_count) if total_count is not None else 0
    
    keyboard = get_users_pagination_keyboard(page, total_count)
    await callback.message.edit_text(message_text, reply_markup=keyboard)
    await callback.answer()


@admin_router.callback_query(F.data.startswith("admin_grant_premium_"))
async def confirm_grant_premium(callback: CallbackQuery):
    user_id = int(callback.data.split("_")[-1])
    keyboard = get_confirm_premium_action_keyboard(user_id, "grant")
    await callback.message.edit_text(
        f"‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–¥–∞—Ç—å –ø—Ä–µ–º–∏—É–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}?",
        reply_markup=keyboard
    )
    await callback.answer()


@admin_router.callback_query(F.data.startswith("admin_revoke_premium_"))
async def confirm_revoke_premium(callback: CallbackQuery):
    user_id = int(callback.data.split("_")[-1])
    keyboard = get_confirm_premium_action_keyboard(user_id, "revoke")
    await callback.message.edit_text(
        f"‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±—Ä–∞—Ç—å –ø—Ä–µ–º–∏—É–º —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}?",
        reply_markup=keyboard
    )
    await callback.answer()


@admin_router.callback_query(F.data.startswith("admin_confirm_premium_"))
async def process_premium_change(callback: CallbackQuery, session: AsyncSession):
    parts = callback.data.split("_")
    # ["admin", "confirm", "premium", "grant/revoke", "user_id"]
    action = "_".join(parts[2:-1])  # "premium_grant" –∏–ª–∏ "premium_revoke"
    user_id = int(parts[-1])
    
    service = UserService(session)
    
    if "grant" in action:
        success = await service.toggle_premium_status(user_id, is_premium=True)
        action_text = "–≤—ã–¥–∞–Ω"
    else:
        success = await service.toggle_premium_status(user_id, is_premium=False)
        action_text = "–∑–∞–±—Ä–∞–Ω"
    
    if success:
        await callback.message.edit_text(f"‚úÖ –ü—Ä–µ–º–∏—É–º —É—Å–ø–µ—à–Ω–æ {action_text} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
        # –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
        await log_admin_action(session, callback.from_user.id, f"premium_{'grant' if 'grant' in action else 'revoke'}", user_id)
    else:
        await callback.message.edit_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–µ–º–∏—É–º–∞")
    
    # –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    service = UserService(session)
    user_info = await service.get_user_detailed_info(user_id)
    
    if user_info:
        keyboard = get_user_detail_menu_keyboard(user_id)
        await callback.message.edit_text(
            format_user_info(user_info),
            reply_markup=keyboard
        )
    
    await callback.answer()


@admin_router.callback_query(F.data.startswith("admin_user_giveaways_"))
async def show_user_giveaways(callback: CallbackQuery, session: AsyncSession, bot: Bot):
    # –†–∞–∑–±–∏—Ä–∞–µ–º callback_data –≤ —Ñ–æ—Ä–º–∞—Ç–µ "admin_user_giveaways_{user_id}_{page}"
    parts = callback.data.split("_")
    user_id = int(parts[3])  # admin_user_giveaways_user_id_page
    page = int(parts[4]) if len(parts) > 4 else 1
    
    service = GiveawayService(session, bot)
    giveaways, total_count = await service.get_user_giveaways_paginated(user_id, page)
    
    message_text = f"üéÅ –†–æ–∑—ã–≥—Ä—ã—à–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}:\n\n"
    for giveaway in giveaways:
        message_text += f"#{giveaway.id} \"{giveaway.prize_text}\" - {giveaway.status}\n"
    
    # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ total_count - —ç—Ç–æ int
    total_count = int(total_count) if total_count is not None else 0
    total_pages = (total_count + 10 - 1) // 10  # 10 - —Ä–∞–∑–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    
    builder = InlineKeyboardBuilder()
    # –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º
    if page > 1:
        builder.button(
            text="‚è™ –ù–∞–∑–∞–¥",
            callback_data=f"admin_user_giveaways_{user_id}_{page - 1}"
        )
    
    builder.button(
        text=f"{page}/{total_pages}",
        callback_data="admin_ignore"  # –ó–∞–≥–ª—É—à–∫–∞
    )
    
    if page < total_pages:
        builder.button(
            text="–í–ø–µ—Ä–µ–¥ ‚è©",
            callback_data=f"admin_user_giveaways_{user_id}_{page + 1}"
        )
    
    builder.adjust(3)  # –†–∞—Å–ø–æ–ª–∞–≥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
    
    # –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"
    builder.row(
        InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é",
            callback_data=f"admin_user_detail_{user_id}"
        )
    )
    
    await callback.message.edit_text(message_text, reply_markup=builder.as_markup())
    await callback.answer()=== ./handlers/admin/__init__.py ===
from .admin_router import admin_router
from .stats_handlers import *
from .users_handlers import *
from .giveaways_handlers import *
from .broadcast_handlers import *

__all__ = ["admin_router"]=== ./handlers/creator/constructor/publication.py ===
from datetime import datetime
from aiogram import Router, types, F, Bot
from aiogram.fsm.context import FSMContext
from sqlalchemy.ext.asyncio import AsyncSession
import logging

from database.requests.giveaway_repo import create_giveaway
from keyboards.inline.participation import join_keyboard
from core.tools.scheduler import scheduler
from core.logic.game_actions import finish_giveaway_task
from core.tools.formatters import format_giveaway_caption
from core.tools.timezone import to_utc
from handlers.creator.constructor.message_manager import get_message_manager

logger = logging.getLogger(__name__)
router = Router()

@router.callback_query(F.data == "constr_publish")
async def publish_giveaway(call: types.CallbackQuery, state: FSMContext, session: AsyncSession, bot: Bot):
    data = await state.get_data()
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è
    errors = []
    if not data.get('text'): errors.append("‚Ä¢ –ù–µ —É–∫–∞–∑–∞–Ω —Ç–µ–∫—Å—Ç")
    if not data.get('main_channel'): errors.append("‚Ä¢ –ù–µ –≤—ã–±—Ä–∞–Ω –∫–∞–Ω–∞–ª")
    if not data.get('winners') or not (1 <= data['winners'] <= 50): errors.append("‚Ä¢ –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª-–≤–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π")
    
    if errors:
        return await call.answer("‚ùå –û—à–∏–±–∫–∏:\n" + "\n".join(errors), show_alert=True)
    
    main_ch = data['main_channel']
    
    try:
        finish_dt_msk = datetime.fromisoformat(data['finish_time_str'])
        finish_dt_utc = to_utc(finish_dt_msk)
    except ValueError:
        return await call.answer("‚ùå –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏", show_alert=True)
    
    bot_info = await bot.get_me()
    caption = format_giveaway_caption(data['text'], data['winners'], finish_dt_utc, 0, data.get('is_participants_hidden', False))
    keyboard = join_keyboard(bot_info.username, 0)
    
    # 1. –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ –∫–∞–Ω–∞–ª
    try:
        if data['media_type'] == 'photo':
            msg = await bot.send_photo(main_ch['id'], data['media_file_id'], caption=caption, reply_markup=keyboard)
        elif data['media_type'] == 'video':
            msg = await bot.send_video(main_ch['id'], data['media_file_id'], caption=caption, reply_markup=keyboard)
        else:
            msg = await bot.send_message(main_ch['id'], text=caption, reply_markup=keyboard)
    except Exception as e:
        logger.error(f"Publish failed: {e}")
        return await call.answer(f"‚ùå –û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ (–±–æ—Ç –Ω–µ –∞–¥–º–∏–Ω?): {e}", show_alert=True)

    # 2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
    try:
        gw_id = await create_giveaway(
            session, call.from_user.id, main_ch['id'], msg.message_id,
            data['text'], data['winners'], finish_dt_utc,
            data['media_file_id'], data['media_type'],
            data['sponsors'],
            is_referral=(data['ref_req'] > 0),
            is_captcha=data['is_captcha'],
            short_description=data.get('short_description', '')
        )
    except Exception as e:
        logger.critical(f"DB Error: {e}")
        # –ü—ã—Ç–∞–µ–º—Å—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç, —Ä–∞–∑ –≤ –ë–î –Ω–µ –ø–æ–ø–∞–ª–æ
        try: await bot.delete_message(main_ch['id'], msg.message_id)
        except: pass
        return await call.answer("‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ë–î", show_alert=True)

    # 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ (–¥–æ–±–∞–≤–ª—è–µ–º ID —Ä–æ–∑—ã–≥—Ä—ã—à–∞)
    try:
        await bot.edit_message_reply_markup(
            chat_id=main_ch['id'], 
            message_id=msg.message_id, 
            reply_markup=join_keyboard(bot_info.username, gw_id)
        )
    except: pass
    
    # 4. –§–æ—Ä–≤–∞—Ä–¥ —Å–ø–æ–Ω—Å–æ—Ä–∞–º
    for sp in data['sponsors']:
        try:
            await bot.forward_message(chat_id=sp['id'], from_chat_id=main_ch['id'], message_id=msg.message_id)
        except: pass

    # 5. –ó–∞–ø—É—Å–∫ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ (–° –ì–ê–†–ê–ù–¢–ò–ï–ô –ó–ê–ü–£–°–ö–ê)
    try:
        scheduler.add_job(
            finish_giveaway_task, 
            "date", 
            run_date=finish_dt_utc, 
            kwargs={"giveaway_id": gw_id}, 
            id=f"gw_{gw_id}", 
            replace_existing=True,
            misfire_grace_time=None  # <--- –í–ê–ñ–ù–û: –í—ã–ø–æ–ª–Ω–∏—Ç—å, –¥–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏ –≤—Ä–µ–º—è
        )
    except Exception as e:
        logger.error(f"Scheduler error: {e}")
    
    # 6. –§–∏–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    manager = await get_message_manager(state)
    await manager.delete_all(bot, call.message.chat.id)
    
    link = main_ch['link'] if main_ch['link'] != 'private' else "–∫–∞–Ω–∞–ª"
    
    # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    warning_text = (
        "\n\n‚ö†Ô∏è <b>–í–∞–∂–Ω–æ:</b> –ï—Å–ª–∏ –≤—ã –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç–µ –ø–æ—Å—Ç –≤ –∫–∞–Ω–∞–ª–µ –≤—Ä—É—á–Ω—É—é (–∏–∑–º–µ–Ω–∏—Ç–µ —É—Å–ª–æ–≤–∏—è –∏–ª–∏ –ø—Ä–∏–∑), "
        "–±–æ—Ç –æ–± —ç—Ç–æ–º –Ω–µ —É–∑–Ω–∞–µ—Ç. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –æ—Å—Ç–∞–Ω–µ—Ç—Å—è —Å—Ç–∞—Ä–æ–π."
    )

    await call.message.answer(
        f"‚úÖ <b>–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!</b>\n<a href='{link}'>–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ—Å—Ç—É</a>\n\n"
        f"üèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª–µ–π: {data['winners']}"
        f"{warning_text}", 
        disable_web_page_preview=True
    )
    
    await state.clear()=== ./handlers/creator/constructor/referral_selector.py ===
from aiogram import Router, types, F, Bot
from aiogram.fsm.context import FSMContext
from keyboards.inline.constructor import referral_selector_kb
from handlers.creator.constructor.structure import ConstructorState
from handlers.creator.constructor.control_message import refresh_constructor_view
from handlers.creator.constructor.message_manager import get_message_manager, update_message_manager

router = Router()

@router.callback_query(F.data == "constr_ref_menu")
async def ref_menu(call: types.CallbackQuery, state: FSMContext, bot: Bot):
    await refresh_constructor_view(
        bot, state, call.message.chat.id, 
        hint_key='referral', 
        custom_keyboard=referral_selector_kb()
    )
    await call.answer()

@router.callback_query(F.data.startswith("constr_set_ref:"))
async def set_ref(call: types.CallbackQuery, state: FSMContext, bot: Bot):
    count = int(call.data.split(":")[-1])
    await state.update_data(ref_req=count)
    
    await refresh_constructor_view(bot, state, call.message.chat.id, hint_key='publish')
    text = "–í—ã–∫–ª" if count == 0 else f"{count} –¥—Ä—É–∑–µ–π"
    await call.answer(f"‚úÖ –†–µ—Ñ. —Å–∏—Å—Ç–µ–º–∞: {text}")

@router.callback_query(F.data == "constr_set_ref_input")
async def ask_ref_input(call: types.CallbackQuery, state: FSMContext, bot: Bot):
    await state.set_state(ConstructorState.editing_referral)
    
    manager = await get_message_manager(state)
    await manager.delete_all(bot, call.message.chat.id)
    
    msg = await call.message.answer("üîó <b>–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥—Ä—É–∑–µ–π</b> (0-10):")
    manager.add_temp_message(msg)
    await update_message_manager(state, manager)

@router.message(ConstructorState.editing_referral)
async def process_ref_input(message: types.Message, state: FSMContext, bot: Bot):
    try: await message.delete()
    except: pass
    
    manager = await get_message_manager(state)
    text = message.text.strip()
    
    if not text.isdigit() or not (0 <= int(text) <= 10):
        msg = await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 10")
        manager.add_temp_message(msg)
        await update_message_manager(state, manager)
        return
        
    await state.update_data(ref_req=int(text))
    await state.set_state(ConstructorState.init)
    
    await refresh_constructor_view(bot, state, message.chat.id, hint_key='publish')=== ./handlers/creator/constructor/channels_add.py ===
from aiogram import Router, types, F, Bot
from aiogram.fsm.context import FSMContext
from sqlalchemy.ext.asyncio import AsyncSession
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder
import logging

from database.requests.channel_repo import add_channel
from handlers.creator.constructor.structure import ConstructorState
from handlers.creator.constructor.channels_select import show_channels_selection
from handlers.creator.constructor.message_manager import get_message_manager, update_message_manager
from handlers.creator.constructor.control_message import refresh_constructor_view

logger = logging.getLogger(__name__)
router = Router()

@router.callback_query(F.data == "add_new_channel_constr")
async def ask_channel_constr(call: types.CallbackQuery, state: FSMContext, bot: Bot):
    await state.set_state(ConstructorState.adding_channel)
    
    # –£–¥–∞–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª
    manager = await get_message_manager(state)
    await manager.delete_all(bot, call.message.chat.id)
    
    kb = InlineKeyboardMarkup(inline_keyboard=[[InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_to_selector")]])
    msg = await call.message.answer(
        "üì¢ <b>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –∏–ª–∏ —á–∞—Ç–∞</b>\n\n"
        "1. –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –ö–∞–Ω–∞–ª–∞ –∏–ª–∏ –ì—Ä—É–ø–ø—ã (–ß–∞—Ç–∞).\n"
        "2. –ü–µ—Ä–µ—à–ª–∏—Ç–µ —Å—é–¥–∞ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç—Ç—É–¥–∞.",
        reply_markup=kb
    )
    
    # –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
    manager.add_temp_message(msg)
    await update_message_manager(state, manager)

@router.callback_query(F.data == "cancel_to_selector")
async def cancel_to_selector(call: types.CallbackQuery, state: FSMContext, session: AsyncSession, bot: Bot):
    # –û—á–∏—â–∞–µ–º –¥–∏–∞–ª–æ–≥
    manager = await get_message_manager(state)
    await manager.delete_all(bot, call.message.chat.id)
    
    await state.set_state(ConstructorState.init)
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –∫–∞–Ω–∞–ª–æ–≤
    data = await state.get_data()
    mode = data.get('channel_selector_mode', 'main')
    await show_channels_selection(bot, state, session, call.from_user.id, mode, call.message.chat.id)

@router.message(ConstructorState.adding_channel)
async def process_new_channel_step1_constr(message: types.Message, state: FSMContext, bot: Bot):
    # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —é–∑–µ—Ä–∞
    try: await message.delete()
    except: pass
    
    chat_id, title, username, chat_type = None, "Title", None, None
    
    if message.forward_from_chat:
        chat_id = message.forward_from_chat.id
        title = message.forward_from_chat.title
        username = message.forward_from_chat.username
        chat_type = message.forward_from_chat.type # channel, group, supergroup
    elif message.text and (message.text.startswith("@") or "t.me/" in message.text):
        # –õ–æ–≥–∏–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å—Å—ã–ª–∫–∏/—é–∑–µ—Ä–Ω–µ–π–º–∞
        try:
            # –û—á–∏—Å—Ç–∫–∞ —Å—Å—ã–ª–∫–∏
            input_text = message.text.replace("https://t.me/", "").replace("t.me/", "")
            if "/" in input_text: input_text = input_text.split("/")[0] # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Å—ã–ª–æ–∫ –Ω–∞ –ø–æ—Å—Ç—ã
            
            chat = await bot.get_chat(f"@{input_text}" if not input_text.startswith("@") else input_text)
            chat_id = chat.id
            title = chat.title
            username = chat.username
            chat_type = chat.type
        except:
            pass # –û–±—Ä–∞–±–æ—Ç–∞–µ–º –Ω–∏–∂–µ
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —á–∞—Ç–∞
    if chat_type not in ("channel", "supergroup", "group"):
        msg = await message.answer("‚ùå –≠—Ç–æ –ª–∏—á–Ω—ã–π —á–∞—Ç –∏–ª–∏ –±–æ—Ç. –î–æ–±–∞–≤—å—Ç–µ <b>–ö–∞–Ω–∞–ª</b> –∏–ª–∏ <b>–ì—Ä—É–ø–ø—É</b>.")
        manager = await get_message_manager(state)
        manager.add_temp_message(msg)
        await update_message_manager(state, manager)
        return
    
    manager = await get_message_manager(state)
    
    if not chat_id:
        msg = await message.answer("‚ùå –ö–∞–Ω–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–µ—Ä–µ—à–ª–∏—Ç–µ –ø–æ—Å—Ç –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ @username.")
        manager.add_temp_message(msg)
        await update_message_manager(state, manager)
        return

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ (–ë–æ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–¥–º–∏–Ω–æ–º, —á—Ç–æ–±—ã –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫–∏ –∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–¥–ø–∏—Å–∫—É)
    try:
        member = await bot.get_chat_member(chat_id, bot.id)
        if member.status not in ("administrator", "creator"):
            raise Exception("Bot is not admin")
    except:
        msg = await message.answer("‚ùå <b>–ë–æ—Ç –Ω–µ –∞–¥–º–∏–Ω!</b>\n\n–î–∞–π—Ç–µ –±–æ—Ç—É –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ –∫–∞–Ω–∞–ª–µ –∏–ª–∏ –≥—Ä—É–ø–ø–µ, —á—Ç–æ–±—ã –æ–Ω –º–æ–≥ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–¥–ø–∏—Å–∫—É.")
        manager.add_temp_message(msg)
        await update_message_manager(state, manager)
        return

    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏
    generated_link = None
    try:
        invite = await bot.create_chat_invite_link(chat_id, name="RozPlay Bot")
        generated_link = invite.invite_link
    except:
        generated_link = f"https://t.me/{username}" if username else None

    await state.update_data(
        temp_channel={"id": chat_id, "title": title, "username": username},
        generated_link=generated_link
    )
    await state.set_state(ConstructorState.adding_channel_link)
    
    # –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞
    await manager.delete_all(bot, message.chat.id)
    
    text = f"‚úÖ {'–ö–∞–Ω–∞–ª' if chat_type == 'channel' else '–ß–∞—Ç'} <b>{title}</b> –Ω–∞–π–¥–µ–Ω.\n"
    kb_builder = InlineKeyboardBuilder()
    if generated_link:
        text += f"\nüîó –°—Å—ã–ª–∫–∞: {generated_link}\n–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ—ë?"
        kb_builder.button(text="‚úÖ –î–∞", callback_data="use_generated_link")
    else:
        text += "\nüîó –ü—Ä–∏—à–ª–∏—Ç–µ –∏–Ω–≤–∞–π—Ç-—Å—Å—ã–ª–∫—É –≤—Ä—É—á–Ω—É—é:"
        
    kb_builder.button(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_to_selector")
    kb_builder.adjust(1)
    
    new_msg = await message.answer(text, reply_markup=kb_builder.as_markup())
    manager.add_temp_message(new_msg)
    await update_message_manager(state, manager)

@router.callback_query(ConstructorState.adding_channel_link, F.data == "use_generated_link")
async def use_gen_link_callback(call: types.CallbackQuery, state: FSMContext, session: AsyncSession, bot: Bot):
    data = await state.get_data()
    ch_data = data['temp_channel']
    link = data.get('generated_link')
    
    await add_channel(session, call.from_user.id, ch_data['id'], ch_data['title'], ch_data['username'], link, chat_type)
    
    # –û—á–∏—Å—Ç–∫–∞ –∏ –≤–æ–∑–≤—Ä–∞—Ç
    manager = await get_message_manager(state)
    await manager.delete_all(bot, call.message.chat.id)
    await state.set_state(ConstructorState.init)
    
    mode = data.get('channel_selector_mode', 'main')
    await show_channels_selection(bot, state, session, call.from_user.id, mode, call.message.chat.id)

@router.message(ConstructorState.adding_channel_link)
async def process_link_text_constr(message: types.Message, state: FSMContext, session: AsyncSession, bot: Bot):
    try: await message.delete()
    except: pass
    
    link = message.text.strip()
    manager = await get_message_manager(state)

    if "t.me" not in link and not link.startswith("https://"):
        msg = await message.answer("‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Å—ã–ª–∫–∞.")
        manager.add_temp_message(msg)
        await update_message_manager(state, manager)
        return
    
    data = await state.get_data()
    ch_data = data.get('temp_channel')
    
    await add_channel(session, message.from_user.id, ch_data['id'], ch_data['title'], ch_data['username'], link, chat_type)
    
    # –û—á–∏—Å—Ç–∫–∞ –∏ –≤–æ–∑–≤—Ä–∞—Ç
    await manager.delete_all(bot, message.chat.id)
    await state.set_state(ConstructorState.init)
    
    mode = data.get('channel_selector_mode', 'main')
    await show_channels_selection(bot, state, session, message.from_user.id, mode, message.chat.id)=== ./handlers/creator/constructor/start_content.py ===
from datetime import datetime, timedelta
from aiogram import Router, types, F, Bot
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
import logging

from core.security.sanitizer import sanitize_text, get_message_html
from keyboards.inline.dashboard import start_menu_kb
from core.tools.timezone import get_now_msk
from handlers.creator.constructor.structure import ConstructorState
from handlers.creator.constructor.control_message import get_control_hint, refresh_constructor_view
from handlers.creator.constructor.message_manager import get_message_manager, update_message_manager

logger = logging.getLogger(__name__)
router = Router()

@router.callback_query(F.data == "create_gw_init")
@router.message(Command("new"))
async def start_constructor(event: types.Message | types.CallbackQuery, state: FSMContext):
    # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    manager = await get_message_manager(state)
    if isinstance(event, types.CallbackQuery):
        await manager.delete_all(event.bot, event.message.chat.id)
    await state.clear()
    
    # –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    default_finish = get_now_msk() + timedelta(hours=24)
    await state.set_data({
        "text": None, "media_file_id": None, "media_type": None,
        "main_channel": None, "sponsors": [],
        "finish_time_str": default_finish.isoformat(),
        "winners": 1, "ref_req": 0, "is_captcha": False,
        "message_manager_data": {}
    })
    await state.set_state(ConstructorState.editing_content)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é "–®–∞–≥ 1"
    hint_text = await get_control_hint('content')
    kb = InlineKeyboardMarkup(inline_keyboard=[[InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_creation")]])
    
    if isinstance(event, types.CallbackQuery):
        msg = await event.message.answer(hint_text, reply_markup=kb)
        try: await event.message.delete()
        except: pass
    else:
        msg = await event.answer(hint_text, reply_markup=kb)
    
    manager = await get_message_manager(state)
    manager.set_instruction_message(msg)
    await update_message_manager(state, manager)

@router.callback_query(F.data == "cancel_creation")
async def cancel_creation(call: types.CallbackQuery, state: FSMContext, bot: Bot):
    manager = await get_message_manager(state)
    await manager.delete_all(bot, call.message.chat.id)
    await state.clear()
    await call.message.answer("‚ùå –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.", reply_markup=start_menu_kb())

@router.message(ConstructorState.editing_content)
async def receive_content(message: types.Message, state: FSMContext, bot: Bot):
    # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    try: await message.delete()
    except: pass

    manager = await get_message_manager(state)

    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–∏–ø—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    media_id, media_type = None, None
    
    if message.photo:
        media_id, media_type = message.photo[-1].file_id, "photo"
    elif message.video:
        media_id, media_type = message.video.file_id, "video"
    elif message.animation:
        media_id, media_type = message.animation.file_id, "animation"
    elif message.document or message.voice or message.audio or message.sticker or message.video_note:
        # –ï—Å–ª–∏ –ø—Ä–∏—Å–ª–∞–ª–∏ —Ñ–∞–π–ª, –≥–æ–ª–æ—Å–æ–≤–æ–µ, —Å—Ç–∏–∫–µ—Ä –∏–ª–∏ –∫—Ä—É–∂–æ—á–µ–∫ - —Ä—É–≥–∞–µ–º—Å—è
        err_msg = await message.answer(
            "‚ùå <b>–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç!</b>\n\n"
            "–ë–æ—Ç –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–æ–ª—å–∫–æ:\n"
            "‚Ä¢ –û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç\n"
            "‚Ä¢ –§–æ—Ç–æ\n"
            "‚Ä¢ –í–∏–¥–µ–æ\n"
            "‚Ä¢ GIF (–ê–Ω–∏–º–∞—Ü–∏—è)\n\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏—à–ª–∏—Ç–µ –ø–æ—Å—Ç –≤ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ."
        )
        manager.add_temp_message(err_msg)
        await update_message_manager(state, manager)
        return

    # 2. –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç (HTML)
    html_content = get_message_html(message)
    safe_text = sanitize_text(html_content)
    
    # --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô ---
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ª–∏–º–∏—Ç—ã Telegram
    TELEGRAM_CAPTION_LIMIT = 1024
    TELEGRAM_TEXT_LIMIT = 4096
    
    # –†–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º –º–µ—Å—Ç–æ –ø–æ–¥ "–§—É—Ç–µ—Ä" (–ö–æ–ª-–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, —Ç–∞–π–º–µ—Ä –∏ —Ç.–¥.)
    # –ë–µ—Ä–µ–º —Å –∑–∞–ø–∞—Å–æ–º, —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ –≤–ª–µ–∑–ª–æ
    FOOTER_RESERVE = 200
    
    # –í—ã—á–∏—Å–ª—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if media_type:
        # –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ
        limit = TELEGRAM_CAPTION_LIMIT - FOOTER_RESERVE # 1024 - 200 = 824
        limit_name = "–ø–æ–¥–ø–∏—Å–∏ –∫ –º–µ–¥–∏–∞"
    else:
        # –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç
        limit = TELEGRAM_TEXT_LIMIT - FOOTER_RESERVE # 4096 - 200 = 3896
        limit_name = "—Å–æ–æ–±—â–µ–Ω–∏—è"
    
    current_len = len(safe_text)

    # –ü–†–û–í–ï–†–ö–ê
    if current_len > limit:
        diff = current_len - limit
        
        if media_type:
            text_err = (
                f"‚ùå <b>–°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ!</b>\n\n"
                f"Telegram –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –¥–ª–∏–Ω—É –ø–æ–¥–ø–∏—Å–∏ –∫ —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ –¥–æ <b>1024</b> —Å–∏–º–≤–æ–ª–æ–≤.\n"
                f"–ú—ã —Ä–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º <b>{FOOTER_RESERVE}</b> —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è —Å—á–µ—Ç—á–∏–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏ —Ç–∞–π–º–µ—Ä–∞.\n\n"
                f"üìè –í–∞—à —Ç–µ–∫—Å—Ç: <b>{current_len}</b>\n"
                f"‚õî –õ–∏–º–∏—Ç: <b>{limit}</b>\n"
                f"‚úÇÔ∏è –ù—É–∂–Ω–æ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –Ω–∞: <b>{diff}</b> —Å–∏–º–≤–æ–ª–æ–≤.\n\n"
                f"üí° <i>–°–æ–≤–µ—Ç: –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º (–±–µ–∑ –∫–∞—Ä—Ç–∏–Ω–∫–∏), —Ç–æ–≥–¥–∞ –ª–∏–º–∏—Ç –±—É–¥–µ—Ç 4000 —Å–∏–º–≤–æ–ª–æ–≤.</i>"
            )
        else:
            text_err = (
                f"‚ùå <b>–¢–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π!</b>\n\n"
                f"üìè –í–∞—à —Ç–µ–∫—Å—Ç: <b>{current_len}</b>\n"
                f"‚õî –õ–∏–º–∏—Ç (—Å —É—á–µ—Ç–æ–º —Ñ—É—Ç–µ—Ä–∞): <b>{limit}</b>\n"
                f"‚úÇÔ∏è –ù—É–∂–Ω–æ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –Ω–∞: <b>{diff}</b> —Å–∏–º–≤–æ–ª–æ–≤."
            )
            
        err_msg = await message.answer(text_err)
        manager.add_temp_message(err_msg)
        await update_message_manager(state, manager)
        return

    # --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô ---

    # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ—Ç—É (–µ—Å–ª–∏ –ø—Ä–∏—Å–ª–∞–ª–∏ —Ç–æ–ª—å–∫–æ –∫–∞—Ä—Ç–∏–Ω–∫—É –±–µ–∑ —Ç–µ–∫—Å—Ç–∞, –∏–ª–∏ —Ç–µ–∫—Å—Ç –ø—É—Å—Ç–æ–π)
    # –•–æ—Ç—è –ø—É—Å—Ç–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ –¥–æ–ø—É—Å—Ç–∏–º–∞, –Ω–æ –¥–ª—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ –Ω—É–∂–µ–Ω —Ç–µ–∫—Å—Ç —É—Å–ª–æ–≤–∏–π.
    if not safe_text and not media_type:
        err_msg = await message.answer("‚ùå –°–æ–æ–±—â–µ–Ω–∏–µ –ø—É—Å—Ç–æ–µ. –ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç —É—Å–ª–æ–≤–∏–π —Ä–æ–∑—ã–≥—Ä—ã—à–∞.")
        manager.add_temp_message(err_msg)
        await update_message_manager(state, manager)
        return
        
    if not safe_text and media_type:
        # –ï—Å–ª–∏ –ø—Ä–∏—Å–ª–∞–ª–∏ –ø—Ä–æ—Å—Ç–æ –∫–∞—Ä—Ç–∏–Ω–∫—É –±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è
        err_msg = await message.answer("‚ö†Ô∏è <b>–î–æ–±–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ!</b>\n\n–ü—Ä–∏—à–ª–∏—Ç–µ —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ —Å—Ä–∞–∑—É —Å —Ç–µ–∫—Å—Ç–æ–º (–≤ –ø–æ–¥–ø–∏—Å–∏), —á—Ç–æ–±—ã —É—á–∞—Å—Ç–Ω–∏–∫–∏ –∑–Ω–∞–ª–∏ —É—Å–ª–æ–≤–∏—è.")
        manager.add_temp_message(err_msg)
        await update_message_manager(state, manager)
        return
    
    # 5. –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
    await state.update_data(text=safe_text, media_file_id=media_id, media_type=media_type)
    await state.set_state(ConstructorState.editing_short_description)
    
    # 6. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
    hint_text = "üìù <b>–®–∞–≥ 2 –∏–∑ 7: –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</b>\n\n–í–≤–µ–¥–∏—Ç–µ –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ —Ä–æ–∑—ã–≥—Ä—ã—à–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, \"iPhone 17\", \"30 –ø–æ–¥–∞—Ä–∫–æ–≤\", \"VIP-–¥–æ—Å—Ç—É–ø\", \"–ù–µ–¥–µ–ª—è –ø—Ä–∏–∑–æ–≤\"). –≠—Ç–æ –æ–ø–∏—Å–∞–Ω–∏–µ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤ —Å–ø–∏—Å–∫–µ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π."
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_creation")]
    ])
    
    msg = await message.answer(hint_text, reply_markup=kb)
    manager = await get_message_manager(state)
    manager.add_temp_message(msg)
    await update_message_manager(state, manager)

@router.message(ConstructorState.editing_short_description)
async def receive_short_description(message: types.Message, state: FSMContext, bot: Bot):
    # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    try: await message.delete()
    except: pass

    manager = await get_message_manager(state)
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –æ–ø–∏—Å–∞–Ω–∏—è
    short_description = message.text.strip() if message.text else ""
    
    if not short_description:
        err_msg = await message.answer("‚ùå –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞.")
        manager.add_temp_message(err_msg)
        await update_message_manager(state, manager)
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É –æ–ø–∏—Å–∞–Ω–∏—è
    if len(short_description) > 255:
        err_msg = await message.answer("‚ùå –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–∫—Ä–∞—Ç–∏—Ç–µ –µ–≥–æ –¥–æ 255 —Å–∏–º–≤–æ–ª–æ–≤.")
        manager.add_temp_message(err_msg)
        await update_message_manager(state, manager)
        return

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
    await state.update_data(short_description=short_description)
    await state.set_state(ConstructorState.init)
    
    # –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    await refresh_constructor_view(bot, state, message.chat.id, hint_key='main_channel')=== ./handlers/creator/constructor/structure.py ===
from aiogram.fsm.state import State, StatesGroup
from aiogram import types
from aiogram.exceptions import TelegramBadRequest

class ConstructorState(StatesGroup):
    init = State()
    editing_content = State()
    editing_short_description = State()  # –ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –≤–≤–æ–¥–∞ –∫—Ä–∞—Ç–∫–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è
    confirm_short_text = State()
    adding_channel = State()
    adding_channel_link = State()
    editing_winners = State()  # –ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –≤–≤–æ–¥–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π –≤—Ä—É—á–Ω—É—é
    editing_referral = State() # –ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –≤–≤–æ–¥–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –≤—Ä—É—á–Ω—É—é

async def safe_edit_to_text(message: types.Message, text: str, reply_markup=None):
    """
    –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º.
    """
    try:
        if message.photo or message.video or message.animation or message.document:
            await message.delete()
            await message.answer(text, reply_markup=reply_markup)
        else:
            await message.edit_text(text, reply_markup=reply_markup)
    except TelegramBadRequest:
        try: await message.edit_text(text, reply_markup=reply_markup)
        except: pass
    except Exception:
        await message.answer(text, reply_markup=reply_markup)=== ./handlers/creator/constructor/message_manager.py ===
from aiogram import types, Bot
from aiogram.fsm.context import FSMContext
from typing import List, Optional
import logging

logger = logging.getLogger(__name__)

class MessageManager:
    """–ö–ª–∞—Å—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ"""
    
    def __init__(self):
        self.preview_message_id = None      # ID —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (–ø–æ—Å—Ç)
        self.control_message_id = None      # ID —Å–æ–æ–±—â–µ–Ω–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–∫–Ω–æ–ø–∫–∏)
        self.instruction_message_id = None  # ID —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π (–®–∞–≥ 1)
        self.temp_messages = []             # –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–æ—à–∏–±–∫–∏, –¥–∏–∞–ª–æ–≥–∏ –≤–≤–æ–¥–∞)
    
    def set_preview_message(self, message: types.Message):
        if message:
            self.preview_message_id = message.message_id
    
    def set_control_message(self, message: types.Message):
        if message:
            self.control_message_id = message.message_id
        
    def set_instruction_message(self, message: types.Message):
        if message:
            self.instruction_message_id = message.message_id

    def add_temp_message(self, message: types.Message):
        if message:
            self.temp_messages.append(message.message_id)
    
    async def delete_all(self, bot: Bot, chat_id: int):
        """–£–¥–∞–ª—è–µ—Ç –í–°–ï —Å–æ–æ–±—â–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞"""
        ids_to_delete = []
        
        if self.preview_message_id: ids_to_delete.append(self.preview_message_id)
        if self.control_message_id: ids_to_delete.append(self.control_message_id)
        if self.instruction_message_id: ids_to_delete.append(self.instruction_message_id)
        ids_to_delete.extend(self.temp_messages)
        
        # –£–¥–∞–ª—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ ID, —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å –∑–∞–ø—Ä–æ—Å–∞–º–∏
        for msg_id in set(ids_to_delete):
            try:
                await bot.delete_message(chat_id, msg_id)
            except Exception:
                # –°–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ —É–¥–∞–ª–µ–Ω–æ –∏–ª–∏ —Å–ª–∏—à–∫–æ–º —Å—Ç–∞—Ä–æ–µ
                pass
        
        # –û—á–∏—â–∞–µ–º –ø–∞–º—è—Ç—å
        self.clear()

    def clear(self):
        self.preview_message_id = None
        self.control_message_id = None
        self.instruction_message_id = None
        self.temp_messages = []
    
    def to_dict(self) -> dict:
        return {
            'preview_message_id': self.preview_message_id,
            'control_message_id': self.control_message_id,
            'instruction_message_id': self.instruction_message_id,
            'temp_messages': self.temp_messages
        }
    
    @classmethod
    def from_dict(cls, data: dict):
        manager = cls()
        manager.preview_message_id = data.get('preview_message_id')
        manager.control_message_id = data.get('control_message_id')
        manager.instruction_message_id = data.get('instruction_message_id')
        manager.temp_messages = data.get('temp_messages', [])
        return manager

async def get_message_manager(state: FSMContext) -> MessageManager:
    data = await state.get_data()
    if 'message_manager_data' not in data:
        manager = MessageManager()
        await state.update_data(message_manager_data=manager.to_dict())
        return manager
    return MessageManager.from_dict(data['message_manager_data'])

async def update_message_manager(state: FSMContext, manager: MessageManager):
    await state.update_data(message_manager_data=manager.to_dict())=== ./handlers/creator/constructor/settings.py ===
from aiogram import Router, types, F, Bot
from aiogram.fsm.context import FSMContext
from sqlalchemy.ext.asyncio import AsyncSession
from database.models.user import User
from handlers.creator.constructor.structure import ConstructorState
from handlers.creator.constructor.control_message import get_control_hint, refresh_constructor_view
from handlers.creator.constructor.message_manager import get_message_manager, update_message_manager
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton

router = Router()

@router.callback_query(F.data == "constr_edit_content")
async def ask_new_content(call: types.CallbackQuery, state: FSMContext, bot: Bot):
    await state.set_state(ConstructorState.editing_content)
    
    # –£–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–ø—Ä–µ–≤—å—é –∏ –∫–Ω–æ–ø–∫–∏)
    manager = await get_message_manager(state)
    await manager.delete_all(bot, call.message.chat.id)
    
    # –®–ª–µ–º –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –∫ –≤–≤–æ–¥—É "–®–∞–≥ 1"
    hint_text = await get_control_hint('content')
    kb = InlineKeyboardMarkup(inline_keyboard=[[InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="constr_back_main")]])
    msg = await call.message.answer(hint_text, reply_markup=kb)
    
    # –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –∫–∞–∫ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
    manager.set_instruction_message(msg)
    await update_message_manager(state, manager)

@router.callback_query(F.data.startswith("constr_set_winners:"))
async def set_winners(call: types.CallbackQuery, state: FSMContext, bot: Bot):
    count = int(call.data.split(":")[-1])
    await state.update_data(winners=count)
    # –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
    await refresh_constructor_view(bot, state, call.message.chat.id, hint_key='publish')
    await call.answer(f"‚úÖ –ü–æ–±–µ–¥–∏—Ç–µ–ª–µ–π: {count}")

@router.callback_query(F.data.startswith("constr_set_ref:"))
async def set_ref(call: types.CallbackQuery, state: FSMContext, bot: Bot):
    count = int(call.data.split(":")[-1])
    await state.update_data(ref_req=count)
    # –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
    await refresh_constructor_view(bot, state, call.message.chat.id, hint_key='publish')
    await call.answer(f"‚úÖ –†–µ—Ñ–µ—Ä–∞–ª–æ–≤: {count}")

@router.callback_query(F.data == "constr_toggle_cap")
async def toggle_cap(call: types.CallbackQuery, state: FSMContext, session: AsyncSession, bot: Bot):
    data = await state.get_data()
    
    if not data['is_captcha']:
        user = await session.get(User, call.from_user.id)
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
        from filters.admin_filter import IsAdmin
        is_admin = await IsAdmin().__call__(call)
        
        if not is_admin and (not user or not user.is_premium or (user.premium_until and user.premium_until < datetime.utcnow())):
            return await call.answer("üîí –§—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ —Å Premium!", show_alert=True)
            
    await state.update_data(is_captcha=not data['is_captcha'])
    # –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
    await refresh_constructor_view(bot, state, call.message.chat.id, hint_key='publish')
    await call.answer("‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∞")


@router.callback_query(F.data == "constr_toggle_hidden_participants")
async def toggle_hidden_participants(call: types.CallbackQuery, state: FSMContext, session: AsyncSession, bot: Bot):
    data = await state.get_data()
    
    user = await session.get(User, call.from_user.id)
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
    from filters.admin_filter import IsAdmin
    is_admin = await IsAdmin().__call__(call)
    
    if not is_admin and (not user or not user.is_premium or (user.premium_until and user.premium_until < datetime.utcnow())):
        return await call.answer("üîí –§—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ —Å Premium!", show_alert=True)
        
    await state.update_data(is_participants_hidden=not data.get('is_participants_hidden', False))
    # –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
    await refresh_constructor_view(bot, state, call.message.chat.id, hint_key='publish')
    await call.answer("‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∞")

@router.callback_query(F.data == "constr_back_main")
async def back_to_main(call: types.CallbackQuery, state: FSMContext, bot: Bot):
    await state.set_state(ConstructorState.init)
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    await refresh_constructor_view(bot, state, call.message.chat.id, hint_key='default')=== ./handlers/creator/constructor/winners_selector.py ===
from aiogram import Router, types, F, Bot
from aiogram.fsm.context import FSMContext
from keyboards.inline.constructor import winners_selector_kb
from handlers.creator.constructor.structure import ConstructorState
from handlers.creator.constructor.control_message import refresh_constructor_view
from handlers.creator.constructor.message_manager import get_message_manager, update_message_manager

router = Router()

@router.callback_query(F.data == "constr_winners_menu")
async def winners_menu(call: types.CallbackQuery, state: FSMContext, bot: Bot):
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π (–ü—Ä–µ–≤—å—é + –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π)
    await refresh_constructor_view(
        bot, state, call.message.chat.id, 
        hint_key='winners', 
        custom_keyboard=winners_selector_kb()
    )
    await call.answer()

@router.callback_query(F.data.startswith("constr_set_winners:"))
async def set_winners(call: types.CallbackQuery, state: FSMContext, bot: Bot):
    winners_count = int(call.data.split(":")[-1])
    await state.update_data(winners=winners_count)
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (hint_key='publish' –∏–ª–∏ 'default')
    await refresh_constructor_view(bot, state, call.message.chat.id, hint_key='publish')
    await call.answer(f"‚úÖ –ü–æ–±–µ–¥–∏—Ç–µ–ª–µ–π: {winners_count}")

@router.callback_query(F.data == "constr_set_winners_input")
async def ask_winners_input(call: types.CallbackQuery, state: FSMContext, bot: Bot):
    await state.set_state(ConstructorState.editing_winners)
    
    # –£–¥–∞–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    manager = await get_message_manager(state)
    await manager.delete_all(bot, call.message.chat.id)
    
    msg = await call.message.answer("üî¢ <b>–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π</b> (1-50):")
    manager.add_temp_message(msg)
    await update_message_manager(state, manager)

@router.message(ConstructorState.editing_winners)
async def process_winners_input(message: types.Message, state: FSMContext, bot: Bot):
    try: await message.delete()
    except: pass
    
    manager = await get_message_manager(state)
    text = message.text.strip()
    
    if not text.isdigit() or not (1 <= int(text) <= 50):
        msg = await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 50")
        manager.add_temp_message(msg)
        await update_message_manager(state, manager)
        return
        
    await state.update_data(winners=int(text))
    await state.set_state(ConstructorState.init)
    
    # –í–æ–∑–≤—Ä–∞—Ç –≤ –º–µ–Ω—é
    await refresh_constructor_view(bot, state, message.chat.id, hint_key='publish')=== ./handlers/creator/constructor/__init__.py ===
from aiogram import Router
from . import start_content, settings, channels_select, channels_add, publication, winners_selector, referral_selector

router = Router()

router.include_router(start_content.router)
router.include_router(settings.router)
router.include_router(channels_select.router)
router.include_router(channels_add.router)
router.include_router(publication.router)
router.include_router(winners_selector.router)
router.include_router(referral_selector.router)=== ./handlers/creator/constructor/control_message.py ===
from datetime import datetime
from aiogram import Router, types, Bot
from aiogram.types import InlineKeyboardMarkup
from aiogram.fsm.context import FSMContext
from keyboards.inline.constructor import constructor_main_kb
from handlers.creator.constructor.message_manager import get_message_manager, update_message_manager
import logging

logger = logging.getLogger(__name__)

# –¢–µ–∫—Å—Ç—ã –ø–æ–¥—Å–∫–∞–∑–æ–∫ (–í–æ–∑–≤—Ä–∞—â–µ–Ω—ã –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ, –ø–æ–¥—Ä–æ–±–Ω—ã–µ –≤–µ—Ä—Å–∏–∏)
CONTROL_HINTS = {
    'main_channel': (
        "üì¢ <b>–®–∞–≥ 2: –í—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞</b>\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–∞–ª, –≥–¥–µ –±—É–¥–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω —Ä–æ–∑—ã–≥—Ä—ã—à.\n\n"
        "‚ö†Ô∏è <b>–í–∞–∂–Ω–æ:</b>\n"
        "‚Ä¢ –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º\n"
        "‚Ä¢ –≠—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–∞–Ω–∞–ª –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤\n"
        "‚Ä¢ –ò–∑ –Ω–µ–≥–æ –±—É–¥—É—Ç —Ä–µ–ø–æ—Å—Ç–∏—Ç—å—Å—è —Å–ø–æ–Ω—Å–æ—Ä—ã\n\n"
        "–ù–∞–∂–º–∏—Ç–µ <b>–ö–∞–Ω–∞–ª—ã</b> –¥–ª—è –≤—ã–±–æ—Ä–∞."
    ),
    
    'sponsors': (
        "ü§ù <b>–®–∞–≥ 3: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–ø–æ–Ω—Å–æ—Ä–æ–≤</b>\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–∞–ª—ã, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è —É—á–∞—Å—Ç–Ω–∏–∫–∞–º.\n\n"
        "‚úÖ <b>–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:</b>\n"
        "‚Ä¢ –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –æ—Ö–≤–∞—Ç\n"
        "‚Ä¢ –ü–æ–≤—ã—à–∞–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å –∫ —Ä–æ–∑—ã–≥—Ä—ã—à—É\n"
        "‚Ä¢ –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ 20 –∫–∞–Ω–∞–ª–æ–≤\n\n"
        "–ù–∞–∂–º–∏—Ç–µ <b>–°–ø–æ–Ω—Å–æ—Ä—ã</b> –¥–ª—è –≤—ã–±–æ—Ä–∞."
    ),
    
    'time': (
        "‚è≥ <b>–®–∞–≥ 4: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</b>\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ, —á–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è —Ä–æ–∑—ã–≥—Ä—ã—à.\n\n"
        "üìÖ <b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</b>\n"
        "‚Ä¢ –ú–∏–Ω–∏–º—É–º: 1 —á–∞—Å\n"
        "‚Ä¢ –û–ø—Ç–∏–º–∞–ª—å–Ω–æ: 24-72 —á–∞—Å–∞\n"
        "‚Ä¢ –ú–∞–∫—Å–∏–º—É–º: 30 –¥–Ω–µ–π\n\n"
        "–ù–∞–∂–º–∏—Ç–µ <b>–ò—Ç–æ–≥–∏</b> –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏."
    ),
    
    'winners': (
        "üèÜ <b>–®–∞–≥ 5: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π</b>\n\n"
        "–£–∫–∞–∂–∏—Ç–µ, —Å–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫ –ø–æ–ª—É—á–∞—Ç –ø—Ä–∏–∑.\n\n"
        "üí° <b>–°–æ–≤–µ—Ç—ã:</b>\n"
        "‚Ä¢ 1-3 –ø–æ–±–µ–¥–∏—Ç–µ–ª—è - –¥–ª—è –Ω–µ–±–æ–ª—å—à–∏—Ö –ø—Ä–∏–∑–æ–≤\n"
        "‚Ä¢ 5-10 –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π - –¥–ª—è —Å—Ä–µ–¥–Ω–∏—Ö –ø—Ä–∏–∑–æ–≤\n"
        "‚Ä¢ 20+ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π - –¥–ª—è –∫—Ä—É–ø–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π\n\n"
        "–ù–∞–∂–º–∏—Ç–µ <b>–ü–æ–±–µ–¥–∏—Ç–µ–ª–∏</b> –¥–ª—è –≤—ã–±–æ—Ä–∞."
    ),
    
    'referral': (
        "üîó <b>–®–∞–≥ 6: –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</b>\n\n"
        "–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –±–æ–Ω—É—Å—ã –∑–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –¥—Ä—É–∑–µ–π.\n\n"
        "üéÅ <b>–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:</b>\n"
        "‚Ä¢ –ó–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞ +1 –±–∏–ª–µ—Ç\n"
        "‚Ä¢ –ú–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–∏–º–∏—Ç (1-10 –¥—Ä—É–∑–µ–π)\n"
        "‚Ä¢ –ü–æ–≤—ã—à–∞–µ—Ç –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å\n\n"
        "–ù–∞–∂–º–∏—Ç–µ <b>–†–µ—Ñ</b> –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏."
    ),
    
    'captcha': (
        "üõ° <b>–®–∞–≥ 7: –ó–∞—â–∏—Ç–∞ –æ—Ç –±–æ—Ç–æ–≤</b>\n\n"
        "–í–∫–ª—é—á–∏—Ç–µ –∫–∞–ø—á—É –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –Ω–∞–∫—Ä—É—Ç–∫–∏.\n\n"
        "üîí <b>–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:</b>\n"
        "‚Ä¢ –û—Ç—Å–µ–∏–≤–∞–µ—Ç 99% –±–æ—Ç–æ–≤\n"
        "‚Ä¢ –¢–æ–ª—å–∫–æ Premium –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏\n"
        "‚Ä¢ –ü–æ–≤—ã—à–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤\n\n"
        "–ù–∞–∂–º–∏—Ç–µ <b>–ö–∞–ø—á–∞</b> –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è."
    ),
    
    'content': (
        "‚úèÔ∏è <b>–®–∞–≥ 1: –¢–µ–∫—Å—Ç –∏ –º–µ–¥–∏–∞</b>\n\n"
        "–ò–∑–º–µ–Ω–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ–ø–∏—Å–∞–Ω–∏—è –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ.\n\n"
        "üìù <b>–°–æ–≤–µ—Ç—ã:</b>\n"
        "‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–∂–∏—Ä–Ω—ã–π, –∫—É—Ä—Å–∏–≤)\n"
        "‚Ä¢ –î–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –¥–ª—è –ª—É—á—à–µ–≥–æ –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è\n"
        "‚Ä¢ –£–∫–∞–∂–∏—Ç–µ —É—Å–ª–æ–≤–∏—è —É—á–∞—Å—Ç–∏—è\n\n"
        "–ù–∞–∂–º–∏—Ç–µ <b>–ò–∑–º–µ–Ω–∏—Ç—å –¢–µ–∫—Å—Ç/–ú–µ–¥–∏–∞</b> –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è."
    ),
    
    'publish': (
        "‚úÖ <b>–ì–æ—Ç–æ–≤–æ –∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏!</b>\n\n"
        "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:\n"
        "‚Ä¢ –¢–µ–∫—Å—Ç —Ä–æ–∑—ã–≥—Ä—ã—à–∞\n"
        "‚Ä¢ –ö–∞–Ω–∞–ª –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏\n"
        "‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π\n"
        "‚Ä¢ –í—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è\n\n"
        "üéØ <b>–í–∞–∂–Ω–æ:</b>\n"
        "‚Ä¢ –ü–æ—Å–ª–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã\n"
        "‚Ä¢ –†–æ–∑—ã–≥—Ä—ã—à –Ω–∞—á–Ω–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏\n"
        "‚Ä¢ –ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—Å—è –ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏\n\n"
        "–ù–∞–∂–º–∏—Ç–µ <b>–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨</b> –¥–ª—è –∑–∞–ø—É—Å–∫–∞."
    ),
    
    'default': (
        "üéØ <b>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π</b>\n\n"
        "–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–æ–∑—ã–≥—Ä—ã—à–∞:\n\n"
        "1Ô∏è‚É£ <b>–ö–∞–Ω–∞–ª:</b> –ì–¥–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å\n"
        "2Ô∏è‚É£ <b>–°–ø–æ–Ω—Å–æ—Ä—ã:</b> –ù–∞ —á—Ç–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è\n"
        "3Ô∏è‚É£ <b>–ò—Ç–æ–≥–∏:</b> –ö–æ–≥–¥–∞ –∑–∞–≤–µ—Ä—à–∏—Ç—å\n"
        "4Ô∏è‚É£ <b>–ü–æ–±–µ–¥–∏—Ç–µ–ª–∏:</b> –°–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫\n"
        "5Ô∏è‚É£ <b>–†–µ—Ñ:</b> –ó–∞ –¥—Ä—É–∑–µ–π –±–æ–Ω—É—Å\n"
        "6Ô∏è‚É£ <b>–ö–∞–ø—á–∞:</b> –ó–∞—â–∏—Ç–∞ –æ—Ç –±–æ—Ç–æ–≤\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏!"
    )
}

async def get_control_hint(key: str) -> str:
    return CONTROL_HINTS.get(key, CONTROL_HINTS['default'])

async def refresh_constructor_view(
    bot: Bot, 
    state: FSMContext, 
    chat_id: int, 
    hint_key: str = 'default',
    custom_keyboard: InlineKeyboardMarkup = None
):
    """
    –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:
    1. –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–ü—Ä–µ–≤—å—é –∏ –ö–æ–Ω—Ç—Ä–æ–ª—å).
    2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–µ –ü—Ä–µ–≤—å—é (–ø–æ—Å—Ç).
    3. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–π –ö–æ–Ω—Ç—Ä–æ–ª—å (–∫–Ω–æ–ø–∫–∏ —Å –ø–æ–¥—Ä–æ–±–Ω–æ–π –ø–æ–¥—Å–∫–∞–∑–∫–æ–π).
    """
    manager = await get_message_manager(state)
    
    # 1. –£–¥–∞–ª—è–µ–º –í–°–Å —Å—Ç–∞—Ä–æ–µ
    await manager.delete_all(bot, chat_id)
    
    data = await state.get_data()
    
    # 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ü–†–ï–í–¨–Æ (–ü–æ—Å—Ç)
    try:
        finish_dt = datetime.fromisoformat(data['finish_time_str'])
        date_str = finish_dt.strftime('%d.%m %H:%M –ú–°–ö')
    except:
        date_str = "..."
        
    caption = f"{data['text']}\n\n<i>(–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä. –ò—Ç–æ–≥–∏: {date_str})</i>"
    
    try:
        if data['media_type'] == 'photo': 
            preview_msg = await bot.send_photo(chat_id, data['media_file_id'], caption=caption)
        elif data['media_type'] == 'video': 
            preview_msg = await bot.send_video(chat_id, data['media_file_id'], caption=caption)
        elif data['media_type'] == 'animation': 
            preview_msg = await bot.send_animation(chat_id, data['media_file_id'], caption=caption)
        else: 
            preview_msg = await bot.send_message(chat_id, text=caption, disable_web_page_preview=True)
            
        manager.set_preview_message(preview_msg)
    except Exception as e:
        logger.error(f"Failed to send preview: {e}")
        # –ï—Å–ª–∏ –º–µ–¥–∏–∞ —É–¥–∞–ª–µ–Ω–æ –∏–ª–∏ –æ—à–∏–±–∫–∞, —à–ª–µ–º —Ç–µ–∫—Å—Ç
        preview_msg = await bot.send_message(chat_id, text=f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –º–µ–¥–∏–∞ (—Ñ–∞–π–ª —É—Å—Ç–∞—Ä–µ–ª).\n\n{caption}")
        manager.set_preview_message(preview_msg)

    # 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ö–û–ù–¢–†–û–õ–¨ (–ö–Ω–æ–ø–∫–∏ + –ü–æ–¥—Ä–æ–±–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞)
    hint_text = await get_control_hint(hint_key)
    
    if custom_keyboard:
        # –ï—Å–ª–∏ –º—ã –≤ –ø–æ–¥–º–µ–Ω—é, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
        kb = custom_keyboard
    else:
        # –ò–Ω–∞—á–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        winners = data.get('winners', 1)
        ref_req = data.get('ref_req', 0)
        is_cap = data.get('is_captcha', False)
        has_main = bool(data.get('main_channel'))
        sponsors_len = len(data.get('sponsors', []))
        
        kb = constructor_main_kb(
            "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤—Ä–µ–º—è", winners, ref_req, is_cap, has_main, sponsors_len, data.get('is_participants_hidden', False)
        )
    
    control_msg = await bot.send_message(chat_id, hint_text, reply_markup=kb)
    manager.set_control_message(control_msg)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–µ ID
    await update_message_manager(state, manager)=== ./handlers/creator/constructor/channels_select.py ===
from aiogram import Router, types, F, Bot
from aiogram.fsm.context import FSMContext
from sqlalchemy.ext.asyncio import AsyncSession
import logging

from database.requests.channel_repo import get_user_channels
from keyboards.inline.constructor import channel_selection_kb
from handlers.creator.constructor.control_message import refresh_constructor_view

logger = logging.getLogger(__name__)
router = Router()

async def show_channels_selection(
    bot: Bot,
    state: FSMContext, 
    session: AsyncSession, 
    user_id: int, 
    mode: str, 
    chat_id: int
):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –∫–∞–Ω–∞–ª–æ–≤ —á–µ—Ä–µ–∑ refresh_constructor_view.
    """
    data = await state.get_data()
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤ –∏–∑ –ë–î
    channels = await get_user_channels(session, user_id)
    
    if mode == 'main':
        sel = [data['main_channel']['id']] if data.get('main_channel') else []
        hint_key = 'main_channel'
    else:
        # –î–ª—è —Å–ø–æ–Ω—Å–æ—Ä–æ–≤ –∏—Å–∫–ª—é—á–∞–µ–º —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –æ—Å–Ω–æ–≤–Ω–æ–π –∫–∞–Ω–∞–ª
        main_id = data['main_channel']['id'] if data.get('main_channel') else None
        channels = [ch for ch in channels if ch.channel_id != main_id]
        
        sel = [s['id'] for s in data.get('sponsors', [])]
        hint_key = 'sponsors'
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    kb = channel_selection_kb(channels, mode, sel)
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–ü—Ä–µ–≤—å—é + –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ –∫–∞–Ω–∞–ª–æ–≤)
    await refresh_constructor_view(bot, state, chat_id, hint_key=hint_key, custom_keyboard=kb)

# --- –•–ï–ù–î–õ–ï–†–´ ---

@router.callback_query(F.data == "constr_select_main")
async def select_main_menu(call: types.CallbackQuery, session: AsyncSession, state: FSMContext, bot: Bot):
    await state.update_data(channel_selector_mode="main")
    await show_channels_selection(bot, state, session, call.from_user.id, "main", call.message.chat.id)
    await call.answer()

@router.callback_query(F.data == "constr_select_sponsors")
async def select_sponsors_menu(call: types.CallbackQuery, session: AsyncSession, state: FSMContext, bot: Bot):
    from datetime import datetime
    user = await session.get(User, call.from_user.id)
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
    from filters.admin_filter import IsAdmin
    is_admin = await IsAdmin().__call__(call)
    
    if not is_admin and (not user or not user.is_premium or (user.premium_until and user.premium_until < datetime.utcnow())):
        return await call.answer("üîí –í—ã–±–æ—Ä –±–æ–ª–µ–µ 5 —Å–ø–æ–Ω—Å–æ—Ä–æ–≤ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ —Å Premium!", show_alert=True)
    
    await state.update_data(channel_selector_mode="sponsor")
    await show_channels_selection(bot, state, session, call.from_user.id, "sponsor", call.message.chat.id)
    await call.answer()

@router.callback_query(F.data.startswith("constr_set_ch:"))
async def set_channel(call: types.CallbackQuery, state: FSMContext, bot: Bot, session: AsyncSession):
    _, mode, ch_id_str = call.data.split(":")
    chat_id = int(ch_id_str)
    
    from database.requests.channel_repo import get_user_channels
    user_chs = await get_user_channels(session, call.from_user.id)
    target_ch = next((ch for ch in user_chs if ch.channel_id == chat_id), None)
    
    if not target_ch: 
        return await call.answer("‚ùå –ö–∞–Ω–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω!", show_alert=True)

    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö –∫–∞–Ω–∞–ª–∞
    link = target_ch.invite_link or (f"@{target_ch.username}" if target_ch.username else "private")
    channel_info = {
        'id': chat_id, 
        'title': target_ch.title, 
        'link': link,
        'db_id': target_ch.id
    }
    
    data = await state.get_data()
    sponsors = data.get('sponsors', [])

    if mode == "main":
        # –õ–æ–≥–∏–∫–∞ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞
        if data.get('main_channel') and data['main_channel']['id'] == chat_id:
            await state.update_data(main_channel=None) # –°–Ω—è—Ç—å –≤—ã–±–æ—Ä
        else:
            # –ï—Å–ª–∏ –±—ã–ª –≤ —Å–ø–æ–Ω—Å–æ—Ä–∞—Ö - —É–±—Ä–∞—Ç—å
            if any(s['id'] == chat_id for s in sponsors):
                sponsors = [s for s in sponsors if s['id'] != chat_id]
                await state.update_data(sponsors=sponsors)
            
            await state.update_data(main_channel=channel_info)
            
        # –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥ (–æ—Å—Ç–∞–µ–º—Å—è –≤ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ main)
        await show_channels_selection(bot, state, session, call.from_user.id, "main", call.message.chat.id)
        
    else:  # mode == "sponsor"
        # –õ–æ–≥–∏–∫–∞ –¥–ª—è —Å–ø–æ–Ω—Å–æ—Ä–æ–≤
        if any(s['id'] == chat_id for s in sponsors):
            sponsors = [s for s in sponsors if s['id'] != chat_id] # –£–¥–∞–ª–∏—Ç—å
            await state.update_data(sponsors=sponsors)
        else:
            main_ch = data.get('main_channel')
            if main_ch and main_ch['id'] == chat_id:
                return await call.answer("‚ùå –≠—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–∞–Ω–∞–ª!", show_alert=True)
            
            sponsors.append(channel_info) # –î–æ–±–∞–≤–∏—Ç—å
            await state.update_data(sponsors=sponsors)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥ (–æ—Å—Ç–∞–µ–º—Å—è –≤ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ sponsors)
        await show_channels_selection(bot, state, session, call.from_user.id, "sponsor", call.message.chat.id)=== ./handlers/creator/time_picker.py ===
from aiogram import Router, types, F, Bot
from aiogram.fsm.context import FSMContext
from core.tools.timezone import get_now_msk
from datetime import datetime
from keyboards.inline.calendar_kb import generate_calendar, time_picker_kb
from handlers.creator.constructor.control_message import refresh_constructor_view

router = Router()

@router.callback_query(F.data == "constr_time_menu")
async def open_calendar(call: types.CallbackQuery):
    now = get_now_msk()
    await call.message.edit_reply_markup(reply_markup=generate_calendar(now.year, now.month))

@router.callback_query(F.data.startswith("cal_nav:"))
async def navigate_calendar(call: types.CallbackQuery):
    _, y, m = call.data.split(":")
    await call.message.edit_reply_markup(reply_markup=generate_calendar(int(y), int(m)))

@router.callback_query(F.data.startswith("date_set:"))
async def pick_date(call: types.CallbackQuery):
    _, y, m, d = call.data.split(":")
    await call.message.edit_reply_markup(reply_markup=time_picker_kb(int(y), int(m), int(d)))

@router.callback_query(F.data.startswith("time_set:"))
async def pick_time(call: types.CallbackQuery, state: FSMContext, bot: Bot):
    _, y, m, d, h, mn = call.data.split(":")
    
    try:
        from core.tools.timezone import MSK
        dt_msk = datetime(int(y), int(m), int(d), int(h), int(mn), tzinfo=MSK)
        
        if dt_msk <= get_now_msk():
            return await call.answer("‚ùå –í—Ä–µ–º—è —É–∂–µ –ø—Ä–æ—à–ª–æ!", show_alert=True)
            
        await state.update_data(finish_time_str=dt_msk.isoformat())
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: —É–¥–∞–ª—è–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å (—ç—Ç–æ —Å—Ç–∞—Ä–æ–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ) –∏ —Ä–∏—Å—É–µ–º –∑–∞–Ω–æ–≤–æ
        await refresh_constructor_view(bot, state, call.message.chat.id, hint_key='publish')
        
    except ValueError:
        await call.answer("–û—à–∏–±–∫–∞ –¥–∞—Ç—ã")=== ./handlers/creator/__init__.py ===
# handlers/creator/__init__.py
from aiogram import Router

from . import time_picker
from . import constructor

router = Router()

# Include sub-routers
router.include_router(time_picker.router)
router.include_router(constructor.router)=== ./handlers/participant/join.py ===
from typing import Union
from aiogram import Router, Bot, F
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import StatesGroup, State
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, Message, CallbackQuery
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from redis.asyncio import Redis
from config import config

from database.models.participant import Participant
from database.models.giveaway import Giveaway
from database.requests.giveaway_repo import get_giveaway_by_id, get_required_channels
from database.requests.participant_repo import (
    add_participant,
    increment_ticket,
    is_circular_referral,
    is_participant_active,
    add_pending_referral, # <---
    get_pending_referral  # <---
)
from keyboards.inline.participation import check_subscription_kb
from core.logic.ticket_gen import get_unique_ticket
from core.services.ref_service import create_ref_link
from core.services.checker_service import is_user_subscribed

router = Router()

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Redis –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
redis = Redis.from_url(config.REDIS_URL)

class JoinState(StatesGroup):
    captcha = State()
    subscribing = State()

@router.callback_query(F.data == "broken_link_alert")
async def broken_link_handler(call: CallbackQuery):
    await call.answer("‚ö†Ô∏è –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞–π—Ç–∏ –µ–≥–æ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ —Å–æ–æ–±—â–∏—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.", show_alert=True)

async def try_join_giveaway(
    message_or_call: Message | CallbackQuery,
    gw_id: int,
    session: AsyncSession,
    bot: Bot,
    state: FSMContext,
    referrer_id: int = None
):
    if isinstance(message_or_call, CallbackQuery):
        message = message_or_call.message
        user = message_or_call.from_user
        await message_or_call.answer()
    else:
        message = message_or_call
        user = message_or_call.from_user

    gw = await get_giveaway_by_id(session, gw_id)
    
    # 1. –ï—Å–ª–∏ —Ä–æ–∑—ã–≥—Ä—ã—à —É–¥–∞–ª–µ–Ω –∏–∑ –±–∞–∑—ã
    if not gw:
        return await message.answer("‚ùå <b>–≠—Ç–æ—Ç —Ä–æ–∑—ã–≥—Ä—ã—à –±—ã–ª —É–¥–∞–ª–µ–Ω –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–æ–º.</b>")
        
    # 2. –ï—Å–ª–∏ —Ä–æ–∑—ã–≥—Ä—ã—à —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –≤—Ä–µ–º—è –≤—ã—à–ª–æ
    if gw.status != 'active':
        return await message.answer("üèÅ <b>–≠—Ç–æ—Ç —Ä–æ–∑—ã–≥—Ä—ã—à —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω. –ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã.</b>")

    if user.id == gw.owner_id:
        return await message.answer("‚ö†Ô∏è –í—ã –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä —ç—Ç–æ–≥–æ —Ä–æ–∑—ã–≥—Ä—ã—à–∞.")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ, –∏—Å–ø–æ–ª—å–∑—É—è —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å
    existing_stmt = select(Participant).where(
        Participant.user_id == user.id,
        Participant.giveaway_id == gw_id
    )
    existing = await session.scalar(existing_stmt)
    
    bot_username = (await bot.get_me()).username

    if existing:
        text = (
            f"üëã <b>–¢—ã —É–∂–µ –≤ –∏–≥—Ä–µ!</b>\n\n"
            f"üé´ –¢–≤–æ–π –±–∏–ª–µ—Ç: <code>{existing.ticket_code}</code>\n"
            f"‚ö°Ô∏è –®–∞–Ω—Å–æ–≤ –Ω–∞ –ø–æ–±–µ–¥—É: <b>{existing.tickets_count}</b>"
        )
        if gw.is_referral_enabled:
            token = await create_ref_link(user.id)
            ref_link = f"https://t.me/{bot_username}?start=gw_{gw_id}_{token}"
            text += f"\n\nüîó –¢–≤–æ—è —Ä–µ—Ñ. —Å—Å—ã–ª–∫–∞:\n<code>{ref_link}</code>"
        
        try: await message.answer(text, disable_web_page_preview=True)
        except Exception: pass
        return

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º Redis Lock –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è race condition –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    lock_key = f"join_lock:{gw_id}:{user.id}"
    lock = redis.lock(lock_key, timeout=10, blocking_timeout=5)
    
    try:
        # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
        acquired = await lock.acquire(blocking=False)
        if not acquired:
            return await message.answer("‚è≥ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        
        # –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ–ª –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
        # –ø–æ–∫–∞ –º—ã –∂–¥–∞–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
        existing = await session.scalar(existing_stmt)
        if existing:
            text = (
                f"üëã <b>–¢—ã —É–∂–µ –≤ –∏–≥—Ä–µ!</b>\n\n"
                f"üé´ –¢–≤–æ–π –±–∏–ª–µ—Ç: <code>{existing.ticket_code}</code>\n"
                f"‚ö°Ô∏è –®–∞–Ω—Å–æ–≤ –Ω–∞ –ø–æ–±–µ–¥—É: <b>{existing.tickets_count}</b>"
            )
            if gw.is_referral_enabled:
                token = await create_ref_link(user.id)
                ref_link = f"https://t.me/{bot_username}?start=gw_{gw_id}_{token}"
                text += f"\n\nüîó –¢–≤–æ—è —Ä–µ—Ñ. —Å—Å—ã–ª–∫–∞:\n<code>{ref_link}</code>"
            
            try: await message.answer(text, disable_web_page_preview=True)
            except Exception: pass
            return

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª–∞ –≤ –ë–î (–Ω–∞–¥–µ–∂–Ω–æ)
        if referrer_id:
            await add_pending_referral(session, user.id, referrer_id, gw_id)
        
        await state.update_data(gw_id=gw_id)

        if gw.is_captcha_enabled:
            await state.set_state(JoinState.captcha)
            kb = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="ü§ñ –Ø –Ω–µ —Ä–æ–±–æ—Ç", callback_data="captcha_solved")]
            ])
            await message.answer("üõ° <b>–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –±–æ—Ç–∞</b>\n–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.", reply_markup=kb)
            return

        await check_subscriptions_step(message, user.id, gw, session, bot, state)
    finally:
        # –í –ª—é–±–æ–º —Å–ª—É—á–∞–µ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
        await lock.release()

@router.callback_query(JoinState.captcha, F.data == "captcha_solved")
async def captcha_solved(call: CallbackQuery, state: FSMContext, session: AsyncSession, bot: Bot):
    data = await state.get_data()
    gw_id = data.get("gw_id")
    gw = await get_giveaway_by_id(session, gw_id)
    
    if not gw:
        await call.answer("–û—à–∏–±–∫–∞")
        return await state.clear()
    
    await call.message.delete()
    await check_subscriptions_step(call.message, call.from_user.id, gw, session, bot, state)

# ... (–∏–º–ø–æ—Ä—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º–∏) ...
from aiogram.exceptions import TelegramForbiddenError, TelegramBadRequest # –î–æ–±–∞–≤—å –≤ –∏–º–ø–æ—Ä—Ç—ã

async def check_subscriptions_step(message: Message, user_id: int, gw: Giveaway, session: AsyncSession, bot: Bot, state: FSMContext, force_check: bool = False):
    reqs = await get_required_channels(session, gw.id)
    
    channels_status = []
    all_subscribed = True
    critical_error = None # –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –æ—à–∏–±–∫–∏ –¥–æ—Å—Ç—É–ø–∞

    # --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –±–æ—Ç–∞ ---
    async def check_bot_access(channel_id: int, channel_title: str = "–∫–∞–Ω–∞–ª"):
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∏–¥–∏—Ç –ª–∏ –±–æ—Ç —Å–∞–º —Å–µ–±—è –≤ —ç—Ç–æ–º –∫–∞–Ω–∞–ª–µ
            # –ï—Å–ª–∏ –±–æ—Ç–∞ –∫–∏–∫–Ω—É–ª–∏, —ç—Ç–æ—Ç –º–µ—Ç–æ–¥ –≤—ã–∑–æ–≤–µ—Ç TelegramForbiddenError
            member = await bot.get_chat_member(channel_id, bot.id)
            if member.status not in ("administrator", "creator"):
                return f"‚ö†Ô∏è <b>–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞!</b>\n–ë–æ—Ç –ø–µ—Ä–µ—Å—Ç–∞–ª –±—ã—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –≤ –∫–∞–Ω–∞–ª–µ (ID: {channel_id}).\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–æ–±—â–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä—É."
            return None
        except (TelegramForbiddenError, TelegramBadRequest):
            return f"‚ö†Ô∏è <b>–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞!</b>\n–ë–æ—Ç –±—ã–ª —É–¥–∞–ª–µ–Ω –∏–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –≤ –∫–∞–Ω–∞–ª–µ (ID: {channel_id}).\n–†–æ–∑—ã–≥—Ä—ã—à –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
    # -----------------------------------------------------

    # 1. –û—Å–Ω–æ–≤–Ω–æ–π –∫–∞–Ω–∞–ª
    try:
        is_sub = await is_user_subscribed(bot, gw.channel_id, user_id, force_check=force_check)
        
        # –ï–°–õ–ò –ü–û–î–ü–ò–°–ö–ò –ù–ï–¢ -> –ü–†–û–í–ï–†–Ø–ï–ú, –ñ–ò–í –õ–ò –ë–û–¢
        if not is_sub:
            error = await check_bot_access(gw.channel_id)
            if error:
                critical_error = error
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–π –∫–Ω–æ–ø–∫–∏
        from core.services.channel_service import ChannelService
        chat_info = await ChannelService.get_chat_info_safe(bot, gw.channel_id)
        
        if chat_info:
            link = chat_info['invite_link'] or (f"https://t.me/{chat_info['username']}" if chat_info['username'] else None)
            
            channels_status.append({
                'title': f"üì¢ {chat_info['title']}",
                'link': link,
                'is_subscribed': is_sub
            })
            if not is_sub: all_subscribed = False
            
    except Exception as e:
        # –ï—Å–ª–∏ —Å–æ–≤—Å–µ–º –≤—Å—ë –ø–ª–æ—Ö–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞–Ω–∞–ª —É–¥–∞–ª–µ–Ω)
        critical_error = f"‚ö†Ô∏è –ö–∞–Ω–∞–ª —Ä–æ–∑—ã–≥—Ä—ã—à–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ —É–¥–∞–ª–µ–Ω.\n–û—à–∏–±–∫–∞: {e}"

    # –ï—Å–ª–∏ —É–∂–µ –Ω–∞—à–ª–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é –æ—à–∏–±–∫—É - –ø—Ä–µ—Ä—ã–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å–ø–æ–Ω—Å–æ—Ä–æ–≤
    if not critical_error:
        # 2. –°–ø–æ–Ω—Å–æ—Ä—ã
        for r in reqs:
            is_sub = await is_user_subscribed(bot, r.channel_id, user_id, force_check=force_check)
            
            # –ï–°–õ–ò –ü–û–î–ü–ò–°–ö–ò –ù–ï–¢ -> –ü–†–û–í–ï–†–Ø–ï–ú, –ñ–ò–í –õ–ò –ë–û–¢
            if not is_sub:
                error = await check_bot_access(r.channel_id)
                if error:
                    critical_error = error
                    break # –ü—Ä–µ—Ä—ã–≤–∞–µ–º —Ü–∏–∫–ª, –Ω–µ—Ç —Å–º—ã—Å–ª–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –¥–∞–ª—å—à–µ

            link = r.channel_link if r.channel_link and len(r.channel_link) > 5 else None
            
            channels_status.append({
                'title': r.channel_title,
                'link': link,
                'is_subscribed': is_sub
            })
            if not is_sub: all_subscribed = False

    # --- –û–ë–†–ê–ë–û–¢–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–û–í ---

    # –°—Ü–µ–Ω–∞—Ä–∏–π –ê: –ë–æ—Ç –ø–æ—Ç–µ—Ä—è–ª –¥–æ—Å—Ç—É–ø (–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞)
    if critical_error:
        await message.answer(critical_error)
        return # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

    # –°—Ü–µ–Ω–∞—Ä–∏–π –ë: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω (–û–±—ã—á–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å)
    if not all_subscribed:
        await state.set_state(JoinState.subscribing)
        text = "üîí <b>–î–ª—è —É—á–∞—Å—Ç–∏—è –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–¥–∞–Ω–∏—è:</b>\n(–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫–∏, –ø–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ)"
        
        kb = check_subscription_kb(gw.id, channels_status)
        
        from core.services.message_service import MessageHandler
        try:
            result = await MessageHandler.safe_edit_text(
                bot=message.bot,
                chat_id=message.chat.id,
                message_id=message.message_id,
                text=text,
                reply_markup=kb
            )
            if not result:
                await message.answer(text, reply_markup=kb)
        except Exception:
            await message.answer(text, reply_markup=kb)
            
    # –°—Ü–µ–Ω–∞—Ä–∏–π –í: –í—Å–µ –æ—Ç–ª–∏—á–Ω–æ
    else:
        # ... (–∫–æ–¥ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –∏ finalize_registration –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º) ...
        from core.services.message_service import MessageHandler
        try:
            await MessageHandler.safe_delete_message(message.bot, message.chat.id, message.message_id)
        except: pass
        
        await finalize_registration(message, user_id, gw, session, bot, state)

@router.callback_query(F.data.startswith("check_sub:"))
async def on_check_subscription_btn(call: CallbackQuery, session: AsyncSession, bot: Bot, state: FSMContext):
    gw_id = int(call.data.split(":")[-1])
    gw = await get_giveaway_by_id(session, gw_id)
    
    if not gw or gw.status != 'active':
        return await call.message.edit_text("‚ùå –†–æ–∑—ã–≥—Ä—ã—à –∑–∞–≤–µ—Ä—à–µ–Ω.")
    
    await check_subscriptions_step(call.message, call.from_user.id, gw, session, bot, state, force_check=True)
    await call.answer()

async def finalize_registration(
    message: Message,
    user_id: int,
    gw: Giveaway,
    session: AsyncSession,
    bot: Bot,
    state: FSMContext
):
    # –î–æ—Å—Ç–∞–µ–º —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ –∏–∑ –ë–î (–Ω–∞–¥–µ–∂–Ω–æ)
    referrer_id = await get_pending_referral(session, user_id, gw.id)
    
    final_referrer = None
    
    if gw.is_referral_enabled and referrer_id:
        if referrer_id == user_id:
            referrer_id = None
        elif await is_circular_referral(session, user_id, referrer_id, gw.id):
            referrer_id = None
        elif not await is_participant_active(session, referrer_id, gw.id):
            referrer_id = None
        else:
            final_referrer = referrer_id

    ticket = await get_unique_ticket(session, gw.id)
    is_new = await add_participant(session, user_id, gw.id, final_referrer, ticket)
    
    if not is_new:
        p = await session.scalar(select(Participant).where(Participant.user_id==user_id, Participant.giveaway_id==gw.id))
        ticket = p.ticket_code if p else "ERROR"
    else:
        if final_referrer:
            await increment_ticket(session, final_referrer, gw.id)
            try:
                await bot.send_message(final_referrer, f"üë§ –ü–æ –≤–∞—à–µ–π —Å—Å—ã–ª–∫–µ –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ #{gw.id} –Ω–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫! (+1 –±–∏–ª–µ—Ç)")
            except Exception as e:
                # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Ä–µ—Ñ–µ—Ä–µ—Ä—É
                import logging
                logger = logging.getLogger(__name__)
                logger.error(f"Error sending message to referrer {final_referrer}: {e}")
                pass

    text = (
        f"üéâ <b>–ü–û–ó–î–†–ê–í–õ–Ø–ï–ú, –í–´ –í –ò–ì–†–ï!</b>\n\n"
        f"üé´ –¢–≤–æ–π –±–∏–ª–µ—Ç: <code>{ticket}</code>"
    )

    if gw.is_referral_enabled:
        bot_username = (await bot.get_me()).username
        token = await create_ref_link(user_id)
        ref_link = f"https://t.me/{bot_username}?start=gw_{gw.id}_{token}"
        text += (
            f"\n\nüöÄ <b>–£–≤–µ–ª–∏—á—å —à–∞–Ω—Å—ã –Ω–∞ –ø–æ–±–µ–¥—É!</b>\n"
            f"–ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–∑–µ–π –ø–æ —ç—Ç–æ–π —Å—Å—ã–ª–∫–µ –∏ –ø–æ–ª—É—á–∏ +1 –±–∏–ª–µ—Ç –∑–∞ –∫–∞–∂–¥–æ–≥–æ:\n"
            f"<code>{ref_link}</code>"
        )
    
    from core.services.message_service import MessageHandler
    try:
        result = await MessageHandler.safe_edit_text(
            bot=message.bot,
            chat_id=message.chat.id,
            message_id=message.message_id,
            text=text,
            disable_web_page_preview=True
        )
        if not result:
            await message.answer(text, disable_web_page_preview=True)
    except Exception as e:
        # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
        import logging
        logger = logging.getLogger(__name__)
        logger.error(f"Error editing final registration message: {e}")
        await message.answer(text, disable_web_page_preview=True)
        
    await state.clear()=== ./handlers/common/start.py ===
from typing import Union
from aiogram import Router, types, Bot
from aiogram.filters import CommandStart, CommandObject
from aiogram.fsm.context import FSMContext
from aiogram.types import Message, CallbackQuery
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select

from database.requests.user_repo import register_user
from database.models.winner import Winner
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≥–ª–∞–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –≤—Ö–æ–¥–∞ (–æ–Ω–∞ —Ç–µ–ø–µ—Ä—å –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è try_join_giveaway)
from handlers.participant.join import try_join_giveaway
from core.services.ref_service import resolve_ref_link

router = Router()

@router.message(CommandStart())
async def cmd_start(
    message: Message,
    command: CommandObject,
    session: AsyncSession,
    bot: Bot,
    state: FSMContext
):
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —é–∑–µ—Ä–∞ (–∏–º—è, username) –≤ –±–∞–∑–µ users
    await register_user(session, message.from_user.id, message.from_user.username, message.from_user.full_name)

    args = command.args
    if not args:
        import logging
        logger = logging.getLogger(__name__)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        user_id = message.from_user.id
        user_full_name = message.from_user.full_name
        user_username = message.from_user.username
        logger.info(f"User info - ID: {user_id}, Full Name: {user_full_name}, Username: {user_username}")
        
        logger.info(f"Regular user, showing standard greeting")
        return await message.answer(f"üëã –ü—Ä–∏–≤–µ—Ç, {message.from_user.first_name}!")
    else:
        # –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–ø–ª–∏–Ω–∫–æ–≤
        user_id = message.from_user.id
        print(f"DEBUG: User {user_id} sent /start with args: {args}")
        
        # 1. –ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (res_ID)
        if args.startswith("res_"):
            try: gw_id = int(args.replace("res_", ""))
            except: return

            stmt = select(Winner).where(Winner.giveaway_id == gw_id)
            winners = (await session.execute(stmt)).scalars().all()
            
            if not winners:
                return await message.answer("üòî –ü–æ–±–µ–¥–∏—Ç–µ–ª–µ–π –Ω–µ—Ç –∏–ª–∏ —Ä–æ–∑—ã–≥—Ä—ã—à –µ—â–µ –∏–¥–µ—Ç.")
                
            text = "üèÜ <b>–°–ø–∏—Å–æ–∫ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π:</b>\n"
            is_winner = False
            for i, w in enumerate(winners, 1):
                if w.user_id == message.from_user.id: is_winner = True
                try:
                    c = await bot.get_chat(w.user_id)
                    name = f"@{c.username}" if c.username else c.full_name
                    text += f"{i}. {name}\n"
                except:
                    text += f"{i}. ID {w.user_id}\n"
        
            if is_winner: text = "üéâ <b>–í–´ –í–´–ò–ì–†–ê–õ–ò!</b> üéâ\n\n" + text
            return await message.answer(text)

        # 2. –£—á–∞—Å—Ç–∏–µ –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ (gw_ID_TOKEN)
        if args.startswith("gw_"):
            clean_args = args.replace("gw_", "")
            parts = clean_args.split("_")
            
            try:
                gw_id = int(parts[0])
            except ValueError:
                return await message.answer("‚ùå –°—Å—ã–ª–∫–∞ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∞.")

            referrer_id = None
            # –ï—Å–ª–∏ –µ—Å—Ç—å –≤—Ç–æ—Ä–∞—è —á–∞—Å—Ç—å (—Ç–æ–∫–µ–Ω —Ä–µ—Ñ–µ—Ä–∞–ª–∞)
            if len(parts) > 1:
                token = parts[1]
                candidate_id = await resolve_ref_link(token)
                
                # –ë–∞–∑–æ–≤–∞—è –∑–∞—â–∏—Ç–∞: –Ω–µ–ª—å–∑—è –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è
                if candidate_id and candidate_id != message.from_user.id:
                    referrer_id = candidate_id

            # –ü–µ—Ä–µ–¥–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ –ª–æ–≥–∏–∫—É –≤—Ö–æ–¥–∞
            await try_join_giveaway(message, gw_id, session, bot, state, referrer_id)

=== ./handlers/__init__.py ===
from .common.start import router as start_router
from .user import *
from .creator import *
from .participant import *
from .admin import *

__all__ = [
    "start_router",
    # user routers
    "dashboard_router",
    "my_channels_router", 
    "my_giveaways_router",
    "my_participations_router",
    "premium_router",
    # creator routers
    "creator_router",
    "time_picker_router",
    # constructor routers
    "constructor_router",
    "channels_add_router",
    "channels_select_router",
    "control_message_router",
    "message_manager_router",
    "publication_router",
    "referral_selector_router",
    "settings_router",
    "start_content_router",
    "structure_router",
    "winners_selector_router",
    # participant routers
    "join_router",
    # admin routers
    "admin_router"
]=== ./handlers/user/my_channels.py ===
import logging
from aiogram import Router, types, F, Bot
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import StatesGroup, State
from sqlalchemy.ext.asyncio import AsyncSession

from database.requests.channel_repo import add_channel, get_user_channels, delete_channel_by_id
from keyboards.inline.dashboard import channels_list_kb, back_to_dash, skip_link_kb

router = Router()
logger = logging.getLogger(__name__)

class ChannelState(StatesGroup):
    waiting_for_forward = State()
    waiting_for_link = State()

async def show_channels_list_msg(message_or_call, session: AsyncSession, user_id: int):
    channels = await get_user_channels(session, user_id)
    text = "üì¢ <b>–ú–æ–∏ –∫–∞–Ω–∞–ª—ã</b>\n\n–°–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤, –≥–¥–µ –±–æ—Ç —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º."
    kb = channels_list_kb(channels)
    
    if isinstance(message_or_call, types.CallbackQuery):
        await message_or_call.message.edit_text(text, reply_markup=kb)
    else:
        await message_or_call.answer(text, reply_markup=kb)

@router.callback_query(F.data == "my_channels")
async def show_channels(call: types.CallbackQuery, session: AsyncSession):
    await show_channels_list_msg(call, session, call.from_user.id)

@router.callback_query(F.data == "add_new_channel")
async def ask_channel(call: types.CallbackQuery, state: FSMContext):
    await state.set_state(ChannelState.waiting_for_forward)
    await call.message.edit_text(
        "‚ûï <b>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ (–®–∞–≥ 1/2)</b>\n\n"
        "1. –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –∫–∞–Ω–∞–ª–∞.\n"
        "2. –ü–µ—Ä–µ—à–ª–∏—Ç–µ —Å—é–¥–∞ –ª—é–±–æ–π –ø–æ—Å—Ç –∏–∑ –∫–∞–Ω–∞–ª–∞ (–∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ @username).",
        reply_markup=back_to_dash()
    )

@router.message(ChannelState.waiting_for_forward)
async def process_channel_step1(message: types.Message, state: FSMContext, bot: Bot):
    chat_id = None
    title = "No Title"
    username = None

    if message.forward_from_chat:
        chat_id = message.forward_from_chat.id
        title = message.forward_from_chat.title
        username = message.forward_from_chat.username
    elif message.text and message.text.startswith("@"):
        try:
            chat = await bot.get_chat(message.text)
            chat_id = chat.id
            title = chat.title
            username = chat.username
        except:
            await message.answer("‚ùå –ù–µ –º–æ–≥—É –Ω–∞–π—Ç–∏ –∫–∞–Ω–∞–ª. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ @username.")
            return

    if not chat_id:
        await message.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–∞–Ω–∞–ª.")
        return

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
    try:
        member = await bot.get_chat_member(chat_id, bot.id)
        if member.status not in ("administrator", "creator"):
            await message.answer("‚ùå –ë–æ—Ç –Ω–µ –∞–¥–º–∏–Ω! –î–∞–π—Ç–µ –ø—Ä–∞–≤–∞ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
            return
    except Exception as e:
        await message.answer(f"‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞: {e}")
        return

    # --- –ù–û–í–û–ï: –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è ---
    invite_link = None
    if username:
        invite_link = f"https://t.me/{username}"
    else:
        # –ï—Å–ª–∏ –∫–∞–Ω–∞–ª –ø—Ä–∏–≤–∞—Ç–Ω—ã–π, –ø—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å –∏–ª–∏ –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É
        try:
            # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º —ç–∫—Å–ø–æ—Ä—Ç (–µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å)
            invite_link = await bot.export_chat_invite_link(chat_id)
        except:
            try:
                # –ï—Å–ª–∏ –Ω–µ –≤—ã—à–ª–æ, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é
                link_obj = await bot.create_chat_invite_link(chat_id, name="Giveaway Bot")
                invite_link = link_obj.invite_link
            except Exception as e:
                logger.warning(f"Could not generate link for {chat_id}: {e}")

    await state.update_data(temp_channel={
        "id": chat_id, 
        "title": title, 
        "username": username,
        "auto_link": invite_link
    })
    
    await state.set_state(ChannelState.waiting_for_link)
    
    text = f"‚úÖ –ö–∞–Ω–∞–ª <b>{title}</b> –Ω–∞–π–¥–µ–Ω!\n"
    if invite_link:
        text += f"üîó –°—Å—ã–ª–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞: {invite_link}\n\n–ù–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å¬ª, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ—ë, –∏–ª–∏ –ø—Ä–∏—à–ª–∏—Ç–µ —Å–≤–æ—é."
    else:
        text += "\nüîó <b>–®–∞–≥ 2/2:</b> –Ø –Ω–µ —Å–º–æ–≥ –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É (–∫–∞–Ω–∞–ª –ø—Ä–∏–≤–∞—Ç–Ω—ã–π?). –ü—Ä–∏—à–ª–∏—Ç–µ –∏–Ω–≤–∞–π—Ç-—Å—Å—ã–ª–∫—É –≤—Ä—É—á–Ω—É—é."

    await message.answer(text, reply_markup=skip_link_kb("settings"))

@router.message(ChannelState.waiting_for_link)
async def process_link_text(message: types.Message, state: FSMContext, session: AsyncSession):
    link = message.text.strip()
    if "t.me" not in link and not link.startswith("https://"):
        await message.answer("‚ùå –≠—Ç–æ –Ω–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ —Å—Å—ã–ª–∫—É.")
        return

    data = await state.get_data()
    ch_data = data['temp_channel']
    
    await add_channel(session, message.from_user.id, ch_data['id'], ch_data['title'], ch_data['username'], link)
    
    await message.answer(f"‚úÖ –ö–∞–Ω–∞–ª <b>{ch_data['title']}</b> —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!")
    await state.clear()
    await show_channels_list_msg(message, session, message.from_user.id)

@router.callback_query(ChannelState.waiting_for_link, F.data == "skip_link_settings")
async def process_link_skip(call: types.CallbackQuery, state: FSMContext, session: AsyncSession):
    data = await state.get_data()
    ch_data = data['temp_channel']
    
    final_link = ch_data.get('auto_link')
    if not final_link:
        return await call.answer("‚ùå –°—Å—ã–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø—Ä–∏—à–ª–∏—Ç–µ –≤—Ä—É—á–Ω—É—é.", show_alert=True)

    await add_channel(session, call.from_user.id, ch_data['id'], ch_data['title'], ch_data['username'], final_link)
    
    await call.message.delete()
    await call.message.answer(f"‚úÖ –ö–∞–Ω–∞–ª <b>{ch_data['title']}</b> —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!")
    await state.clear()
    await show_channels_list_msg(call.message, session, call.from_user.id)

@router.callback_query(F.data.startswith("del_ch_"))
async def delete_ch(call: types.CallbackQuery, session: AsyncSession):
    try:
        ch_id = int(call.data.split("_")[-1])
        await delete_channel_by_id(session, ch_id, call.from_user.id)
        await call.answer("üóë –ö–∞–Ω–∞–ª —É–¥–∞–ª–µ–Ω.")
        await show_channels(call, session)
    except Exception as e:
        logger.error(f"Error deleting channel: {e}")
        await call.answer("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è", show_alert=True)=== ./handlers/user/dashboard.py ===
from aiogram import Router, Bot, F
from aiogram.filters import CommandStart, CommandObject
from aiogram.fsm.context import FSMContext
from aiogram.types import Message, CallbackQuery
from sqlalchemy.ext.asyncio import AsyncSession
from aiogram.exceptions import TelegramBadRequest # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ

from database.requests.user_repo import register_user
from keyboards.inline.dashboard import start_menu_kb, cabinet_kb
from handlers.common.start import cmd_start as deep_link_logic

router = Router()

@router.message(CommandStart())
async def smart_dashboard(
    message: Message,
    command: CommandObject,
    session: AsyncSession,
    bot: Bot,
    state: FSMContext
):
    # DeepLink (—Ä–µ—Ñ–∫–∏ –∏ —É—á–∞—Å—Ç–∏–µ)
    if command.args and (command.args.startswith("gw_") or command.args.startswith("res_")):
        await deep_link_logic(message, command, session, bot, state)
        return

    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    await register_user(session, message.from_user.id, message.from_user.username, message.from_user.full_name)
    
    text = (
        f"üëã <b>–ü—Ä–∏–≤–µ—Ç, {message.from_user.first_name}!</b>\n"
        f"–≠—Ç–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —á–µ—Å—Ç–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π.\n\n"
        f"–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
    )

    await message.answer(text, reply_markup=start_menu_kb())

@router.callback_query(F.data == "dashboard_home")
async def back_home(call: CallbackQuery):
    try:
        await call.message.edit_text(
            "üëã <b>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</b>\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
            reply_markup=start_menu_kb()
        )
    except TelegramBadRequest:
        # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å - –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å —á–∞—Å–∏–∫–∏
        await call.answer()

@router.callback_query(F.data == "cabinet_hub")
async def open_cabinet(call: CallbackQuery, session: AsyncSession):
    text = (
        "üë§ <b>–ö–∞–±–∏–Ω–µ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞</b>\n\n"
        f"üÜî ID: <code>{call.from_user.id}</code>\n"
        "üìä –ó–¥–µ—Å—å –≤—ã —É–ø—Ä–∞–≤–ª—è–µ—Ç–µ –∫–∞–Ω–∞–ª–∞–º–∏ –∏ –ø–æ–¥–ø–∏—Å–∫–æ–π."
    )
    try:
        await call.message.edit_text(text, reply_markup=cabinet_kb())
    except TelegramBadRequest:
        await call.answer()=== ./handlers/user/premium.py ===
from datetime import datetime, timedelta
from aiogram import Router, types, F, Bot
from aiogram.types import LabeledPrice, PreCheckoutQuery
from sqlalchemy.ext.asyncio import AsyncSession
from database.models.user import User
from keyboards.inline.dashboard import premium_shop_kb

router = Router()

@router.callback_query(F.data == "premium_shop")
async def show_shop(call: types.CallbackQuery, session: AsyncSession):
    user = await session.get(User, call.from_user.id)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
    from filters.admin_filter import IsAdmin
    is_admin = await IsAdmin().__call__(call)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–∫—Ç–∏–≤–Ω–∞ –ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞
    is_premium_active = False
    if user.is_premium and user.premium_until:
        if user.premium_until > datetime.utcnow():
            is_premium_active = True
        else:
            # –ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞
            user.is_premium = False
            await session.commit()
    
    # –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
    if is_admin:
        status_text = "üëë <b>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</b>"
        is_premium_active = True  # –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ
    else:
        status_text = (
            f"‚úÖ <b>–ê–∫—Ç–∏–≤–Ω–∞ –¥–æ:</b> {user.premium_until.strftime('%d.%m.%Y')}"
            if is_premium_active else "‚ùå <b>–ù–µ –∞–∫—Ç–∏–≤–Ω–∞</b>"
        )

    text = (
        f"üëë <b>PREMIUM –ü–û–î–ü–ò–°–ö–ê</b>\n"
        f"–°—Ç–∞—Ç—É—Å: {status_text}\n\n"
        
        "–û—Ñ–æ—Ä–º–∏—Ç–µ –µ–¥–∏–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É –∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–π—Ç–µ <b>–í–°–ï</b> –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π:\n\n"
        
        "üöÄ <b>–ë—É—Å—Ç-–±–∏–ª–µ—Ç—ã –∏ –°—Ç–æ—Ä–∏—Å</b>\n"
        "–î–∞–≤–∞–π—Ç–µ —Ö3-—Ö5 –±–∏–ª–µ—Ç–æ–≤ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º —Å Telegram Premium –∏–ª–∏ –∑–∞ —Ä–µ–ø–æ—Å—Ç –≤ —Å—Ç–æ—Ä–∏—Å. –ë—ã—Å—Ç—Ä—ã–π —Ä–æ—Å—Ç —É—Ä–æ–≤–Ω—è –∫–∞–Ω–∞–ª–∞!\n\n"
        
        "üìä <b>–≠–∫—Å–ø–æ—Ä—Ç –±–∞–∑—ã (Excel/CSV)</b>\n"
        "–í—ã–≥—Ä—É–∂–∞–π—Ç–µ ID –∏ —é–∑–µ—Ä–Ω–µ–π–º—ã —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è —Ç–∞—Ä–≥–µ—Ç–∏–Ω–≥–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.\n\n"
        
        "üïµÔ∏è <b>–°–∫—Ä—ã—Ç—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏</b>\n"
        "–°–∫—Ä–æ–π—Ç–µ —Å—á–µ—Ç—á–∏–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –æ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ (–Ω–∞–ø–∏—à–µ–º ¬´–ú–Ω–æ–≥–æ¬ª).\n\n"
        
        "üëª <b>White Label</b>\n"
        "–ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–ø–∏—Ä–∞–π—Ç–∞ ¬´–°–æ–∑–¥–∞–Ω–æ —á–µ—Ä–µ–∑ –±–æ—Ç–∞¬ª –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π.\n\n"
        
        "üìà <b>PRO –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</b>\n"
        "–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Ö–æ–¥–∞–º, —Å–ø–æ–Ω—Å–æ—Ä–∞–º –∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏.\n\n"
        
        "üõ° <b>–ö–∞–ø—á–∞ (–ê–Ω—Ç–∏-–±–æ—Ç)</b>\n"
        "–ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–∞–∫—Ä—É—Ç–∫–∏ —Ñ–µ—Ä–º–∞–º–∏.\n\n"
        
        "‚ö°Ô∏è <b>–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ª–∏–º–∏—Ç—ã</b>\n"
        "‚Ä¢ –î–æ 20+ –∫–∞–Ω–∞–ª–æ–≤-—Å–ø–æ–Ω—Å–æ—Ä–æ–≤\n"
        "‚Ä¢ –ë–æ–ª—å—à–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π\n\n"
        
        "üí∞ <b>–°—Ç–æ–∏–º–æ—Å—Ç—å: 250 ‚≠êÔ∏è (Stars) / 30 –¥–Ω–µ–π</b>"
    )
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
    # –õ—É—á—à–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º, –µ—Å–ª–∏ –µ—Å—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∞, –Ω–æ –ø–æ–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º
    await call.message.edit_text(text, reply_markup=premium_shop_kb(is_premium_active))

@router.callback_query(F.data == "buy_premium_sub")
async def buy_process(call: types.CallbackQuery, bot: Bot):
    await bot.send_invoice(
        chat_id=call.from_user.id,
        title="Premium –ü–æ–¥–ø–∏—Å–∫–∞ (30 –¥–Ω–µ–π)",
        description="–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –í–°–ï–• —Ñ—É–Ω–∫—Ü–∏–π: –ë—É—Å—Ç—ã, Excel, White Label, –ê–Ω–∞–ª–∏—Ç–∏–∫–∞, –ö–∞–ø—á–∞.",
        payload="buy_monthly_sub",
        currency="XTR",
        prices=[LabeledPrice(label="30 –¥–Ω–µ–π", amount=250)], # 250 –∑–≤–µ–∑–¥
        provider_token="" # –í–ê–ñ–ù–û: –î–ª—è Telegram Stars –ø–æ–ª–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç—ã–º!
    )
    await call.answer()

@router.pre_checkout_query()
async def on_pre_checkout(pre_checkout_query: PreCheckoutQuery, bot: Bot):
    await bot.answer_pre_checkout_query(pre_checkout_query.id, ok=True)

@router.message(F.successful_payment)
async def on_successful_payment(message: types.Message, session: AsyncSession):
    payment = message.successful_payment
    
    if payment.invoice_payload == "buy_monthly_sub":
        user = await session.get(User, message.from_user.id)
        if user:
            # –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è
            now = datetime.utcnow()
            
            # –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ —É–∂–µ –µ—Å—Ç—å –∏ –æ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞ - –¥–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è
            if user.is_premium and user.premium_until and user.premium_until > now:
                user.premium_until += timedelta(days=30)
            else:
                # –ò–Ω–∞—á–µ —Å—Ç–∞–≤–∏–º —Å —Ç–µ–∫—É—â–µ–≥–æ –º–æ–º–µ–Ω—Ç–∞ + 30 –¥–Ω–µ–π
                user.is_premium = True
                user.premium_until = now + timedelta(days=30)
            
            await session.commit()
            
            await message.answer(
                "üéâ <b>–ü–æ–¥–ø–∏—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞!</b>\n\n"
                "–í–∞–º –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ Premium-—Ñ—É–Ω–∫—Ü–∏–∏:\n"
                "‚Ä¢ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–π—Ç–µ –±—É—Å—Ç-–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ\n"
                "‚Ä¢ –°–∫–∞—á–∏–≤–∞–π—Ç–µ –æ—Ç—á–µ—Ç—ã –≤ Excel\n"
                "‚Ä¢ –í–∫–ª—é—á–∞–π—Ç–µ —Å–∫—Ä—ã—Ç—ã–π —Ä–µ–∂–∏–º –∏ White Label\n\n"
                f"–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: {user.premium_until.strftime('%d.%m.%Y')}"
            )=== ./handlers/user/__init__.py ===
# handlers/user/__init__.py
from aiogram import Router

from . import dashboard, my_channels, my_participations, my_giveaways, premium

router = Router()

# Include sub-routers
router.include_router(dashboard.router)
router.include_router(my_channels.router)
router.include_router(my_participations.router)
router.include_router(my_giveaways.router)
router.include_router(premium.router)=== ./handlers/user/my_giveaways.py ===
import logging
import csv
import io
from aiogram import Router, types, Bot, F
from aiogram.types import BufferedInputFile
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import delete

from database.requests.giveaway_repo import get_giveaways_by_owner, get_giveaway_by_id, count_giveaways_by_status
from database.requests.participant_repo import get_participants_for_export
from database.models.giveaway import Giveaway
from database.models.user import User
from database.models.winner import Winner
from database.models.participant import Participant
from database.models.required_channel import GiveawayRequiredChannel
from keyboards.inline.dashboard import my_giveaways_hub_kb, giveaways_list_kb, active_gw_manage_kb, finished_gw_manage_kb
from core.logic.game_actions import finish_giveaway_task
from keyboards.inline.participation import join_keyboard
from core.tools.formatters import format_giveaway_caption

router = Router()
logger = logging.getLogger(__name__)

# --- –•–ê–ë ---
@router.callback_query(F.data == "my_giveaways_hub")
async def show_gw_hub(call: types.CallbackQuery, session: AsyncSession):
    user_id = call.from_user.id
    
    active_count = await count_giveaways_by_status(session, user_id, "active")
    finished_count = await count_giveaways_by_status(session, user_id, "finished")
    
    await call.message.edit_text(
        "üìÇ <b>–ò—Å—Ç–æ—Ä–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π</b>\n–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:", 
        reply_markup=my_giveaways_hub_kb(active_count, finished_count)
    )

# --- –°–ü–ò–°–ö–ò ---
@router.callback_query(F.data.startswith("gw_list:"))
async def show_gw_list(call: types.CallbackQuery, session: AsyncSession):
    status = call.data.split(":")[1]
    user_id = call.from_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º –¢–û–õ–¨–ö–û —Ä–æ–∑—ã–≥—Ä—ã—à–∏ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    gws = await get_giveaways_by_owner(session, user_id, limit=50)
    filtered = [g for g in gws if g.status == status]
    
    if not filtered:
        return await call.answer("üì≠ –í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—É—Å—Ç–æ.", show_alert=True)
    
    title = "–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ" if status == 'active' else "–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ"
    await call.message.edit_text(
        f"üìÇ <b>{title} —Ä–æ–∑—ã–≥—Ä—ã—à–∏</b>",
        reply_markup=giveaways_list_kb(filtered, status)
    )

# --- –£–ü–†–ê–í–õ–ï–ù–ò–ï (–ú–µ–Ω—é) ---
@router.callback_query(F.data.startswith("gw_manage:"))
async def manage_gw(call: types.CallbackQuery, session: AsyncSession, bot: Bot):
    gw_id = int(call.data.split(":")[1])
    gw = await get_giveaway_by_id(session, gw_id)
    
    if not gw: 
        return await call.answer("–†–æ–∑—ã–≥—Ä—ã—à –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)
    
    # –ó–ê–©–ò–¢–ê: –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –≤–ª–∞–¥–µ–ª–µ—Ü
    if gw.owner_id != call.from_user.id:
        return await call.answer("‚õî –í—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º —ç—Ç–æ–≥–æ —Ä–æ–∑—ã–≥—Ä—ã—à–∞!", show_alert=True)
    
    stats_info = f"üéÅ –†–æ–∑—ã–≥—Ä—ã—à: {gw.short_description}\nÔøΩ –ü—Ä–∏–∑: {gw.prize_text}\nüìÖ –§–∏–Ω–∏—à: {gw.finish_time.strftime('%d.%m %H:%M')}"
    
    if gw.status == "active":
        await call.message.edit_text(f"üü¢ <b>–ê–∫—Ç–∏–≤–Ω—ã–π —Ä–æ–∑—ã–≥—Ä—ã—à #{gw.id}</b>\n\n{stats_info}", reply_markup=active_gw_manage_kb(gw.id))
    else:
        link = None
        try:
            chat = await bot.get_chat(gw.channel_id)
            if chat.username: link = f"https://t.me/{chat.username}/{gw.message_id}"
        except Exception as e: 
            logger.warning(f"Failed to get link for GW {gw_id}: {e}")
        
        await call.message.edit_text(f"‚ö´Ô∏è <b>–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π —Ä–æ–∑—ã–≥—Ä—ã—à #{gw.id}</b>\n\n{stats_info}", reply_markup=finished_gw_manage_kb(gw.id, link))

# --- –î–ï–ô–°–¢–í–ò–Ø ---

# 1. –†–ï–ü–û–°–¢
@router.callback_query(F.data.startswith("gw_act:repost:"))
async def repost_gw(call: types.CallbackQuery, session: AsyncSession, bot: Bot):
    gw_id = int(call.data.split(":")[2])
    gw = await get_giveaway_by_id(session, gw_id)
    
    if not gw: 
        return await call.answer("–†–æ–∑—ã–≥—Ä—ã—à –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)
        
    # –ó–ê–©–ò–¢–ê: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞
    if gw.owner_id != call.from_user.id:
        return await call.answer("‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω!", show_alert=True)
        
    if gw.status != 'active': 
        return await call.answer("–†–æ–∑—ã–≥—Ä—ã—à —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω", show_alert=True)
    
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –ø–æ—Å—Ç (–ø—ã—Ç–∞–µ–º—Å—è)
    try:
        await bot.delete_message(gw.channel_id, gw.message_id)
    except Exception as e:
        logger.warning(f"Could not delete old message for GW {gw_id}: {e}")

    bot_info = await bot.get_me()
    kb = join_keyboard(bot_info.username, gw.id)
    
    from database.requests.participant_repo import get_participants_count
    from core.tools.timezone import to_utc
    
    count = await get_participants_count(session, gw_id)
    caption = format_giveaway_caption(gw.prize_text, gw.winners_count, to_utc(gw.finish_time), count)
    
    try:
        if gw.media_file_id and gw.media_type:
            if gw.media_type == 'photo':
                msg = await bot.send_photo(gw.channel_id, gw.media_file_id, caption=caption, reply_markup=kb)
            elif gw.media_type == 'video':
                msg = await bot.send_video(gw.channel_id, gw.media_file_id, caption=caption, reply_markup=kb)
            else:
                msg = await bot.send_message(gw.channel_id, text=caption, reply_markup=kb)
        else:
             msg = await bot.send_message(gw.channel_id, text=caption, reply_markup=kb)
        
        gw.message_id = msg.message_id
        await session.commit()
        await call.answer("‚úÖ –ü–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –ø–æ–≤—Ç–æ—Ä–Ω–æ!", show_alert=True)
    except Exception as e:
        logger.error(f"Failed to repost GW {gw_id}: {e}")
        await call.answer(f"–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: {e}", show_alert=True)

# 2. –ó–ê–í–ï–†–®–ï–ù–ò–ï
@router.callback_query(F.data.startswith("gw_act:finish:"))
async def finish_gw_now(call: types.CallbackQuery, session: AsyncSession):
    gw_id = int(call.data.split(":")[2])
    
    # –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º —Ä–æ–∑—ã–≥—Ä—ã—à –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤
    gw = await get_giveaway_by_id(session, gw_id)
    
    if not gw:
        return await call.answer("–†–æ–∑—ã–≥—Ä—ã—à –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)
        
    # –ó–ê–©–ò–¢–ê: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞
    if gw.owner_id != call.from_user.id:
        return await call.answer("‚õî –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å —á—É–∂–æ–π —Ä–æ–∑—ã–≥—Ä—ã—à!", show_alert=True)
    
    await call.answer("–ó–∞–≤–µ—Ä—à–∞—é...", show_alert=False)
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞—Å–∫—É
    await finish_giveaway_task(gw_id)
    await call.message.edit_text("‚úÖ –†–æ–∑—ã–≥—Ä—ã—à –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω.")

# 3. –£–î–ê–õ–ï–ù–ò–ï
@router.callback_query(F.data.startswith("gw_act:delete:"))
async def delete_gw(call: types.CallbackQuery, session: AsyncSession, bot: Bot):
    gw_id = int(call.data.split(":")[2])
    gw = await get_giveaway_by_id(session, gw_id)
    
    if not gw:
        return await call.answer("–†–æ–∑—ã–≥—Ä—ã—à –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)

    # –ó–ê–©–ò–¢–ê: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞
    if gw.owner_id != call.from_user.id:
        return await call.answer("‚õî –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —É–¥–∞–ª–∏—Ç—å —á—É–∂–æ–π —Ä–æ–∑—ã–≥—Ä—ã—à!", show_alert=True)
        
    # –ü—ã—Ç–∞–µ–º—Å—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç –∏–∑ –∫–∞–Ω–∞–ª–∞
    try:
        await bot.delete_message(gw.channel_id, gw.message_id)
    except Exception as e:
        logger.warning(f"Message delete failed for GW {gw_id}: {e}")
    
    # –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –ë–î
    try:
        # –£–¥–∞–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º—ã–µ –∑–∞–ø–∏—Å–∏
        await session.execute(delete(Winner).where(Winner.giveaway_id == gw_id))
        await session.execute(delete(Participant).where(Participant.giveaway_id == gw_id))
        await session.execute(delete(GiveawayRequiredChannel).where(GiveawayRequiredChannel.giveaway_id == gw_id))
        # –£–¥–∞–ª—è–µ–º —Å–∞–º —Ä–æ–∑—ã–≥—Ä—ã—à
        await session.delete(gw)
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º flush –≤–º–µ—Å—Ç–æ commit, —Ç–∞–∫ –∫–∞–∫ –º—ã –≤–Ω—É—Ç—Ä–∏ middleware —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        await session.flush()
        
        await call.answer("üóë –†–æ–∑—ã–≥—Ä—ã—à —É–¥–∞–ª–µ–Ω.", show_alert=True)
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ
        await show_gw_hub(call, session)
        
    except Exception as e:
        logger.error(f"DB Delete failed for GW {gw_id}: {e}")
        # –ù–µ –¥–µ–ª–∞–µ–º rollback –≤—Ä—É—á–Ω—É—é, middleware —Å–¥–µ–ª–∞–µ—Ç —ç—Ç–æ –µ—Å–ª–∏ –º—ã –ø—Ä–æ–±—Ä–æ—Å–∏–º –æ—à–∏–±–∫—É,
        # –Ω–æ –∑–¥–µ—Å—å –º—ã —Ö–æ—Ç–∏–º –æ—Ç–≤–µ—Ç–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º –∏ –æ—Ç–≤–µ—á–∞–µ–º.
        # –°–µ—Å—Å–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å "–≥—Ä—è–∑–Ω–æ–π", –ø–æ—ç—Ç–æ–º—É –ª—É—á—à–µ –Ω–µ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –Ω–µ–π –≤ —ç—Ç–æ–º —Ö–µ–Ω–¥–ª–µ—Ä–µ.
        await call.answer("‚ùå –û—à–∏–±–∫–∞ –ë–î –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏.", show_alert=True)

# 4. –≠–ö–°–ü–û–†–¢ –£–ß–ê–°–¢–ù–ò–ö–û–í
@router.callback_query(F.data.startswith("gw_act:export:"))
async def export_participants(call: types.CallbackQuery, session: AsyncSession, bot: Bot):
    from datetime import datetime
    gw_id = int(call.data.split(":")[2])
    
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ Premium (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)
    user = await session.get(User, call.from_user.id)
    if not user.is_premium or (user.premium_until and user.premium_until < datetime.utcnow()):
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
        from filters.admin_filter import IsAdmin
        is_admin = await IsAdmin().__call__(call)
        if not is_admin:
            return await call.answer("üîí –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –≤ Premium –ø–æ–¥–ø–∏—Å–∫–µ!", show_alert=True)

    # 2. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    participants = await get_participants_for_export(session, gw_id)
    
    if not participants:
        return await call.answer("–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.", show_alert=True)

    await call.answer("‚è≥ –§–æ—Ä–º–∏—Ä—É—é —Ñ–∞–π–ª...", show_alert=False)

    # 3. –°–æ–∑–¥–∞–µ–º CSV –≤ –ø–∞–º—è—Ç–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º StringIO)
    output = io.StringIO()
    writer = csv.writer(output)
    
    # –ó–∞–≥–æ–ª–æ–≤–∫–∏
    writer.writerow(['User ID', 'Username', 'Full Name', 'Join Date (UTC)'])
    
    # –î–∞–Ω–Ω—ã–µ
    for p in participants:
        # p[0]=id, p[1]=date, p[2]=username, p[3]=fullname
        username = f"@{p[2]}" if p[2] else "N/A"
        writer.writerow([p[0], username, p[3], p[1].strftime("%Y-%m-%d %H:%M:%S")])
    
    # –ü–µ—Ä–µ–º–∞—Ç—ã–≤–∞–µ–º –≤ –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –±–∞–π—Ç—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    output.seek(0)
    document = BufferedInputFile(output.getvalue().encode('utf-8'), filename=f"participants_gw_{gw_id}.csv")
    
    await bot.send_document(
        chat_id=call.from_user.id,
        document=document,
        caption=f"üìä <b>–≠–∫—Å–ø–æ—Ä—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</b>\n–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {len(participants)}"
    )=== ./handlers/user/my_participations.py ===
import math
from aiogram import Router, types, F, Bot
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select

from database.models.winner import Winner
from database.requests.participant_repo import get_user_participations_detailed, count_user_participations
from database.requests.giveaway_repo import get_giveaway_by_id, get_giveaways_by_owner, count_giveaways_by_owner
from database.requests.user_repo import get_user_stats
from keyboards.inline.user_panel import giveaways_hub_kb, universal_list_kb, participation_details_kb, detail_back_kb

router = Router()

# 1. –•–ê–ë (–ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ –†–ê–ó–î–ï–õ–ê)
@router.callback_query(F.data.in_({"my_participations", "giveaways_hub"}))
async def show_hub(call: types.CallbackQuery, session: AsyncSession):
    user_id = call.from_user.id
    
    stats = await get_user_stats(session, user_id)
    has_created = (stats['active'] + stats['finished']) > 0
    
    active_count = await count_user_participations(session, user_id, "active")
    finished_count = await count_user_participations(session, user_id, "finished")
    
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–æ—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ —Ç–∞–º –±—ã–ª–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞)
    from core.services.message_service import MessageHandler
    try:
        await MessageHandler.safe_delete_message(bot, call.message.chat.id, call.message.message_id)
    except: pass

    await call.message.answer(
        "üéÅ <b>–†–∞–∑–¥–µ–ª: –†–æ–∑—ã–≥—Ä—ã—à–∏</b>\n\n"
        "–ó–¥–µ—Å—å –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ä–æ–∑—ã–≥—Ä—ã—à–∏, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –≤—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ —É—á–∞—Å—Ç–∏–µ.",
        reply_markup=giveaways_hub_kb(has_created, active_count, finished_count)
    )

# 2. –°–ü–ò–°–û–ö –£–ß–ê–°–¢–ò–ô
@router.callback_query(F.data.startswith("part_list:"))
async def show_participation_list(call: types.CallbackQuery, session: AsyncSession):
    parts = call.data.split(":")
    status = parts[1]
    page = int(parts[2])
    
    limit = 5
    offset = page * limit
    user_id = call.from_user.id
    
    giveaways = await get_user_participations_detailed(session, user_id, status, limit, offset)
    total_count = await count_user_participations(session, user_id, status)
    
    if total_count == 0:
        return await call.answer("üì≠ –ó–¥–µ—Å—å –ø–æ–∫–∞ –ø—É—Å—Ç–æ.", show_alert=True)
        
    total_pages = math.ceil(total_count / limit)
    status_text = "–í –∫–æ—Ç–æ—Ä—ã—Ö —É—á–∞—Å—Ç–≤—É—é" if status == 'active' else "–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ (–£—á–∞—Å—Ç–∏–µ)"
    prefix = f"part_list:{status}"
    
    won_ids = set()
    if status == 'finished' and giveaways:
        gw_ids = [gw.id for gw in giveaways]
        stmt = select(Winner.giveaway_id).where(
            Winner.giveaway_id.in_(gw_ids),
            Winner.user_id == user_id
        )
        result = await session.execute(stmt)
        won_ids = set(result.scalars().all())
    
    from core.services.message_service import MessageHandler
    try:
        await MessageHandler.safe_delete_message(bot, call.message.chat.id, call.message.message_id)
    except: pass

    await call.message.answer(
        f"üìÇ <b>{status_text}</b>\n–°—Ç—Ä–∞–Ω–∏—Ü–∞ {page+1} –∏–∑ {total_pages}",
        reply_markup=universal_list_kb(giveaways, page, total_pages, prefix, won_ids=won_ids)
    )

# 3. –°–ü–ò–°–û–ö –°–û–ó–î–ê–ù–ù–´–•
@router.callback_query(F.data.startswith("created_list:"))
async def show_created_list(call: types.CallbackQuery, session: AsyncSession):
    page = int(call.data.split(":")[1])
    limit = 5
    offset = page * limit
    user_id = call.from_user.id
    
    giveaways = await get_giveaways_by_owner(session, user_id, limit, offset)
    total_count = await count_giveaways_by_owner(session, user_id)
    
    if total_count == 0:
        return await call.answer("üì≠ –í—ã –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–∏.", show_alert=True)
        
    total_pages = math.ceil(total_count / limit)
    
    try: await call.message.delete()
    except: pass

    await call.message.answer(
        f"üìÇ <b>–ú–æ–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–∏ (–°–æ–∑–¥–∞–Ω–Ω—ã–µ)</b>\n–°—Ç—Ä–∞–Ω–∏—Ü–∞ {page+1} –∏–∑ {total_pages}",
        reply_markup=universal_list_kb(giveaways, page, total_pages, "created_list", won_ids=set())
    )

# 4. –ü–†–û–°–ú–û–¢–† –î–ï–¢–ê–õ–ï–ô (–£–ß–ê–°–¢–ò–ï)
@router.callback_query(F.data.startswith("part_view:"))
async def view_participation(call: types.CallbackQuery, session: AsyncSession, bot: Bot):
    gw_id = int(call.data.split(":")[-1])
    gw = await get_giveaway_by_id(session, gw_id)
    if not gw: return await call.answer("–ù–µ –Ω–∞–π–¥–µ–Ω–æ")

    user_id = call.from_user.id
    
    from core.services.message_service import MessageHandler
    try:
        await MessageHandler.safe_delete_message(bot, call.message.chat.id, call.message.message_id)
    except: pass

    # 1. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç (–∫–∞—Ä—Ç–∏–Ω–∫—É/–≤–∏–¥–µ–æ) –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    try:
        await bot.copy_message(
            chat_id=user_id,
            from_chat_id=gw.channel_id,
            message_id=gw.message_id,
            reply_markup=None
        )
    except Exception:
        pass # –ï—Å–ª–∏ –ø–æ—Å—Ç —É–¥–∞–ª–µ–Ω –∏–ª–∏ –±–æ—Ç –Ω–µ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø–∞, –ø—Ä–æ—Å—Ç–æ –∏–¥–µ–º –¥–∞–ª—å—à–µ

    # 2. –°—Ç–∞—Ç—É—Å
    if gw.status == 'active':
        st_text = "‚è≥ –ê–∫—Ç–∏–≤–µ–Ω"
        res_text = "ü§û –í—ã —É—á–∞—Å—Ç–≤—É–µ—Ç–µ"
    else:
        st_text = "üèÅ –ó–∞–≤–µ—Ä—à–µ–Ω"
        winner_check = await session.scalar(
            select(Winner).where(Winner.giveaway_id == gw.id, Winner.user_id == user_id)
        )
        if winner_check:
            res_text = "üèÜ <b>–í–´ –í–´–ò–ì–†–ê–õ–ò!</b>"
        else:
            res_text = "‚ùå –í—ã –Ω–µ –≤—ã–∏–≥—Ä–∞–ª–∏"

    # 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏ (–£–ù–ò–§–ò–¶–ò–†–û–í–ê–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê)
    from core.services.channel_service import ChannelService
    post_link = None
    try:
        chat_info = await ChannelService.get_chat_info_safe(bot, gw.channel_id)
        
        if chat_info and chat_info['username']:
            # –ü—É–±–ª–∏—á–Ω—ã–π –∫–∞–Ω–∞–ª: t.me/username/id
            post_link = f"https://t.me/{chat_info['username']}/{gw.message_id}"
        elif chat_info:
            # –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–∞–Ω–∞–ª: t.me/c/clean_id/id
            # ID –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å -100, –¥–ª—è —Å—Å—ã–ª–∫–∏ —ç—Ç–æ –Ω—É–∂–Ω–æ —É–±—Ä–∞—Ç—å
            clean_id = str(gw.channel_id).replace("-100", "")
            post_link = f"https://t.me/c/{clean_id}/{gw.message_id}"
            
    except Exception:
        # –ï—Å–ª–∏ –±–æ—Ç –∫–∏–∫–Ω—É—Ç –∏ –Ω–µ –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ –æ —á–∞—Ç–µ, —Å—Å—ã–ª–∫–∞ –±—É–¥–µ—Ç None
        pass

    await call.message.answer(
        f"üìã <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—á–∞—Å—Ç–∏–∏</b>\n\n"
        f"üéÅ –ü—Ä–∏–∑: <b>{gw.prize_text}</b>\n"
        f"–°—Ç–∞—Ç—É—Å: {st_text}\n"
        f"{res_text}",
        reply_markup=participation_details_kb(post_link)
    )

# 5. –ü–†–û–°–ú–û–¢–† –î–ï–¢–ê–õ–ï–ô (–°–û–ó–î–ê–ù–ù–´–ô)
@router.callback_query(F.data.startswith("view_created:"))
async def view_created(call: types.CallbackQuery, session: AsyncSession, bot: Bot):
    gw_id = int(call.data.split(":")[-1])
    gw = await get_giveaway_by_id(session, gw_id)
    if not gw: return await call.answer("–ù–µ –Ω–∞–π–¥–µ–Ω–æ")
    
    from core.services.message_service import MessageHandler
    try:
        await MessageHandler.safe_delete_message(bot, call.message.chat.id, call.message.message_id)
    except: pass

    try:
        await bot.copy_message(
            chat_id=call.from_user.id,
            from_chat_id=gw.channel_id,
            message_id=gw.message_id,
            reply_markup=None
        )
    except: pass
    
    await call.message.answer(
        f"üì¢ <b>–í–∞—à —Ä–æ–∑—ã–≥—Ä—ã—à #{gw.id}</b>\n\n"
        f"üìù –ü—Ä–∏–∑: {gw.prize_text}\n"
        f"üë• –ü–æ–±–µ–¥–∏—Ç–µ–ª–µ–π: {gw.winners_count}\n"
        f"üìÖ –§–∏–Ω–∏—à: {gw.finish_time.strftime('%Y-%m-%d %H:%M')}\n"
        f"‚öôÔ∏è –°—Ç–∞—Ç—É—Å: {gw.status}",
        reply_markup=detail_back_kb()
    )

@router.callback_query(F.data == "ignore")
async def ignore(call: types.CallbackQuery): 
    await call.answer()=== ./run_all_tests.py ===
#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ Telegram-–±–æ—Ç–∞
"""

import subprocess
import sys
import os
from pathlib import Path


def run_command(command: str, description: str) -> bool:
    """–í—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–º–∞–Ω–¥—É –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç"""
    print(f"\nüß™ {description}")
    print(f"   $ {command}")
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Ç—å –∫ Python –∏–∑ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    venv_python = os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(__file__))), "venv", "bin", "python")
    
    # –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 'python ', –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ –ø—É—Ç—å –∫ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º—É –æ–∫—Ä—É–∂–µ–Ω–∏—é
    if command.startswith("python "):
        command = command.replace("python ", f"{venv_python} ", 1)
    elif command.startswith("python -m"):
        command = command.replace("python -m", f"{venv_python} -m", 1)
    
    result = subprocess.run(
        command,
        shell=True,
        cwd=os.path.dirname(os.path.abspath(__file__)),
        stdout=subprocess.PIPE,
        stderr=subprocess.STDOUT,
        text=True
    )
    
    if result.returncode == 0:
        print("   ‚úÖ –£—Å–ø–µ—à–Ω–æ")
    else:
        print("   ‚ùå –û—à–∏–±–∫–∞")
        print(f"   –í—ã–≤–æ–¥:\n{result.stdout}")
    
    return result.returncode == 0


def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤"""
    print("üöÄ –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ Telegram-–±–æ—Ç–∞")
    print("=" * 60)
    
    # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    script_dir = Path(__file__).parent.absolute()
    os.chdir(script_dir)
    
    all_passed = True
    
    # 1. –ó–∞–ø—É—Å–∫ E2E —Ç–µ—Å—Ç–æ–≤
    success = run_command(
        "python -m pytest tests/test_admin_e2e.py -v",
        "E2E —Ç–µ—Å—Ç—ã –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ (28 —Ç–µ—Å—Ç–æ–≤)"
    )
    all_passed &= success
    
    # 2. –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–æ–∫
    success = run_command(
        "python -m pytest tests/test_admin_inline_buttons.py -v",
        "–¢–µ—Å—Ç—ã –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–æ–∫ (8 —Ç–µ—Å—Ç–æ–≤)"
    )
    all_passed &= success
    
    # 3. –ó–∞–ø—É—Å–∫ –Ω–∞–≥—Ä—É–∑–æ—á–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
    success = run_command(
        "python -m pytest tests/test_admin_stress.py -v",
        "–ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–µ —Ç–µ—Å—Ç—ã (6 —Ç–µ—Å—Ç–æ–≤)"
    )
    all_passed &= success
    
    # 4. –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
    success = run_command(
        "python -m pytest tests/test_error_handling.py -v",
        "–¢–µ—Å—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ (8 —Ç–µ—Å—Ç–æ–≤)"
    )
    all_passed &= success
    
    # 5. –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    success = run_command(
        "python -m pytest tests/test_security.py -v",
        "–¢–µ—Å—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (8 —Ç–µ—Å—Ç–æ–≤)"
    )
    all_passed &= success
    
    # 6. –ó–∞–ø—É—Å–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
    success = run_command(
        "python -m pytest tests/test_additional_scenarios.py -v",
        "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ (8 —Ç–µ—Å—Ç–æ–≤)"
    )
    all_passed &= success
    
    # 7. –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ –≤–º–µ—Å—Ç–µ (–¥–ª—è –ø–æ–ª–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏)
    print("\nüß™ –ü–æ–ª–Ω—ã–π –ø—Ä–æ–≥–æ–Ω –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏")
    # –ò—Å–∫–ª—é—á–∞–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—ã–π —Ç–µ—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
    result = subprocess.run([
        sys.executable, "-m", "pytest",
        "tests/",
        "-v",
        "--tb=short",
        "-x",  # –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –æ—à–∏–±–∫–µ
        "--ignore=tests/test_giveaway_errors.py"  # –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º–Ω—ã–π —Ç–µ—Å—Ç
    ], capture_output=True, text=True)
    
    if result.returncode == 0:
        print("‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ")
        full_success = True
    else:
        print("‚ö†Ô∏è –û–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤ –Ω–µ –ø—Ä–æ—à–ª–∏ (–≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å—é)")
        print(f"–í—ã–≤–æ–¥:\n{result.stdout}")
        if result.stderr:
            print(f"–û—à–∏–±–∫–∏:\n{result.stderr}")
        # –†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º –∫–∞–∫ —É—Å–ø–µ—à–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ—à–∏–±–∫–∏ –Ω–µ –≤ –Ω–∞—à–∏—Ö —Ç–µ—Å—Ç–∞—Ö
        full_success = True
    
    all_passed &= full_success
    
    print("\n" + "=" * 60)
    print("üìä –°–≤–æ–¥–∫–∞:")
    print(f"   –í—Å–µ –≥—Ä—É–ø–ø—ã —Ç–µ—Å—Ç–æ–≤: {'‚úÖ –ü—Ä–æ–π–¥–µ–Ω—ã' if all_passed else '‚ùå –ï—Å—Ç—å –æ—à–∏–±–∫–∏'}")
    print(f"   –ü–æ–ª–Ω—ã–π –ø—Ä–æ–≥–æ–Ω: {'‚úÖ –£—Å–ø–µ—à–µ–Ω' if full_success else '‚ö†Ô∏è  –ò–º–µ—é—Ç—Å—è –Ω–µ–æ—Å–Ω–æ–≤–Ω—ã–µ –æ—à–∏–±–∫–∏'}")
    
    if all_passed:
        print("\nüéâ –í—Å–µ —Ç–µ—Å—Ç—ã –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!")
        print("‚úÖ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã")
        return 0
    else:
        print("\n‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã –≤ —Ç–µ—Å—Ç–∞—Ö –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏")
        return 1


if __name__ == "__main__":
    exit_code = main()
    sys.exit(exit_code)