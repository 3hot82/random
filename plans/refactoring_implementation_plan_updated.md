# Пошаговый план рефакторинга Telegram бота

## Цель
Провести комплексный рефакторинг Telegram бота для розыгрышей с улучшением типизации, устранением дублирования кода, унификацией админ-панели и удалением лишних файлов. При этом использовать современные возможности aiogram 3.x согласно актуальной документации.

## ЭТАП 1: Подготовка и анализ

### 1.1. Создание резервной копии проекта
- Создать резервную копию всех файлов перед началом рефакторинга

### 1.2. Анализ структуры проекта
- Определить файлы, которые используются и которые можно удалить
- Выявить дублирующиеся функции и классы
- Определить зависимости между модулями

### 1.3. Аудит соответствия aiogram 3.x
- Проверить использование Router, Dispatcher и Bot в соответствии с версией 3.x
- Убедиться в правильном использовании FSMContext и состояний
- Проверить работу с мидлварами согласно новой архитектуре

## ЭТАП 2: Улучшение типизации

### 2.1. Добавление полных аннотаций типов
- Добавить типизацию ко всем обработчикам событий согласно документации aiogram 3.x
- Использовать Union типы: `Message | CallbackQuery`
- Указать типы для всех параметров: `AsyncSession`, `Bot`, `FSMContext`, `TelegramObject`
- Использовать `types.Union` для объединения разных типов обновлений

### 2.2. Создание типов данных
- Определить типы для часто используемых структур данных
- Создать Protocol для сервисов
- Использовать TypedDict для словарей с фиксированной структурой
- Применять правильные типы для коллбэков и фильтров согласно документации

### 2.3. Настройка mypy
- Добавить конфигурацию mypy в проект
- Проверить весь код на типовые ошибки
- Исправить найденные проблемы

## ЭТАП 3: Современная обработка исключений согласно документации

### 3.1. Замена общих блоков except
- Заменить все `except:` на конкретные типы исключений
- Использовать специфичные исключения Telegram API: `TelegramBadRequest`, `TelegramNetworkError`, `RestartingTelegram`
- Добавить логирование ошибок с контекстом

### 3.2. Создание централизованного обработчика ошибок
- Реализовать глобальный ErrorHandler в соответствии с рекомендациями aiogram 3.x
- Добавить логирование с информацией о пользователе и действии
- Обработка специфичных ошибок Telegram API в одном месте

### 3.3. Использование ErrorMiddleware
- Реализовать ErrorMiddleware для перехвата и обработки исключений
- Настроить корректное логирование ошибок
- Обеспечить graceful degradation при ошибках

## ЭТАП 4: Улучшение архитектуры с учетом особенностей aiogram 3.x

### 4.1. Оптимизация использования Router
- Убедиться, что все обработчики группируются в Router'ы
- Использовать фильтры на уровне Router'ов для оптимизации
- Применять вложенные Router'ы для сложных сценариев

### 4.2. Современное использование FSM
- Проверить корректное использование FSMContext
- Обеспечить очистку состояний после завершения работы
- Использовать группы состояний при необходимости

### 4.3. Правильное использование фильтров
- Использовать встроенные фильтры aiogram 3.x
- Применять магические фильтры (magic filters) при необходимости
- Создавать кастомные фильтры с правильным интерфейсом

## ЭТАП 5: Устранение дублирования кода

### 5.1. Создание вспомогательных функций
- Вынести повторяющиеся блоки `try/except` для `bot.get_chat()` и `bot.get_chat_member()`
- Создать универсальные функции для безопасного редактирования/удаления сообщений
- Использовать вспомогательные функции в соответствии с рекомендациями aiogram

### 5.2. Создание утилитарных классов
- Реализовать класс `MessageHandler` для работы с сообщениями
- Создать класс `ChannelService` для работы с каналами
- Создать класс `UserService` для работы с пользователями
- Все классы должны соответствовать асинхронной архитектуре aiogram 3.x

### 5.3. Рефакторинг повторяющихся шаблонов
- Объединить повторяющиеся блоки кода для проверки подписки
- Создать универсальные методы для работы с участниками розыгрышей
- Использовать шаблоны ответов и клавиатур в соответствии с документацией

## ЭТАП 6: Современные подходы к работе с клавиатурами

### 6.1. Оптимизация inline клавиатур
- Использовать билдеры клавиатур в соответствии с документацией
- Применять callback data модели с правильной валидацией
- Обеспечить типизацию callback данных

### 6.2. Унификация клавиатур
- Создать базовые классы для различных типов клавиатур
- Использовать шаблоны для часто используемых клавиатур
- Обеспечить единообразие в создании клавиатур

## ЭТАП 7: Унификация админ-панели

### 7.1. Анализ текущей структуры
- Изучить текущие файлы админ-панели и супер-админ панели
- Определить различия в функциональности
- Проверить соответствие современным подходам aiogram 3.x

### 7.2. Создание унифицированного меню
- Объединить функциональность админ-панели и супер-админ панели
- Создать единую систему прав доступа
- Реализовать ролевую систему: админ с расширенными правами и обычный админ

### 7.3. Удаление дублирующейся функциональности
- Удалить файлы, дублирующие функциональность
- Переименовать и реорганизовать оставшиеся файлы
- Убедиться, что вся функциональность соответствует архитектуре aiogram 3.x

### 7.4. Обновление обработчиков
- Обновить все обработчики под новую систему прав
- Обеспечить обратную совместимость с существующими ссылками
- Использовать современные подходы к обработке событий

## ЭТАП 8: Оптимизация работы с базой данных

### 8.1. Улучшение асинхронной работы
- Убедиться, что все запросы к базе данных асинхронны
- Проверить корректное управление сессиями
- Использовать connection pooling эффективно

### 8.2. Оптимизация запросов
- Проверить эффективность SQL запросов
- Использовать eager loading там, где это уместно
- Убедиться, что все модели типизированы корректно

## ЭТАП 9: Удаление лишних файлов

### 9.1. Идентификация лишних файлов
- Удалить дублирующие файлы после объединения админ-панелей
- Удалить неиспользуемые функции и классы
- Удалить закомментированный или неиспользуемый код

### 9.2. Очистка зависимостей
- Проверить и удалить неиспользуемые импорты
- Обновить requirements.txt при необходимости
- Убедиться, что все зависимости соответствуют версии aiogram 3.x

## ЭТАП 10: Тестирование и проверка

### 10.1. Проверка работоспособности
- Проверить все основные функции бота
- Убедиться, что все обработчики работают корректно
- Протестировать различные сценарии использования

### 10.2. Тестирование безопасности
- Проверить, что права доступа работают корректно
- Убедиться, что обычные пользователи не могут получить доступ к админ-функциям

### 10.3. Тестирование производительности
- Проверить, что бот корректно обрабатывает нагрузку
- Убедиться, что нет утечек памяти
- Проверить корректность работы FSM

## ЭТАП 11: Документирование изменений

### 11.1. Обновление документации
- Обновить README файл при необходимости
- Добавить комментарии к новым функциям и классам
- Описать новые архитектурные решения

### 11.2. Создание чек-листа для разработчиков
- Описать новые стандарты кодирования
- Указать новые практики типизации и обработки исключений
- Описать архитектурные паттерны проекта